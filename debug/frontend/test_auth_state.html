<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èªè­‰ç‹€æ…‹æ¸¬è©¦é é¢</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .test-container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
        }
        .status.success { 
            background: #d4edda; 
            border: 1px solid #c3e6cb; 
            color: #155724; 
        }
        .status.error { 
            background: #f8d7da; 
            border: 1px solid #f5c6cb; 
            color: #721c24; 
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            background: #007bff; 
            color: white; 
        }
        button:hover { 
            background: #0056b3; 
        }
        .info-box {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”§ NexusTrade èªè­‰ç‹€æ…‹æ¸¬è©¦</h1>
        
        <div class="info-box">
            <h3>ğŸ“‹ æ¸¬è©¦æ­¥é©Ÿï¼š</h3>
            <ol>
                <li>é»æ“Šã€Œæª¢æŸ¥èªè­‰ç‹€æ…‹ã€æŸ¥çœ‹ç•¶å‰ç‹€æ…‹</li>
                <li>å¦‚æœæœ‰ Tokenï¼Œé»æ“Šã€Œæ¨¡æ“¬é é¢é‡æ–°è¼‰å…¥ã€</li>
                <li>æª¢æŸ¥èªè­‰ç‹€æ…‹æ˜¯å¦æ­£ç¢ºæ¢å¾©</li>
                <li>å¦‚æœéœ€è¦ï¼Œé»æ“Šã€Œæ¸…é™¤èªè­‰ç‹€æ…‹ã€é‡ç½®</li>
            </ol>
        </div>
        
        <div id="status-display"></div>
        
        <div>
            <button onclick="checkAuthState()">ğŸ” æª¢æŸ¥èªè­‰ç‹€æ…‹</button>
            <button onclick="simulatePageReload()">ğŸ”„ æ¨¡æ“¬é é¢é‡æ–°è¼‰å…¥</button>
            <button onclick="clearAuthState()">ğŸ—‘ï¸ æ¸…é™¤èªè­‰ç‹€æ…‹</button>
            <button onclick="setTestAuthState()">ğŸ§ª è¨­å®šæ¸¬è©¦èªè­‰ç‹€æ…‹</button>
        </div>
        
        <div class="info-box">
            <h3>ğŸ” æª¢æŸ¥é …ç›®ï¼š</h3>
            <ul>
                <li><code>localStorage.getItem('nexustrade_token')</code></li>
                <li><code>localStorage.getItem('nexustrade_user')</code></li>
                <li><code>localStorage.getItem('nexustrade_line_bound')</code></li>
            </ul>
        </div>
        
        <div id="debug-info"></div>
    </div>

    <script>
        function displayStatus(message, type = 'info') {
            const display = document.getElementById('status-display');
            display.innerHTML = '<div class="status ' + (type === 'error' ? 'error' : 'success') + '">' + message + '</div>';
        }
        
        function checkAuthState() {
            const token = localStorage.getItem('nexustrade_token');
            const user = localStorage.getItem('nexustrade_user');
            const lineBound = localStorage.getItem('nexustrade_line_bound');
            
            let status = '<h3>ğŸ“Š ç•¶å‰èªè­‰ç‹€æ…‹ï¼š</h3>';
            
            if (token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const isExpired = payload.exp * 1000 <= Date.now();
                    const timeLeft = Math.max(0, payload.exp * 1000 - Date.now());
                    
                    status += '<p><strong>Token:</strong> âœ… å­˜åœ¨ (' + (isExpired ? 'å·²éæœŸ' : 'æœ‰æ•ˆï¼Œå‰©é¤˜ ' + Math.round(timeLeft / 60000) + ' åˆ†é˜') + ')</p>';
                    status += '<p><strong>User ID:</strong> ' + payload.userId + '</p>';
                    status += '<p><strong>Email:</strong> ' + (payload.email || 'N/A') + '</p>';
                } catch (error) {
                    status += '<p><strong>Token:</strong> âŒ ç„¡æ•ˆæ ¼å¼</p>';
                }
            } else {
                status += '<p><strong>Token:</strong> âŒ ä¸å­˜åœ¨</p>';
            }
            
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    status += '<p><strong>ä½¿ç”¨è€…è³‡æ–™:</strong> âœ… å­˜åœ¨ (' + userData.name + ', ' + userData.email + ')</p>';
                } catch (error) {
                    status += '<p><strong>ä½¿ç”¨è€…è³‡æ–™:</strong> âŒ ç„¡æ•ˆæ ¼å¼</p>';
                }
            } else {
                status += '<p><strong>ä½¿ç”¨è€…è³‡æ–™:</strong> âŒ ä¸å­˜åœ¨</p>';
            }
            
            status += '<p><strong>LINE ç¶å®š:</strong> ' + (lineBound === 'true' ? 'âœ… å·²ç¶å®š' : 'âŒ æœªç¶å®š') + '</p>';
            
            displayStatus(status, token && user ? 'success' : 'error');
        }
        
        function simulatePageReload() {
            displayStatus('ğŸ”„ æ¨¡æ“¬é é¢é‡æ–°è¼‰å…¥...é–‹å§‹æª¢æŸ¥èªè­‰æ¢å¾©æ©Ÿåˆ¶', 'info');
            
            setTimeout(() => {
                // æ¨¡æ“¬ LoginModal çš„ checkAndUpdateUIState é‚è¼¯
                const token = localStorage.getItem('nexustrade_token');
                const userStr = localStorage.getItem('nexustrade_user');
                
                if (token && userStr) {
                    try {
                        const tokenParts = token.split('.');
                        if (tokenParts.length === 3) {
                            const payload = JSON.parse(atob(tokenParts[1]));
                            const isExpired = payload.exp * 1000 <= Date.now();
                            
                            if (!isExpired) {
                                const user = JSON.parse(userStr);
                                displayStatus('âœ… èªè­‰ç‹€æ…‹æˆåŠŸæ¢å¾©ï¼ä½¿ç”¨è€…: ' + user.name, 'success');
                                return;
                            }
                        }
                    } catch (error) {
                        displayStatus('âŒ èªè­‰ç‹€æ…‹æ¢å¾©å¤±æ•—: ' + error.message, 'error');
                        return;
                    }
                }
                
                displayStatus('âŒ æ²’æœ‰æœ‰æ•ˆçš„èªè­‰ç‹€æ…‹å¯æ¢å¾©', 'error');
            }, 1000);
        }
        
        function clearAuthState() {
            localStorage.removeItem('nexustrade_token');
            localStorage.removeItem('nexustrade_user');
            localStorage.removeItem('nexustrade_line_bound');
            displayStatus('ğŸ—‘ï¸ èªè­‰ç‹€æ…‹å·²æ¸…é™¤', 'success');
        }
        
        function setTestAuthState() {
            // å‰µå»ºæ¸¬è©¦ Tokenï¼ˆ24å°æ™‚æœ‰æ•ˆæœŸï¼‰
            const header = btoa(JSON.stringify({typ: 'JWT', alg: 'HS256'}));
            const payload = btoa(JSON.stringify({
                userId: 'test-user-123',
                email: 'test@example.com',
                exp: Math.floor(Date.now() / 1000) + 86400 // 24å°æ™‚å¾ŒéæœŸ
            }));
            const testToken = header + '.' + payload + '.test-signature';
            
            const testUser = {
                _id: 'test-user-123',
                email: 'test@example.com',
                name: 'Test User',
                avatar: 'https://via.placeholder.com/40'
            };
            
            localStorage.setItem('nexustrade_token', testToken);
            localStorage.setItem('nexustrade_user', JSON.stringify(testUser));
            localStorage.setItem('nexustrade_line_bound', 'false');
            
            displayStatus('ğŸ§ª æ¸¬è©¦èªè­‰ç‹€æ…‹å·²è¨­å®š', 'success');
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
        checkAuthState();
    </script>
</body>
</html>