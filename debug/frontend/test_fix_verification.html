<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修復驗證測試</title>
    <link rel="stylesheet" href="css/main.css?v=20250625fix6">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e27;
            color: #ffffff;
            margin: 0;
            padding: 20px;
        }
        .verification-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-results {
            background: #1a1f3a;
            border: 1px solid #2d3748;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .indicator-test {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: #2d3748;
            border-radius: 8px;
            font-size: 14px;
        }
        .status-ok { color: #00d4aa; }
        .status-warning { color: #ffa502; }
        .status-error { color: #ff4757; }
        .ai-analysis-container {
            margin: 30px 0;
            border: 2px solid #2d3748;
            border-radius: 12px;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="verification-container">
        <h1>🔧 AI 分析修復驗證 - Llama 4 Scout 模型</h1>
        <p>驗證新的 OpenRouter 模型配置和數據結構修復</p>
        
        <div class="test-results">
            <h2>📊 技術指標檢測結果</h2>
            <div id="indicators-test-results">
                正在檢測...
            </div>
        </div>
        
        <div class="ai-analysis-container">
            <h2>🎨 前端組件顯示測試</h2>
            <div id="ai-currency-analysis-container"></div>
        </div>
        
        <div class="test-results">
            <h2>🔍 問題修復檢查清單</h2>
            <div id="fix-checklist">
                載入中...
            </div>
        </div>
    </div>

    <script src="js/components/AICurrencyAnalysis.js?v=20250625fix6"></script>
    
    <script>
        async function runVerificationTests() {
            console.log('🔧 開始修復驗證測試...');
            
            try {
                // 1. 測試 API 數據
                const response = await fetch('/api/ai/currency-analysis/BTCUSDT');
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayIndicatorResults(data.data.analysis.technicalAnalysis);
                    runFixChecklist(data.data.analysis.technicalAnalysis);
                } else {
                    document.getElementById('indicators-test-results').innerHTML = 
                        '<div class="status-error">❌ API 請求失敗: ' + data.message + '</div>';
                }
                
                // 2. 測試前端組件
                const aiComponent = new AICurrencyAnalysis('ai-currency-analysis-container', 'BTCUSDT');
                
            } catch (error) {
                console.error('驗證測試失敗:', error);
                document.getElementById('indicators-test-results').innerHTML = 
                    '<div class="status-error">❌ 測試過程發生錯誤: ' + error.message + '</div>';
            }
        }
        
        function displayIndicatorResults(indicators) {
            const container = document.getElementById('indicators-test-results');
            let html = '';
            
            const expectedIndicators = ['rsi', 'macd', 'movingAverage', 'bollingerBands', 'volume', 'williamsR'];
            
            expectedIndicators.forEach(key => {
                const indicator = indicators[key];
                const exists = !!indicator;
                
                if (!exists) {
                    html += `<div class="indicator-test">
                        <div class="status-error">❌ ${key}</div>
                        <div>不存在</div>
                        <div>-</div>
                        <div>-</div>
                    </div>`;
                    return;
                }
                
                const value = indicator.value;
                const interpretation = indicator.interpretation;
                const signal = indicator.signal;
                
                // 檢查是否有 N/A, null, undefined 問題
                const hasValueIssue = value === 'N/A' || value === 'null' || value === 'undefined';
                const hasInterpretationIssue = interpretation === 'N/A' || interpretation === 'null' || interpretation === 'undefined';
                const hasSignalIssue = signal === 'N/A' || signal === 'null' || signal === 'undefined' || !signal;
                
                const valueStatus = hasValueIssue ? 'status-error' : (value === null ? 'status-warning' : 'status-ok');
                const interpretationStatus = hasInterpretationIssue ? 'status-error' : (!interpretation ? 'status-warning' : 'status-ok');
                const signalStatus = hasSignalIssue ? 'status-error' : 'status-ok';
                
                html += `<div class="indicator-test">
                    <div class="status-ok">✅ ${key}</div>
                    <div class="${valueStatus}">值: ${value === null ? 'null (正常)' : (hasValueIssue ? '❌ ' + value : '✅ ' + value)}</div>
                    <div class="${interpretationStatus}">解讀: ${!interpretation ? '⚠️ 空值' : (hasInterpretationIssue ? '❌ ' + interpretation : '✅ 正常')}</div>
                    <div class="${signalStatus}">信號: ${hasSignalIssue ? '❌ ' + signal : '✅ ' + signal}</div>
                </div>`;
            });
            
            container.innerHTML = html;
        }
        
        function runFixChecklist(indicators) {
            const checklist = [
                {
                    name: '6 個技術指標完整存在',
                    test: () => Object.keys(indicators).length === 6,
                    description: '確保 RSI, MACD, 移動平均線, 布林通道, 成交量, Williams %R 都存在'
                },
                {
                    name: '沒有 "N/A" 字串值',
                    test: () => {
                        return !Object.values(indicators).some(indicator => {
                            return indicator.value === 'N/A' || indicator.interpretation === 'N/A' || indicator.signal === 'N/A';
                        });
                    },
                    description: '所有 "N/A" 值都應該被正確處理'
                },
                {
                    name: '沒有 "undefined" 字串值',
                    test: () => {
                        return !Object.values(indicators).some(indicator => {
                            return indicator.value === 'undefined' || indicator.interpretation === 'undefined' || indicator.signal === 'undefined';
                        });
                    },
                    description: '所有 "undefined" 值都應該被正確處理'
                },
                {
                    name: '所有信號欄位都有值',
                    test: () => {
                        return Object.values(indicators).every(indicator => indicator.signal && indicator.signal.trim() !== '');
                    },
                    description: '每個技術指標都應該有明確的信號'
                },
                {
                    name: 'Williams %R 指標存在',
                    test: () => !!indicators.williamsR,
                    description: '第6個技術指標 Williams %R 應該存在'
                }
            ];
            
            let html = '';
            let passedCount = 0;
            
            checklist.forEach(check => {
                const passed = check.test();
                if (passed) passedCount++;
                
                html += `<div style="margin: 10px 0; padding: 10px; background: ${passed ? '#1a4d3a' : '#4d1a1a'}; border-radius: 8px;">
                    <div style="font-weight: bold; color: ${passed ? '#00d4aa' : '#ff4757'};">
                        ${passed ? '✅' : '❌'} ${check.name}
                    </div>
                    <div style="font-size: 14px; color: #a0aec0; margin-top: 5px;">
                        ${check.description}
                    </div>
                </div>`;
            });
            
            const overallStatus = passedCount === checklist.length ? '✅ 全部通過' : `⚠️ ${passedCount}/${checklist.length} 項通過`;
            
            html = `<div style="margin-bottom: 20px; padding: 15px; background: ${passedCount === checklist.length ? '#1a4d3a' : '#4d3a1a'}; border-radius: 8px; text-align: center; font-size: 18px; font-weight: bold;">
                ${overallStatus}
            </div>` + html;
            
            document.getElementById('fix-checklist').innerHTML = html;
        }
        
        // 頁面載入完成後開始測試
        window.addEventListener('load', () => {
            runVerificationTests();
        });
    </script>
</body>
</html>