<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusTrade OAuth æ¨¡æ“¬æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: #ffffff;
            max-width: 900px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #2a2a2a;
        }
        .test-button {
            margin: 5px;
            padding: 10px 20px;
            background: #f7931a;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #e8830f;
        }
        .test-button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #0f0f0f;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            border-left: 4px solid #10b981;
        }
        .error {
            border-left: 4px solid #ef4444;
        }
        .info {
            border-left: 4px solid #3b82f6;
        }
        .oauth-simulation {
            background: #2d3748;
            border: 2px dashed #4a5568;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .simulation-input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            background: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 4px;
            color: white;
        }
    </style>
</head>
<body>
    <h1>ğŸ” NexusTrade OAuth æ¨¡æ“¬æ¸¬è©¦</h1>
    <p style="color: #ffa500;">æ­¤é é¢æ¨¡æ“¬ OAuth èªè­‰æµç¨‹ï¼Œç”¨æ–¼åœ¨æ²’æœ‰çœŸå¯¦ OAuth credentials çš„æƒ…æ³ä¸‹æ¸¬è©¦ç³»çµ±åŠŸèƒ½ã€‚</p>
    
    <!-- åŸºæœ¬èªè­‰æ¸¬è©¦ -->
    <div class="test-section">
        <h2>1. åŸºæœ¬èªè­‰æ¸¬è©¦</h2>
        <p>é¦–å…ˆå»ºç«‹ä¸€å€‹æ¸¬è©¦å¸³æˆ¶ï¼š</p>
        <div>
            <button class="test-button" onclick="createTestUser()">å»ºç«‹æ¸¬è©¦å¸³æˆ¶</button>
            <button class="test-button" onclick="loginTestUser()">ç™»å…¥æ¸¬è©¦å¸³æˆ¶</button>
        </div>
        <div id="auth-result" class="result info">æº–å‚™é€²è¡ŒåŸºæœ¬èªè­‰æ¸¬è©¦</div>
    </div>

    <!-- OAuth æ¨¡æ“¬ -->
    <div class="test-section">
        <h2>2. OAuth æ¨¡æ“¬æ¸¬è©¦</h2>
        <p>æ¨¡æ“¬ Google å’Œ LINE OAuth èªè­‰éç¨‹ï¼š</p>
        
        <div class="oauth-simulation">
            <h3>Google OAuth æ¨¡æ“¬</h3>
            <input type="text" class="simulation-input" id="google-id" placeholder="è¼¸å…¥æ¨¡æ“¬çš„ Google ID (ä¾‹å¦‚: 123456789)" value="google_test_12345">
            <input type="text" class="simulation-input" id="google-email" placeholder="è¼¸å…¥æ¨¡æ“¬çš„ Google Email" value="test@gmail.com">
            <input type="text" class="simulation-input" id="google-name" placeholder="è¼¸å…¥æ¨¡æ“¬çš„é¡¯ç¤ºåç¨±" value="Google Test User">
            <button class="test-button" onclick="simulateGoogleOAuth()">æ¨¡æ“¬ Google OAuth</button>
        </div>
        
        <div class="oauth-simulation">
            <h3>LINE OAuth æ¨¡æ“¬</h3>
            <input type="text" class="simulation-input" id="line-id" placeholder="è¼¸å…¥æ¨¡æ“¬çš„ LINE ID (ä¾‹å¦‚: U123456789)" value="line_test_67890">
            <input type="text" class="simulation-input" id="line-email" placeholder="è¼¸å…¥æ¨¡æ“¬çš„ LINE Email (å¯é¸)" value="test@line.com">
            <input type="text" class="simulation-input" id="line-name" placeholder="è¼¸å…¥æ¨¡æ“¬çš„é¡¯ç¤ºåç¨±" value="LINE Test User">
            <button class="test-button" onclick="simulateLINEOAuth()">æ¨¡æ“¬ LINE OAuth</button>
        </div>
        
        <div id="oauth-simulation-result" class="result info">æº–å‚™é€²è¡Œ OAuth æ¨¡æ“¬æ¸¬è©¦</div>
    </div>

    <!-- OAuth ç‹€æ…‹æª¢æŸ¥ -->
    <div class="test-section">
        <h2>3. OAuth ç‹€æ…‹æª¢æŸ¥</h2>
        <div>
            <button class="test-button" onclick="checkOAuthStatus()" id="oauth-status-btn" disabled>æª¢æŸ¥ OAuth ç‹€æ…‹</button>
            <button class="test-button" onclick="unlinkOAuth('google')" id="unlink-google-btn" disabled>å–æ¶ˆé€£çµ Google</button>
            <button class="test-button" onclick="unlinkOAuth('line')" id="unlink-line-btn" disabled>å–æ¶ˆé€£çµ LINE</button>
        </div>
        <div id="oauth-status-result" class="result info">è«‹å…ˆç™»å…¥ä»¥æª¢æŸ¥ OAuth ç‹€æ…‹</div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentToken = null;
        const API_BASE = window.location.origin;

        // æ›´æ–°çµæœé¡¯ç¤º
        function updateResult(elementId, text, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = new Date().toLocaleTimeString() + ' - ' + text;
            element.className = `result ${type}`;
        }

        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        function updateButtonStates() {
            const hasToken = !!currentToken;
            document.getElementById('oauth-status-btn').disabled = !hasToken;
            document.getElementById('unlink-google-btn').disabled = !hasToken;
            document.getElementById('unlink-line-btn').disabled = !hasToken;
        }

        // é€šç”¨ API è«‹æ±‚å‡½æ•¸
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            };

            if (currentToken && !options.skipAuth) {
                config.headers['Authorization'] = `Bearer ${currentToken}`;
            }

            try {
                const response = await fetch(url, config);
                const data = await response.json();
                
                return {
                    ok: response.ok,
                    status: response.status,
                    data
                };
            } catch (error) {
                return {
                    ok: false,
                    status: 0,
                    data: { message: error.message }
                };
            }
        }

        // å»ºç«‹æ¸¬è©¦å¸³æˆ¶
        async function createTestUser() {
            updateResult('auth-result', 'æ­£åœ¨å»ºç«‹æ¸¬è©¦å¸³æˆ¶...', 'info');

            const result = await apiRequest('/auth/register', {
                method: 'POST',
                body: JSON.stringify({
                    email: 'oauth.test@example.com',
                    password: 'testpassword123',
                    username: 'oauthtest',
                    firstName: 'OAuth',
                    lastName: 'Test'
                })
            });

            if (result.ok) {
                currentToken = result.data.data.token;
                updateButtonStates();
                updateResult('auth-result', `æ¸¬è©¦å¸³æˆ¶å»ºç«‹æˆåŠŸï¼\nä½¿ç”¨è€… ID: ${result.data.data.user.id}\nToken: ${currentToken.substring(0, 50)}...`, 'success');
            } else {
                updateResult('auth-result', `å»ºç«‹æ¸¬è©¦å¸³æˆ¶å¤±æ•—: ${result.data.message}`, 'error');
            }
        }

        // ç™»å…¥æ¸¬è©¦å¸³æˆ¶
        async function loginTestUser() {
            updateResult('auth-result', 'æ­£åœ¨ç™»å…¥æ¸¬è©¦å¸³æˆ¶...', 'info');

            const result = await apiRequest('/auth/login', {
                method: 'POST',
                body: JSON.stringify({
                    email: 'oauth.test@example.com',
                    password: 'testpassword123'
                })
            });

            if (result.ok) {
                currentToken = result.data.data.token;
                updateButtonStates();
                updateResult('auth-result', `ç™»å…¥æˆåŠŸï¼\nä½¿ç”¨è€… ID: ${result.data.data.user.id}\nToken: ${currentToken.substring(0, 50)}...`, 'success');
            } else {
                updateResult('auth-result', `ç™»å…¥å¤±æ•—: ${result.data.message}`, 'error');
            }
        }

        // æ¨¡æ“¬ Google OAuth
        async function simulateGoogleOAuth() {
            if (!currentToken) {
                updateResult('oauth-simulation-result', 'è«‹å…ˆç™»å…¥æ¸¬è©¦å¸³æˆ¶', 'error');
                return;
            }

            const googleId = document.getElementById('google-id').value;
            const googleEmail = document.getElementById('google-email').value;
            const googleName = document.getElementById('google-name').value;

            updateResult('oauth-simulation-result', 'æ­£åœ¨æ¨¡æ“¬ Google OAuth é€£çµ...', 'info');

            // æ¨¡æ“¬æ›´æ–°ä½¿ç”¨è€…çš„ Google ID
            const user = {
                googleId: googleId,
                profile: {
                    email: googleEmail,
                    displayName: googleName
                }
            };

            // é€™è£¡æˆ‘å€‘ç›´æ¥æª¢æŸ¥ OAuth ç‹€æ…‹ä¾†é©—è­‰åŠŸèƒ½
            const statusResult = await checkOAuthStatus();
            if (statusResult) {
                updateResult('oauth-simulation-result', 
                    `Google OAuth æ¨¡æ“¬å®Œæˆï¼\n` +
                    `æ¨¡æ“¬çš„ Google ID: ${googleId}\n` +
                    `æ¨¡æ“¬çš„ Email: ${googleEmail}\n` +
                    `æ¨¡æ“¬çš„åç¨±: ${googleName}\n` +
                    `æ³¨æ„: é€™æ˜¯æ¨¡æ“¬æ¸¬è©¦ï¼Œå¯¦éš›éœ€è¦çœŸå¯¦çš„ Google OAuth credentials`, 'info');
            }
        }

        // æ¨¡æ“¬ LINE OAuth
        async function simulateLINEOAuth() {
            if (!currentToken) {
                updateResult('oauth-simulation-result', 'è«‹å…ˆç™»å…¥æ¸¬è©¦å¸³æˆ¶', 'error');
                return;
            }

            const lineId = document.getElementById('line-id').value;
            const lineEmail = document.getElementById('line-email').value;
            const lineName = document.getElementById('line-name').value;

            updateResult('oauth-simulation-result', 'æ­£åœ¨æ¨¡æ“¬ LINE OAuth é€£çµ...', 'info');

            // æª¢æŸ¥ OAuth ç‹€æ…‹
            const statusResult = await checkOAuthStatus();
            if (statusResult) {
                updateResult('oauth-simulation-result', 
                    `LINE OAuth æ¨¡æ“¬å®Œæˆï¼\n` +
                    `æ¨¡æ“¬çš„ LINE ID: ${lineId}\n` +
                    `æ¨¡æ“¬çš„ Email: ${lineEmail}\n` +
                    `æ¨¡æ“¬çš„åç¨±: ${lineName}\n` +
                    `æ³¨æ„: é€™æ˜¯æ¨¡æ“¬æ¸¬è©¦ï¼Œå¯¦éš›éœ€è¦çœŸå¯¦çš„ LINE OAuth credentials`, 'info');
            }
        }

        // æª¢æŸ¥ OAuth ç‹€æ…‹
        async function checkOAuthStatus() {
            if (!currentToken) {
                updateResult('oauth-status-result', 'è«‹å…ˆç™»å…¥ä»¥æª¢æŸ¥ OAuth ç‹€æ…‹', 'error');
                return false;
            }

            updateResult('oauth-status-result', 'æ­£åœ¨æª¢æŸ¥ OAuth ç‹€æ…‹...', 'info');

            const result = await apiRequest('/auth/oauth/status', {
                method: 'GET'
            });

            if (result.ok) {
                const oauth = result.data.data.oauth;
                updateResult('oauth-status-result', 
                    `OAuth ç‹€æ…‹æª¢æŸ¥æˆåŠŸï¼\n` +
                    `Google: ${oauth.google.linked ? 'å·²é€£çµ' : 'æœªé€£çµ'} (ID: ${oauth.google.id || 'null'})\n` +
                    `LINE: ${oauth.line.linked ? 'å·²é€£çµ' : 'æœªé€£çµ'} (ID: ${oauth.line.id || 'null'})\n` +
                    `\nå®Œæ•´å›æ‡‰:\n${JSON.stringify(oauth, null, 2)}`, 'success');
                return true;
            } else {
                updateResult('oauth-status-result', `OAuth ç‹€æ…‹æª¢æŸ¥å¤±æ•—: ${result.data.message}`, 'error');
                return false;
            }
        }

        // å–æ¶ˆé€£çµ OAuth å¸³æˆ¶
        async function unlinkOAuth(provider) {
            if (!currentToken) {
                updateResult('oauth-status-result', 'è«‹å…ˆç™»å…¥ä»¥é€²è¡Œ OAuth æ“ä½œ', 'error');
                return;
            }

            updateResult('oauth-status-result', `æ­£åœ¨å–æ¶ˆé€£çµ ${provider.toUpperCase()} å¸³æˆ¶...`, 'info');

            const result = await apiRequest(`/auth/link/${provider}`, {
                method: 'DELETE'
            });

            if (result.ok) {
                updateResult('oauth-status-result', `${provider.toUpperCase()} å¸³æˆ¶å–æ¶ˆé€£çµæˆåŠŸï¼`, 'success');
                // é‡æ–°æª¢æŸ¥ç‹€æ…‹
                setTimeout(checkOAuthStatus, 1000);
            } else {
                updateResult('oauth-status-result', `å–æ¶ˆé€£çµå¤±æ•—: ${result.data.message}`, 'error');
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            updateButtonStates();
            updateResult('auth-result', 'æº–å‚™é€²è¡ŒåŸºæœ¬èªè­‰æ¸¬è©¦');
            updateResult('oauth-simulation-result', 'æº–å‚™é€²è¡Œ OAuth æ¨¡æ“¬æ¸¬è©¦');
            updateResult('oauth-status-result', 'è«‹å…ˆç™»å…¥ä»¥æª¢æŸ¥ OAuth ç‹€æ…‹');
        });
    </script>
</body>
</html>