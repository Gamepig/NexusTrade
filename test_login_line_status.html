<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>登入後 LINE 狀態測試</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    .success { background-color: #d4edda; border-color: #c3e6cb; }
    .error { background-color: #f8d7da; border-color: #f5c6cb; }
    button { padding: 10px 15px; margin: 5px; cursor: pointer; }
    .status { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; }
    pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>🧪 登入後 LINE 狀態更新測試</h1>
  
  <div class="test-section">
    <h2>步驟 1: 模擬登入</h2>
    <button onclick="simulateLogin()">模擬使用者登入</button>
    <div id="login-status" class="status"></div>
  </div>
  
  <div class="test-section">
    <h2>步驟 2: 檢查 LINE 綁定狀態</h2>
    <button onclick="checkLineStatus()">檢查 LINE 狀態</button>
    <div id="line-status" class="status"></div>
    <pre id="line-status-detail"></pre>
  </div>
  
  <div class="test-section">
    <h2>步驟 3: 測試 PriceAlertModal</h2>
    <button onclick="testPriceAlertModal()">測試價格警報模態框</button>
    <div id="modal-status" class="status"></div>
  </div>
  
  <div class="test-section">
    <h2>完整測試結果</h2>
    <div id="final-result" class="status"></div>
  </div>

  <script>
    // 測試用的 JWT token
    const TEST_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2NzZlZDZhNzE5MWFjMTBlMzEwOWQzMTMiLCJpYXQiOjE3NTExNDMzNDEsImV4cCI6MTc1MTc0ODE0MX0.cgRgbJ8DMqUK9I8KU6Qf-TZMhwJk5KSgAFLHE9cNzPY';
    
    // 測試使用者資料
    const TEST_USER = {
      _id: '676ed6a7191ac10e3109d313',
      email: 'test@nexustrade.com',
      profile: {
        displayName: 'Test User'
      },
      lineId: 'U1234567890abcdef1234567890abcdef'
    };

    function simulateLogin() {
      document.getElementById('login-status').innerHTML = '正在模擬登入...';
      
      // 模擬保存登入資料到 localStorage
      localStorage.setItem('nexustrade_token', TEST_TOKEN);
      localStorage.setItem('nexustrade_user', JSON.stringify(TEST_USER));
      
      // 模擬設定全域狀態
      window.currentUser = TEST_USER;
      
      document.getElementById('login-status').innerHTML = 
        '<span style="color: green;">✅ 登入模擬成功</span><br>' +
        `使用者: ${TEST_USER.profile.displayName}<br>` +
        `LINE ID: ${TEST_USER.lineId.substring(0, 8)}...`;
    }

    async function checkLineStatus() {
      document.getElementById('line-status').innerHTML = '正在檢查 LINE 綁定狀態...';
      
      try {
        const response = await fetch('/api/line/bind/status', {
          headers: {
            'Authorization': `Bearer ${TEST_TOKEN}`,
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (response.ok) {
          const isConnected = data.data.isBound;
          document.getElementById('line-status').innerHTML = 
            `<span style="color: ${isConnected ? 'green' : 'red'};">
              ${isConnected ? '✅ LINE 已連結' : '❌ LINE 未連結'}
            </span>`;
          
          document.getElementById('line-status-detail').textContent = 
            JSON.stringify(data, null, 2);
        } else {
          throw new Error(data.message || '檢查失敗');
        }
      } catch (error) {
        document.getElementById('line-status').innerHTML = 
          `<span style="color: red;">❌ 檢查失敗: ${error.message}</span>`;
      }
    }

    function testPriceAlertModal() {
      document.getElementById('modal-status').innerHTML = '正在測試 PriceAlertModal...';
      
      try {
        // 模擬 PriceAlertModal 的 LINE 狀態檢查邏輯
        const checkLineConnectionStatus = async () => {
          const token = localStorage.getItem('nexustrade_token');
          
          if (!token) {
            return false;
          }
          
          const currentUser = JSON.parse(localStorage.getItem('nexustrade_user') || '{}');
          if (!currentUser || !currentUser._id) {
            return false;
          }
          
          const response = await fetch('/api/line/bind/status', {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            return data.data?.isBound || false;
          }
          
          return false;
        };
        
        checkLineConnectionStatus().then(isConnected => {
          document.getElementById('modal-status').innerHTML = 
            `<span style="color: ${isConnected ? 'green' : 'red'};">
              ${isConnected ? '✅ PriceAlertModal 會顯示「LINE 已連結」' : '❌ PriceAlertModal 會顯示「需要連結 LINE」'}
            </span>`;
          
          // 最終結果
          updateFinalResult(isConnected);
        });
        
      } catch (error) {
        document.getElementById('modal-status').innerHTML = 
          `<span style="color: red;">❌ 測試失敗: ${error.message}</span>`;
      }
    }

    function updateFinalResult(lineConnected) {
      const result = lineConnected ? 
        '🎉 測試完全成功！登入後 LINE 狀態正確更新' : 
        '❌ 測試失敗：登入後 LINE 狀態未正確更新';
      
      const className = lineConnected ? 'success' : 'error';
      
      document.getElementById('final-result').innerHTML = 
        `<span style="font-weight: bold;">${result}</span>`;
      document.getElementById('final-result').className = `status ${className}`;
    }

    // 頁面載入時自動執行完整測試
    window.addEventListener('load', async () => {
      console.log('🧪 自動執行完整測試流程');
      
      // 等待 1 秒
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // 步驟 1: 模擬登入
      simulateLogin();
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // 步驟 2: 檢查 LINE 狀態
      await checkLineStatus();
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // 步驟 3: 測試 PriceAlertModal
      testPriceAlertModal();
    });
  </script>
</body>
</html>