<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç™»å…¥å¾Œ LINE ç‹€æ…‹æ¸¬è©¦</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    .success { background-color: #d4edda; border-color: #c3e6cb; }
    .error { background-color: #f8d7da; border-color: #f5c6cb; }
    button { padding: 10px 15px; margin: 5px; cursor: pointer; }
    .status { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; }
    pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>ğŸ§ª ç™»å…¥å¾Œ LINE ç‹€æ…‹æ›´æ–°æ¸¬è©¦</h1>
  
  <div class="test-section">
    <h2>æ­¥é©Ÿ 1: æ¨¡æ“¬ç™»å…¥</h2>
    <button onclick="simulateLogin()">æ¨¡æ“¬ä½¿ç”¨è€…ç™»å…¥</button>
    <div id="login-status" class="status"></div>
  </div>
  
  <div class="test-section">
    <h2>æ­¥é©Ÿ 2: æª¢æŸ¥ LINE ç¶å®šç‹€æ…‹</h2>
    <button onclick="checkLineStatus()">æª¢æŸ¥ LINE ç‹€æ…‹</button>
    <div id="line-status" class="status"></div>
    <pre id="line-status-detail"></pre>
  </div>
  
  <div class="test-section">
    <h2>æ­¥é©Ÿ 3: æ¸¬è©¦ PriceAlertModal</h2>
    <button onclick="testPriceAlertModal()">æ¸¬è©¦åƒ¹æ ¼è­¦å ±æ¨¡æ…‹æ¡†</button>
    <div id="modal-status" class="status"></div>
  </div>
  
  <div class="test-section">
    <h2>å®Œæ•´æ¸¬è©¦çµæœ</h2>
    <div id="final-result" class="status"></div>
  </div>

  <script>
    // æ¸¬è©¦ç”¨çš„ JWT token
    const TEST_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2NzZlZDZhNzE5MWFjMTBlMzEwOWQzMTMiLCJpYXQiOjE3NTExNDMzNDEsImV4cCI6MTc1MTc0ODE0MX0.cgRgbJ8DMqUK9I8KU6Qf-TZMhwJk5KSgAFLHE9cNzPY';
    
    // æ¸¬è©¦ä½¿ç”¨è€…è³‡æ–™
    const TEST_USER = {
      _id: '676ed6a7191ac10e3109d313',
      email: 'test@nexustrade.com',
      profile: {
        displayName: 'Test User'
      },
      lineId: 'U1234567890abcdef1234567890abcdef'
    };

    function simulateLogin() {
      document.getElementById('login-status').innerHTML = 'æ­£åœ¨æ¨¡æ“¬ç™»å…¥...';
      
      // æ¨¡æ“¬ä¿å­˜ç™»å…¥è³‡æ–™åˆ° localStorage
      localStorage.setItem('nexustrade_token', TEST_TOKEN);
      localStorage.setItem('nexustrade_user', JSON.stringify(TEST_USER));
      
      // æ¨¡æ“¬è¨­å®šå…¨åŸŸç‹€æ…‹
      window.currentUser = TEST_USER;
      
      document.getElementById('login-status').innerHTML = 
        '<span style="color: green;">âœ… ç™»å…¥æ¨¡æ“¬æˆåŠŸ</span><br>' +
        `ä½¿ç”¨è€…: ${TEST_USER.profile.displayName}<br>` +
        `LINE ID: ${TEST_USER.lineId.substring(0, 8)}...`;
    }

    async function checkLineStatus() {
      document.getElementById('line-status').innerHTML = 'æ­£åœ¨æª¢æŸ¥ LINE ç¶å®šç‹€æ…‹...';
      
      try {
        const response = await fetch('/api/line/bind/status', {
          headers: {
            'Authorization': `Bearer ${TEST_TOKEN}`,
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (response.ok) {
          const isConnected = data.data.isBound;
          document.getElementById('line-status').innerHTML = 
            `<span style="color: ${isConnected ? 'green' : 'red'};">
              ${isConnected ? 'âœ… LINE å·²é€£çµ' : 'âŒ LINE æœªé€£çµ'}
            </span>`;
          
          document.getElementById('line-status-detail').textContent = 
            JSON.stringify(data, null, 2);
        } else {
          throw new Error(data.message || 'æª¢æŸ¥å¤±æ•—');
        }
      } catch (error) {
        document.getElementById('line-status').innerHTML = 
          `<span style="color: red;">âŒ æª¢æŸ¥å¤±æ•—: ${error.message}</span>`;
      }
    }

    function testPriceAlertModal() {
      document.getElementById('modal-status').innerHTML = 'æ­£åœ¨æ¸¬è©¦ PriceAlertModal...';
      
      try {
        // æ¨¡æ“¬ PriceAlertModal çš„ LINE ç‹€æ…‹æª¢æŸ¥é‚è¼¯
        const checkLineConnectionStatus = async () => {
          const token = localStorage.getItem('nexustrade_token');
          
          if (!token) {
            return false;
          }
          
          const currentUser = JSON.parse(localStorage.getItem('nexustrade_user') || '{}');
          if (!currentUser || !currentUser._id) {
            return false;
          }
          
          const response = await fetch('/api/line/bind/status', {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            return data.data?.isBound || false;
          }
          
          return false;
        };
        
        checkLineConnectionStatus().then(isConnected => {
          document.getElementById('modal-status').innerHTML = 
            `<span style="color: ${isConnected ? 'green' : 'red'};">
              ${isConnected ? 'âœ… PriceAlertModal æœƒé¡¯ç¤ºã€ŒLINE å·²é€£çµã€' : 'âŒ PriceAlertModal æœƒé¡¯ç¤ºã€Œéœ€è¦é€£çµ LINEã€'}
            </span>`;
          
          // æœ€çµ‚çµæœ
          updateFinalResult(isConnected);
        });
        
      } catch (error) {
        document.getElementById('modal-status').innerHTML = 
          `<span style="color: red;">âŒ æ¸¬è©¦å¤±æ•—: ${error.message}</span>`;
      }
    }

    function updateFinalResult(lineConnected) {
      const result = lineConnected ? 
        'ğŸ‰ æ¸¬è©¦å®Œå…¨æˆåŠŸï¼ç™»å…¥å¾Œ LINE ç‹€æ…‹æ­£ç¢ºæ›´æ–°' : 
        'âŒ æ¸¬è©¦å¤±æ•—ï¼šç™»å…¥å¾Œ LINE ç‹€æ…‹æœªæ­£ç¢ºæ›´æ–°';
      
      const className = lineConnected ? 'success' : 'error';
      
      document.getElementById('final-result').innerHTML = 
        `<span style="font-weight: bold;">${result}</span>`;
      document.getElementById('final-result').className = `status ${className}`;
    }

    // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œå®Œæ•´æ¸¬è©¦
    window.addEventListener('load', async () => {
      console.log('ğŸ§ª è‡ªå‹•åŸ·è¡Œå®Œæ•´æ¸¬è©¦æµç¨‹');
      
      // ç­‰å¾… 1 ç§’
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // æ­¥é©Ÿ 1: æ¨¡æ“¬ç™»å…¥
      simulateLogin();
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // æ­¥é©Ÿ 2: æª¢æŸ¥ LINE ç‹€æ…‹
      await checkLineStatus();
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // æ­¥é©Ÿ 3: æ¸¬è©¦ PriceAlertModal
      testPriceAlertModal();
    });
  </script>
</body>
</html>