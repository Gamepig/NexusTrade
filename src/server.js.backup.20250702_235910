/**
 * NexusTrade ä¸»è¦ä¼ºæœå™¨å…¥å£æª”æ¡ˆ
 * 
 * æ­¤æª”æ¡ˆè² è²¬ï¼š
 * - åˆå§‹åŒ– Express æ‡‰ç”¨ç¨‹å¼
 * - è¨­å®šåŸºæœ¬ä¸­ä»‹è»Ÿé«”
 * - å»ºç«‹è·¯ç”±ç³»çµ±
 * - å•Ÿå‹•ä¼ºæœå™¨
 */

// ç’°å¢ƒè®Šæ•¸è¼‰å…¥
require('dotenv').config();

const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const path = require('path');
const morgan = require('morgan');
const compression = require('compression');
const rateLimit = require('express-rate-limit');

// è‡ªè¨‚æ¨¡çµ„
const logger = require('./utils/logger');
const { connectDB } = require('./config/database');
const { errorHandler } = require('./middleware/errorHandler');
const { notFoundHandler } = require('./middleware/notFoundHandler');
const { getWebSocketService } = require('./services/websocket.service');

// è·¯ç”±æ¨¡çµ„
const healthRouter = require('./routes/health');
const authRouter = require('./routes/auth');
const apiRouter = require('./routes/api');
const marketRouter = require('./routes/market');
const watchlistRouter = require('./routes/watchlist');
const lineRouter = require('./routes/line');
const lineMessagingRouter = require('./routes/line-messaging');
const lineUserRouter = require('./routes/line-user');

// å»ºç«‹ Express æ‡‰ç”¨ç¨‹å¼
const app = express();

// åŸºæœ¬è¨­å®š
const PORT = process.env.PORT || 3000;
const NODE_ENV = process.env.NODE_ENV || 'development';

/**
 * å®‰å…¨æ€§ä¸­ä»‹è»Ÿé«”è¨­å®š
 */
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'", "https://fonts.googleapis.com"],
      fontSrc: ["'self'", "https://fonts.gstatic.com"],
      scriptSrc: ["'self'", "'unsafe-inline'", "'unsafe-hashes'", "https://unpkg.com", "https://cdn.jsdelivr.net", "https://s3.tradingview.com", "https://www.tradingview.com"],
      imgSrc: ["'self'", "data:", "https:"],
      connectSrc: ["'self'", "wss:", "https:"],
      frameSrc: ["'self'", "https://www.tradingview.com", "https://www.tradingview-widget.com", "https://s.tradingview.com"],
      scriptSrcAttr: ["'self'", "'unsafe-inline'"],
    },
  },
  crossOriginEmbedderPolicy: false
}));

/**
 * CORS è¨­å®š
 */
const corsOptions = {
  origin: process.env.CORS_ORIGIN?.split(',') || ['http://localhost:3000'],
  credentials: true,
  optionsSuccessStatus: 200,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With']
};
app.use(cors(corsOptions));

/**
 * é€Ÿç‡é™åˆ¶è¨­å®š
 */
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†é˜
  max: 200, // âœ… å¢åŠ åˆ°æ¯å€‹IPæœ€å¤š200æ¬¡è«‹æ±‚
  message: {
    error: 'Too many requests from this IP, please try again later.',
    retryAfter: 15 * 60 // ç§’
  },
  standardHeaders: true,
  legacyHeaders: false,
  // âŒ ç§»é™¤éæ™‚çš„ onLimitReached é…ç½® (express-rate-limit v7 å·²ç§»é™¤)
  handler: (req, res) => {
    logger.warn(`Rate limit exceeded for IP: ${req.ip}, User-Agent: ${req.get('User-Agent')}`);
    res.status(429).json({
      error: 'Too many requests from this IP, please try again later.',
      retryAfter: 15 * 60
    });
  }
});
app.use('/api/', limiter);

/**
 * åŸºæœ¬ä¸­ä»‹è»Ÿé«”è¨­å®š
 */
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// å£“ç¸®å›æ‡‰
app.use(compression());

// éœæ…‹æª”æ¡ˆæœå‹™
app.use(express.static(path.join(__dirname, '../public')));

// æ¸¬è©¦æª”æ¡ˆæœå‹™ (åƒ…é–‹ç™¼ç’°å¢ƒ)
if (NODE_ENV === 'development') {
  app.use('/tests', express.static(path.join(__dirname, '../tests')));
}

// Session é…ç½® (OAuth èªè­‰éœ€è¦)
const session = require('express-session');

app.use(session({
  secret: process.env.SESSION_SECRET || 'nexustrade_session_secret',
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: NODE_ENV === 'production', // åƒ…åœ¨ HTTPS ç’°å¢ƒä¸‹å•Ÿç”¨
    httpOnly: true,
    maxAge: 24 * 60 * 60 * 1000 // 24å°æ™‚
  }
}));

// OAuth èªè­‰ - ä½¿ç”¨çµ±ä¸€çš„ REST API å¯¦ä½œ

// è«‹æ±‚æ—¥èªŒ (åƒ…åœ¨é–‹ç™¼ç’°å¢ƒ)
if (NODE_ENV === 'development') {
  app.use(morgan('combined', { stream: { write: message => logger.info(message.trim()) } }));
}

/**
 * è·¯ç”±è¨­å®š
 */
app.use('/health', healthRouter);
app.use('/api/auth', authRouter);
app.use('/api', apiRouter);
app.use('/api/market', marketRouter);
app.use('/api/watchlist', watchlistRouter);
app.use('/api/line', lineRouter);
app.use('/api/line-messaging', lineMessagingRouter);
app.use('/api/line-user', lineUserRouter);

// OAuth ç›¸å®¹æ€§è·¯ç”± - ç›´æ¥é‡å®šå‘åˆ° /api/auth
app.get('/auth/google', (req, res) => {
  logger.info('é‡å®šå‘ /auth/google åˆ° /api/auth/google');
  res.redirect('/api/auth/google');
});

app.get('/auth/google/callback', (req, res) => {
  logger.info('é‡å®šå‘ /auth/google/callback åˆ° /api/auth/google/callback');
  const queryString = req.url.substring(req.url.indexOf('?'));
  res.redirect('/api/auth/google/callback' + queryString);
});

app.get('/auth/line', (req, res) => {
  logger.info('é‡å®šå‘ /auth/line åˆ° /api/auth/line');
  res.redirect('/api/auth/line');
});

app.get('/auth/line/callback', (req, res) => {
  logger.info('é‡å®šå‘ /auth/line/callback åˆ° /api/auth/line/callback');
  const queryString = req.url.substring(req.url.indexOf('?'));
  res.redirect('/api/auth/line/callback' + queryString);
});

// æ ¹è·¯ç”± - æä¾›å‰ç«¯é¦–é 
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, '../public/index.html'));
});

/**
 * éŒ¯èª¤è™•ç†ä¸­ä»‹è»Ÿé«”
 */
app.use(notFoundHandler);
app.use(errorHandler);

// SPA æ”¯æ´ - æ‰€æœ‰å…¶ä»–è·¯ç”±éƒ½è¿”å› index.html (å¿…é ˆæ”¾åœ¨æœ€å¾Œ)
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, '../public/index.html'));
});

/**
 * ä¼ºæœå™¨å•Ÿå‹•å‡½æ•¸
 */
const startServer = async () => {
  try {
    // é€£æ¥è³‡æ–™åº«
    const dbConnection = await connectDB();
    if (dbConnection) {
      logger.info('è³‡æ–™åº«é€£æ¥æˆåŠŸ');
    } else {
      logger.info('ä½¿ç”¨ Mock æ¨¡å¼é‹è¡Œ (è·³éè³‡æ–™åº«é€£æ¥)');
    }

    // å•Ÿå‹•ä¼ºæœå™¨
    const server = app.listen(PORT, () => {
      logger.info(`NexusTrade ä¼ºæœå™¨é‹è¡Œåœ¨ ${NODE_ENV} æ¨¡å¼`);
      logger.info(`ä¼ºæœå™¨åœ°å€: http://localhost:${PORT}`);
      logger.info(`å¥åº·æª¢æŸ¥: http://localhost:${PORT}/health`);
      logger.info(`WebSocket ç«¯é»: ws://localhost:${PORT}/ws`);
    });

    // åˆå§‹åŒ– WebSocket æœå‹™
    const wsService = getWebSocketService();
    wsService.initialize(server);

    // å•Ÿå‹•åƒ¹æ ¼è­¦å ±ç›£æ§æœå‹™ (åƒ…åœ¨éæ¸¬è©¦ç’°å¢ƒ)
    if (NODE_ENV !== 'test') {
      const { getPriceAlertMonitorService } = require('./services/price-alert-monitor.service');
      const priceAlertMonitor = getPriceAlertMonitorService();
      priceAlertMonitor.start();
      logger.info('ğŸ”” åƒ¹æ ¼è­¦å ±ç›£æ§æœå‹™å·²å•Ÿå‹•');

      // å•Ÿå‹•æ¯æ—¥ AI åˆ†ææ’ç¨‹å™¨
      const { getDailyAISchedulerService } = require('./services/daily-ai-scheduler.service');
      const dailyAIScheduler = getDailyAISchedulerService();
      dailyAIScheduler.start();
      logger.info('ğŸ¤– æ¯æ—¥ AI åˆ†ææ’ç¨‹å™¨å·²å•Ÿå‹•');
    }

    // å„ªé›…é—œé–‰è™•ç†
    const gracefulShutdown = async (signal) => {
      logger.info(`æ”¶åˆ° ${signal} ä¿¡è™Ÿï¼Œé–‹å§‹å„ªé›…é—œé–‰ä¼ºæœå™¨...`);
      
      server.close(async () => {
        logger.info('HTTP ä¼ºæœå™¨å·²é—œé–‰');
        
        // é—œé–‰è³‡æ–™åº«é€£æ¥
        try {
          await require('mongoose').connection.close();
          logger.info('è³‡æ–™åº«é€£æ¥å·²é—œé–‰');
          process.exit(0);
        } catch (error) {
          logger.error('é—œé–‰è³‡æ–™åº«é€£æ¥å¤±æ•—:', error.message);
          process.exit(1);
        }
      });

      // å¼·åˆ¶é—œé–‰è¶…æ™‚
      setTimeout(() => {
        logger.error('å¼·åˆ¶é—œé–‰ä¼ºæœå™¨');
        process.exit(1);
      }, 10000);
    };

    // è¨»å†Šä¿¡è™Ÿè™•ç†å™¨
    process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
    process.on('SIGINT', () => gracefulShutdown('SIGINT'));

    // æœªæ•ç²çš„ç•°å¸¸è™•ç†
    process.on('uncaughtException', (error) => {
      logger.error('æœªæ•ç²çš„ç•°å¸¸:', error);
      process.exit(1);
    });

    process.on('unhandledRejection', (reason, promise) => {
      logger.error('æœªè™•ç†çš„ Promise æ‹’çµ•:', reason);
      logger.error('Promise:', promise);
    });

    return server;

  } catch (error) {
    logger.error('ä¼ºæœå™¨å•Ÿå‹•å¤±æ•—:', error);
    process.exit(1);
  }
};

// å•Ÿå‹•ä¼ºæœå™¨
if (require.main === module) {
  startServer();
}

module.exports = { app, startServer };