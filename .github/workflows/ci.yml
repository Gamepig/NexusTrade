# NexusTrade æŒçºŒæ•´åˆ (CI) å·¥ä½œæµç¨‹
# ç°¡åŒ–ç‰ˆæœ¬ï¼Œå°ˆæ³¨æ–¼æ ¸å¿ƒåŠŸèƒ½é©—è­‰

name: Continuous Integration

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

# ç’°å¢ƒè®Šæ•¸
env:
  NODE_VERSION: '20'

# å·¥ä½œæ¬Šé™
permissions:
  contents: read

jobs:
  # ========================
  # ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
  # ========================
  code-quality:
    name: ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸ—ï¸ è¨­å®š Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ å®‰è£ä¾è³´
        run: npm ci
        
      - name: ğŸ” ESLint ç¨‹å¼ç¢¼æª¢æŸ¥
        run: npm run lint
        continue-on-error: true
        
      - name: ğŸ¨ Prettier æ ¼å¼æª¢æŸ¥
        run: npx prettier --check "**/*.{js,json,md}" || echo "Format check failed but continuing"
        continue-on-error: true

  # ========================
  # åŸºæœ¬å»ºç½®æ¸¬è©¦
  # ========================
  build-test:
    name: å»ºç½®æ¸¬è©¦
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸ—ï¸ è¨­å®š Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ å®‰è£ä¾è³´
        run: npm ci
        
      - name: ğŸ§ª åŸºæœ¬åŠŸèƒ½æ¸¬è©¦
        run: |
          # æª¢æŸ¥ä¸»è¦æª”æ¡ˆæ˜¯å¦å­˜åœ¨
          test -f src/server.js || exit 1
          test -f public/index.html || exit 1
          echo "âœ… æ ¸å¿ƒæª”æ¡ˆæª¢æŸ¥é€šé"
          
      - name: ğŸ”§ æª¢æŸ¥ npm è…³æœ¬
        run: |
          npm run --silent health || echo "å¥åº·æª¢æŸ¥è…³æœ¬éœ€è¦é‹è¡Œæ™‚ç’°å¢ƒ"
          echo "âœ… è…³æœ¬æª¢æŸ¥å®Œæˆ"

  # ========================
  # Docker å»ºç½®æ¸¬è©¦
  # ========================
  docker-build:
    name: Docker å»ºç½®æ¸¬è©¦
    runs-on: ubuntu-latest
    needs: build-test
    
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸ—ï¸ è¨­å®š Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ”¨ å»ºç½® Docker æ˜ åƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: nexustrade:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ========================
  # å®‰å…¨æ€§åŸºæœ¬æª¢æŸ¥
  # ========================
  security-check:
    name: å®‰å…¨æ€§æª¢æŸ¥
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸ—ï¸ è¨­å®š Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ å®‰è£ä¾è³´
        run: npm ci
        
      - name: ğŸ”’ npm audit å®‰å…¨æƒæ
        run: npm audit --audit-level=high || echo "ç™¼ç¾å®‰å…¨å•é¡Œï¼Œä½†ä¸ä¸­æ–·å»ºç½®"
        continue-on-error: true

  # ========================
  # å»ºç½®çµæœå ±å‘Š
  # ========================
  build-report:
    name: å»ºç½®å ±å‘Š
    runs-on: ubuntu-latest
    needs: [code-quality, build-test, docker-build, security-check]
    if: always()
    
    steps:
      - name: ğŸ“Š ç”Ÿæˆå»ºç½®å ±å‘Š
        run: |
          echo "# ğŸš€ NexusTrade CI å»ºç½®å ±å‘Š"
          echo ""
          echo "**å»ºç½®æ™‚é–“:** $(date)"
          echo "**æäº¤:** ${{ github.sha }}"
          echo ""
          echo "## å»ºç½®ç‹€æ…‹"
          echo "- ç¨‹å¼ç¢¼å“è³ª: ${{ needs.code-quality.result }}"
          echo "- å»ºç½®æ¸¬è©¦: ${{ needs.build-test.result }}"
          echo "- Docker å»ºç½®: ${{ needs.docker-build.result }}"
          echo "- å®‰å…¨æª¢æŸ¥: ${{ needs.security-check.result }}"
          echo ""
          if [[ "${{ needs.code-quality.result }}" == "success" && "${{ needs.build-test.result }}" == "success" && "${{ needs.docker-build.result }}" == "success" ]]; then
            echo "âœ… æ‰€æœ‰æ ¸å¿ƒæª¢æŸ¥é€šé"
          else
            echo "âš ï¸ éƒ¨åˆ†æª¢æŸ¥æœªé€šéï¼Œè«‹æª¢æŸ¥è©³ç´°æ—¥èªŒ"
          fi