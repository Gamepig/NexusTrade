# NexusTrade æŒçºŒéƒ¨ç½² (CD) å·¥ä½œæµç¨‹
# ç°¡åŒ–ç‰ˆæœ¬ï¼Œå°ˆæ³¨æ–¼æ˜ åƒå»ºç½®å’ŒåŸºæœ¬éƒ¨ç½²é©—è­‰

name: Continuous Deployment

on:
  push:
    branches: [master, main]
    tags: ['v*']
  workflow_run:
    workflows: ["Continuous Integration"]
    types: [completed]
    branches: [master, main]

# ç’°å¢ƒè®Šæ•¸
env:
  NODE_VERSION: '20'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

# å·¥ä½œæ¬Šé™
permissions:
  contents: read
  packages: write

jobs:
  # ========================
  # å»ºç½®å’Œç™¼å¸ƒ Docker æ˜ åƒ
  # ========================
  build-and-publish:
    name: å»ºç½®å’Œç™¼å¸ƒ Docker æ˜ åƒ
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'push'
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸ—ï¸ è¨­å®š Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ” ç™»å…¥ Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ“ æå– metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            
      - name: ğŸ”¨ å»ºç½®ä¸¦æ¨é€ Docker æ˜ åƒ
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ========================
  # éƒ¨ç½²é©—è­‰
  # ========================
  deployment-validation:
    name: éƒ¨ç½²é©—è­‰
    runs-on: ubuntu-latest
    needs: build-and-publish
    if: github.ref == 'refs/heads/master'
    
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸ§ª Docker æ˜ åƒæ¸¬è©¦
        run: |
          echo "ğŸ§ª æ¸¬è©¦ Docker æ˜ åƒ..."
          # åœ¨é€™è£¡å¯ä»¥æ·»åŠ åŸºæœ¬çš„æ˜ åƒæ¸¬è©¦
          echo "æ˜ åƒæ¨™ç±¤: ${{ needs.build-and-publish.outputs.image-tag }}"
          echo "æ˜ åƒæ‘˜è¦: ${{ needs.build-and-publish.outputs.image-digest }}"
          echo "âœ… æ˜ åƒå»ºç½®é©—è­‰å®Œæˆ"
          
      - name: ğŸ“Š éƒ¨ç½²å°±ç·’æª¢æŸ¥
        run: |
          echo "ğŸ“Š æª¢æŸ¥éƒ¨ç½²å°±ç·’ç‹€æ…‹..."
          
          # æª¢æŸ¥å¿…è¦æª”æ¡ˆ
          test -f Dockerfile || { echo "âŒ Dockerfile ç¼ºå¤±"; exit 1; }
          test -f docker-compose.yml || { echo "âŒ docker-compose.yml ç¼ºå¤±"; exit 1; }
          test -f src/server.js || { echo "âŒ ä¸»æ‡‰ç”¨ç¨‹å¼ç¼ºå¤±"; exit 1; }
          
          echo "âœ… æ‰€æœ‰å¿…è¦æª”æ¡ˆå­˜åœ¨"
          echo "ğŸš€ éƒ¨ç½²å°±ç·’æª¢æŸ¥é€šé"

  # ========================
  # ç™¼å¸ƒå ±å‘Š
  # ========================
  release-report:
    name: ç™¼å¸ƒå ±å‘Š
    runs-on: ubuntu-latest
    needs: [build-and-publish, deployment-validation]
    if: always()
    
    steps:
      - name: ğŸ“Š ç”Ÿæˆç™¼å¸ƒå ±å‘Š
        run: |
          echo "# ğŸš€ NexusTrade ç™¼å¸ƒå ±å‘Š"
          echo ""
          echo "**ç™¼å¸ƒæ™‚é–“:** $(date)"
          echo "**ç‰ˆæœ¬:** ${{ github.ref_name }}"
          echo "**æäº¤:** ${{ github.sha }}"
          echo ""
          echo "## ç™¼å¸ƒç‹€æ…‹"
          echo "- æ˜ åƒå»ºç½®: ${{ needs.build-and-publish.result }}"
          echo "- éƒ¨ç½²é©—è­‰: ${{ needs.deployment-validation.result }}"
          echo ""
          
          if [[ "${{ needs.build-and-publish.result }}" == "success" ]]; then
            echo "âœ… Docker æ˜ åƒå·²æˆåŠŸå»ºç½®ä¸¦æ¨é€åˆ° registry"
            echo "ğŸ“¦ æ˜ åƒä½ç½®: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          else
            echo "âŒ æ˜ åƒå»ºç½®å¤±æ•—"
          fi
          
          echo ""
          echo "## ä½¿ç”¨æ–¹å¼"
          echo "```bash"
          echo "# æ‹‰å–æœ€æ–°æ˜ åƒ"
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "# ä½¿ç”¨ docker-compose éƒ¨ç½²"
          echo "docker-compose up -d"
          echo "```"