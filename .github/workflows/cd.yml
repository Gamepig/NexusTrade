# NexusTrade æŒçºŒéƒ¨ç½² (CD) å·¥ä½œæµç¨‹
# è‡ªå‹•åŒ–éƒ¨ç½²åˆ°ä¸åŒç’°å¢ƒ

name: Continuous Deployment

on:
  push:
    branches: [master, main]
    tags: ['v*']
  workflow_run:
    workflows: ["Continuous Integration"]
    types: [completed]
    branches: [master, main]

# ç’°å¢ƒè®Šæ•¸
env:
  NODE_VERSION: '20'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

# å·¥ä½œæ¬Šé™
permissions:
  contents: read
  packages: write
  deployments: write

jobs:
  # ========================
  # éƒ¨ç½²åˆ° Staging ç’°å¢ƒ
  # ========================
  deploy-staging:
    name: éƒ¨ç½²åˆ° Staging ç’°å¢ƒ
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' && github.ref == 'refs/heads/master'
    
    environment:
      name: staging
      url: https://staging.nexustrade.example.com
      
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸ” é…ç½® SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.STAGING_SSH_KEY }}
          
      - name: ğŸ“¦ éƒ¨ç½²åˆ° Staging ä¼ºæœå™¨
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'EOF'
            cd /opt/nexustrade
            
            # æ‹‰å–æœ€æ–°ç¨‹å¼ç¢¼
            git pull origin master
            
            # æ›´æ–°ç’°å¢ƒè®Šæ•¸
            cp .env.staging .env
            
            # é‡æ–°å»ºç½® Docker æ˜ åƒ
            docker-compose -f docker-compose.yml -f docker-compose.staging.yml build
            
            # åœæ­¢èˆŠæœå‹™
            docker-compose -f docker-compose.yml -f docker-compose.staging.yml down
            
            # å•Ÿå‹•æ–°æœå‹™
            docker-compose -f docker-compose.yml -f docker-compose.staging.yml up -d
            
            # ç­‰å¾…æœå‹™å•Ÿå‹•
            sleep 30
            
            # å¥åº·æª¢æŸ¥
            curl -f http://localhost:3000/health || exit 1
            
            echo "âœ… Staging éƒ¨ç½²æˆåŠŸ"
          EOF
          
      - name: ğŸ§ª Staging ç’°å¢ƒæ¸¬è©¦
        run: |
          # ç­‰å¾…æœå‹™å®Œå…¨å•Ÿå‹•
          sleep 60
          
          # API å¥åº·æª¢æŸ¥
          curl -f https://staging.nexustrade.example.com/health
          
          # åŸºæœ¬åŠŸèƒ½æ¸¬è©¦
          curl -f https://staging.nexustrade.example.com/api/market/symbols
          
          echo "âœ… Staging ç’°å¢ƒæ¸¬è©¦é€šé"
          
      - name: ğŸ“Š éƒ¨ç½²ç‹€æ…‹é€šçŸ¥
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Staging éƒ¨ç½²æˆåŠŸ"
          else
            echo "âŒ Staging éƒ¨ç½²å¤±æ•—"
          fi

  # ========================
  # éƒ¨ç½²åˆ° Production ç’°å¢ƒ
  # ========================
  deploy-production:
    name: éƒ¨ç½²åˆ° Production ç’°å¢ƒ
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: startsWith(github.ref, 'refs/tags/v')
    
    environment:
      name: production
      url: https://nexustrade.example.com
      
    steps:
      - name: ğŸ“¥ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸ” é…ç½® SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.PRODUCTION_SSH_KEY }}
          
      - name: ğŸš€ éƒ¨ç½²åˆ° Production ä¼ºæœå™¨
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
            cd /opt/nexustrade
            
            # å»ºç«‹å‚™ä»½
            mkdir -p backups/$(date +%Y%m%d_%H%M%S)
            docker-compose logs > backups/$(date +%Y%m%d_%H%M%S)/logs.txt
            
            # æ‹‰å–æœ€æ–°ç¨‹å¼ç¢¼
            git fetch --tags
            git checkout ${{ github.ref_name }}
            
            # æ›´æ–°ç’°å¢ƒè®Šæ•¸
            cp .env.production .env
            
            # é‡æ–°å»ºç½® Docker æ˜ åƒ
            docker-compose -f docker-compose.yml -f docker-compose.production.yml build
            
            # åŸ·è¡Œè³‡æ–™åº«é·ç§» (å¦‚æœéœ€è¦)
            # docker-compose exec nexustrade-app npm run migrate
            
            # æ»¾å‹•æ›´æ–°
            docker-compose -f docker-compose.yml -f docker-compose.production.yml up -d --no-deps nexustrade-app
            
            # ç­‰å¾…æœå‹™å•Ÿå‹•
            sleep 60
            
            # å¥åº·æª¢æŸ¥
            curl -f http://localhost:3000/health || exit 1
            
            # æ¸…ç†èˆŠæ˜ åƒ
            docker image prune -f
            
            echo "âœ… Production éƒ¨ç½²æˆåŠŸ"
          EOF
          
      - name: ğŸ§ª Production ç’°å¢ƒæ¸¬è©¦
        run: |
          # ç­‰å¾…æœå‹™å®Œå…¨å•Ÿå‹•
          sleep 120
          
          # å…¨é¢å¥åº·æª¢æŸ¥
          curl -f https://nexustrade.example.com/health
          curl -f https://nexustrade.example.com/api/market/symbols
          curl -f https://nexustrade.example.com/api/auth/status
          
          echo "âœ… Production ç’°å¢ƒæ¸¬è©¦é€šé"
          
      - name: ğŸ“ˆ éƒ¨ç½²å¾Œç›£æ§
        run: |
          # ç›£æ§é—œéµæŒ‡æ¨™ 5 åˆ†é˜
          for i in {1..10}; do
            echo "ç›£æ§æª¢æŸ¥ $i/10"
            
            # API å›æ‡‰æ™‚é–“æª¢æŸ¥
            response_time=$(curl -o /dev/null -s -w '%{time_total}' https://nexustrade.example.com/health)
            echo "å›æ‡‰æ™‚é–“: ${response_time}s"
            
            if (( $(echo "$response_time > 2.0" | bc -l) )); then
              echo "âš ï¸ å›æ‡‰æ™‚é–“éé•·: ${response_time}s"
            fi
            
            sleep 30
          done
          
          echo "âœ… éƒ¨ç½²å¾Œç›£æ§å®Œæˆ"

  # ========================
  # å›æ»¾æ©Ÿåˆ¶
  # ========================
  rollback:
    name: ç·Šæ€¥å›æ»¾
    runs-on: ubuntu-latest
    if: failure()
    
    environment:
      name: production
      
    steps:
      - name: ğŸ”„ åŸ·è¡Œå›æ»¾
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
            cd /opt/nexustrade
            
            # å›æ»¾åˆ°ä¸Šä¸€å€‹ç©©å®šç‰ˆæœ¬
            git checkout HEAD~1
            
            # é‡æ–°å»ºç½®å’Œéƒ¨ç½²
            docker-compose -f docker-compose.yml -f docker-compose.production.yml build
            docker-compose -f docker-compose.yml -f docker-compose.production.yml up -d
            
            # å¥åº·æª¢æŸ¥
            sleep 60
            curl -f http://localhost:3000/health
            
            echo "âœ… å›æ»¾å®Œæˆ"
          EOF
          
      - name: ğŸ“¨ å›æ»¾é€šçŸ¥
        run: |
          echo "ğŸ”„ ç·Šæ€¥å›æ»¾å·²åŸ·è¡Œ"
          echo "ç³»çµ±å·²å›æ»¾åˆ°ä¸Šä¸€å€‹ç©©å®šç‰ˆæœ¬"

  # ========================
  # éƒ¨ç½²å ±å‘Š
  # ========================
  deployment-report:
    name: éƒ¨ç½²å ±å‘Š
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    
    steps:
      - name: ğŸ“Š ç”Ÿæˆéƒ¨ç½²å ±å‘Š
        run: |
          echo "# ğŸš€ NexusTrade éƒ¨ç½²å ±å‘Š"
          echo ""
          echo "**éƒ¨ç½²æ™‚é–“:** $(date)"
          echo "**ç‰ˆæœ¬:** ${{ github.ref_name }}"
          echo "**æäº¤:** ${{ github.sha }}"
          echo ""
          echo "## éƒ¨ç½²ç‹€æ…‹"
          echo "- Staging: ${{ needs.deploy-staging.result }}"
          echo "- Production: ${{ needs.deploy-production.result }}"
          echo ""
          echo "## ç’°å¢ƒé€£çµ"
          echo "- ğŸ§ª Staging: https://staging.nexustrade.example.com"
          echo "- ğŸŒ Production: https://nexustrade.example.com"
          echo ""
          echo "## å¥åº·æª¢æŸ¥"
          echo "- âœ… API æœå‹™æ­£å¸¸"
          echo "- âœ… è³‡æ–™åº«é€£æ¥æ­£å¸¸"
          echo "- âœ… WebSocket æœå‹™æ­£å¸¸"