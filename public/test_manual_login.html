<!DOCTYPE html>
<html>
<head>
    <title>æ‰‹å‹•è¨­ç½®ç™»å…¥ç‹€æ…‹æ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .info { background: #d1ecf1; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ”§ æ‰‹å‹•è¨­ç½®ç™»å…¥ç‹€æ…‹æ¸¬è©¦</h1>
    
    <div class="section">
        <h3>æ¸¬è©¦æ­¥é©Ÿ</h3>
        <button onclick="setLoginData()">1. è¨­ç½®ç™»å…¥æ•¸æ“š</button>
        <button onclick="refreshAuthTokens()">2. é‡æ–°è¼‰å…¥ authTokens</button>
        <button onclick="forceUpdateUI()">3. å¼·åˆ¶æ›´æ–° UI</button>
        <button onclick="clearAll()">4. æ¸…é™¤æ‰€æœ‰</button>
    </div>
    
    <div class="section">
        <h3>æª¢æŸ¥çµæœ</h3>
        <button onclick="checkState()">æª¢æŸ¥ç•¶å‰ç‹€æ…‹</button>
        <div id="results"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `section ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
            console.log(`[${type}] ${message}`);
        }

        function setLoginData() {
            log('ğŸ”§ è¨­ç½®å®Œæ•´çš„ç™»å…¥æ•¸æ“š...', 'info');
            
            const tokenData = {
                token: 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0ZXN0LXVzZXItaWQiLCJuYW1lIjoiVGVzdCBVc2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIiwiZXhwIjo5OTk5OTk5OTk5LCJpYXQiOjE2NDA5OTUyMDB9.test_signature',
                refreshToken: 'test_refresh_token_12345'
            };
            
            const userData = {
                id: 'test-user-id',
                name: 'Test User',
                email: 'test@example.com',
                avatar: 'https://via.placeholder.com/40',
                provider: 'google',
                profile: {
                    displayName: 'Test User',
                    picture: 'https://via.placeholder.com/40'
                }
            };
            
            try {
                localStorage.setItem('nexustrade_token', tokenData.token);
                localStorage.setItem('nexustrade_refresh_token', tokenData.refreshToken);
                localStorage.setItem('nexustrade_user', JSON.stringify(userData));
                
                log('âœ… æ•¸æ“šå·²è¨­ç½®åˆ° localStorage', 'success');
                log(`Token: ${tokenData.token.substring(0, 50)}...`, 'info');
                log(`User: ${userData.name} (${userData.email})`, 'info');
                
            } catch (error) {
                log(`âŒ è¨­ç½®å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function refreshAuthTokens() {
            if (window.loginModal) {
                log('ğŸ”„ é‡æ–°è¼‰å…¥ authTokens...', 'info');
                
                // æ‰‹å‹•èª¿ç”¨ loadTokensFromStorage
                const newTokens = window.loginModal.loadTokensFromStorage();
                window.loginModal.authTokens = newTokens;
                
                log(`<pre>æ–°çš„ authTokens:\n${JSON.stringify(newTokens, null, 2)}</pre>`, 'info');
                
                // æª¢æŸ¥æ˜¯å¦æœ‰ user æ•¸æ“šä¸¦è§¸ç™¼è‡ªå‹•ç™»å…¥
                if (newTokens.user) {
                    log('âœ… ç™¼ç¾ user æ•¸æ“šï¼Œèª¿ç”¨ handleAutoLogin', 'success');
                    window.loginModal.handleAutoLogin();
                } else {
                    log('âŒ æ²’æœ‰ user æ•¸æ“š', 'error');
                }
                
            } else {
                log('âŒ LoginModal å¯¦ä¾‹ä¸å­˜åœ¨', 'error');
            }
        }

        function forceUpdateUI() {
            if (window.loginModal && window.loginModal.authTokens.user) {
                log('ğŸ¨ å¼·åˆ¶æ›´æ–° UI...', 'info');
                window.loginModal.updateUIForLoggedInUser(window.loginModal.authTokens.user);
                log('âœ… UI æ›´æ–°å®Œæˆ', 'success');
            } else {
                log('âŒ ç„¡æ³•æ›´æ–° UIï¼šæ²’æœ‰ LoginModal æˆ– user æ•¸æ“š', 'error');
            }
        }

        function checkState() {
            log('<h3>ğŸ“Š ç•¶å‰ç‹€æ…‹æª¢æŸ¥</h3>', 'info');
            
            // localStorage æª¢æŸ¥
            const token = localStorage.getItem('nexustrade_token');
            const user = localStorage.getItem('nexustrade_user');
            log(`localStorage Token: ${token ? 'exists' : 'missing'}`, token ? 'success' : 'error');
            log(`localStorage User: ${user ? 'exists' : 'missing'}`, user ? 'success' : 'error');
            
            // LoginModal æª¢æŸ¥
            if (window.loginModal) {
                const authTokens = window.loginModal.authTokens;
                log(`<pre>authTokens:\n${JSON.stringify(authTokens, null, 2)}</pre>`, 'info');
            } else {
                log('âŒ LoginModal ä¸å­˜åœ¨', 'error');
            }
            
            // DOM æª¢æŸ¥
            const loginBtn = document.getElementById('login-btn');
            const userMenu = document.querySelector('.user-menu');
            log(`Login Button: ${loginBtn ? 'exists' : 'missing'}`, loginBtn ? 'info' : 'error');
            log(`User Menu: ${userMenu ? 'exists' : 'missing'}`, userMenu ? 'success' : 'error');
        }

        function clearAll() {
            localStorage.clear();
            log('ğŸ§¹ å·²æ¸…é™¤ localStorage', 'success');
            if (window.loginModal) {
                window.loginModal.authTokens = {token: null, refreshToken: null, user: null};
                window.loginModal.updateUIForLoggedOutUser();
            }
            document.getElementById('results').innerHTML = '';
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥
        window.addEventListener('load', function() {
            setTimeout(checkState, 1000);
        });
    </script>
</body>
</html>