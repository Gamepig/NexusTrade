<!DOCTYPE html>
<html>
<head>
    <title>新認證系統測試</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-container { background: white; padding: 20px; border-radius: 8px; margin: 10px 0; }
        .status { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { background: #f8f9fa; padding: 15px; margin: 10px 0; border-left: 4px solid #007bff; }
        pre { background: #f1f1f1; padding: 10px; overflow-x: auto; white-space: pre-wrap; }
        .header-mock { background: #333; color: white; padding: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        #login-btn { background: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
        .user-menu { position: relative; }
        .user-profile-btn { background: none; border: none; color: white; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; }
        .user-dropdown { position: absolute; top: 100%; right: 0; background: white; color: black; border: 1px solid #ddd; border-radius: 4px; padding: 10px; min-width: 200px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .dropdown-item { background: none; border: none; padding: 8px; width: 100%; text-align: left; cursor: pointer; }
        .dropdown-item:hover { background: #f8f9fa; }
    </style>
</head>
<body>
    <h1>🔐 新認證系統測試</h1>
    
    <!-- 模擬的 header -->
    <div class="header-mock">
        <div>
            <h2>NexusTrade 模擬頂欄</h2>
        </div>
        <div class="header-right">
            <button id="login-btn">登入</button>
        </div>
    </div>
    
    <div class="test-container">
        <h2>📊 系統狀態檢查</h2>
        <button onclick="checkAuthManager()">檢查 AuthManager</button>
        <button onclick="checkAuthState()">檢查認證狀態</button>
        <button onclick="checkLocalStorage()">檢查 localStorage</button>
        <div id="system-status"></div>
    </div>
    
    <div class="test-container">
        <h2>🧪 測試登入流程</h2>
        <button onclick="testManualLogin()">模擬手動登入</button>
        <button onclick="testOAuthCallback()">模擬 OAuth 回調</button>
        <button onclick="testTokenValidation()">測試 Token 驗證</button>
        <div id="login-test-result"></div>
    </div>
    
    <div class="test-container">
        <h2>🔄 UI 更新測試</h2>
        <button onclick="updateUITest()">測試 UI 更新</button>
        <button onclick="testLogout()">測試登出</button>
        <button onclick="clearAllData()">清除所有資料</button>
        <div id="ui-test-result"></div>
    </div>
    
    <div class="test-container">
        <h2>📱 OAuth 回調模擬</h2>
        <p>模擬從 OAuth 提供者返回的 URL 參數</p>
        <button onclick="simulateGoogleCallback()">模擬 Google OAuth 成功</button>
        <button onclick="simulateLineCallback()">模擬 LINE OAuth 成功</button>
        <button onclick="simulateOAuthError()">模擬 OAuth 錯誤</button>
        <div id="oauth-test-result"></div>
    </div>

    <!-- 載入新的認證系統 -->
    <script src="/js/auth/AuthManager.js"></script>
    
    <script>
        function showResult(containerId, type, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function showDetailedResult(containerId, title, data) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="result">
                    <h4>${title}</h4>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
        }
        
        function checkAuthManager() {
            const hasAuthManager = !!window.authManager;
            const isInitialized = hasAuthManager ? window.authManager.isInitialized : false;
            
            const result = {
                exists: hasAuthManager,
                initialized: isInitialized,
                methods: hasAuthManager ? Object.getOwnPropertyNames(window.authManager.__proto__) : [],
                instance: hasAuthManager ? 'AuthManager instance exists' : 'No AuthManager instance'
            };
            
            showDetailedResult('system-status', '🔐 AuthManager 狀態', result);
        }
        
        function checkAuthState() {
            if (!window.authManager) {
                showResult('system-status', 'error', '❌ AuthManager 不存在');
                return;
            }
            
            const authState = window.authManager.getAuthState();
            showDetailedResult('system-status', '📊 認證狀態', authState);
        }
        
        function checkLocalStorage() {
            const storageKeys = [
                'nexustrade_token', 'nexustrade_refresh_token', 'nexustrade_user', 
                'nexustrade_line_bound', 'nexustrade_return_state'
            ];
            
            const storageData = {};
            storageKeys.forEach(key => {
                const value = localStorage.getItem(key);
                storageData[key] = value ? (key.includes('user') ? JSON.parse(value) : value) : null;
            });
            
            showDetailedResult('system-status', '💾 localStorage 內容', storageData);
        }
        
        function testManualLogin() {
            if (!window.authManager) {
                showResult('login-test-result', 'error', '❌ AuthManager 不存在');
                return;
            }
            
            const testUser = {
                name: '測試使用者',
                email: 'test@nexustrade.com',
                avatar: 'https://via.placeholder.com/40',
                provider: 'manual'
            };
            
            const testToken = 'test_token_' + Date.now();
            
            window.authManager.setAuthState(testToken, testUser);
            
            showResult('login-test-result', 'success', '✅ 手動登入測試完成，檢查頂欄是否顯示使用者資訊');
        }
        
        function testOAuthCallback() {
            if (!window.authManager) {
                showResult('login-test-result', 'error', '❌ AuthManager 不存在');
                return;
            }
            
            // 模擬 OAuth 回調參數
            const params = new URLSearchParams({
                token: 'oauth_test_token_' + Date.now(),
                provider: 'google',
                userName: 'OAuth 測試使用者',
                userEmail: 'oauth@test.com',
                userAvatar: 'https://via.placeholder.com/40',
                refreshToken: 'refresh_token_123'
            });
            
            // 更新當前 URL
            const newUrl = window.location.pathname + '?' + params.toString();
            window.history.pushState({}, '', newUrl);
            
            // 觸發 OAuth 回調處理
            window.authManager.handleOAuthCallback();
            
            showResult('login-test-result', 'success', '✅ OAuth 回調測試完成');
        }
        
        function testTokenValidation() {
            if (!window.authManager) {
                showResult('login-test-result', 'error', '❌ AuthManager 不存在');
                return;
            }
            
            window.authManager.validateAndRestoreSession().then(() => {
                showResult('login-test-result', 'success', '✅ Token 驗證測試完成，請檢查 Console 日誌');
            });
        }
        
        function updateUITest() {
            if (!window.authManager) {
                showResult('ui-test-result', 'error', '❌ AuthManager 不存在');
                return;
            }
            
            window.authManager.updateUI();
            showResult('ui-test-result', 'success', '✅ UI 更新測試完成，檢查頂欄變化');
        }
        
        function testLogout() {
            if (!window.authManager) {
                showResult('ui-test-result', 'error', '❌ AuthManager 不存在');
                return;
            }
            
            window.authManager.logout();
            showResult('ui-test-result', 'success', '✅ 登出測試完成');
        }
        
        function clearAllData() {
            const keys = [
                'nexustrade_token', 'nexustrade_refresh_token', 'nexustrade_user',
                'nexustrade_line_bound', 'nexustrade_return_state'
            ];
            
            keys.forEach(key => localStorage.removeItem(key));
            
            if (window.authManager) {
                window.authManager.clearAuthState();
            }
            
            // 清除 URL 參數
            window.history.replaceState({}, document.title, window.location.pathname);
            
            showResult('ui-test-result', 'success', '🧹 所有資料已清除');
        }
        
        function simulateGoogleCallback() {
            const params = new URLSearchParams({
                token: 'google_token_' + Date.now(),
                provider: 'google',
                userName: 'Google 使用者',
                userEmail: 'google@gmail.com',
                userAvatar: 'https://lh3.googleusercontent.com/a/default-user',
                refreshToken: 'google_refresh_' + Date.now()
            });
            
            const newUrl = window.location.pathname + '?' + params.toString();
            window.history.pushState({}, '', newUrl);
            
            if (window.authManager) {
                window.authManager.handleOAuthCallback();
            }
            
            showResult('oauth-test-result', 'success', '✅ Google OAuth 回調模擬完成');
        }
        
        function simulateLineCallback() {
            const params = new URLSearchParams({
                token: 'line_token_' + Date.now(),
                provider: 'line',
                userName: 'LINE 使用者',
                userEmail: 'line@example.com',
                userAvatar: 'https://profile.line-scdn.net/default',
                refreshToken: 'line_refresh_' + Date.now()
            });
            
            const newUrl = window.location.pathname + '?' + params.toString();
            window.history.pushState({}, '', newUrl);
            
            if (window.authManager) {
                window.authManager.handleOAuthCallback();
            }
            
            showResult('oauth-test-result', 'success', '✅ LINE OAuth 回調模擬完成');
        }
        
        function simulateOAuthError() {
            const params = new URLSearchParams({
                error: 'access_denied',
                error_description: '使用者拒絕授權'
            });
            
            const newUrl = window.location.pathname + '?' + params.toString();
            window.history.pushState({}, '', newUrl);
            
            if (window.authManager) {
                window.authManager.handleOAuthCallback();
            }
            
            showResult('oauth-test-result', 'warning', '⚠️ OAuth 錯誤模擬完成');
        }
        
        // 頁面載入完成後自動檢查
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkAuthManager();
                checkAuthState();
                checkLocalStorage();
            }, 1000);
        });
        
        // 監聽認證狀態變化
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (window.authManager) {
                    window.authManager.on('stateChange', (authState) => {
                        console.log('🔄 認證狀態變化:', authState);
                    });
                    
                    window.authManager.on('login', (user) => {
                        console.log('🎉 使用者登入:', user);
                    });
                    
                    window.authManager.on('logout', () => {
                        console.log('👋 使用者登出');
                    });
                }
            }, 1500);
        });
    </script>
</body>
</html>