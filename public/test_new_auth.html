<!DOCTYPE html>
<html>
<head>
    <title>æ–°èªè­‰ç³»çµ±æ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-container { background: white; padding: 20px; border-radius: 8px; margin: 10px 0; }
        .status { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { background: #f8f9fa; padding: 15px; margin: 10px 0; border-left: 4px solid #007bff; }
        pre { background: #f1f1f1; padding: 10px; overflow-x: auto; white-space: pre-wrap; }
        .header-mock { background: #333; color: white; padding: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        #login-btn { background: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
        .user-menu { position: relative; }
        .user-profile-btn { background: none; border: none; color: white; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; }
        .user-dropdown { position: absolute; top: 100%; right: 0; background: white; color: black; border: 1px solid #ddd; border-radius: 4px; padding: 10px; min-width: 200px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .dropdown-item { background: none; border: none; padding: 8px; width: 100%; text-align: left; cursor: pointer; }
        .dropdown-item:hover { background: #f8f9fa; }
    </style>
</head>
<body>
    <h1>ğŸ” æ–°èªè­‰ç³»çµ±æ¸¬è©¦</h1>
    
    <!-- æ¨¡æ“¬çš„ header -->
    <div class="header-mock">
        <div>
            <h2>NexusTrade æ¨¡æ“¬é ‚æ¬„</h2>
        </div>
        <div class="header-right">
            <button id="login-btn">ç™»å…¥</button>
        </div>
    </div>
    
    <div class="test-container">
        <h2>ğŸ“Š ç³»çµ±ç‹€æ…‹æª¢æŸ¥</h2>
        <button onclick="checkAuthManager()">æª¢æŸ¥ AuthManager</button>
        <button onclick="checkAuthState()">æª¢æŸ¥èªè­‰ç‹€æ…‹</button>
        <button onclick="checkLocalStorage()">æª¢æŸ¥ localStorage</button>
        <div id="system-status"></div>
    </div>
    
    <div class="test-container">
        <h2>ğŸ§ª æ¸¬è©¦ç™»å…¥æµç¨‹</h2>
        <button onclick="testManualLogin()">æ¨¡æ“¬æ‰‹å‹•ç™»å…¥</button>
        <button onclick="testOAuthCallback()">æ¨¡æ“¬ OAuth å›èª¿</button>
        <button onclick="testTokenValidation()">æ¸¬è©¦ Token é©—è­‰</button>
        <div id="login-test-result"></div>
    </div>
    
    <div class="test-container">
        <h2>ğŸ”„ UI æ›´æ–°æ¸¬è©¦</h2>
        <button onclick="updateUITest()">æ¸¬è©¦ UI æ›´æ–°</button>
        <button onclick="testLogout()">æ¸¬è©¦ç™»å‡º</button>
        <button onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
        <div id="ui-test-result"></div>
    </div>
    
    <div class="test-container">
        <h2>ğŸ“± OAuth å›èª¿æ¨¡æ“¬</h2>
        <p>æ¨¡æ“¬å¾ OAuth æä¾›è€…è¿”å›çš„ URL åƒæ•¸</p>
        <button onclick="simulateGoogleCallback()">æ¨¡æ“¬ Google OAuth æˆåŠŸ</button>
        <button onclick="simulateLineCallback()">æ¨¡æ“¬ LINE OAuth æˆåŠŸ</button>
        <button onclick="simulateOAuthError()">æ¨¡æ“¬ OAuth éŒ¯èª¤</button>
        <div id="oauth-test-result"></div>
    </div>

    <!-- è¼‰å…¥æ–°çš„èªè­‰ç³»çµ± -->
    <script src="/js/auth/AuthManager.js"></script>
    
    <script>
        function showResult(containerId, type, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function showDetailedResult(containerId, title, data) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="result">
                    <h4>${title}</h4>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
        }
        
        function checkAuthManager() {
            const hasAuthManager = !!window.authManager;
            const isInitialized = hasAuthManager ? window.authManager.isInitialized : false;
            
            const result = {
                exists: hasAuthManager,
                initialized: isInitialized,
                methods: hasAuthManager ? Object.getOwnPropertyNames(window.authManager.__proto__) : [],
                instance: hasAuthManager ? 'AuthManager instance exists' : 'No AuthManager instance'
            };
            
            showDetailedResult('system-status', 'ğŸ” AuthManager ç‹€æ…‹', result);
        }
        
        function checkAuthState() {
            if (!window.authManager) {
                showResult('system-status', 'error', 'âŒ AuthManager ä¸å­˜åœ¨');
                return;
            }
            
            const authState = window.authManager.getAuthState();
            showDetailedResult('system-status', 'ğŸ“Š èªè­‰ç‹€æ…‹', authState);
        }
        
        function checkLocalStorage() {
            const storageKeys = [
                'nexustrade_token', 'nexustrade_refresh_token', 'nexustrade_user', 
                'nexustrade_line_bound', 'nexustrade_return_state'
            ];
            
            const storageData = {};
            storageKeys.forEach(key => {
                const value = localStorage.getItem(key);
                storageData[key] = value ? (key.includes('user') ? JSON.parse(value) : value) : null;
            });
            
            showDetailedResult('system-status', 'ğŸ’¾ localStorage å…§å®¹', storageData);
        }
        
        function testManualLogin() {
            if (!window.authManager) {
                showResult('login-test-result', 'error', 'âŒ AuthManager ä¸å­˜åœ¨');
                return;
            }
            
            const testUser = {
                name: 'æ¸¬è©¦ä½¿ç”¨è€…',
                email: 'test@nexustrade.com',
                avatar: 'https://via.placeholder.com/40',
                provider: 'manual'
            };
            
            const testToken = 'test_token_' + Date.now();
            
            window.authManager.setAuthState(testToken, testUser);
            
            showResult('login-test-result', 'success', 'âœ… æ‰‹å‹•ç™»å…¥æ¸¬è©¦å®Œæˆï¼Œæª¢æŸ¥é ‚æ¬„æ˜¯å¦é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š');
        }
        
        function testOAuthCallback() {
            if (!window.authManager) {
                showResult('login-test-result', 'error', 'âŒ AuthManager ä¸å­˜åœ¨');
                return;
            }
            
            // æ¨¡æ“¬ OAuth å›èª¿åƒæ•¸
            const params = new URLSearchParams({
                token: 'oauth_test_token_' + Date.now(),
                provider: 'google',
                userName: 'OAuth æ¸¬è©¦ä½¿ç”¨è€…',
                userEmail: 'oauth@test.com',
                userAvatar: 'https://via.placeholder.com/40',
                refreshToken: 'refresh_token_123'
            });
            
            // æ›´æ–°ç•¶å‰ URL
            const newUrl = window.location.pathname + '?' + params.toString();
            window.history.pushState({}, '', newUrl);
            
            // è§¸ç™¼ OAuth å›èª¿è™•ç†
            window.authManager.handleOAuthCallback();
            
            showResult('login-test-result', 'success', 'âœ… OAuth å›èª¿æ¸¬è©¦å®Œæˆ');
        }
        
        function testTokenValidation() {
            if (!window.authManager) {
                showResult('login-test-result', 'error', 'âŒ AuthManager ä¸å­˜åœ¨');
                return;
            }
            
            window.authManager.validateAndRestoreSession().then(() => {
                showResult('login-test-result', 'success', 'âœ… Token é©—è­‰æ¸¬è©¦å®Œæˆï¼Œè«‹æª¢æŸ¥ Console æ—¥èªŒ');
            });
        }
        
        function updateUITest() {
            if (!window.authManager) {
                showResult('ui-test-result', 'error', 'âŒ AuthManager ä¸å­˜åœ¨');
                return;
            }
            
            window.authManager.updateUI();
            showResult('ui-test-result', 'success', 'âœ… UI æ›´æ–°æ¸¬è©¦å®Œæˆï¼Œæª¢æŸ¥é ‚æ¬„è®ŠåŒ–');
        }
        
        function testLogout() {
            if (!window.authManager) {
                showResult('ui-test-result', 'error', 'âŒ AuthManager ä¸å­˜åœ¨');
                return;
            }
            
            window.authManager.logout();
            showResult('ui-test-result', 'success', 'âœ… ç™»å‡ºæ¸¬è©¦å®Œæˆ');
        }
        
        function clearAllData() {
            const keys = [
                'nexustrade_token', 'nexustrade_refresh_token', 'nexustrade_user',
                'nexustrade_line_bound', 'nexustrade_return_state'
            ];
            
            keys.forEach(key => localStorage.removeItem(key));
            
            if (window.authManager) {
                window.authManager.clearAuthState();
            }
            
            // æ¸…é™¤ URL åƒæ•¸
            window.history.replaceState({}, document.title, window.location.pathname);
            
            showResult('ui-test-result', 'success', 'ğŸ§¹ æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤');
        }
        
        function simulateGoogleCallback() {
            const params = new URLSearchParams({
                token: 'google_token_' + Date.now(),
                provider: 'google',
                userName: 'Google ä½¿ç”¨è€…',
                userEmail: 'google@gmail.com',
                userAvatar: 'https://lh3.googleusercontent.com/a/default-user',
                refreshToken: 'google_refresh_' + Date.now()
            });
            
            const newUrl = window.location.pathname + '?' + params.toString();
            window.history.pushState({}, '', newUrl);
            
            if (window.authManager) {
                window.authManager.handleOAuthCallback();
            }
            
            showResult('oauth-test-result', 'success', 'âœ… Google OAuth å›èª¿æ¨¡æ“¬å®Œæˆ');
        }
        
        function simulateLineCallback() {
            const params = new URLSearchParams({
                token: 'line_token_' + Date.now(),
                provider: 'line',
                userName: 'LINE ä½¿ç”¨è€…',
                userEmail: 'line@example.com',
                userAvatar: 'https://profile.line-scdn.net/default',
                refreshToken: 'line_refresh_' + Date.now()
            });
            
            const newUrl = window.location.pathname + '?' + params.toString();
            window.history.pushState({}, '', newUrl);
            
            if (window.authManager) {
                window.authManager.handleOAuthCallback();
            }
            
            showResult('oauth-test-result', 'success', 'âœ… LINE OAuth å›èª¿æ¨¡æ“¬å®Œæˆ');
        }
        
        function simulateOAuthError() {
            const params = new URLSearchParams({
                error: 'access_denied',
                error_description: 'ä½¿ç”¨è€…æ‹’çµ•æˆæ¬Š'
            });
            
            const newUrl = window.location.pathname + '?' + params.toString();
            window.history.pushState({}, '', newUrl);
            
            if (window.authManager) {
                window.authManager.handleOAuthCallback();
            }
            
            showResult('oauth-test-result', 'warning', 'âš ï¸ OAuth éŒ¯èª¤æ¨¡æ“¬å®Œæˆ');
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œè‡ªå‹•æª¢æŸ¥
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkAuthManager();
                checkAuthState();
                checkLocalStorage();
            }, 1000);
        });
        
        // ç›£è½èªè­‰ç‹€æ…‹è®ŠåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (window.authManager) {
                    window.authManager.on('stateChange', (authState) => {
                        console.log('ğŸ”„ èªè­‰ç‹€æ…‹è®ŠåŒ–:', authState);
                    });
                    
                    window.authManager.on('login', (user) => {
                        console.log('ğŸ‰ ä½¿ç”¨è€…ç™»å…¥:', user);
                    });
                    
                    window.authManager.on('logout', () => {
                        console.log('ğŸ‘‹ ä½¿ç”¨è€…ç™»å‡º');
                    });
                }
            }, 1500);
        });
    </script>
</body>
</html>