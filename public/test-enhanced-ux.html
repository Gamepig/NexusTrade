<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusTrade 增強版 UX 測試</title>
    
    <!-- 載入樣式 -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/enhanced-watchlist.css">
    
    <!-- 載入核心依賴 -->
    <script src="/js/components/common/LoadingManager.js"></script>
    <script src="/js/components/common/ErrorHandler.js"></script>
    <script src="/js/components/common/FormValidator.js"></script>
    <script src="/js/components/enhanced/EnhancedWatchlistPage.js"></script>
    <script src="/js/components/enhanced/EnhancedPriceAlertModal.js"></script>
    
    <style>
        /* 測試頁面樣式 */
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: var(--bg-primary, #0f1419);
            min-height: 100vh;
        }
        
        .test-header {
            background: var(--bg-secondary, #1a1d29);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 32px;
            border: 1px solid var(--border-color, #2d3748);
        }
        
        .test-header h1 {
            color: var(--text-primary, #ffffff);
            margin: 0 0 8px 0;
            font-size: 28px;
        }
        
        .test-header p {
            color: var(--text-secondary, #a0aec0);
            margin: 0;
            font-size: 16px;
        }
        
        .test-section {
            background: var(--bg-secondary, #1a1d29);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color, #2d3748);
        }
        
        .test-section h2 {
            color: var(--text-primary, #ffffff);
            margin: 0 0 16px 0;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .test-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .test-result {
            margin-top: 16px;
            padding: 12px;
            background: var(--bg-tertiary, #2d3748);
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            color: var(--text-secondary, #a0aec0);
            white-space: pre-wrap;
        }
        
        .mockup-container {
            border: 2px dashed var(--border-color, #2d3748);
            border-radius: 8px;
            padding: 16px;
            min-height: 200px;
            background: var(--bg-primary, #0f1419);
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: var(--accent-color, #3182ce);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--accent-color-dark, #2c5aa0);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary, #2d3748);
            color: var(--text-primary, #ffffff);
            border: 1px solid var(--border-color, #4a5568);
        }
        
        .btn-secondary:hover {
            background: var(--bg-quaternary, #4a5568);
        }
        
        .btn-danger {
            background: var(--error-color, #e53e3e);
            color: white;
        }
        
        .btn-danger:hover {
            background: var(--error-color-dark, #c53030);
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.success {
            background: var(--success-color, #38a169);
        }
        
        .status-indicator.error {
            background: var(--error-color, #e53e3e);
        }
        
        .status-indicator.loading {
            background: var(--warning-color, #ffc107);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Mock 用戶認證狀態 */
        .auth-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary, #1a1d29);
            border: 1px solid var(--border-color, #2d3748);
            border-radius: 8px;
            padding: 12px;
            z-index: 1000;
            font-size: 12px;
        }
        
        .auth-status.authenticated {
            border-color: var(--success-color, #38a169);
        }
        
        .auth-status.unauthenticated {
            border-color: var(--error-color, #e53e3e);
        }
    </style>
</head>
<body>
    <div class="test-container">
        <!-- 測試標題 -->
        <div class="test-header">
            <h1>🚀 NexusTrade 增強版 UX 測試</h1>
            <p>測試統一載入管理、錯誤處理、表單驗證和增強版組件功能</p>
        </div>
        
        <!-- 認證狀態指示器 -->
        <div class="auth-status unauthenticated" id="auth-status">
            <div><strong>認證狀態:</strong> <span id="auth-status-text">未登入</span></div>
            <div><strong>用戶:</strong> <span id="auth-user-text">-</span></div>
        </div>
        
        <!-- 1. 載入管理器測試 -->
        <div class="test-section">
            <h2>🔄 LoadingManager 測試</h2>
            <div class="test-controls">
                <button class="btn btn-primary" onclick="testLoadingSpinner()">測試旋轉載入</button>
                <button class="btn btn-primary" onclick="testLoadingSkeleton()">測試骨架屏</button>
                <button class="btn btn-primary" onclick="testLoadingProgress()">測試進度條</button>
                <button class="btn btn-primary" onclick="testLoadingDots()">測試點點載入</button>
                <button class="btn btn-secondary" onclick="hideAllLoading()">隱藏所有載入</button>
            </div>
            <div class="mockup-container" id="loading-test-container"></div>
            <div class="test-result" id="loading-test-result"></div>
        </div>
        
        <!-- 2. 錯誤處理器測試 -->
        <div class="test-section">
            <h2>❌ ErrorHandler 測試</h2>
            <div class="test-controls">
                <button class="btn btn-danger" onclick="testNetworkError()">網路錯誤</button>
                <button class="btn btn-danger" onclick="testAuthError()">認證錯誤</button>
                <button class="btn btn-danger" onclick="testValidationError()">驗證錯誤</button>
                <button class="btn btn-danger" onclick="testServerError()">伺服器錯誤</button>
                <button class="btn btn-danger" onclick="testTimeoutError()">超時錯誤</button>
                <button class="btn btn-secondary" onclick="clearErrorHistory()">清除錯誤歷史</button>
            </div>
            <div class="test-result" id="error-test-result"></div>
        </div>
        
        <!-- 3. 表單驗證測試 -->
        <div class="test-section">
            <h2>✅ FormValidator 測試</h2>
            <form id="test-form" class="enhanced-form" data-auto-validate>
                <div class="form-group">
                    <label for="test-email">電子郵件</label>
                    <input 
                        type="email" 
                        id="test-email" 
                        name="email" 
                        class="form-input"
                        data-validate-required
                        data-validate-email
                        placeholder="請輸入電子郵件"
                    >
                    <div class="input-feedback"></div>
                </div>
                
                <div class="form-group">
                    <label for="test-symbol">貨幣代碼</label>
                    <input 
                        type="text" 
                        id="test-symbol" 
                        name="symbol" 
                        class="form-input"
                        data-validate-required
                        data-validate-crypto-symbol
                        data-format="cryptoSymbol"
                        placeholder="例如: BTCUSDT"
                        maxlength="20"
                    >
                    <div class="input-feedback"></div>
                </div>
                
                <div class="form-group">
                    <label for="test-price">價格</label>
                    <input 
                        type="text" 
                        id="test-price" 
                        name="price" 
                        class="form-input"
                        data-validate-required
                        data-validate-price
                        data-format="currency"
                        placeholder="請輸入價格"
                    >
                    <div class="input-feedback"></div>
                </div>
                
                <div class="form-group">
                    <label for="test-percentage">百分比</label>
                    <input 
                        type="text" 
                        id="test-percentage" 
                        name="percentage" 
                        class="form-input"
                        data-validate-percentage
                        data-format="percentage"
                        placeholder="例如: 5.5"
                    >
                    <div class="input-feedback"></div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="resetTestForm()">重置</button>
                    <button type="submit" class="btn btn-primary">提交測試</button>
                </div>
            </form>
            <div class="test-result" id="form-test-result"></div>
        </div>
        
        <!-- 4. 增強版觀察清單測試 -->
        <div class="test-section">
            <h2>📋 EnhancedWatchlistPage 測試</h2>
            <div class="test-controls">
                <button class="btn btn-primary" onclick="mockLogin()">模擬登入</button>
                <button class="btn btn-secondary" onclick="mockLogout()">模擬登出</button>
                <button class="btn btn-primary" onclick="initEnhancedWatchlist()">初始化增強版觀察清單</button>
                <button class="btn btn-secondary" onclick="mockWatchlistData()">模擬觀察清單數據</button>
            </div>
            <div class="mockup-container">
                <div id="watchlist-container"></div>
                <div id="watchlist-stats"></div>
            </div>
            <div class="test-result" id="watchlist-test-result"></div>
        </div>
        
        <!-- 5. 系統狀態監控 -->
        <div class="test-section">
            <h2>📊 系統狀態監控</h2>
            <div class="test-controls">
                <button class="btn btn-primary" onclick="refreshSystemStatus()">重新整理狀態</button>
                <button class="btn btn-secondary" onclick="exportSystemLogs()">導出系統日誌</button>
            </div>
            <div class="test-result" id="system-status-result"></div>
        </div>
    </div>

    <script>
        // 全域變數
        let enhancedWatchlist = null;
        let mockAuthToken = null;
        let mockUser = null;

        // 載入管理器測試
        function testLoadingSpinner() {
            const loader = window.loadingManager.show('test-spinner', {
                type: 'spinner',
                size: 'large',
                message: '正在載入數據...',
                container: '#loading-test-container',
                overlay: true,
                timeout: 5000
            });
            
            updateResult('loading-test-result', '✅ 顯示旋轉載入器 (5秒後自動隱藏)');
        }

        function testLoadingSkeleton() {
            const loader = window.loadingManager.show('test-skeleton', {
                type: 'skeleton',
                skeletonType: 'card',
                container: '#loading-test-container',
                timeout: 3000
            });
            
            updateResult('loading-test-result', '✅ 顯示骨架屏載入 (3秒後自動隱藏)');
        }

        function testLoadingProgress() {
            const loader = window.loadingManager.show('test-progress', {
                type: 'progress',
                progressType: 'bar',
                message: '下載中...',
                showProgress: true,
                container: '#loading-test-container',
                overlay: true
            });
            
            // 模擬進度更新
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                window.loadingManager.update('test-progress', { 
                    progress, 
                    message: `下載中... ${progress}%` 
                });
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        window.loadingManager.hide('test-progress');
                    }, 1000);
                }
            }, 300);
            
            updateResult('loading-test-result', '✅ 顯示進度條載入 (模擬進度更新)');
        }

        function testLoadingDots() {
            const loader = window.loadingManager.show('test-dots', {
                type: 'dots',
                dotsType: 'bouncing',
                size: 'medium',
                message: '處理中...',
                container: '#loading-test-container',
                timeout: 4000
            });
            
            updateResult('loading-test-result', '✅ 顯示點點載入 (4秒後自動隱藏)');
        }

        function hideAllLoading() {
            window.loadingManager.hideAll();
            updateResult('loading-test-result', '✅ 隱藏所有載入器');
        }

        // 錯誤處理器測試
        function testNetworkError() {
            const error = new Error('Failed to fetch');
            const result = window.errorHandler.handle(error, {
                component: 'TestPage',
                operation: 'networkTest',
                operationId: 'test_' + Date.now()
            });
            
            updateResult('error-test-result', `✅ 網路錯誤處理完成\n錯誤 ID: ${result.errorId}`);
        }

        function testAuthError() {
            const error = { status: 401, message: 'Unauthorized' };
            const result = window.errorHandler.handle(error, {
                component: 'TestPage',
                operation: 'authTest',
                operationId: 'test_' + Date.now()
            });
            
            updateResult('error-test-result', `✅ 認證錯誤處理完成\n錯誤 ID: ${result.errorId}`);
        }

        function testValidationError() {
            const error = { status: 400, message: 'Validation failed' };
            const result = window.errorHandler.handle(error, {
                component: 'TestPage',
                operation: 'validationTest',
                operationId: 'test_' + Date.now()
            });
            
            updateResult('error-test-result', `✅ 驗證錯誤處理完成\n錯誤 ID: ${result.errorId}`);
        }

        function testServerError() {
            const error = { status: 500, message: 'Internal Server Error' };
            const result = window.errorHandler.handle(error, {
                component: 'TestPage',
                operation: 'serverTest',
                operationId: 'test_' + Date.now()
            });
            
            updateResult('error-test-result', `✅ 伺服器錯誤處理完成\n錯誤 ID: ${result.errorId}`);
        }

        function testTimeoutError() {
            const error = new Error('Request timeout');
            const result = window.errorHandler.handle(error, {
                component: 'TestPage',
                operation: 'timeoutTest',
                operationId: 'test_' + Date.now()
            });
            
            updateResult('error-test-result', `✅ 超時錯誤處理完成\n錯誤 ID: ${result.errorId}`);
        }

        function clearErrorHistory() {
            window.errorHandler.clearErrorHistory();
            updateResult('error-test-result', '✅ 錯誤歷史已清除');
        }

        // 表單驗證測試
        function resetTestForm() {
            window.formValidator.resetForm('#test-form');
            document.getElementById('test-form').reset();
            updateResult('form-test-result', '✅ 表單已重置');
        }

        // 模擬認證
        function mockLogin() {
            mockAuthToken = 'mock_jwt_token_' + Date.now();
            mockUser = {
                id: 'user_123',
                name: 'Test User',
                email: 'test@example.com',
                lineUserId: 'line_user_123'
            };
            
            // 儲存到 localStorage
            localStorage.setItem('nexustrade_token', mockAuthToken);
            localStorage.setItem('nexustrade_user', JSON.stringify(mockUser));
            
            updateAuthStatus(true);
            updateResult('watchlist-test-result', '✅ 模擬登入成功');
        }

        function mockLogout() {
            mockAuthToken = null;
            mockUser = null;
            
            localStorage.removeItem('nexustrade_token');
            localStorage.removeItem('nexustrade_user');
            
            updateAuthStatus(false);
            updateResult('watchlist-test-result', '✅ 模擬登出成功');
        }

        function updateAuthStatus(isAuthenticated) {
            const statusEl = document.getElementById('auth-status');
            const statusTextEl = document.getElementById('auth-status-text');
            const userTextEl = document.getElementById('auth-user-text');
            
            if (isAuthenticated) {
                statusEl.className = 'auth-status authenticated';
                statusTextEl.textContent = '已登入';
                userTextEl.textContent = mockUser?.name || '測試用戶';
            } else {
                statusEl.className = 'auth-status unauthenticated';
                statusTextEl.textContent = '未登入';
                userTextEl.textContent = '-';
            }
        }

        // 增強版觀察清單測試
        function initEnhancedWatchlist() {
            try {
                enhancedWatchlist = new window.EnhancedWatchlistPage();
                enhancedWatchlist.init();
                updateResult('watchlist-test-result', '✅ 增強版觀察清單初始化完成');
            } catch (error) {
                updateResult('watchlist-test-result', `❌ 初始化失敗: ${error.message}`);
            }
        }

        function mockWatchlistData() {
            if (!enhancedWatchlist) {
                updateResult('watchlist-test-result', '❌ 請先初始化觀察清單');
                return;
            }
            
            // 模擬觀察清單數據
            enhancedWatchlist.watchlist = [
                {
                    symbol: 'BTCUSDT',
                    priority: 5,
                    addedAt: new Date().toISOString(),
                    priceData: {
                        price: 43250.50,
                        priceChangePercent: 2.45,
                        high: 44100.00,
                        low: 42800.00,
                        volume: 125000000
                    }
                },
                {
                    symbol: 'ETHUSDT',
                    priority: 4,
                    addedAt: new Date(Date.now() - 86400000).toISOString(),
                    priceData: {
                        price: 2650.75,
                        priceChangePercent: -1.20,
                        high: 2720.00,
                        low: 2580.00,
                        volume: 85000000
                    }
                },
                {
                    symbol: 'BNBUSDT',
                    priority: 3,
                    addedAt: new Date(Date.now() - 172800000).toISOString(),
                    priceData: {
                        price: 310.25,
                        priceChangePercent: 0.85,
                        high: 315.50,
                        low: 305.00,
                        volume: 25000000
                    }
                }
            ];
            
            enhancedWatchlist.stats = {
                totalItems: 3,
                remainingSlots: 27,
                priorityDistribution: {
                    high: 2,
                    medium: 1,
                    low: 0
                },
                totalValue: 156250.45
            };
            
            enhancedWatchlist.renderWatchlistEnhanced();
            enhancedWatchlist.renderStatsEnhanced();
            
            updateResult('watchlist-test-result', '✅ 模擬觀察清單數據已載入');
        }

        // 系統狀態監控
        function refreshSystemStatus() {
            const status = {
                loadingManager: {
                    activeLoaders: window.loadingManager.getAllStatus().length,
                    status: '✅ 正常'
                },
                errorHandler: {
                    errorHistory: window.errorHandler.getErrorHistory().length,
                    status: '✅ 正常'
                },
                formValidator: {
                    validatedForms: window.formValidator.validatedForms.size,
                    status: '✅ 正常'
                },
                enhancedComponents: {
                    watchlistPage: enhancedWatchlist ? '✅ 已初始化' : '⏳ 未初始化',
                    status: '✅ 正常'
                }
            };
            
            const statusText = Object.entries(status).map(([key, value]) => {
                if (typeof value === 'object') {
                    return `${key}:\n${Object.entries(value).map(([k, v]) => `  ${k}: ${v}`).join('\n')}`;
                }
                return `${key}: ${value}`;
            }).join('\n\n');
            
            updateResult('system-status-result', statusText);
        }

        function exportSystemLogs() {
            const logs = {
                timestamp: new Date().toISOString(),
                loadingManager: window.loadingManager.getAllStatus(),
                errorHandler: window.errorHandler.getErrorHistory(),
                formValidator: {
                    validatedForms: window.formValidator.validatedForms.size
                }
            };
            
            const dataStr = JSON.stringify(logs, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `nexustrade-ux-logs-${Date.now()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            updateResult('system-status-result', '✅ 系統日誌已導出');
        }

        // 工具函數
        function updateResult(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
            }
        }

        // 設置表單事件監聽
        document.addEventListener('DOMContentLoaded', () => {
            // 表單驗證事件
            const testForm = document.getElementById('test-form');
            testForm.addEventListener('validationSuccess', (e) => {
                updateResult('form-test-result', `✅ 表單驗證成功\n數據: ${JSON.stringify(e.detail.formData, null, 2)}`);
            });
            
            testForm.addEventListener('validationError', (e) => {
                updateResult('form-test-result', `❌ 表單驗證失敗\n錯誤: ${JSON.stringify(e.detail.errors, null, 2)}`);
            });
            
            // 初始化系統狀態
            refreshSystemStatus();
            updateAuthStatus(false);
        });
    </script>
</body>
</html>