<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusTrade å¢å¼·ç‰ˆ UX æ¸¬è©¦</title>
    
    <!-- è¼‰å…¥æ¨£å¼ -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/enhanced-watchlist.css">
    
    <!-- è¼‰å…¥æ ¸å¿ƒä¾è³´ -->
    <script src="/js/components/common/LoadingManager.js"></script>
    <script src="/js/components/common/ErrorHandler.js"></script>
    <script src="/js/components/common/FormValidator.js"></script>
    <script src="/js/components/enhanced/EnhancedWatchlistPage.js"></script>
    <script src="/js/components/enhanced/EnhancedPriceAlertModal.js"></script>
    
    <style>
        /* æ¸¬è©¦é é¢æ¨£å¼ */
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: var(--bg-primary, #0f1419);
            min-height: 100vh;
        }
        
        .test-header {
            background: var(--bg-secondary, #1a1d29);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 32px;
            border: 1px solid var(--border-color, #2d3748);
        }
        
        .test-header h1 {
            color: var(--text-primary, #ffffff);
            margin: 0 0 8px 0;
            font-size: 28px;
        }
        
        .test-header p {
            color: var(--text-secondary, #a0aec0);
            margin: 0;
            font-size: 16px;
        }
        
        .test-section {
            background: var(--bg-secondary, #1a1d29);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color, #2d3748);
        }
        
        .test-section h2 {
            color: var(--text-primary, #ffffff);
            margin: 0 0 16px 0;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .test-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .test-result {
            margin-top: 16px;
            padding: 12px;
            background: var(--bg-tertiary, #2d3748);
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            color: var(--text-secondary, #a0aec0);
            white-space: pre-wrap;
        }
        
        .mockup-container {
            border: 2px dashed var(--border-color, #2d3748);
            border-radius: 8px;
            padding: 16px;
            min-height: 200px;
            background: var(--bg-primary, #0f1419);
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: var(--accent-color, #3182ce);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--accent-color-dark, #2c5aa0);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary, #2d3748);
            color: var(--text-primary, #ffffff);
            border: 1px solid var(--border-color, #4a5568);
        }
        
        .btn-secondary:hover {
            background: var(--bg-quaternary, #4a5568);
        }
        
        .btn-danger {
            background: var(--error-color, #e53e3e);
            color: white;
        }
        
        .btn-danger:hover {
            background: var(--error-color-dark, #c53030);
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.success {
            background: var(--success-color, #38a169);
        }
        
        .status-indicator.error {
            background: var(--error-color, #e53e3e);
        }
        
        .status-indicator.loading {
            background: var(--warning-color, #ffc107);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Mock ç”¨æˆ¶èªè­‰ç‹€æ…‹ */
        .auth-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary, #1a1d29);
            border: 1px solid var(--border-color, #2d3748);
            border-radius: 8px;
            padding: 12px;
            z-index: 1000;
            font-size: 12px;
        }
        
        .auth-status.authenticated {
            border-color: var(--success-color, #38a169);
        }
        
        .auth-status.unauthenticated {
            border-color: var(--error-color, #e53e3e);
        }
    </style>
</head>
<body>
    <div class="test-container">
        <!-- æ¸¬è©¦æ¨™é¡Œ -->
        <div class="test-header">
            <h1>ğŸš€ NexusTrade å¢å¼·ç‰ˆ UX æ¸¬è©¦</h1>
            <p>æ¸¬è©¦çµ±ä¸€è¼‰å…¥ç®¡ç†ã€éŒ¯èª¤è™•ç†ã€è¡¨å–®é©—è­‰å’Œå¢å¼·ç‰ˆçµ„ä»¶åŠŸèƒ½</p>
        </div>
        
        <!-- èªè­‰ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
        <div class="auth-status unauthenticated" id="auth-status">
            <div><strong>èªè­‰ç‹€æ…‹:</strong> <span id="auth-status-text">æœªç™»å…¥</span></div>
            <div><strong>ç”¨æˆ¶:</strong> <span id="auth-user-text">-</span></div>
        </div>
        
        <!-- 1. è¼‰å…¥ç®¡ç†å™¨æ¸¬è©¦ -->
        <div class="test-section">
            <h2>ğŸ”„ LoadingManager æ¸¬è©¦</h2>
            <div class="test-controls">
                <button class="btn btn-primary" onclick="testLoadingSpinner()">æ¸¬è©¦æ—‹è½‰è¼‰å…¥</button>
                <button class="btn btn-primary" onclick="testLoadingSkeleton()">æ¸¬è©¦éª¨æ¶å±</button>
                <button class="btn btn-primary" onclick="testLoadingProgress()">æ¸¬è©¦é€²åº¦æ¢</button>
                <button class="btn btn-primary" onclick="testLoadingDots()">æ¸¬è©¦é»é»è¼‰å…¥</button>
                <button class="btn btn-secondary" onclick="hideAllLoading()">éš±è—æ‰€æœ‰è¼‰å…¥</button>
            </div>
            <div class="mockup-container" id="loading-test-container"></div>
            <div class="test-result" id="loading-test-result"></div>
        </div>
        
        <!-- 2. éŒ¯èª¤è™•ç†å™¨æ¸¬è©¦ -->
        <div class="test-section">
            <h2>âŒ ErrorHandler æ¸¬è©¦</h2>
            <div class="test-controls">
                <button class="btn btn-danger" onclick="testNetworkError()">ç¶²è·¯éŒ¯èª¤</button>
                <button class="btn btn-danger" onclick="testAuthError()">èªè­‰éŒ¯èª¤</button>
                <button class="btn btn-danger" onclick="testValidationError()">é©—è­‰éŒ¯èª¤</button>
                <button class="btn btn-danger" onclick="testServerError()">ä¼ºæœå™¨éŒ¯èª¤</button>
                <button class="btn btn-danger" onclick="testTimeoutError()">è¶…æ™‚éŒ¯èª¤</button>
                <button class="btn btn-secondary" onclick="clearErrorHistory()">æ¸…é™¤éŒ¯èª¤æ­·å²</button>
            </div>
            <div class="test-result" id="error-test-result"></div>
        </div>
        
        <!-- 3. è¡¨å–®é©—è­‰æ¸¬è©¦ -->
        <div class="test-section">
            <h2>âœ… FormValidator æ¸¬è©¦</h2>
            <form id="test-form" class="enhanced-form" data-auto-validate>
                <div class="form-group">
                    <label for="test-email">é›»å­éƒµä»¶</label>
                    <input 
                        type="email" 
                        id="test-email" 
                        name="email" 
                        class="form-input"
                        data-validate-required
                        data-validate-email
                        placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶"
                    >
                    <div class="input-feedback"></div>
                </div>
                
                <div class="form-group">
                    <label for="test-symbol">è²¨å¹£ä»£ç¢¼</label>
                    <input 
                        type="text" 
                        id="test-symbol" 
                        name="symbol" 
                        class="form-input"
                        data-validate-required
                        data-validate-crypto-symbol
                        data-format="cryptoSymbol"
                        placeholder="ä¾‹å¦‚: BTCUSDT"
                        maxlength="20"
                    >
                    <div class="input-feedback"></div>
                </div>
                
                <div class="form-group">
                    <label for="test-price">åƒ¹æ ¼</label>
                    <input 
                        type="text" 
                        id="test-price" 
                        name="price" 
                        class="form-input"
                        data-validate-required
                        data-validate-price
                        data-format="currency"
                        placeholder="è«‹è¼¸å…¥åƒ¹æ ¼"
                    >
                    <div class="input-feedback"></div>
                </div>
                
                <div class="form-group">
                    <label for="test-percentage">ç™¾åˆ†æ¯”</label>
                    <input 
                        type="text" 
                        id="test-percentage" 
                        name="percentage" 
                        class="form-input"
                        data-validate-percentage
                        data-format="percentage"
                        placeholder="ä¾‹å¦‚: 5.5"
                    >
                    <div class="input-feedback"></div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="resetTestForm()">é‡ç½®</button>
                    <button type="submit" class="btn btn-primary">æäº¤æ¸¬è©¦</button>
                </div>
            </form>
            <div class="test-result" id="form-test-result"></div>
        </div>
        
        <!-- 4. å¢å¼·ç‰ˆè§€å¯Ÿæ¸…å–®æ¸¬è©¦ -->
        <div class="test-section">
            <h2>ğŸ“‹ EnhancedWatchlistPage æ¸¬è©¦</h2>
            <div class="test-controls">
                <button class="btn btn-primary" onclick="mockLogin()">æ¨¡æ“¬ç™»å…¥</button>
                <button class="btn btn-secondary" onclick="mockLogout()">æ¨¡æ“¬ç™»å‡º</button>
                <button class="btn btn-primary" onclick="initEnhancedWatchlist()">åˆå§‹åŒ–å¢å¼·ç‰ˆè§€å¯Ÿæ¸…å–®</button>
                <button class="btn btn-secondary" onclick="mockWatchlistData()">æ¨¡æ“¬è§€å¯Ÿæ¸…å–®æ•¸æ“š</button>
            </div>
            <div class="mockup-container">
                <div id="watchlist-container"></div>
                <div id="watchlist-stats"></div>
            </div>
            <div class="test-result" id="watchlist-test-result"></div>
        </div>
        
        <!-- 5. ç³»çµ±ç‹€æ…‹ç›£æ§ -->
        <div class="test-section">
            <h2>ğŸ“Š ç³»çµ±ç‹€æ…‹ç›£æ§</h2>
            <div class="test-controls">
                <button class="btn btn-primary" onclick="refreshSystemStatus()">é‡æ–°æ•´ç†ç‹€æ…‹</button>
                <button class="btn btn-secondary" onclick="exportSystemLogs()">å°å‡ºç³»çµ±æ—¥èªŒ</button>
            </div>
            <div class="test-result" id="system-status-result"></div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let enhancedWatchlist = null;
        let mockAuthToken = null;
        let mockUser = null;

        // è¼‰å…¥ç®¡ç†å™¨æ¸¬è©¦
        function testLoadingSpinner() {
            const loader = window.loadingManager.show('test-spinner', {
                type: 'spinner',
                size: 'large',
                message: 'æ­£åœ¨è¼‰å…¥æ•¸æ“š...',
                container: '#loading-test-container',
                overlay: true,
                timeout: 5000
            });
            
            updateResult('loading-test-result', 'âœ… é¡¯ç¤ºæ—‹è½‰è¼‰å…¥å™¨ (5ç§’å¾Œè‡ªå‹•éš±è—)');
        }

        function testLoadingSkeleton() {
            const loader = window.loadingManager.show('test-skeleton', {
                type: 'skeleton',
                skeletonType: 'card',
                container: '#loading-test-container',
                timeout: 3000
            });
            
            updateResult('loading-test-result', 'âœ… é¡¯ç¤ºéª¨æ¶å±è¼‰å…¥ (3ç§’å¾Œè‡ªå‹•éš±è—)');
        }

        function testLoadingProgress() {
            const loader = window.loadingManager.show('test-progress', {
                type: 'progress',
                progressType: 'bar',
                message: 'ä¸‹è¼‰ä¸­...',
                showProgress: true,
                container: '#loading-test-container',
                overlay: true
            });
            
            // æ¨¡æ“¬é€²åº¦æ›´æ–°
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                window.loadingManager.update('test-progress', { 
                    progress, 
                    message: `ä¸‹è¼‰ä¸­... ${progress}%` 
                });
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        window.loadingManager.hide('test-progress');
                    }, 1000);
                }
            }, 300);
            
            updateResult('loading-test-result', 'âœ… é¡¯ç¤ºé€²åº¦æ¢è¼‰å…¥ (æ¨¡æ“¬é€²åº¦æ›´æ–°)');
        }

        function testLoadingDots() {
            const loader = window.loadingManager.show('test-dots', {
                type: 'dots',
                dotsType: 'bouncing',
                size: 'medium',
                message: 'è™•ç†ä¸­...',
                container: '#loading-test-container',
                timeout: 4000
            });
            
            updateResult('loading-test-result', 'âœ… é¡¯ç¤ºé»é»è¼‰å…¥ (4ç§’å¾Œè‡ªå‹•éš±è—)');
        }

        function hideAllLoading() {
            window.loadingManager.hideAll();
            updateResult('loading-test-result', 'âœ… éš±è—æ‰€æœ‰è¼‰å…¥å™¨');
        }

        // éŒ¯èª¤è™•ç†å™¨æ¸¬è©¦
        function testNetworkError() {
            const error = new Error('Failed to fetch');
            const result = window.errorHandler.handle(error, {
                component: 'TestPage',
                operation: 'networkTest',
                operationId: 'test_' + Date.now()
            });
            
            updateResult('error-test-result', `âœ… ç¶²è·¯éŒ¯èª¤è™•ç†å®Œæˆ\néŒ¯èª¤ ID: ${result.errorId}`);
        }

        function testAuthError() {
            const error = { status: 401, message: 'Unauthorized' };
            const result = window.errorHandler.handle(error, {
                component: 'TestPage',
                operation: 'authTest',
                operationId: 'test_' + Date.now()
            });
            
            updateResult('error-test-result', `âœ… èªè­‰éŒ¯èª¤è™•ç†å®Œæˆ\néŒ¯èª¤ ID: ${result.errorId}`);
        }

        function testValidationError() {
            const error = { status: 400, message: 'Validation failed' };
            const result = window.errorHandler.handle(error, {
                component: 'TestPage',
                operation: 'validationTest',
                operationId: 'test_' + Date.now()
            });
            
            updateResult('error-test-result', `âœ… é©—è­‰éŒ¯èª¤è™•ç†å®Œæˆ\néŒ¯èª¤ ID: ${result.errorId}`);
        }

        function testServerError() {
            const error = { status: 500, message: 'Internal Server Error' };
            const result = window.errorHandler.handle(error, {
                component: 'TestPage',
                operation: 'serverTest',
                operationId: 'test_' + Date.now()
            });
            
            updateResult('error-test-result', `âœ… ä¼ºæœå™¨éŒ¯èª¤è™•ç†å®Œæˆ\néŒ¯èª¤ ID: ${result.errorId}`);
        }

        function testTimeoutError() {
            const error = new Error('Request timeout');
            const result = window.errorHandler.handle(error, {
                component: 'TestPage',
                operation: 'timeoutTest',
                operationId: 'test_' + Date.now()
            });
            
            updateResult('error-test-result', `âœ… è¶…æ™‚éŒ¯èª¤è™•ç†å®Œæˆ\néŒ¯èª¤ ID: ${result.errorId}`);
        }

        function clearErrorHistory() {
            window.errorHandler.clearErrorHistory();
            updateResult('error-test-result', 'âœ… éŒ¯èª¤æ­·å²å·²æ¸…é™¤');
        }

        // è¡¨å–®é©—è­‰æ¸¬è©¦
        function resetTestForm() {
            window.formValidator.resetForm('#test-form');
            document.getElementById('test-form').reset();
            updateResult('form-test-result', 'âœ… è¡¨å–®å·²é‡ç½®');
        }

        // æ¨¡æ“¬èªè­‰
        function mockLogin() {
            mockAuthToken = 'mock_jwt_token_' + Date.now();
            mockUser = {
                id: 'user_123',
                name: 'Test User',
                email: 'test@example.com',
                lineUserId: 'line_user_123'
            };
            
            // å„²å­˜åˆ° localStorage
            localStorage.setItem('nexustrade_token', mockAuthToken);
            localStorage.setItem('nexustrade_user', JSON.stringify(mockUser));
            
            updateAuthStatus(true);
            updateResult('watchlist-test-result', 'âœ… æ¨¡æ“¬ç™»å…¥æˆåŠŸ');
        }

        function mockLogout() {
            mockAuthToken = null;
            mockUser = null;
            
            localStorage.removeItem('nexustrade_token');
            localStorage.removeItem('nexustrade_user');
            
            updateAuthStatus(false);
            updateResult('watchlist-test-result', 'âœ… æ¨¡æ“¬ç™»å‡ºæˆåŠŸ');
        }

        function updateAuthStatus(isAuthenticated) {
            const statusEl = document.getElementById('auth-status');
            const statusTextEl = document.getElementById('auth-status-text');
            const userTextEl = document.getElementById('auth-user-text');
            
            if (isAuthenticated) {
                statusEl.className = 'auth-status authenticated';
                statusTextEl.textContent = 'å·²ç™»å…¥';
                userTextEl.textContent = mockUser?.name || 'æ¸¬è©¦ç”¨æˆ¶';
            } else {
                statusEl.className = 'auth-status unauthenticated';
                statusTextEl.textContent = 'æœªç™»å…¥';
                userTextEl.textContent = '-';
            }
        }

        // å¢å¼·ç‰ˆè§€å¯Ÿæ¸…å–®æ¸¬è©¦
        function initEnhancedWatchlist() {
            try {
                enhancedWatchlist = new window.EnhancedWatchlistPage();
                enhancedWatchlist.init();
                updateResult('watchlist-test-result', 'âœ… å¢å¼·ç‰ˆè§€å¯Ÿæ¸…å–®åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                updateResult('watchlist-test-result', `âŒ åˆå§‹åŒ–å¤±æ•—: ${error.message}`);
            }
        }

        function mockWatchlistData() {
            if (!enhancedWatchlist) {
                updateResult('watchlist-test-result', 'âŒ è«‹å…ˆåˆå§‹åŒ–è§€å¯Ÿæ¸…å–®');
                return;
            }
            
            // æ¨¡æ“¬è§€å¯Ÿæ¸…å–®æ•¸æ“š
            enhancedWatchlist.watchlist = [
                {
                    symbol: 'BTCUSDT',
                    priority: 5,
                    addedAt: new Date().toISOString(),
                    priceData: {
                        price: 43250.50,
                        priceChangePercent: 2.45,
                        high: 44100.00,
                        low: 42800.00,
                        volume: 125000000
                    }
                },
                {
                    symbol: 'ETHUSDT',
                    priority: 4,
                    addedAt: new Date(Date.now() - 86400000).toISOString(),
                    priceData: {
                        price: 2650.75,
                        priceChangePercent: -1.20,
                        high: 2720.00,
                        low: 2580.00,
                        volume: 85000000
                    }
                },
                {
                    symbol: 'BNBUSDT',
                    priority: 3,
                    addedAt: new Date(Date.now() - 172800000).toISOString(),
                    priceData: {
                        price: 310.25,
                        priceChangePercent: 0.85,
                        high: 315.50,
                        low: 305.00,
                        volume: 25000000
                    }
                }
            ];
            
            enhancedWatchlist.stats = {
                totalItems: 3,
                remainingSlots: 27,
                priorityDistribution: {
                    high: 2,
                    medium: 1,
                    low: 0
                },
                totalValue: 156250.45
            };
            
            enhancedWatchlist.renderWatchlistEnhanced();
            enhancedWatchlist.renderStatsEnhanced();
            
            updateResult('watchlist-test-result', 'âœ… æ¨¡æ“¬è§€å¯Ÿæ¸…å–®æ•¸æ“šå·²è¼‰å…¥');
        }

        // ç³»çµ±ç‹€æ…‹ç›£æ§
        function refreshSystemStatus() {
            const status = {
                loadingManager: {
                    activeLoaders: window.loadingManager.getAllStatus().length,
                    status: 'âœ… æ­£å¸¸'
                },
                errorHandler: {
                    errorHistory: window.errorHandler.getErrorHistory().length,
                    status: 'âœ… æ­£å¸¸'
                },
                formValidator: {
                    validatedForms: window.formValidator.validatedForms.size,
                    status: 'âœ… æ­£å¸¸'
                },
                enhancedComponents: {
                    watchlistPage: enhancedWatchlist ? 'âœ… å·²åˆå§‹åŒ–' : 'â³ æœªåˆå§‹åŒ–',
                    status: 'âœ… æ­£å¸¸'
                }
            };
            
            const statusText = Object.entries(status).map(([key, value]) => {
                if (typeof value === 'object') {
                    return `${key}:\n${Object.entries(value).map(([k, v]) => `  ${k}: ${v}`).join('\n')}`;
                }
                return `${key}: ${value}`;
            }).join('\n\n');
            
            updateResult('system-status-result', statusText);
        }

        function exportSystemLogs() {
            const logs = {
                timestamp: new Date().toISOString(),
                loadingManager: window.loadingManager.getAllStatus(),
                errorHandler: window.errorHandler.getErrorHistory(),
                formValidator: {
                    validatedForms: window.formValidator.validatedForms.size
                }
            };
            
            const dataStr = JSON.stringify(logs, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `nexustrade-ux-logs-${Date.now()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            updateResult('system-status-result', 'âœ… ç³»çµ±æ—¥èªŒå·²å°å‡º');
        }

        // å·¥å…·å‡½æ•¸
        function updateResult(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
            }
        }

        // è¨­ç½®è¡¨å–®äº‹ä»¶ç›£è½
        document.addEventListener('DOMContentLoaded', () => {
            // è¡¨å–®é©—è­‰äº‹ä»¶
            const testForm = document.getElementById('test-form');
            testForm.addEventListener('validationSuccess', (e) => {
                updateResult('form-test-result', `âœ… è¡¨å–®é©—è­‰æˆåŠŸ\næ•¸æ“š: ${JSON.stringify(e.detail.formData, null, 2)}`);
            });
            
            testForm.addEventListener('validationError', (e) => {
                updateResult('form-test-result', `âŒ è¡¨å–®é©—è­‰å¤±æ•—\néŒ¯èª¤: ${JSON.stringify(e.detail.errors, null, 2)}`);
            });
            
            // åˆå§‹åŒ–ç³»çµ±ç‹€æ…‹
            refreshSystemStatus();
            updateAuthStatus(false);
        });
    </script>
</body>
</html>