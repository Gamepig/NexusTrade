<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>價格警報認證修復測試</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1d29;
            color: white;
        }
        .test-section {
            background: #2d3748;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #4a5568;
        }
        button {
            background: #3182ce;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2c5aa0;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: rgba(56, 161, 105, 0.2); border: 1px solid #38a169; }
        .error { background: rgba(229, 62, 62, 0.2); border: 1px solid #e53e3e; }
        .warning { background: rgba(255, 165, 0, 0.2); border: 1px solid #ffa500; }
        .info { background: rgba(49, 130, 206, 0.2); border: 1px solid #3182ce; }
    </style>
</head>
<body>
    <h1>🔧 價格警報認證修復測試</h1>
    
    <div class="test-section">
        <h2>📋 測試說明</h2>
        <p>此測試驗證「設定通知」按鈕在不同認證狀態下的行為：</p>
        <ul>
            <li><strong>未登入使用者</strong>：顯示登入提示</li>
            <li><strong>已登入但未連結 LINE</strong>：顯示 LINE 連結選項和直接設定選項</li>
            <li><strong>已登入且已連結 LINE</strong>：直接顯示警報設定表單</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>🔍 當前狀態檢查</h2>
        <div id="auth-status" class="status info">檢查中...</div>
        
        <h3>🧪 測試操作</h3>
        <button onclick="testPriceAlertModal()">🔔 測試設定通知按鈕</button>
        <button onclick="clearAuthState()">🗑️ 清除認證狀態</button>
        <button onclick="setMockAuthState()">👤 設定模擬認證狀態</button>
        <button onclick="setMockLineState()">📱 設定模擬 LINE 連結</button>
        
        <div id="test-results" class="status info" style="display: none;">
            <h4>測試結果：</h4>
            <div id="test-output"></div>
        </div>
    </div>

    <!-- 載入必要的 JavaScript -->
    <script src="/js/components/PriceAlertModal.js"></script>
    
    <script>
        // 測試腳本
        function checkCurrentAuthState() {
            const token = localStorage.getItem('nexustrade_token') || sessionStorage.getItem('nexustrade_token');
            const userStr = localStorage.getItem('nexustrade_user') || sessionStorage.getItem('nexustrade_user');
            let user = null;
            
            try {
                user = userStr ? JSON.parse(userStr) : null;
            } catch (e) {
                console.error('解析使用者資訊失敗:', e);
            }
            
            const isAuthenticated = !!(token && user);
            const isLineConnected = user?.lineId ? true : false;
            
            const statusEl = document.getElementById('auth-status');
            
            if (!isAuthenticated) {
                statusEl.className = 'status error';
                statusEl.innerHTML = '❌ 未登入狀態<br>Token: 無<br>User: 無';
            } else if (!isLineConnected) {
                statusEl.className = 'status warning';
                statusEl.innerHTML = `✅ 已登入但未連結 LINE<br>User: ${user.name || user.email || '未知'}<br>LINE: 未連結`;
            } else {
                statusEl.className = 'status success';
                statusEl.innerHTML = `✅ 已登入且已連結 LINE<br>User: ${user.name || user.email || '未知'}<br>LINE: 已連結`;
            }
            
            return { isAuthenticated, isLineConnected, user };
        }
        
        function testPriceAlertModal() {
            console.log('🧪 開始測試價格警報模態框...');
            
            // 確保 PriceAlertModal 已載入
            if (typeof PriceAlertModal === 'undefined') {
                showTestResult('error', 'PriceAlertModal 組件未載入');
                return;
            }
            
            // 創建測試實例
            if (!window.testPriceAlertModal) {
                window.testPriceAlertModal = new PriceAlertModal();
            }
            
            // 測試顯示模態框
            try {
                window.testPriceAlertModal.show('BTCUSDT');
                showTestResult('success', '價格警報模態框已顯示，請檢查顯示的內容是否正確');
            } catch (error) {
                showTestResult('error', `顯示模態框失敗: ${error.message}`);
            }
        }
        
        function clearAuthState() {
            localStorage.removeItem('nexustrade_token');
            localStorage.removeItem('nexustrade_user');
            sessionStorage.removeItem('nexustrade_token');
            sessionStorage.removeItem('nexustrade_user');
            
            checkCurrentAuthState();
            showTestResult('info', '認證狀態已清除');
        }
        
        function setMockAuthState() {
            const mockToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJ0ZXN0X3VzZXJfMTIzIiwibmFtZSI6IuauuyztlqDnmbowrOuLsueCtvuztA","iat":1640995200,"exp":9999999999}.mock_signature';
            const mockUser = {
                id: 'test_user_123',
                name: '測試使用者',
                email: 'test@example.com',
                provider: 'google'
                // 注意：沒有 lineId，表示未連結 LINE
            };
            
            localStorage.setItem('nexustrade_token', mockToken);
            localStorage.setItem('nexustrade_user', JSON.stringify(mockUser));
            
            checkCurrentAuthState();
            showTestResult('success', '已設定模擬認證狀態（未連結 LINE）');
        }
        
        function setMockLineState() {
            const userStr = localStorage.getItem('nexustrade_user');
            if (!userStr) {
                showTestResult('error', '請先設定認證狀態');
                return;
            }
            
            try {
                const user = JSON.parse(userStr);
                user.lineId = 'mock_line_user_123';
                localStorage.setItem('nexustrade_user', JSON.stringify(user));
                
                checkCurrentAuthState();
                showTestResult('success', '已設定模擬 LINE 連結狀態');
            } catch (error) {
                showTestResult('error', `設定 LINE 狀態失敗: ${error.message}`);
            }
        }
        
        function showTestResult(type, message) {
            const resultsEl = document.getElementById('test-results');
            const outputEl = document.getElementById('test-output');
            
            resultsEl.style.display = 'block';
            resultsEl.className = `status ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            outputEl.innerHTML = `[${timestamp}] ${message}`;
        }
        
        // 頁面載入完成後檢查狀態
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 價格警報認證修復測試頁面載入完成');
            checkCurrentAuthState();
        });
    </script>
</body>
</html>