<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusTrade å³æ™‚èªè­‰ç‹€æ…‹è¨ºæ–·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #ffffff;
        }
        .debug-section {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #444;
        }
        .debug-section h2 {
            color: #4CAF50;
            margin-top: 0;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #444;
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .status-label {
            font-weight: bold;
            color: #64B5F6;
        }
        .status-value {
            font-family: monospace;
            color: #FFB74D;
        }
        .status-success {
            color: #4CAF50;
        }
        .status-error {
            color: #F44336;
        }
        .status-warning {
            color: #FF9800;
        }
        .btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #1976D2;
        }
        .btn-danger {
            background: #F44336;
        }
        .btn-danger:hover {
            background: #D32F2F;
        }
        .btn-success {
            background: #4CAF50;
        }
        .btn-success:hover {
            background: #388E3C;
        }
        .json-display {
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 200px;
            overflow-y: auto;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .test-success {
            background: rgba(76, 175, 80, 0.1);
            border-left-color: #4CAF50;
        }
        .test-error {
            background: rgba(244, 67, 54, 0.1);
            border-left-color: #F44336;
        }
        .test-warning {
            background: rgba(255, 152, 0, 0.1);
            border-left-color: #FF9800;
        }
        .real-time {
            border: 2px solid #4CAF50;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }
    </style>
</head>
<body>
    <h1>ğŸ” NexusTrade å³æ™‚èªè­‰ç‹€æ…‹è¨ºæ–·</h1>
    <p><strong>ç›®çš„</strong>ï¼šè¨ºæ–·ç‚ºä»€éº¼å·²ç™»å…¥ä½¿ç”¨è€… "Vic Huang" é»æ“Šã€Œè¨­å®šé€šçŸ¥ã€ä»é¡¯ç¤ºç™»å…¥æç¤º</p>

    <div class="debug-section real-time">
        <h2>âš¡ å³æ™‚èªè­‰ç‹€æ…‹ç›£æ§</h2>
        <div id="realtime-status">
            <div class="status-item">
                <span class="status-label">ç›£æ§ç‹€æ…‹ï¼š</span>
                <span class="status-value">è¼‰å…¥ä¸­...</span>
            </div>
        </div>
        <button class="btn" onclick="toggleRealTimeMonitoring()">ğŸ”„ åˆ‡æ›å³æ™‚ç›£æ§</button>
        <button class="btn btn-success" onclick="diagnoseAuthIssue()">ğŸ”¬ è¨ºæ–·èªè­‰å•é¡Œ</button>
    </div>

    <div class="debug-section">
        <h2>ğŸ¯ PriceAlertModal æ¨¡æ“¬æ¸¬è©¦</h2>
        <div id="modal-test-results"></div>
        <button class="btn" onclick="simulateModalShow()">ğŸ§ª æ¨¡æ“¬è¨­å®šé€šçŸ¥é»æ“Š</button>
        <button class="btn" onclick="testAuthLogic()">ğŸ” æ¸¬è©¦èªè­‰é‚è¼¯</button>
    </div>

    <div class="debug-section">
        <h2>ğŸ“Š è©³ç´°èªè­‰ç‹€æ…‹</h2>
        <div id="detailed-auth-status"></div>
        <button class="btn" onclick="refreshAuthStatus()">ğŸ”„ é‡æ–°æ•´ç†ç‹€æ…‹</button>
    </div>

    <div class="debug-section">
        <h2>ğŸ› ï¸ å•é¡Œä¿®å¾©å·¥å…·</h2>
        <div id="fix-results"></div>
        <button class="btn btn-success" onclick="attemptAuthFix()">ğŸ”§ å˜—è©¦ä¿®å¾©èªè­‰ç‹€æ…‹</button>
        <button class="btn" onclick="forceStateSync()">âš¡ å¼·åˆ¶ç‹€æ…‹åŒæ­¥</button>
    </div>

    <script>
        let realTimeMonitoring = false;
        let monitoringInterval = null;

        /**
         * åˆ‡æ›å³æ™‚ç›£æ§
         */
        function toggleRealTimeMonitoring() {
            realTimeMonitoring = !realTimeMonitoring;
            
            if (realTimeMonitoring) {
                console.log('ğŸš€ é–‹å§‹å³æ™‚ç›£æ§');
                monitoringInterval = setInterval(updateRealTimeStatus, 2000);
                updateRealTimeStatus();
            } else {
                console.log('â¹ï¸ åœæ­¢å³æ™‚ç›£æ§');
                if (monitoringInterval) {
                    clearInterval(monitoringInterval);
                    monitoringInterval = null;
                }
            }
        }

        /**
         * æ›´æ–°å³æ™‚ç‹€æ…‹
         */
        function updateRealTimeStatus() {
            const statusDiv = document.getElementById('realtime-status');
            const timestamp = new Date().toLocaleTimeString();
            
            try {
                const authStatus = getCurrentAuthStatus();
                const lineStatus = checkLineConnectionSync();
                
                statusDiv.innerHTML = `
                    <div class="status-item">
                        <span class="status-label">æ›´æ–°æ™‚é–“ï¼š</span>
                        <span class="status-value">${timestamp}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">èªè­‰ç‹€æ…‹ï¼š</span>
                        <span class="status-value ${authStatus.isAuthenticated ? 'status-success' : 'status-error'}">
                            ${authStatus.isAuthenticated ? 'âœ… å·²èªè­‰' : 'âŒ æœªèªè­‰'}
                        </span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ä½¿ç”¨è€…ï¼š</span>
                        <span class="status-value ${authStatus.user ? 'status-success' : 'status-error'}">
                            ${authStatus.user ? authStatus.user.name || authStatus.user.email : 'âŒ ç„¡ä½¿ç”¨è€…'}
                        </span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">LINE ç‹€æ…‹ï¼š</span>
                        <span class="status-value ${lineStatus.isConnected ? 'status-success' : 'status-warning'}">
                            ${lineStatus.isConnected ? 'âœ… å·²é€£æ¥' : 'âš ï¸ æœªé€£æ¥'}
                        </span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">é æœŸè¡Œç‚ºï¼š</span>
                        <span class="status-value ${authStatus.isAuthenticated ? 'status-success' : 'status-error'}">
                            ${!authStatus.isAuthenticated ? 'é¡¯ç¤ºç™»å…¥æç¤º' : 
                              !lineStatus.isConnected ? 'é¡¯ç¤º LINE é€£æ¥é¸é …' : 'é¡¯ç¤ºå®Œæ•´è¡¨å–®'}
                        </span>
                    </div>
                `;
                
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="test-error">
                        âŒ å³æ™‚ç›£æ§éŒ¯èª¤: ${error.message}
                    </div>
                `;
            }
        }

        /**
         * å–å¾—ç•¶å‰èªè­‰ç‹€æ…‹ï¼ˆæ¨¡æ“¬ PriceAlertModal é‚è¼¯ï¼‰
         */
        function getCurrentAuthStatus() {
            // æ¨¡æ“¬ PriceAlertModal.getCurrentUser() æ–¹æ³•
            let currentUser = null;
            
            if (window.currentUser) {
                currentUser = window.currentUser;
            } else {
                try {
                    const userStr = localStorage.getItem('nexustrade_user') || sessionStorage.getItem('nexustrade_user');
                    currentUser = userStr ? JSON.parse(userStr) : null;
                } catch (error) {
                    console.error('âŒ è§£æä½¿ç”¨è€…è³‡æ–™å¤±æ•—:', error);
                    currentUser = null;
                }
            }
            
            // æ¨¡æ“¬ PriceAlertModal çš„èªè­‰æª¢æŸ¥é‚è¼¯
            const token = localStorage.getItem('nexustrade_token') || sessionStorage.getItem('nexustrade_token');
            const isAuthenticated = !!(token && currentUser);
            
            return {
                isAuthenticated,
                user: currentUser,
                token: !!token,
                source: window.currentUser ? 'window.currentUser' : 
                       localStorage.getItem('nexustrade_user') ? 'localStorage' : 
                       sessionStorage.getItem('nexustrade_user') ? 'sessionStorage' : 'none'
            };
        }

        /**
         * æª¢æŸ¥ LINE é€£æ¥ç‹€æ…‹ï¼ˆåŒæ­¥ç‰ˆæœ¬ï¼‰
         */
        function checkLineConnectionSync() {
            const authStatus = getCurrentAuthStatus();
            
            if (!authStatus.user) {
                return { isConnected: false, reason: 'no_user' };
            }
            
            // æª¢æŸ¥å¤šç¨®å¯èƒ½çš„ LINE ID æ¬„ä½
            const lineId = authStatus.user.lineUserId || 
                          authStatus.user.lineId || 
                          authStatus.user.line_user_id;
            
            return {
                isConnected: !!lineId,
                lineId: lineId,
                reason: lineId ? 'connected' : 'no_line_id'
            };
        }

        /**
         * è¨ºæ–·èªè­‰å•é¡Œ
         */
        function diagnoseAuthIssue() {
            const resultsDiv = document.getElementById('modal-test-results');
            resultsDiv.innerHTML = '<div class="test-warning">ğŸ”¬ æ­£åœ¨è¨ºæ–·èªè­‰å•é¡Œ...</div>';
            
            setTimeout(() => {
                let diagnostics = [];
                
                // 1. æª¢æŸ¥èªè­‰ç‹€æ…‹
                const authStatus = getCurrentAuthStatus();
                diagnostics.push({
                    test: '1. åŸºæœ¬èªè­‰æª¢æŸ¥',
                    result: authStatus.isAuthenticated,
                    details: `ä½¿ç”¨è€…: ${authStatus.user?.name || 'ç„¡'}, Token: ${authStatus.token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}, ä¾†æº: ${authStatus.source}`
                });
                
                // 2. æª¢æŸ¥ LINE ç‹€æ…‹
                const lineStatus = checkLineConnectionSync();
                diagnostics.push({
                    test: '2. LINE é€£æ¥æª¢æŸ¥',
                    result: lineStatus.isConnected,
                    details: `LINE ID: ${lineStatus.lineId || 'ç„¡'}, åŸå› : ${lineStatus.reason}`
                });
                
                // 3. æª¢æŸ¥ AuthStateManager
                const hasAuthManager = typeof window.authStateManager !== 'undefined';
                diagnostics.push({
                    test: '3. AuthStateManager å¯ç”¨æ€§',
                    result: hasAuthManager,
                    details: hasAuthManager ? 'å¯ç”¨' : 'ä¸å¯ç”¨'
                });
                
                // 4. æª¢æŸ¥ PriceAlertModal
                const hasPriceModal = typeof window.PriceAlertModal !== 'undefined';
                const hasModalInstance = typeof window.priceAlertModal !== 'undefined';
                diagnostics.push({
                    test: '4. PriceAlertModal ç‹€æ…‹',
                    result: hasPriceModal && hasModalInstance,
                    details: `é¡åˆ¥: ${hasPriceModal ? 'å·²è¼‰å…¥' : 'æœªè¼‰å…¥'}, å¯¦ä¾‹: ${hasModalInstance ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`
                });
                
                // ç”Ÿæˆè¨ºæ–·å ±å‘Š
                let html = '<h3>ğŸ”¬ èªè­‰å•é¡Œè¨ºæ–·å ±å‘Š</h3>';
                diagnostics.forEach(diag => {
                    const className = diag.result ? 'test-success' : 'test-error';
                    const icon = diag.result ? 'âœ…' : 'âŒ';
                    html += `
                        <div class="${className}">
                            ${icon} ${diag.test}: ${diag.details}
                        </div>
                    `;
                });
                
                // æä¾›è§£æ±ºå»ºè­°
                if (!authStatus.isAuthenticated) {
                    html += `
                        <div class="test-error">
                            <strong>ğŸš¨ å•é¡Œç™¼ç¾</strong>: èªè­‰ç‹€æ…‹æª¢æŸ¥å¤±æ•—<br>
                            <strong>å»ºè­°</strong>: æª¢æŸ¥ localStorage/sessionStorage ä¸­çš„èªè­‰è³‡æ–™æ ¼å¼
                        </div>
                    `;
                } else if (!lineStatus.isConnected) {
                    html += `
                        <div class="test-warning">
                            <strong>âš ï¸ éƒ¨åˆ†å•é¡Œ</strong>: LINE æœªé€£æ¥<br>
                            <strong>é æœŸè¡Œç‚º</strong>: æ‡‰è©²é¡¯ç¤º LINE é€£æ¥é¸é …ï¼Œè€Œä¸æ˜¯ç™»å…¥æç¤º
                        </div>
                    `;
                } else {
                    html += `
                        <div class="test-success">
                            <strong>âœ… èªè­‰ç‹€æ…‹æ­£å¸¸</strong><br>
                            <strong>é æœŸè¡Œç‚º</strong>: æ‡‰è©²ç›´æ¥é¡¯ç¤ºå®Œæ•´è­¦å ±è¨­å®šè¡¨å–®
                        </div>
                    `;
                }
                
                resultsDiv.innerHTML = html;
            }, 1000);
        }

        /**
         * æ¨¡æ“¬ Modal é¡¯ç¤º
         */
        function simulateModalShow() {
            const resultsDiv = document.getElementById('modal-test-results');
            
            try {
                // æ¨¡æ“¬ PriceAlertModal.renderAlertForm() çš„é‚è¼¯
                const currentUser = getCurrentAuthStatus().user;
                const token = localStorage.getItem('nexustrade_token') || sessionStorage.getItem('nexustrade_token');
                const isAuthenticated = !!(token && currentUser);
                
                let expectedBehavior = '';
                
                if (!isAuthenticated) {
                    expectedBehavior = 'ğŸ” é¡¯ç¤ºã€Œéœ€è¦ç™»å…¥ã€è¨Šæ¯';
                } else {
                    const lineStatus = checkLineConnectionSync();
                    if (!lineStatus.isConnected) {
                        expectedBehavior = 'ğŸ“± é¡¯ç¤ºã€Œé€£çµ LINEã€é¸é …å’Œã€Œç›´æ¥è¨­å®šè­¦å ±ã€æŒ‰éˆ•';
                    } else {
                        expectedBehavior = 'âœ… é¡¯ç¤ºå®Œæ•´è­¦å ±è¨­å®šè¡¨å–®';
                    }
                }
                
                resultsDiv.innerHTML = `
                    <div class="test-result test-success">
                        <strong>ğŸ¯ æ¨¡æ“¬çµæœ</strong><br>
                        èªè­‰ç‹€æ…‹: ${isAuthenticated ? 'å·²èªè­‰' : 'æœªèªè­‰'}<br>
                        é æœŸè¡Œç‚º: ${expectedBehavior}
                    </div>
                `;
                
                // å¦‚æœå¯¦éš› PriceAlertModal å­˜åœ¨ï¼Œä¹Ÿæ¸¬è©¦å®ƒ
                if (window.priceAlertModal && typeof window.priceAlertModal.renderAlertForm === 'function') {
                    // é€™æ˜¯ç§æœ‰æ–¹æ³•ï¼Œç„¡æ³•ç›´æ¥å‘¼å«ï¼Œä½†å¯ä»¥æª¢æŸ¥ç‹€æ…‹
                    resultsDiv.innerHTML += `
                        <div class="test-result test-warning">
                            <strong>âš ï¸ å¯¦éš› PriceAlertModal å­˜åœ¨</strong><br>
                            å»ºè­°åœ¨ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·ä¸­åŸ·è¡Œ: window.priceAlertModal.show('BTCUSDT')
                        </div>
                    `;
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="test-error">
                        âŒ æ¨¡æ“¬æ¸¬è©¦å¤±æ•—: ${error.message}
                    </div>
                `;
            }
        }

        /**
         * æ¸¬è©¦èªè­‰é‚è¼¯
         */
        function testAuthLogic() {
            const resultsDiv = document.getElementById('modal-test-results');
            
            resultsDiv.innerHTML = '<div class="test-warning">ğŸ§ª æ¸¬è©¦èªè­‰é‚è¼¯...</div>';
            
            setTimeout(() => {
                const authStatus = getCurrentAuthStatus();
                
                let html = '<h4>ğŸ§ª èªè­‰é‚è¼¯æ¸¬è©¦çµæœ</h4>';
                
                // æ¸¬è©¦å„ç¨®æƒ…å¢ƒ
                const scenarios = [
                    {
                        name: 'æƒ…å¢ƒ 1: å®Œå…¨æœªç™»å…¥',
                        condition: !authStatus.token && !authStatus.user,
                        expected: 'é¡¯ç¤ºç™»å…¥æç¤º'
                    },
                    {
                        name: 'æƒ…å¢ƒ 2: æœ‰ Token ä½†ç„¡ä½¿ç”¨è€…',
                        condition: authStatus.token && !authStatus.user,
                        expected: 'é¡¯ç¤ºç™»å…¥æç¤ºï¼ˆè³‡æ–™ä¸å®Œæ•´ï¼‰'
                    },
                    {
                        name: 'æƒ…å¢ƒ 3: æœ‰ä½¿ç”¨è€…ä½†ç„¡ Token',
                        condition: !authStatus.token && authStatus.user,
                        expected: 'é¡¯ç¤ºç™»å…¥æç¤ºï¼ˆToken éºå¤±ï¼‰'
                    },
                    {
                        name: 'æƒ…å¢ƒ 4: å·²èªè­‰ä½†æœªé€£çµ LINE',
                        condition: authStatus.isAuthenticated && !checkLineConnectionSync().isConnected,
                        expected: 'é¡¯ç¤º LINE é€£æ¥é¸é …'
                    },
                    {
                        name: 'æƒ…å¢ƒ 5: å·²èªè­‰ä¸”å·²é€£çµ LINE',
                        condition: authStatus.isAuthenticated && checkLineConnectionSync().isConnected,
                        expected: 'é¡¯ç¤ºå®Œæ•´è­¦å ±è¡¨å–®'
                    }
                ];
                
                scenarios.forEach(scenario => {
                    const isCurrentScenario = scenario.condition;
                    const className = isCurrentScenario ? 'test-success' : 'test-warning';
                    const icon = isCurrentScenario ? 'âœ… ç•¶å‰æƒ…å¢ƒ' : 'âšª éç•¶å‰æƒ…å¢ƒ';
                    
                    html += `
                        <div class="${className}">
                            ${icon} ${scenario.name}<br>
                            é æœŸè¡Œç‚º: ${scenario.expected}
                        </div>
                    `;
                });
                
                resultsDiv.innerHTML = html;
            }, 500);
        }

        /**
         * é‡æ–°æ•´ç†èªè­‰ç‹€æ…‹
         */
        function refreshAuthStatus() {
            const statusDiv = document.getElementById('detailed-auth-status');
            
            try {
                const authStatus = getCurrentAuthStatus();
                const lineStatus = checkLineConnectionSync();
                
                // é¡¯ç¤ºè©³ç´°çš„èªè­‰è³‡æ–™
                const localUser = localStorage.getItem('nexustrade_user');
                const sessionUser = sessionStorage.getItem('nexustrade_user');
                
                statusDiv.innerHTML = `
                    <div class="status-item">
                        <span class="status-label">window.currentUserï¼š</span>
                        <span class="status-value">${window.currentUser ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">localStorage Tokenï¼š</span>
                        <span class="status-value">${localStorage.getItem('nexustrade_token') ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">sessionStorage Tokenï¼š</span>
                        <span class="status-value">${sessionStorage.getItem('nexustrade_token') ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">localStorage Userï¼š</span>
                        <span class="status-value">${localUser ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">sessionStorage Userï¼š</span>
                        <span class="status-value">${sessionUser ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ä½¿ç”¨è€…ä¾†æºï¼š</span>
                        <span class="status-value">${authStatus.source}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">LINE æ¬„ä½ï¼š</span>
                        <span class="status-value">${JSON.stringify({
                            lineUserId: authStatus.user?.lineUserId,
                            lineId: authStatus.user?.lineId,
                            line_user_id: authStatus.user?.line_user_id
                        })}</span>
                    </div>
                `;
                
                // å¦‚æœæœ‰ä½¿ç”¨è€…è³‡æ–™ï¼Œé¡¯ç¤ºå®Œæ•´çµæ§‹
                if (authStatus.user) {
                    statusDiv.innerHTML += `
                        <div style="margin-top: 10px;">
                            <strong>å®Œæ•´ä½¿ç”¨è€…è³‡æ–™ï¼š</strong>
                            <div class="json-display">${JSON.stringify(authStatus.user, null, 2)}</div>
                        </div>
                    `;
                }
                
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="test-error">
                        âŒ é‡æ–°æ•´ç†ç‹€æ…‹å¤±æ•—: ${error.message}
                    </div>
                `;
            }
        }

        /**
         * å˜—è©¦ä¿®å¾©èªè­‰ç‹€æ…‹
         */
        function attemptAuthFix() {
            const resultsDiv = document.getElementById('fix-results');
            resultsDiv.innerHTML = '<div class="test-warning">ğŸ”§ å˜—è©¦ä¿®å¾©èªè­‰ç‹€æ…‹...</div>';
            
            setTimeout(() => {
                let fixes = [];
                
                try {
                    // æª¢æŸ¥ä¸¦ä¿®å¾©å¸¸è¦‹å•é¡Œ
                    const token = localStorage.getItem('nexustrade_token') || sessionStorage.getItem('nexustrade_token');
                    const userStr = localStorage.getItem('nexustrade_user') || sessionStorage.getItem('nexustrade_user');
                    
                    if (token && userStr) {
                        try {
                            const user = JSON.parse(userStr);
                            
                            // ç¢ºä¿ window.currentUser è¨­å®šæ­£ç¢º
                            if (!window.currentUser) {
                                window.currentUser = user;
                                fixes.push('âœ… è¨­å®š window.currentUser');
                            }
                            
                            // ç¢ºä¿è³‡æ–™åœ¨ localStorage ä¸­
                            if (!localStorage.getItem('nexustrade_token') && sessionStorage.getItem('nexustrade_token')) {
                                localStorage.setItem('nexustrade_token', sessionStorage.getItem('nexustrade_token'));
                                fixes.push('âœ… å°‡ token è¤‡è£½åˆ° localStorage');
                            }
                            
                            if (!localStorage.getItem('nexustrade_user') && sessionStorage.getItem('nexustrade_user')) {
                                localStorage.setItem('nexustrade_user', sessionStorage.getItem('nexustrade_user'));
                                fixes.push('âœ… å°‡ä½¿ç”¨è€…è³‡æ–™è¤‡è£½åˆ° localStorage');
                            }
                            
                            fixes.push('âœ… èªè­‰ç‹€æ…‹æª¢æŸ¥å®Œæˆ');
                            
                        } catch (error) {
                            fixes.push('âŒ ä½¿ç”¨è€…è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œéœ€è¦é‡æ–°ç™»å…¥');
                        }
                    } else {
                        fixes.push('âŒ ç¼ºå°‘å¿…è¦èªè­‰è³‡æ–™ï¼Œéœ€è¦é‡æ–°ç™»å…¥');
                    }
                    
                } catch (error) {
                    fixes.push(`âŒ ä¿®å¾©éç¨‹ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
                }
                
                resultsDiv.innerHTML = `
                    <h4>ğŸ”§ ä¿®å¾©çµæœ</h4>
                    ${fixes.map(fix => `<div class="test-result ${fix.startsWith('âœ…') ? 'test-success' : 'test-error'}">${fix}</div>`).join('')}
                `;
                
                // ä¿®å¾©å¾Œé‡æ–°æª¢æŸ¥
                setTimeout(() => {
                    diagnoseAuthIssue();
                }, 1000);
                
            }, 1000);
        }

        /**
         * å¼·åˆ¶ç‹€æ…‹åŒæ­¥
         */
        function forceStateSync() {
            const resultsDiv = document.getElementById('fix-results');
            
            if (window.authStateManager && typeof window.authStateManager.forceAuthStateRefresh === 'function') {
                resultsDiv.innerHTML = '<div class="test-warning">âš¡ æ­£åœ¨åŸ·è¡Œå¼·åˆ¶ç‹€æ…‹åŒæ­¥...</div>';
                
                window.authStateManager.forceAuthStateRefresh()
                    .then(result => {
                        if (result) {
                            resultsDiv.innerHTML = '<div class="test-success">âœ… ç‹€æ…‹åŒæ­¥æˆåŠŸ</div>';
                        } else {
                            resultsDiv.innerHTML = '<div class="test-error">âŒ ç‹€æ…‹åŒæ­¥å¤±æ•—</div>';
                        }
                        
                        // åŒæ­¥å¾Œé‡æ–°æª¢æŸ¥
                        setTimeout(() => {
                            diagnoseAuthIssue();
                            updateRealTimeStatus();
                        }, 1000);
                    })
                    .catch(error => {
                        resultsDiv.innerHTML = `<div class="test-error">âŒ ç‹€æ…‹åŒæ­¥éŒ¯èª¤: ${error.message}</div>`;
                    });
            } else {
                resultsDiv.innerHTML = '<div class="test-warning">âš ï¸ AuthStateManager ä¸å¯ç”¨ï¼Œç„¡æ³•åŸ·è¡Œå¼·åˆ¶åŒæ­¥</div>';
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œè‡ªå‹•åŸ·è¡Œåˆå§‹æª¢æŸ¥
        window.addEventListener('load', function() {
            setTimeout(() => {
                refreshAuthStatus();
                diagnoseAuthIssue();
                console.log('ğŸ” å³æ™‚èªè­‰ç‹€æ…‹è¨ºæ–·å·¥å…·å·²è¼‰å…¥');
                
                // è‡ªå‹•é–‹å§‹å³æ™‚ç›£æ§
                toggleRealTimeMonitoring();
            }, 1000);
        });
    </script>
</body>
</html>