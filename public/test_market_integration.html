<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸‚å ´é é¢æ•´åˆæ¸¬è©¦ - NexusTrade</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #0a0e17;
            color: #fff;
            min-height: 100vh;
        }
        .test-section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #2a3142;
            border-radius: 8px;
            background: #1a1d29;
        }
        .test-section h2 {
            color: #4CAF50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #2a3142;
        }
        .test-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: 500;
        }
        .test-status.success {
            background-color: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
            color: #4CAF50;
        }
        .test-status.error {
            background-color: rgba(244, 67, 54, 0.2);
            border: 1px solid #F44336;
            color: #F44336;
        }
        .test-status.loading {
            background-color: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196F3;
            color: #2196F3;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª å¸‚å ´é é¢æ•´åˆæ¸¬è©¦</h1>
        <p>æ¸¬è©¦å¸‚å ´é é¢çš„ CryptoCurrencyList çµ„ä»¶æ•´åˆå’Œ TradingView Widget åŠŸèƒ½</p>

        <!-- API æ¸¬è©¦å€å¡Š -->
        <div class="test-section">
            <h2>ğŸ“Š API ç«¯é»æ¸¬è©¦</h2>
            <div id="api-test-results">
                <div class="test-status loading">æ­£åœ¨æ¸¬è©¦ API ç«¯é»...</div>
            </div>
        </div>

        <!-- å¸‚å ´çµ±è¨ˆæ¸¬è©¦ -->
        <div class="test-section">
            <h2>ğŸ“ˆ å¸‚å ´çµ±è¨ˆé¡¯ç¤ºæ¸¬è©¦</h2>
            <div id="market-stats" class="market-stats">
                <div class="test-status loading">è¼‰å…¥å¸‚å ´çµ±è¨ˆä¸­...</div>
            </div>
        </div>

        <!-- CryptoCurrencyList çµ„ä»¶æ¸¬è©¦ -->
        <div class="test-section">
            <h2>ğŸª™ è²¨å¹£åˆ—è¡¨çµ„ä»¶æ¸¬è©¦</h2>
            <div class="test-status loading" id="crypto-list-status">åˆå§‹åŒ– CryptoCurrencyList çµ„ä»¶...</div>
            
            <div class="coins-table-header">
                <div class="header-coin">è²¨å¹£</div>
                <div class="header-price">åƒ¹æ ¼</div>
                <div class="header-change">å³æ™‚è®ŠåŒ–</div>
                <div class="header-volume">24h ç´¯ç©äº¤æ˜“é‡</div>
            </div>
            
            <div id="market-coins-grid" class="market-coins-grid">
                <!-- å‹•æ…‹è¼‰å…¥è²¨å¹£å¡ç‰‡ -->
            </div>
        </div>

        <!-- TradingView Widget æ¸¬è©¦ -->
        <div class="test-section">
            <h2>ğŸ“Š TradingView Widget æ¸¬è©¦</h2>
            <div class="test-status loading" id="tradingview-status">åˆå§‹åŒ– TradingView Widgets...</div>
            
            <div class="trading-widgets-grid">
                <div class="trading-widget-container">
                    <h3>Bitcoin (BTC)</h3>
                    <div id="tradingview-widget-0" class="tradingview-widget"></div>
                </div>
                <div class="trading-widget-container">
                    <h3>Ethereum (ETH)</h3>
                    <div id="tradingview-widget-1" class="tradingview-widget"></div>
                </div>
                <div class="trading-widget-container">
                    <h3>BNB</h3>
                    <div id="tradingview-widget-2" class="tradingview-widget"></div>
                </div>
                <div class="trading-widget-container">
                    <h3>Cardano (ADA)</h3>
                    <div id="tradingview-widget-3" class="tradingview-widget"></div>
                </div>
            </div>
        </div>

        <!-- ç³»çµ±è³‡è¨Š -->
        <div class="test-section">
            <h2>â„¹ï¸ ç³»çµ±è³‡è¨Š</h2>
            <div id="system-info">
                <div><strong>æ¸¬è©¦æ™‚é–“:</strong> <span id="test-time"></span></div>
                <div><strong>ç”¨æˆ¶ä»£ç†:</strong> <span id="user-agent"></span></div>
                <div><strong>é é¢è¼‰å…¥æ™‚é–“:</strong> <span id="load-time"></span></div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥æ‰€éœ€çš„çµ„ä»¶ -->
    <script src="/js/crypto-icons.js"></script>
    <script src="/js/components/CryptoCurrencyList.js"></script>
    <script>
        // æ¸¬è©¦é–‹å§‹æ™‚é–“
        const testStartTime = Date.now();
        
        // ç³»çµ±è³‡è¨Š
        document.getElementById('test-time').textContent = new Date().toLocaleString('zh-TW');
        document.getElementById('user-agent').textContent = navigator.userAgent.substring(0, 100) + '...';
        
        window.addEventListener('load', () => {
            const loadTime = Date.now() - testStartTime;
            document.getElementById('load-time').textContent = `${loadTime}ms`;
        });

        // æ ¼å¼åŒ–å¤§æ•¸å­—
        function formatLargeNumber(num) {
            if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
            return num.toFixed(2);
        }

        // æ›´æ–°æ¸¬è©¦ç‹€æ…‹
        function updateTestStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `test-status ${status}`;
                element.textContent = message;
            }
        }

        // 1. API ç«¯é»æ¸¬è©¦
        async function testAPIs() {
            const apis = [
                { name: 'å¥åº·æª¢æŸ¥', url: '/health' },
                { name: 'å¸‚å ´çµ±è¨ˆ', url: '/api/market/stats24h' },
                { name: 'ç†±é–€è²¨å¹£', url: '/api/market/trending?limit=10' },
                { name: 'æ‰¹é‡åƒ¹æ ¼', url: '/api/market/batch-prices?symbols=BTCUSDT,ETHUSDT' }
            ];

            let results = '';
            for (const api of apis) {
                try {
                    const response = await fetch(api.url);
                    const data = await response.json();
                    if (data.success !== false) {
                        results += `<div class="test-status success">âœ… ${api.name}: æ­£å¸¸</div>`;
                    } else {
                        results += `<div class="test-status error">âŒ ${api.name}: ${data.message}</div>`;
                    }
                } catch (error) {
                    results += `<div class="test-status error">âŒ ${api.name}: ${error.message}</div>`;
                }
            }
            document.getElementById('api-test-results').innerHTML = results;
        }

        // 2. è¼‰å…¥å¸‚å ´çµ±è¨ˆ
        async function loadMarketStats() {
            try {
                const response = await fetch('/api/market/stats24h');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const stats = result.data;
                    document.getElementById('market-stats').innerHTML = `
                        <div class="market-stat">
                            <div class="stat-label">ç¸½äº¤æ˜“å°æ•¸é‡</div>
                            <div class="stat-value">${stats.totalCoins || 0}</div>
                        </div>
                        <div class="market-stat">
                            <div class="stat-label">24h å¹³å‡è®ŠåŒ–</div>
                            <div class="stat-value ${stats.avgChange >= 0 ? 'positive' : 'negative'}">
                                ${stats.avgChange ? stats.avgChange.toFixed(2) : '0.00'}%
                            </div>
                        </div>
                        <div class="market-stat">
                            <div class="stat-label">ä¸Šæ¼²è²¨å¹£</div>
                            <div class="stat-value positive">${stats.gainersCount || 0}</div>
                        </div>
                        <div class="market-stat">
                            <div class="stat-label">ä¸‹è·Œè²¨å¹£</div>
                            <div class="stat-value negative">${stats.losersCount || 0}</div>
                        </div>
                        <div class="market-stat">
                            <div class="stat-label">24h ç¸½äº¤æ˜“é‡</div>
                            <div class="stat-value">${formatLargeNumber(stats.totalVolume || 0)}</div>
                        </div>
                    `;
                } else {
                    updateTestStatus('market-stats', 'error', 'âŒ è¼‰å…¥å¸‚å ´çµ±è¨ˆå¤±æ•—');
                }
            } catch (error) {
                console.error('è¼‰å…¥å¸‚å ´çµ±è¨ˆå¤±æ•—:', error);
                updateTestStatus('market-stats', 'error', `âŒ è¼‰å…¥å¤±æ•—: ${error.message}`);
            }
        }

        // 3. åˆå§‹åŒ– CryptoCurrencyList çµ„ä»¶
        function initializeCryptoList() {
            try {
                if (typeof CryptoCurrencyList === 'undefined') {
                    updateTestStatus('crypto-list-status', 'error', 'âŒ CryptoCurrencyList çµ„ä»¶æœªè¼‰å…¥');
                    return;
                }

                const container = document.getElementById('market-coins-grid');
                if (!container) {
                    updateTestStatus('crypto-list-status', 'error', 'âŒ æ‰¾ä¸åˆ°å®¹å™¨å…ƒç´ ');
                    return;
                }

                updateTestStatus('crypto-list-status', 'loading', 'â³ åˆå§‹åŒ– CryptoCurrencyList...');

                const cryptoList = new CryptoCurrencyList({
                    container: container,
                    mode: 'infinite',
                    maxCoins: 50,  // æ¸¬è©¦æ™‚åªè¼‰å…¥ 50 å€‹
                    coinsPerPage: 25,
                    updateInterval: 15000,
                    onCoinClick: (coin) => {
                        console.log('æ¸¬è©¦: é»æ“Šè²¨å¹£', coin);
                        alert(`é»æ“Šäº†: ${coin.symbol}`);
                    }
                });

                // ç›£è½çµ„ä»¶ç‹€æ…‹
                setTimeout(() => {
                    const hasCoins = container.children.length > 0;
                    if (hasCoins) {
                        updateTestStatus('crypto-list-status', 'success', `âœ… CryptoCurrencyList çµ„ä»¶è¼‰å…¥æˆåŠŸ (${container.children.length} å€‹é …ç›®)`);
                    } else {
                        updateTestStatus('crypto-list-status', 'error', 'âŒ CryptoCurrencyList çµ„ä»¶ç„¡æ³•è¼‰å…¥æ•¸æ“š');
                    }
                }, 3000);

            } catch (error) {
                console.error('åˆå§‹åŒ– CryptoCurrencyList å¤±æ•—:', error);
                updateTestStatus('crypto-list-status', 'error', `âŒ åˆå§‹åŒ–å¤±æ•—: ${error.message}`);
            }
        }

        // 4. å‰µå»º TradingView Widget
        function createTradingViewWidget(containerId, config) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`æ‰¾ä¸åˆ°å®¹å™¨: ${containerId}`);
                return;
            }
            
            // æ¸…ç†ç¾æœ‰å…§å®¹
            container.innerHTML = '';
            
            // å»ºç«‹ Widget å®¹å™¨
            const widgetContainer = document.createElement('div');
            widgetContainer.className = 'tradingview-widget-container';
            
            const widgetDiv = document.createElement('div');
            widgetDiv.className = 'tradingview-widget-container__widget';
            
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js';
            script.async = true;
            script.innerHTML = JSON.stringify(config);
            
            widgetContainer.appendChild(widgetDiv);
            widgetContainer.appendChild(script);
            container.appendChild(widgetContainer);
            
            console.log(`å‰µå»º TradingView Widget: ${containerId}`, config);
        }

        // 5. åˆå§‹åŒ– TradingView Widgets
        function initializeTradingViewWidgets() {
            try {
                updateTestStatus('tradingview-status', 'loading', 'â³ è¼‰å…¥ TradingView Widgets...');

                const widgets = [
                    { symbol: "BINANCE:BTCUSDT", name: "Bitcoin" },
                    { symbol: "BINANCE:ETHUSDT", name: "Ethereum" },
                    { symbol: "BINANCE:BNBUSDT", name: "BNB" },
                    { symbol: "BINANCE:ADAUSDT", name: "Cardano" }
                ];

                let successCount = 0;
                widgets.forEach((widget, index) => {
                    const containerId = `tradingview-widget-${index}`;
                    
                    createTradingViewWidget(containerId, {
                        symbol: widget.symbol,
                        width: "100%",
                        height: "300",
                        locale: "en",
                        dateRange: "12M",
                        colorTheme: "dark",
                        isTransparent: false,
                        autosize: false,
                        largeChartUrl: ""
                    });
                    
                    successCount++;
                });

                setTimeout(() => {
                    updateTestStatus('tradingview-status', 'success', `âœ… å·²è¼‰å…¥ ${successCount} å€‹ TradingView Widgets`);
                }, 2000);

            } catch (error) {
                console.error('åˆå§‹åŒ– TradingView Widgets å¤±æ•—:', error);
                updateTestStatus('tradingview-status', 'error', `âŒ åˆå§‹åŒ–å¤±æ•—: ${error.message}`);
            }
        }

        // åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸ§ª é–‹å§‹å¸‚å ´é é¢æ•´åˆæ¸¬è©¦...');
            
            // æŒ‰é †åºåŸ·è¡Œæ¸¬è©¦
            await testAPIs();
            await loadMarketStats();
            
            // å»¶é²åˆå§‹åŒ–çµ„ä»¶ï¼Œç¢ºä¿ DOM æº–å‚™å°±ç·’
            setTimeout(() => {
                initializeCryptoList();
                initializeTradingViewWidgets();
            }, 1000);
        });
    </script>
</body>
</html>