<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>市場頁面整合測試 - NexusTrade</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #0a0e17;
            color: #fff;
            min-height: 100vh;
        }
        .test-section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #2a3142;
            border-radius: 8px;
            background: #1a1d29;
        }
        .test-section h2 {
            color: #4CAF50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #2a3142;
        }
        .test-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: 500;
        }
        .test-status.success {
            background-color: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
            color: #4CAF50;
        }
        .test-status.error {
            background-color: rgba(244, 67, 54, 0.2);
            border: 1px solid #F44336;
            color: #F44336;
        }
        .test-status.loading {
            background-color: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196F3;
            color: #2196F3;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧪 市場頁面整合測試</h1>
        <p>測試市場頁面的 CryptoCurrencyList 組件整合和 TradingView Widget 功能</p>

        <!-- API 測試區塊 -->
        <div class="test-section">
            <h2>📊 API 端點測試</h2>
            <div id="api-test-results">
                <div class="test-status loading">正在測試 API 端點...</div>
            </div>
        </div>

        <!-- 市場統計測試 -->
        <div class="test-section">
            <h2>📈 市場統計顯示測試</h2>
            <div id="market-stats" class="market-stats">
                <div class="test-status loading">載入市場統計中...</div>
            </div>
        </div>

        <!-- CryptoCurrencyList 組件測試 -->
        <div class="test-section">
            <h2>🪙 貨幣列表組件測試</h2>
            <div class="test-status loading" id="crypto-list-status">初始化 CryptoCurrencyList 組件...</div>
            
            <div class="coins-table-header">
                <div class="header-coin">貨幣</div>
                <div class="header-price">價格</div>
                <div class="header-change">即時變化</div>
                <div class="header-volume">24h 累積交易量</div>
            </div>
            
            <div id="market-coins-grid" class="market-coins-grid">
                <!-- 動態載入貨幣卡片 -->
            </div>
        </div>

        <!-- TradingView Widget 測試 -->
        <div class="test-section">
            <h2>📊 TradingView Widget 測試</h2>
            <div class="test-status loading" id="tradingview-status">初始化 TradingView Widgets...</div>
            
            <div class="trading-widgets-grid">
                <div class="trading-widget-container">
                    <h3>Bitcoin (BTC)</h3>
                    <div id="tradingview-widget-0" class="tradingview-widget"></div>
                </div>
                <div class="trading-widget-container">
                    <h3>Ethereum (ETH)</h3>
                    <div id="tradingview-widget-1" class="tradingview-widget"></div>
                </div>
                <div class="trading-widget-container">
                    <h3>BNB</h3>
                    <div id="tradingview-widget-2" class="tradingview-widget"></div>
                </div>
                <div class="trading-widget-container">
                    <h3>Cardano (ADA)</h3>
                    <div id="tradingview-widget-3" class="tradingview-widget"></div>
                </div>
            </div>
        </div>

        <!-- 系統資訊 -->
        <div class="test-section">
            <h2>ℹ️ 系統資訊</h2>
            <div id="system-info">
                <div><strong>測試時間:</strong> <span id="test-time"></span></div>
                <div><strong>用戶代理:</strong> <span id="user-agent"></span></div>
                <div><strong>頁面載入時間:</strong> <span id="load-time"></span></div>
            </div>
        </div>
    </div>

    <!-- 引入所需的組件 -->
    <script src="/js/crypto-icons.js"></script>
    <script src="/js/components/CryptoCurrencyList.js"></script>
    <script>
        // 測試開始時間
        const testStartTime = Date.now();
        
        // 系統資訊
        document.getElementById('test-time').textContent = new Date().toLocaleString('zh-TW');
        document.getElementById('user-agent').textContent = navigator.userAgent.substring(0, 100) + '...';
        
        window.addEventListener('load', () => {
            const loadTime = Date.now() - testStartTime;
            document.getElementById('load-time').textContent = `${loadTime}ms`;
        });

        // 格式化大數字
        function formatLargeNumber(num) {
            if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
            return num.toFixed(2);
        }

        // 更新測試狀態
        function updateTestStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `test-status ${status}`;
                element.textContent = message;
            }
        }

        // 1. API 端點測試
        async function testAPIs() {
            const apis = [
                { name: '健康檢查', url: '/health' },
                { name: '市場統計', url: '/api/market/stats24h' },
                { name: '熱門貨幣', url: '/api/market/trending?limit=10' },
                { name: '批量價格', url: '/api/market/batch-prices?symbols=BTCUSDT,ETHUSDT' }
            ];

            let results = '';
            for (const api of apis) {
                try {
                    const response = await fetch(api.url);
                    const data = await response.json();
                    if (data.success !== false) {
                        results += `<div class="test-status success">✅ ${api.name}: 正常</div>`;
                    } else {
                        results += `<div class="test-status error">❌ ${api.name}: ${data.message}</div>`;
                    }
                } catch (error) {
                    results += `<div class="test-status error">❌ ${api.name}: ${error.message}</div>`;
                }
            }
            document.getElementById('api-test-results').innerHTML = results;
        }

        // 2. 載入市場統計
        async function loadMarketStats() {
            try {
                const response = await fetch('/api/market/stats24h');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const stats = result.data;
                    document.getElementById('market-stats').innerHTML = `
                        <div class="market-stat">
                            <div class="stat-label">總交易對數量</div>
                            <div class="stat-value">${stats.totalCoins || 0}</div>
                        </div>
                        <div class="market-stat">
                            <div class="stat-label">24h 平均變化</div>
                            <div class="stat-value ${stats.avgChange >= 0 ? 'positive' : 'negative'}">
                                ${stats.avgChange ? stats.avgChange.toFixed(2) : '0.00'}%
                            </div>
                        </div>
                        <div class="market-stat">
                            <div class="stat-label">上漲貨幣</div>
                            <div class="stat-value positive">${stats.gainersCount || 0}</div>
                        </div>
                        <div class="market-stat">
                            <div class="stat-label">下跌貨幣</div>
                            <div class="stat-value negative">${stats.losersCount || 0}</div>
                        </div>
                        <div class="market-stat">
                            <div class="stat-label">24h 總交易量</div>
                            <div class="stat-value">${formatLargeNumber(stats.totalVolume || 0)}</div>
                        </div>
                    `;
                } else {
                    updateTestStatus('market-stats', 'error', '❌ 載入市場統計失敗');
                }
            } catch (error) {
                console.error('載入市場統計失敗:', error);
                updateTestStatus('market-stats', 'error', `❌ 載入失敗: ${error.message}`);
            }
        }

        // 3. 初始化 CryptoCurrencyList 組件
        function initializeCryptoList() {
            try {
                if (typeof CryptoCurrencyList === 'undefined') {
                    updateTestStatus('crypto-list-status', 'error', '❌ CryptoCurrencyList 組件未載入');
                    return;
                }

                const container = document.getElementById('market-coins-grid');
                if (!container) {
                    updateTestStatus('crypto-list-status', 'error', '❌ 找不到容器元素');
                    return;
                }

                updateTestStatus('crypto-list-status', 'loading', '⏳ 初始化 CryptoCurrencyList...');

                const cryptoList = new CryptoCurrencyList({
                    container: container,
                    mode: 'infinite',
                    maxCoins: 50,  // 測試時只載入 50 個
                    coinsPerPage: 25,
                    updateInterval: 15000,
                    onCoinClick: (coin) => {
                        console.log('測試: 點擊貨幣', coin);
                        alert(`點擊了: ${coin.symbol}`);
                    }
                });

                // 監聽組件狀態
                setTimeout(() => {
                    const hasCoins = container.children.length > 0;
                    if (hasCoins) {
                        updateTestStatus('crypto-list-status', 'success', `✅ CryptoCurrencyList 組件載入成功 (${container.children.length} 個項目)`);
                    } else {
                        updateTestStatus('crypto-list-status', 'error', '❌ CryptoCurrencyList 組件無法載入數據');
                    }
                }, 3000);

            } catch (error) {
                console.error('初始化 CryptoCurrencyList 失敗:', error);
                updateTestStatus('crypto-list-status', 'error', `❌ 初始化失敗: ${error.message}`);
            }
        }

        // 4. 創建 TradingView Widget
        function createTradingViewWidget(containerId, config) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`找不到容器: ${containerId}`);
                return;
            }
            
            // 清理現有內容
            container.innerHTML = '';
            
            // 建立 Widget 容器
            const widgetContainer = document.createElement('div');
            widgetContainer.className = 'tradingview-widget-container';
            
            const widgetDiv = document.createElement('div');
            widgetDiv.className = 'tradingview-widget-container__widget';
            
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js';
            script.async = true;
            script.innerHTML = JSON.stringify(config);
            
            widgetContainer.appendChild(widgetDiv);
            widgetContainer.appendChild(script);
            container.appendChild(widgetContainer);
            
            console.log(`創建 TradingView Widget: ${containerId}`, config);
        }

        // 5. 初始化 TradingView Widgets
        function initializeTradingViewWidgets() {
            try {
                updateTestStatus('tradingview-status', 'loading', '⏳ 載入 TradingView Widgets...');

                const widgets = [
                    { symbol: "BINANCE:BTCUSDT", name: "Bitcoin" },
                    { symbol: "BINANCE:ETHUSDT", name: "Ethereum" },
                    { symbol: "BINANCE:BNBUSDT", name: "BNB" },
                    { symbol: "BINANCE:ADAUSDT", name: "Cardano" }
                ];

                let successCount = 0;
                widgets.forEach((widget, index) => {
                    const containerId = `tradingview-widget-${index}`;
                    
                    createTradingViewWidget(containerId, {
                        symbol: widget.symbol,
                        width: "100%",
                        height: "300",
                        locale: "en",
                        dateRange: "12M",
                        colorTheme: "dark",
                        isTransparent: false,
                        autosize: false,
                        largeChartUrl: ""
                    });
                    
                    successCount++;
                });

                setTimeout(() => {
                    updateTestStatus('tradingview-status', 'success', `✅ 已載入 ${successCount} 個 TradingView Widgets`);
                }, 2000);

            } catch (error) {
                console.error('初始化 TradingView Widgets 失敗:', error);
                updateTestStatus('tradingview-status', 'error', `❌ 初始化失敗: ${error.message}`);
            }
        }

        // 執行所有測試
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🧪 開始市場頁面整合測試...');
            
            // 按順序執行測試
            await testAPIs();
            await loadMarketStats();
            
            // 延遲初始化組件，確保 DOM 準備就緒
            setTimeout(() => {
                initializeCryptoList();
                initializeTradingViewWidgets();
            }, 1000);
        });
    </script>
</body>
</html>