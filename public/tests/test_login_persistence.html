<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登入狀態持久性測試 - NexusTrade</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover { background: #0056b3; }
        .button.success { background: #28a745; }
        .button.warning { background: #ffc107; color: #212529; }
        .button.danger { background: #dc3545; }
        
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .status.warning { background: #fff3cd; color: #856404; }
        
        h1 { color: #333; }
        h2 { color: #555; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        
        .highlight {
            background: #ffffcc;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>🔍 登入狀態持久性診斷</h1>
    
    <div class="status info">
        <strong>問題</strong>: Google 登入成功並顯示頭像，但重新載入後變回登出狀態
    </div>
    
    <div class="section">
        <h2>📊 當前認證狀態檢查</h2>
        <button class="button" onclick="checkCurrentAuthState()">檢查當前狀態</button>
        <button class="button warning" onclick="refreshPage()">重新載入頁面</button>
        <div id="auth-state-result" class="result">點擊檢查當前認證狀態...</div>
    </div>
    
    <div class="section">
        <h2>🗄️ localStorage 資料檢查</h2>
        <button class="button" onclick="checkLocalStorage()">檢查 localStorage</button>
        <button class="button success" onclick="simulateLogin()">模擬登入數據</button>
        <button class="button danger" onclick="clearAllStorage()">清除所有數據</button>
        <div id="storage-result" class="result">點擊檢查 localStorage 數據...</div>
    </div>
    
    <div class="section">
        <h2>🔧 Token 驗證測試</h2>
        <button class="button" onclick="testTokenVerification()">測試 Token 驗證</button>
        <button class="button" onclick="testTokenExpiry()">檢查 Token 過期</button>
        <div id="token-result" class="result">點擊測試 Token 驗證...</div>
    </div>
    
    <div class="section">
        <h2>⚡ 初始化流程測試</h2>
        <button class="button" onclick="testInitializationFlow()">測試初始化流程</button>
        <button class="button" onclick="testUIUpdate()">測試 UI 更新</button>
        <div id="init-result" class="result">點擊測試初始化流程...</div>
    </div>

    <!-- 載入必要腳本 -->
    <script src="/js/lib/api.js"></script>
    <script src="/js/lib/dom.js"></script>
    <script src="/js/lib/router.js"></script>
    <script src="/js/lib/auth-state-manager.js"></script>
    <script src="/js/state/store.js"></script>
    <script src="/js/components/Notification.js"></script>
    <script src="/js/components/LoginModal.js"></script>

    <script>
        function log(elementId, message, append = true) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            
            if (append) {
                element.textContent += logMessage;
            } else {
                element.textContent = logMessage;
            }
            element.scrollTop = element.scrollHeight;
        }

        // 檢查當前認證狀態
        function checkCurrentAuthState() {
            log('auth-state-result', '=== 檢查當前認證狀態 ===', false);
            
            // 1. 檢查全域變數
            log('auth-state-result', `window.app: ${typeof window.app !== 'undefined'}`);
            log('auth-state-result', `window.loginModal: ${typeof window.loginModal !== 'undefined'}`);
            log('auth-state-result', `LoginModal 類別: ${typeof LoginModal !== 'undefined'}`);
            
            // 2. 檢查 UI 狀態
            const loginBtn = document.getElementById('login-btn');
            const userMenu = document.querySelector('.user-menu');
            
            log('auth-state-result', `登入按鈕存在: ${!!loginBtn}`);
            log('auth-state-result', `使用者選單存在: ${!!userMenu}`);
            
            if (loginBtn) {
                log('auth-state-result', `登入按鈕可見: ${loginBtn.style.display !== 'none'}`);
            }
            
            if (userMenu) {
                log('auth-state-result', `使用者選單可見: ${userMenu.style.display !== 'none'}`);
                const userName = userMenu.querySelector('.user-name');
                if (userName) {
                    log('auth-state-result', `顯示的使用者名稱: "${userName.textContent}"`);
                }
            }
            
            // 3. 檢查認證狀態管理器
            if (window.authStateManager) {
                try {
                    const token = window.authStateManager.getToken();
                    const user = window.authStateManager.getUser();
                    log('auth-state-result', `AuthStateManager token: ${token ? '存在' : '不存在'}`);
                    log('auth-state-result', `AuthStateManager user: ${user ? user.name || '存在' : '不存在'}`);
                } catch (error) {
                    log('auth-state-result', `AuthStateManager 錯誤: ${error.message}`);
                }
            }
        }

        // 檢查 localStorage
        function checkLocalStorage() {
            log('storage-result', '=== 檢查 localStorage 數據 ===', false);
            
            const keys = [
                'nexustrade_token',
                'nexustrade_user', 
                'nexustrade_refresh_token',
                'nexustrade_line_bound',
                'nexustrade_return_state',
                'token',
                'userInfo',
                'refreshToken'
            ];
            
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    if (key.includes('token')) {
                        // 只顯示 token 的前 20 個字符
                        log('storage-result', `${key}: ${value.substring(0, 20)}...`);
                    } else {
                        log('storage-result', `${key}: ${value.substring(0, 100)}${value.length > 100 ? '...' : ''}`);
                    }
                } else {
                    log('storage-result', `${key}: (空)`);
                }
            });
            
            // 檢查 sessionStorage
            log('storage-result', '\n=== sessionStorage ===');
            keys.forEach(key => {
                const value = sessionStorage.getItem(key);
                if (value) {
                    log('storage-result', `${key}: ${value.substring(0, 50)}...`);
                }
            });
        }

        // 模擬登入數據
        function simulateLogin() {
            log('storage-result', '=== 模擬登入數據 ===', false);
            
            const mockToken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IlRlc3QgVXNlciIsImV4cCI6OTk5OTk5OTk5OX0.test';
            const mockUser = {
                id: '123456',
                name: 'Test User',
                email: 'test@example.com',
                avatar: 'https://via.placeholder.com/40',
                provider: 'google'
            };
            
            localStorage.setItem('nexustrade_token', mockToken);
            localStorage.setItem('nexustrade_user', JSON.stringify(mockUser));
            
            log('storage-result', '✅ 已設置模擬登入數據');
            log('storage-result', '請重新載入頁面測試持久性');
        }

        // 清除所有存儲
        function clearAllStorage() {
            log('storage-result', '=== 清除所有數據 ===', false);
            
            localStorage.clear();
            sessionStorage.clear();
            
            log('storage-result', '✅ 已清除所有 localStorage 和 sessionStorage 數據');
        }

        // 測試 Token 驗證
        async function testTokenVerification() {
            log('token-result', '=== 測試 Token 驗證 ===', false);
            
            const token = localStorage.getItem('nexustrade_token');
            
            if (!token) {
                log('token-result', '❌ 沒有找到 token');
                return;
            }
            
            log('token-result', `Token 存在: ${token.substring(0, 20)}...`);
            
            try {
                // 解析 token
                const parts = token.split('.');
                if (parts.length === 3) {
                    const payload = JSON.parse(atob(parts[1]));
                    log('token-result', `Token 過期時間: ${new Date(payload.exp * 1000).toLocaleString()}`);
                    log('token-result', `Token 是否過期: ${payload.exp * 1000 <= Date.now()}`);
                    log('token-result', `Token 使用者: ${payload.name || payload.sub || 'N/A'}`);
                }
                
                // 測試伺服器驗證
                log('token-result', '\n測試伺服器驗證...');
                const response = await fetch('/api/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                log('token-result', `伺服器驗證回應: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('token-result', `✅ 伺服器驗證成功: ${JSON.stringify(data, null, 2)}`);
                } else {
                    const errorText = await response.text();
                    log('token-result', `❌ 伺服器驗證失敗: ${errorText}`);
                }
                
            } catch (error) {
                log('token-result', `❌ Token 驗證錯誤: ${error.message}`);
            }
        }

        // 檢查 Token 過期
        function testTokenExpiry() {
            log('token-result', '=== 檢查 Token 過期邏輯 ===', false);
            
            const token = localStorage.getItem('nexustrade_token');
            
            if (!token) {
                log('token-result', '❌ 沒有找到 token');
                return;
            }
            
            try {
                const parts = token.split('.');
                if (parts.length !== 3) {
                    log('token-result', '❌ Token 格式無效');
                    return;
                }
                
                const payload = JSON.parse(atob(parts[1]));
                const now = Date.now();
                const expiry = payload.exp * 1000;
                
                log('token-result', `當前時間: ${new Date(now).toLocaleString()}`);
                log('token-result', `Token 過期時間: ${new Date(expiry).toLocaleString()}`);
                log('token-result', `剩餘時間: ${Math.round((expiry - now) / 1000 / 60)} 分鐘`);
                log('token-result', `是否過期: ${expiry <= now}`);
                
                if (expiry <= now) {
                    log('token-result', '⚠️ Token 已過期，這可能是問題原因');
                } else {
                    log('token-result', '✅ Token 尚未過期');
                }
                
            } catch (error) {
                log('token-result', `❌ Token 解析錯誤: ${error.message}`);
            }
        }

        // 測試初始化流程
        function testInitializationFlow() {
            log('init-result', '=== 測試初始化流程 ===', false);
            
            try {
                // 檢查 LoginModal 初始化
                if (typeof LoginModal !== 'undefined') {
                    log('init-result', '✅ LoginModal 類別已載入');
                    
                    // 創建新實例測試
                    const testModal = new LoginModal();
                    log('init-result', '✅ LoginModal 實例創建成功');
                    
                    // 測試狀態檢查方法
                    if (typeof testModal.checkAndUpdateUIState === 'function') {
                        log('init-result', '測試 checkAndUpdateUIState 方法...');
                        
                        testModal.checkAndUpdateUIState().then(() => {
                            log('init-result', '✅ checkAndUpdateUIState 執行完成');
                        }).catch(error => {
                            log('init-result', `❌ checkAndUpdateUIState 錯誤: ${error.message}`);
                        });
                    }
                    
                } else {
                    log('init-result', '❌ LoginModal 類別未載入');
                }
                
                // 檢查應用程式初始化
                if (window.app) {
                    log('init-result', `✅ 主應用程式已載入: ${typeof window.app}`);
                    
                    if (window.app.loginModal) {
                        log('init-result', '✅ 應用程式的 loginModal 實例存在');
                    } else {
                        log('init-result', '❌ 應用程式的 loginModal 實例不存在');
                    }
                } else {
                    log('init-result', '❌ 主應用程式未載入');
                }
                
            } catch (error) {
                log('init-result', `❌ 初始化測試錯誤: ${error.message}`);
            }
        }

        // 測試 UI 更新
        function testUIUpdate() {
            log('init-result', '=== 測試 UI 更新 ===', false);
            
            const mockUser = {
                id: '123',
                name: 'Test User',
                email: 'test@example.com',
                avatar: 'https://via.placeholder.com/40'
            };
            
            try {
                if (window.app && window.app.loginModal) {
                    log('init-result', '測試 updateUIForLoggedInUser...');
                    window.app.loginModal.updateUIForLoggedInUser(mockUser);
                    log('init-result', '✅ UI 更新完成');
                } else if (window.loginModal) {
                    log('init-result', '測試全域 loginModal 的 UI 更新...');
                    window.loginModal.updateUIForLoggedInUser(mockUser);
                    log('init-result', '✅ UI 更新完成');
                } else {
                    log('init-result', '❌ 找不到可用的 loginModal 實例');
                }
            } catch (error) {
                log('init-result', `❌ UI 更新錯誤: ${error.message}`);
            }
        }

        // 重新載入頁面
        function refreshPage() {
            log('auth-state-result', '⟳ 重新載入頁面...', true);
            setTimeout(() => {
                location.reload();
            }, 1000);
        }

        // 頁面載入時自動檢查
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔧 登入狀態持久性測試頁面已載入');
            
            // 延遲執行，確保所有腳本載入完成
            setTimeout(() => {
                checkCurrentAuthState();
                checkLocalStorage();
            }, 1000);
        });

        // 監聽錯誤
        window.addEventListener('error', function(event) {
            console.error('頁面錯誤:', event.error);
        });
    </script>
</body>
</html>