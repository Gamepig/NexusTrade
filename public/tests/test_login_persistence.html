<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å…¥ç‹€æ…‹æŒä¹…æ€§æ¸¬è©¦ - NexusTrade</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover { background: #0056b3; }
        .button.success { background: #28a745; }
        .button.warning { background: #ffc107; color: #212529; }
        .button.danger { background: #dc3545; }
        
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .status.warning { background: #fff3cd; color: #856404; }
        
        h1 { color: #333; }
        h2 { color: #555; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        
        .highlight {
            background: #ffffcc;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ç™»å…¥ç‹€æ…‹æŒä¹…æ€§è¨ºæ–·</h1>
    
    <div class="status info">
        <strong>å•é¡Œ</strong>: Google ç™»å…¥æˆåŠŸä¸¦é¡¯ç¤ºé ­åƒï¼Œä½†é‡æ–°è¼‰å…¥å¾Œè®Šå›ç™»å‡ºç‹€æ…‹
    </div>
    
    <div class="section">
        <h2>ğŸ“Š ç•¶å‰èªè­‰ç‹€æ…‹æª¢æŸ¥</h2>
        <button class="button" onclick="checkCurrentAuthState()">æª¢æŸ¥ç•¶å‰ç‹€æ…‹</button>
        <button class="button warning" onclick="refreshPage()">é‡æ–°è¼‰å…¥é é¢</button>
        <div id="auth-state-result" class="result">é»æ“Šæª¢æŸ¥ç•¶å‰èªè­‰ç‹€æ…‹...</div>
    </div>
    
    <div class="section">
        <h2>ğŸ—„ï¸ localStorage è³‡æ–™æª¢æŸ¥</h2>
        <button class="button" onclick="checkLocalStorage()">æª¢æŸ¥ localStorage</button>
        <button class="button success" onclick="simulateLogin()">æ¨¡æ“¬ç™»å…¥æ•¸æ“š</button>
        <button class="button danger" onclick="clearAllStorage()">æ¸…é™¤æ‰€æœ‰æ•¸æ“š</button>
        <div id="storage-result" class="result">é»æ“Šæª¢æŸ¥ localStorage æ•¸æ“š...</div>
    </div>
    
    <div class="section">
        <h2>ğŸ”§ Token é©—è­‰æ¸¬è©¦</h2>
        <button class="button" onclick="testTokenVerification()">æ¸¬è©¦ Token é©—è­‰</button>
        <button class="button" onclick="testTokenExpiry()">æª¢æŸ¥ Token éæœŸ</button>
        <div id="token-result" class="result">é»æ“Šæ¸¬è©¦ Token é©—è­‰...</div>
    </div>
    
    <div class="section">
        <h2>âš¡ åˆå§‹åŒ–æµç¨‹æ¸¬è©¦</h2>
        <button class="button" onclick="testInitializationFlow()">æ¸¬è©¦åˆå§‹åŒ–æµç¨‹</button>
        <button class="button" onclick="testUIUpdate()">æ¸¬è©¦ UI æ›´æ–°</button>
        <div id="init-result" class="result">é»æ“Šæ¸¬è©¦åˆå§‹åŒ–æµç¨‹...</div>
    </div>

    <!-- è¼‰å…¥å¿…è¦è…³æœ¬ -->
    <script src="/js/lib/api.js"></script>
    <script src="/js/lib/dom.js"></script>
    <script src="/js/lib/router.js"></script>
    <script src="/js/lib/auth-state-manager.js"></script>
    <script src="/js/state/store.js"></script>
    <script src="/js/components/Notification.js"></script>
    <script src="/js/components/LoginModal.js"></script>

    <script>
        function log(elementId, message, append = true) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            
            if (append) {
                element.textContent += logMessage;
            } else {
                element.textContent = logMessage;
            }
            element.scrollTop = element.scrollHeight;
        }

        // æª¢æŸ¥ç•¶å‰èªè­‰ç‹€æ…‹
        function checkCurrentAuthState() {
            log('auth-state-result', '=== æª¢æŸ¥ç•¶å‰èªè­‰ç‹€æ…‹ ===', false);
            
            // 1. æª¢æŸ¥å…¨åŸŸè®Šæ•¸
            log('auth-state-result', `window.app: ${typeof window.app !== 'undefined'}`);
            log('auth-state-result', `window.loginModal: ${typeof window.loginModal !== 'undefined'}`);
            log('auth-state-result', `LoginModal é¡åˆ¥: ${typeof LoginModal !== 'undefined'}`);
            
            // 2. æª¢æŸ¥ UI ç‹€æ…‹
            const loginBtn = document.getElementById('login-btn');
            const userMenu = document.querySelector('.user-menu');
            
            log('auth-state-result', `ç™»å…¥æŒ‰éˆ•å­˜åœ¨: ${!!loginBtn}`);
            log('auth-state-result', `ä½¿ç”¨è€…é¸å–®å­˜åœ¨: ${!!userMenu}`);
            
            if (loginBtn) {
                log('auth-state-result', `ç™»å…¥æŒ‰éˆ•å¯è¦‹: ${loginBtn.style.display !== 'none'}`);
            }
            
            if (userMenu) {
                log('auth-state-result', `ä½¿ç”¨è€…é¸å–®å¯è¦‹: ${userMenu.style.display !== 'none'}`);
                const userName = userMenu.querySelector('.user-name');
                if (userName) {
                    log('auth-state-result', `é¡¯ç¤ºçš„ä½¿ç”¨è€…åç¨±: "${userName.textContent}"`);
                }
            }
            
            // 3. æª¢æŸ¥èªè­‰ç‹€æ…‹ç®¡ç†å™¨
            if (window.authStateManager) {
                try {
                    const token = window.authStateManager.getToken();
                    const user = window.authStateManager.getUser();
                    log('auth-state-result', `AuthStateManager token: ${token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
                    log('auth-state-result', `AuthStateManager user: ${user ? user.name || 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
                } catch (error) {
                    log('auth-state-result', `AuthStateManager éŒ¯èª¤: ${error.message}`);
                }
            }
        }

        // æª¢æŸ¥ localStorage
        function checkLocalStorage() {
            log('storage-result', '=== æª¢æŸ¥ localStorage æ•¸æ“š ===', false);
            
            const keys = [
                'nexustrade_token',
                'nexustrade_user', 
                'nexustrade_refresh_token',
                'nexustrade_line_bound',
                'nexustrade_return_state',
                'token',
                'userInfo',
                'refreshToken'
            ];
            
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    if (key.includes('token')) {
                        // åªé¡¯ç¤º token çš„å‰ 20 å€‹å­—ç¬¦
                        log('storage-result', `${key}: ${value.substring(0, 20)}...`);
                    } else {
                        log('storage-result', `${key}: ${value.substring(0, 100)}${value.length > 100 ? '...' : ''}`);
                    }
                } else {
                    log('storage-result', `${key}: (ç©º)`);
                }
            });
            
            // æª¢æŸ¥ sessionStorage
            log('storage-result', '\n=== sessionStorage ===');
            keys.forEach(key => {
                const value = sessionStorage.getItem(key);
                if (value) {
                    log('storage-result', `${key}: ${value.substring(0, 50)}...`);
                }
            });
        }

        // æ¨¡æ“¬ç™»å…¥æ•¸æ“š
        function simulateLogin() {
            log('storage-result', '=== æ¨¡æ“¬ç™»å…¥æ•¸æ“š ===', false);
            
            const mockToken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IlRlc3QgVXNlciIsImV4cCI6OTk5OTk5OTk5OX0.test';
            const mockUser = {
                id: '123456',
                name: 'Test User',
                email: 'test@example.com',
                avatar: 'https://via.placeholder.com/40',
                provider: 'google'
            };
            
            localStorage.setItem('nexustrade_token', mockToken);
            localStorage.setItem('nexustrade_user', JSON.stringify(mockUser));
            
            log('storage-result', 'âœ… å·²è¨­ç½®æ¨¡æ“¬ç™»å…¥æ•¸æ“š');
            log('storage-result', 'è«‹é‡æ–°è¼‰å…¥é é¢æ¸¬è©¦æŒä¹…æ€§');
        }

        // æ¸…é™¤æ‰€æœ‰å­˜å„²
        function clearAllStorage() {
            log('storage-result', '=== æ¸…é™¤æ‰€æœ‰æ•¸æ“š ===', false);
            
            localStorage.clear();
            sessionStorage.clear();
            
            log('storage-result', 'âœ… å·²æ¸…é™¤æ‰€æœ‰ localStorage å’Œ sessionStorage æ•¸æ“š');
        }

        // æ¸¬è©¦ Token é©—è­‰
        async function testTokenVerification() {
            log('token-result', '=== æ¸¬è©¦ Token é©—è­‰ ===', false);
            
            const token = localStorage.getItem('nexustrade_token');
            
            if (!token) {
                log('token-result', 'âŒ æ²’æœ‰æ‰¾åˆ° token');
                return;
            }
            
            log('token-result', `Token å­˜åœ¨: ${token.substring(0, 20)}...`);
            
            try {
                // è§£æ token
                const parts = token.split('.');
                if (parts.length === 3) {
                    const payload = JSON.parse(atob(parts[1]));
                    log('token-result', `Token éæœŸæ™‚é–“: ${new Date(payload.exp * 1000).toLocaleString()}`);
                    log('token-result', `Token æ˜¯å¦éæœŸ: ${payload.exp * 1000 <= Date.now()}`);
                    log('token-result', `Token ä½¿ç”¨è€…: ${payload.name || payload.sub || 'N/A'}`);
                }
                
                // æ¸¬è©¦ä¼ºæœå™¨é©—è­‰
                log('token-result', '\næ¸¬è©¦ä¼ºæœå™¨é©—è­‰...');
                const response = await fetch('/api/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                log('token-result', `ä¼ºæœå™¨é©—è­‰å›æ‡‰: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('token-result', `âœ… ä¼ºæœå™¨é©—è­‰æˆåŠŸ: ${JSON.stringify(data, null, 2)}`);
                } else {
                    const errorText = await response.text();
                    log('token-result', `âŒ ä¼ºæœå™¨é©—è­‰å¤±æ•—: ${errorText}`);
                }
                
            } catch (error) {
                log('token-result', `âŒ Token é©—è­‰éŒ¯èª¤: ${error.message}`);
            }
        }

        // æª¢æŸ¥ Token éæœŸ
        function testTokenExpiry() {
            log('token-result', '=== æª¢æŸ¥ Token éæœŸé‚è¼¯ ===', false);
            
            const token = localStorage.getItem('nexustrade_token');
            
            if (!token) {
                log('token-result', 'âŒ æ²’æœ‰æ‰¾åˆ° token');
                return;
            }
            
            try {
                const parts = token.split('.');
                if (parts.length !== 3) {
                    log('token-result', 'âŒ Token æ ¼å¼ç„¡æ•ˆ');
                    return;
                }
                
                const payload = JSON.parse(atob(parts[1]));
                const now = Date.now();
                const expiry = payload.exp * 1000;
                
                log('token-result', `ç•¶å‰æ™‚é–“: ${new Date(now).toLocaleString()}`);
                log('token-result', `Token éæœŸæ™‚é–“: ${new Date(expiry).toLocaleString()}`);
                log('token-result', `å‰©é¤˜æ™‚é–“: ${Math.round((expiry - now) / 1000 / 60)} åˆ†é˜`);
                log('token-result', `æ˜¯å¦éæœŸ: ${expiry <= now}`);
                
                if (expiry <= now) {
                    log('token-result', 'âš ï¸ Token å·²éæœŸï¼Œé€™å¯èƒ½æ˜¯å•é¡ŒåŸå› ');
                } else {
                    log('token-result', 'âœ… Token å°šæœªéæœŸ');
                }
                
            } catch (error) {
                log('token-result', `âŒ Token è§£æéŒ¯èª¤: ${error.message}`);
            }
        }

        // æ¸¬è©¦åˆå§‹åŒ–æµç¨‹
        function testInitializationFlow() {
            log('init-result', '=== æ¸¬è©¦åˆå§‹åŒ–æµç¨‹ ===', false);
            
            try {
                // æª¢æŸ¥ LoginModal åˆå§‹åŒ–
                if (typeof LoginModal !== 'undefined') {
                    log('init-result', 'âœ… LoginModal é¡åˆ¥å·²è¼‰å…¥');
                    
                    // å‰µå»ºæ–°å¯¦ä¾‹æ¸¬è©¦
                    const testModal = new LoginModal();
                    log('init-result', 'âœ… LoginModal å¯¦ä¾‹å‰µå»ºæˆåŠŸ');
                    
                    // æ¸¬è©¦ç‹€æ…‹æª¢æŸ¥æ–¹æ³•
                    if (typeof testModal.checkAndUpdateUIState === 'function') {
                        log('init-result', 'æ¸¬è©¦ checkAndUpdateUIState æ–¹æ³•...');
                        
                        testModal.checkAndUpdateUIState().then(() => {
                            log('init-result', 'âœ… checkAndUpdateUIState åŸ·è¡Œå®Œæˆ');
                        }).catch(error => {
                            log('init-result', `âŒ checkAndUpdateUIState éŒ¯èª¤: ${error.message}`);
                        });
                    }
                    
                } else {
                    log('init-result', 'âŒ LoginModal é¡åˆ¥æœªè¼‰å…¥');
                }
                
                // æª¢æŸ¥æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–
                if (window.app) {
                    log('init-result', `âœ… ä¸»æ‡‰ç”¨ç¨‹å¼å·²è¼‰å…¥: ${typeof window.app}`);
                    
                    if (window.app.loginModal) {
                        log('init-result', 'âœ… æ‡‰ç”¨ç¨‹å¼çš„ loginModal å¯¦ä¾‹å­˜åœ¨');
                    } else {
                        log('init-result', 'âŒ æ‡‰ç”¨ç¨‹å¼çš„ loginModal å¯¦ä¾‹ä¸å­˜åœ¨');
                    }
                } else {
                    log('init-result', 'âŒ ä¸»æ‡‰ç”¨ç¨‹å¼æœªè¼‰å…¥');
                }
                
            } catch (error) {
                log('init-result', `âŒ åˆå§‹åŒ–æ¸¬è©¦éŒ¯èª¤: ${error.message}`);
            }
        }

        // æ¸¬è©¦ UI æ›´æ–°
        function testUIUpdate() {
            log('init-result', '=== æ¸¬è©¦ UI æ›´æ–° ===', false);
            
            const mockUser = {
                id: '123',
                name: 'Test User',
                email: 'test@example.com',
                avatar: 'https://via.placeholder.com/40'
            };
            
            try {
                if (window.app && window.app.loginModal) {
                    log('init-result', 'æ¸¬è©¦ updateUIForLoggedInUser...');
                    window.app.loginModal.updateUIForLoggedInUser(mockUser);
                    log('init-result', 'âœ… UI æ›´æ–°å®Œæˆ');
                } else if (window.loginModal) {
                    log('init-result', 'æ¸¬è©¦å…¨åŸŸ loginModal çš„ UI æ›´æ–°...');
                    window.loginModal.updateUIForLoggedInUser(mockUser);
                    log('init-result', 'âœ… UI æ›´æ–°å®Œæˆ');
                } else {
                    log('init-result', 'âŒ æ‰¾ä¸åˆ°å¯ç”¨çš„ loginModal å¯¦ä¾‹');
                }
            } catch (error) {
                log('init-result', `âŒ UI æ›´æ–°éŒ¯èª¤: ${error.message}`);
            }
        }

        // é‡æ–°è¼‰å…¥é é¢
        function refreshPage() {
            log('auth-state-result', 'âŸ³ é‡æ–°è¼‰å…¥é é¢...', true);
            setTimeout(() => {
                location.reload();
            }, 1000);
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”§ ç™»å…¥ç‹€æ…‹æŒä¹…æ€§æ¸¬è©¦é é¢å·²è¼‰å…¥');
            
            // å»¶é²åŸ·è¡Œï¼Œç¢ºä¿æ‰€æœ‰è…³æœ¬è¼‰å…¥å®Œæˆ
            setTimeout(() => {
                checkCurrentAuthState();
                checkLocalStorage();
            }, 1000);
        });

        // ç›£è½éŒ¯èª¤
        window.addEventListener('error', function(event) {
            console.error('é é¢éŒ¯èª¤:', event.error);
        });
    </script>
</body>
</html>