<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‰ æœ€çµ‚ä¿®å¾©é©—è­‰</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button.success {
            background: #28a745;
        }
        button.warning {
            background: #ffc107;
            color: #212529;
        }
        button.danger {
            background: #dc3545;
        }
        .test-container {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            min-height: 400px;
            background: white;
        }
        .console-output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .result-summary {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‰ åƒ¹æ ¼è­¦å ±ç³»çµ±æœ€çµ‚ä¿®å¾©é©—è­‰</h1>
        <p>é©—è­‰æ‰€æœ‰ä¿®å¾©é …ç›®ï¼šæ–°å¢æŒ‰éˆ•ã€å¤šæ¬¡å½ˆå‡ºé˜²è­·ã€æœƒå“¡é™åˆ¶ã€é…é¡è¨ˆç®—</p>

        <!-- é©—è­‰çµæœæ‘˜è¦ -->
        <div class="test-section">
            <h3>ğŸ“Š é©—è­‰çµæœæ‘˜è¦</h3>
            <div id="summary-result" class="result-summary">
                <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹é©—è­‰...</p>
            </div>
        </div>

        <!-- å®Œæ•´é©—è­‰æµç¨‹ -->
        <div class="test-section">
            <h3>ğŸ§ª å®Œæ•´é©—è­‰æµç¨‹</h3>
            <button onclick="runCompleteVerification()" class="success">ğŸš€ åŸ·è¡Œå®Œæ•´é©—è­‰</button>
            <button onclick="testNewAlertCreation()" style="background: #17a2b8;">â• æ¸¬è©¦æ–°å¢è­¦å ±</button>
            <button onclick="testQuotaLimit()" class="warning">ğŸ“ˆ æ¸¬è©¦é…é¡é™åˆ¶</button>
            <button onclick="clearConsole()">ğŸ§¹ æ¸…ç©ºæ§åˆ¶å°</button>
        </div>

        <!-- æ¸¬è©¦å®¹å™¨ -->
        <div class="test-section">
            <h3>ğŸ’» åƒ¹æ ¼è­¦å ±æ¸¬è©¦å®¹å™¨</h3>
            <div id="test-container" class="test-container">
                <div id="price-alerts-page">
                    <div class="page-header">
                        <h1>ğŸ’° åƒ¹æ ¼è­¦å ±</h1>
                        <p>ç®¡ç†ä½ çš„åƒ¹æ ¼æé†’èˆ‡é€šçŸ¥è¨­å®š</p>
                    </div>
                    <div id="price-alerts-content" class="page-content">
                        <div class="loading-spinner">æº–å‚™è¼‰å…¥æ¸¬è©¦...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶å°è¼¸å‡º -->
        <div class="test-section">
            <h3>ğŸ“ æ¸¬è©¦æ—¥èªŒ</h3>
            <div id="console-output" class="console-output"></div>
        </div>
    </div>

    <!-- è¼‰å…¥å¿…è¦çš„çµ„ä»¶ -->
    <script src="/js/components/PriceAlertsPage.js"></script>

    <script>
        let consoleOutput = document.getElementById('console-output');
        let originalConsole = { ...console };
        let priceAlertsPageInstance = null;
        let verificationResults = {
            loginUI: false,
            alertLoading: false,
            addButton: false,
            modalPrevention: false,
            quotaCalculation: false
        };

        // åŠ«æŒ console è¼¸å‡º
        function interceptConsole() {
            ['log', 'error', 'warn', 'info'].forEach(method => {
                console[method] = function(...args) {
                    originalConsole[method].apply(console, args);
                    appendToConsole(`[${method.toUpperCase()}] ${args.join(' ')}`);
                };
            });
        }

        function appendToConsole(message) {
            const timestamp = new Date().toLocaleTimeString();
            consoleOutput.innerHTML += `[${timestamp}] ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        function clearConsole() {
            consoleOutput.innerHTML = '';
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summary-result');
            const totalTests = Object.keys(verificationResults).length;
            const passedTests = Object.values(verificationResults).filter(Boolean).length;
            
            let summaryHTML = `<h4>ğŸ“ˆ é©—è­‰é€²åº¦: ${passedTests}/${totalTests} é …é€šé</h4><ul>`;
            
            summaryHTML += `<li>${verificationResults.loginUI ? 'âœ…' : 'âŒ'} ç™»å…¥æç¤ºç•Œé¢</li>`;
            summaryHTML += `<li>${verificationResults.alertLoading ? 'âœ…' : 'âŒ'} è­¦å ±æ•¸æ“šè¼‰å…¥</li>`;
            summaryHTML += `<li>${verificationResults.addButton ? 'âœ…' : 'âŒ'} æ–°å¢æŒ‰éˆ•åŠŸèƒ½</li>`;
            summaryHTML += `<li>${verificationResults.modalPrevention ? 'âœ…' : 'âŒ'} å¤šæ¬¡å½ˆå‡ºé˜²è­·</li>`;
            summaryHTML += `<li>${verificationResults.quotaCalculation ? 'âœ…' : 'âŒ'} é…é¡è¨ˆç®—é‚è¼¯</li>`;
            
            summaryHTML += '</ul>';
            
            if (passedTests === totalTests) {
                summaryHTML += '<p style="color: green; font-weight: bold;">ğŸ‰ æ‰€æœ‰é©—è­‰é …ç›®é€šéï¼</p>';
            } else {
                summaryHTML += `<p style="color: orange;">âš ï¸ é‚„æœ‰ ${totalTests - passedTests} é …éœ€è¦é©—è­‰</p>`;
            }
            
            summaryDiv.innerHTML = summaryHTML;
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            interceptConsole();
            appendToConsole('ğŸ‰ æœ€çµ‚ä¿®å¾©é©—è­‰å·¥å…·å·²æº–å‚™å°±ç·’');
            updateSummary();
        });

        // å®Œæ•´é©—è­‰æµç¨‹
        async function runCompleteVerification() {
            appendToConsole('ğŸš€ é–‹å§‹å®Œæ•´é©—è­‰æµç¨‹...');
            
            try {
                // 1. æ¸¬è©¦æœªç™»å…¥ç‹€æ…‹
                appendToConsole('ğŸ“‹ æ­¥é©Ÿ 1: æ¸¬è©¦æœªç™»å…¥ç™»å…¥æç¤ºç•Œé¢');
                await testLoginRequiredUI();
                
                // 2. è¨­ç½®èªè­‰ä¸¦æ¸¬è©¦
                appendToConsole('ğŸ“‹ æ­¥é©Ÿ 2: è¨­ç½®èªè­‰ä¸¦è¼‰å…¥è­¦å ±');
                await setupAuthAndTest();
                
                // 3. æ¸¬è©¦æ–°å¢æŒ‰éˆ•
                appendToConsole('ğŸ“‹ æ­¥é©Ÿ 3: æ¸¬è©¦æ–°å¢æŒ‰éˆ•åŠŸèƒ½');
                await testAddButtonFunction();
                
                // 4. æ¸¬è©¦é˜²è­·æ©Ÿåˆ¶
                appendToConsole('ğŸ“‹ æ­¥é©Ÿ 4: æ¸¬è©¦å¤šæ¬¡å½ˆå‡ºé˜²è­·');
                await testModalPrevention();
                
                appendToConsole('âœ… å®Œæ•´é©—è­‰æµç¨‹å®Œæˆ');
                updateSummary();
                
            } catch (error) {
                appendToConsole(`âŒ é©—è­‰æµç¨‹å¤±æ•—: ${error.message}`);
            }
        }

        async function testLoginRequiredUI() {
            // æ¸…é™¤èªè­‰
            localStorage.removeItem('nexustrade_token');
            localStorage.removeItem('nexustrade_user');
            
            // å‰µå»ºå¯¦ä¾‹ä¸¦åˆå§‹åŒ–
            priceAlertsPageInstance = new PriceAlertsPage();
            await priceAlertsPageInstance.init();
            
            // æª¢æŸ¥æ˜¯å¦é¡¯ç¤ºç™»å…¥æç¤º
            const loginRequired = document.querySelector('.login-required-container');
            if (loginRequired) {
                appendToConsole('âœ… ç™»å…¥æç¤ºç•Œé¢æ­£ç¢ºé¡¯ç¤º');
                verificationResults.loginUI = true;
            } else {
                appendToConsole('âŒ ç™»å…¥æç¤ºç•Œé¢æœªé¡¯ç¤º');
            }
        }

        async function setupAuthAndTest() {
            // è¨­ç½®èªè­‰
            const mockToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2ODY3YmM4NTJiODMxNmUwZDRiN2YyY2EiLCJlbWFpbCI6ImxpbmVfdWU1Y2MxODhlMWQyY2RiYWM1Y2ZkYTJhYmI2ZjZhMzRiQGV4YW1wbGUuY29tIiwibGluZUlkIjoiVWU1Y2MxODhlMWQyY2RiYWM1Y2ZkYTJhYmI2ZjZhMzRiIiwibGluZVVzZXJJZCI6IlVlNWNjMTg4ZTFkMmNkYmFjNWNmZGEyYWJiNmY2YTM0YiIsImdvb2dsZUlkIjpudWxsLCJwcm92aWRlciI6ImxpbmUiLCJtZW1iZXJzaGlwIjoiZnJlZSIsImlhdCI6MTc1MTY0Njg0NiwiZXhwIjoxNzUyMjUxNjQ2fQ.QEUm4SeOwkrXPikpyTQmqQbaHHXr_m50wug0Ri9iFng';
            const mockUser = {
                _id: '6867bc852b8316e0d4b7f2ca',
                email: 'line_ue5cc188e1d2cdbac5cfda2abb6f6a34b@example.com',
                lineId: 'Ue5cc188e1d2cdbac5cfda2abb6f6a34b',
                lineUserId: 'Ue5cc188e1d2cdbac5cfda2abb6f6a34b',
                provider: 'line',
                membership: 'free'
            };

            localStorage.setItem('nexustrade_token', mockToken);
            localStorage.setItem('nexustrade_user', JSON.stringify(mockUser));
            
            // é‡æ–°åˆå§‹åŒ–
            priceAlertsPageInstance = new PriceAlertsPage();
            await priceAlertsPageInstance.init();
            
            // æª¢æŸ¥è­¦å ±è¼‰å…¥
            if (priceAlertsPageInstance.alerts.length >= 0) {
                appendToConsole(`âœ… è­¦å ±æ•¸æ“šè¼‰å…¥æˆåŠŸ: ${priceAlertsPageInstance.alerts.length} å€‹`);
                verificationResults.alertLoading = true;
            } else {
                appendToConsole('âŒ è­¦å ±æ•¸æ“šè¼‰å…¥å¤±æ•—');
            }
        }

        async function testAddButtonFunction() {
            const addBtn = document.getElementById('add-alert-btn');
            if (addBtn) {
                appendToConsole('âœ… æ–°å¢è­¦å ±æŒ‰éˆ•å­˜åœ¨');
                
                // æ¸¬è©¦é»æ“Š
                addBtn.click();
                
                // æª¢æŸ¥æ¨¡æ…‹æ¡†
                setTimeout(() => {
                    const modal = document.getElementById('create-alert-modal');
                    if (modal && (modal.style.display === 'flex' || modal.style.display === 'block')) {
                        appendToConsole('âœ… æ–°å¢è­¦å ±æ¨¡æ…‹æ¡†æ­£ç¢ºé¡¯ç¤º');
                        verificationResults.addButton = true;
                        
                        // é—œé–‰æ¨¡æ…‹æ¡†
                        modal.style.display = 'none';
                        priceAlertsPageInstance.isShowingModal = false;
                    } else {
                        appendToConsole('âŒ æ–°å¢è­¦å ±æ¨¡æ…‹æ¡†æœªé¡¯ç¤º');
                    }
                    updateSummary();
                }, 500);
            } else {
                appendToConsole('âŒ æ–°å¢è­¦å ±æŒ‰éˆ•ä¸å­˜åœ¨');
            }
        }

        async function testModalPrevention() {
            if (!priceAlertsPageInstance) return;
            
            // æ¸¬è©¦å¤šæ¬¡å¿«é€Ÿé»æ“Š
            appendToConsole('ğŸ”„ æ¸¬è©¦å¤šæ¬¡å¿«é€Ÿé»æ“Šé˜²è­·...');
            
            const addBtn = document.getElementById('add-alert-btn');
            if (addBtn) {
                // å¿«é€Ÿé»æ“Š 3 æ¬¡
                addBtn.click();
                addBtn.click();
                addBtn.click();
                
                setTimeout(() => {
                    const modals = document.querySelectorAll('#create-alert-modal[style*="flex"]');
                    if (modals.length <= 1) {
                        appendToConsole('âœ… å¤šæ¬¡å½ˆå‡ºé˜²è­·æ­£å¸¸å·¥ä½œ');
                        verificationResults.modalPrevention = true;
                    } else {
                        appendToConsole(`âŒ æª¢æ¸¬åˆ° ${modals.length} å€‹æ¨¡æ…‹æ¡†ï¼Œé˜²è­·å¤±æ•ˆ`);
                    }
                    updateSummary();
                }, 300);
            }
        }

        async function testNewAlertCreation() {
            appendToConsole('â• æ¸¬è©¦æ–°å¢è­¦å ±åŠŸèƒ½...');
            
            if (!priceAlertsPageInstance) {
                appendToConsole('âŒ è«‹å…ˆåŸ·è¡Œå®Œæ•´é©—è­‰');
                return;
            }
            
            const testAlert = {
                symbol: 'TESTUSDT',
                alertType: 'price_above',
                targetPrice: 100,
                notificationMethods: {
                    lineMessaging: { enabled: true }
                }
            };
            
            try {
                const success = await priceAlertsPageInstance.createAlert(testAlert);
                if (success) {
                    appendToConsole('âœ… æ¸¬è©¦è­¦å ±å‰µå»ºæˆåŠŸ');
                } else {
                    appendToConsole('â„¹ï¸ è­¦å ±å‰µå»ºè¢«é˜»æ“‹ (å¯èƒ½æ˜¯é…é¡é™åˆ¶)');
                }
            } catch (error) {
                appendToConsole(`âŒ æ¸¬è©¦è­¦å ±å‰µå»ºå¤±æ•—: ${error.message}`);
            }
        }

        async function testQuotaLimit() {
            appendToConsole('ğŸ“ˆ æ¸¬è©¦é…é¡é™åˆ¶é‚è¼¯...');
            
            // ç™¼é€ API è«‹æ±‚æ¸¬è©¦é…é¡
            const token = localStorage.getItem('nexustrade_token');
            if (!token) {
                appendToConsole('âŒ è«‹å…ˆè¨­ç½®èªè­‰ç‹€æ…‹');
                return;
            }
            
            try {
                const response = await fetch('/api/notifications/alerts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        symbol: 'QUOTATEST',
                        alertType: 'price_above',
                        targetPrice: 999,
                        notificationMethods: {
                            lineMessaging: { enabled: true }
                        }
                    })
                });
                
                const data = await response.json();
                
                if (response.status === 403 && data.code === 'QUOTA_EXCEEDED') {
                    appendToConsole('âœ… é…é¡é™åˆ¶æ­£ç¢ºå·¥ä½œ');
                    appendToConsole(`ğŸ“Š é…é¡è³‡è¨Š: ${data.quota.used}/${data.quota.limit}`);
                    verificationResults.quotaCalculation = true;
                } else if (response.ok) {
                    appendToConsole('âœ… è­¦å ±å‰µå»ºæˆåŠŸ (é…é¡æœªæ»¿)');
                    verificationResults.quotaCalculation = true;
                } else {
                    appendToConsole(`âš ï¸ å…¶ä»–éŒ¯èª¤: ${data.message}`);
                }
                
                updateSummary();
                
            } catch (error) {
                appendToConsole(`âŒ é…é¡æ¸¬è©¦å¤±æ•—: ${error.message}`);
            }
        }
    </script>
</body>
</html>