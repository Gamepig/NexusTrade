<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth ä¿®å¾©é©—è­‰ - NexusTrade</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover { background: #3367d6; }
        .test-button.success { background: #28a745; }
        .test-button.warning { background: #ffc107; color: #212529; }
        .test-button.danger { background: #dc3545; }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        
        .log-output {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        h1 { color: #333; margin-bottom: 10px; }
        h2 { color: #555; margin-bottom: 15px; font-size: 18px; }
        h3 { color: #666; margin-bottom: 10px; font-size: 16px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ OAuth èªè­‰ç³»çµ±ä¿®å¾©é©—è­‰</h1>
    <p><strong>ä¿®å¾©æ™‚é–“</strong>: 2025-06-30 æ™šä¸Š</p>
    
    <div class="grid">
        <!-- ç³»çµ±ç‹€æ…‹æª¢æŸ¥ -->
        <div class="test-section">
            <h3>ğŸš€ ç³»çµ±ç‹€æ…‹æª¢æŸ¥</h3>
            <button class="test-button" onclick="checkSystemStatus()">æª¢æŸ¥ç³»çµ±ç‹€æ…‹</button>
            <div id="system-status" class="status info">é»æ“Šæª¢æŸ¥ç³»çµ±æ˜¯å¦æ­£å¸¸é‹è¡Œ</div>
        </div>

        <!-- çµ„ä»¶è¼‰å…¥æª¢æŸ¥ -->
        <div class="test-section">
            <h3>ğŸ“¦ çµ„ä»¶è¼‰å…¥æª¢æŸ¥</h3>
            <button class="test-button" onclick="checkComponentLoading()">æª¢æŸ¥çµ„ä»¶è¼‰å…¥</button>
            <div id="component-status" class="status info">é»æ“Šæª¢æŸ¥ LoginModal ç­‰çµ„ä»¶</div>
        </div>

        <!-- èªè­‰ç‹€æ…‹ç®¡ç† -->
        <div class="test-section">
            <h3>ğŸ” èªè­‰ç‹€æ…‹ç®¡ç†</h3>
            <button class="test-button" onclick="checkAuthState()">æª¢æŸ¥èªè­‰ç‹€æ…‹</button>
            <button class="test-button warning" onclick="clearAuthState()">æ¸…é™¤èªè­‰ç‹€æ…‹</button>
            <div id="auth-status" class="status info">é»æ“Šæª¢æŸ¥ç•¶å‰èªè­‰ç‹€æ…‹</div>
        </div>

        <!-- äº‹ä»¶ç¶å®šæ¸¬è©¦ -->
        <div class="test-section">
            <h3>âš¡ äº‹ä»¶ç¶å®šæ¸¬è©¦</h3>
            <button class="test-button" onclick="testEventBinding()">æ¸¬è©¦äº‹ä»¶ç¶å®š</button>
            <div id="event-status" class="status info">é»æ“Šæ¸¬è©¦ç™»å…¥æŒ‰éˆ•äº‹ä»¶</div>
        </div>

        <!-- OAuth ç«¯é»æ¸¬è©¦ -->
        <div class="test-section">
            <h3>ğŸŒ OAuth ç«¯é»æ¸¬è©¦</h3>
            <button class="test-button" onclick="testOAuthEndpoints()">æ¸¬è©¦ OAuth ç«¯é»</button>
            <div id="oauth-status" class="status info">é»æ“Šæ¸¬è©¦å¾Œç«¯ OAuth ç«¯é»</div>
        </div>

        <!-- æ¨¡æ…‹æ¡†é¡¯ç¤ºæ¸¬è©¦ -->
        <div class="test-section">
            <h3>ğŸ­ æ¨¡æ…‹æ¡†é¡¯ç¤ºæ¸¬è©¦</h3>
            <button class="test-button" onclick="testModalDisplay()">é¡¯ç¤ºç™»å…¥æ¨¡æ…‹æ¡†</button>
            <button class="test-button danger" onclick="hideModal()">é—œé–‰æ¨¡æ…‹æ¡†</button>
            <div id="modal-status" class="status info">é»æ“Šæ¸¬è©¦æ¨¡æ…‹æ¡†é¡¯ç¤º/éš±è—</div>
        </div>

        <!-- æ¸¬è©¦æ—¥èªŒ -->
        <div class="test-section full-width">
            <h3>ğŸ“‹ æ¸¬è©¦æ—¥èªŒ</h3>
            <button class="test-button warning" onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
            <button class="test-button" onclick="runAllTests()">åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦</button>
            <div id="log" class="log-output">æ¸¬è©¦æ—¥èªŒå°‡é¡¯ç¤ºåœ¨é€™è£¡...\n</div>
        </div>
    </div>

    <script>
        let testResults = {};

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`OAuth Test - ${logEntry}`);
        }

        function clearLog() {
            document.getElementById('log').textContent = 'æ¸¬è©¦æ—¥èªŒå°‡é¡¯ç¤ºåœ¨é€™è£¡...\n';
            testResults = {};
        }

        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = message;
        }

        // 1. ç³»çµ±ç‹€æ…‹æª¢æŸ¥
        async function checkSystemStatus() {
            log('é–‹å§‹æª¢æŸ¥ç³»çµ±ç‹€æ…‹...', 'info');
            
            try {
                // æª¢æŸ¥å‰ç«¯æœå‹™
                const frontendResponse = await fetch('/');
                const frontendOk = frontendResponse.ok;
                
                // æª¢æŸ¥å¾Œç«¯ API
                const backendResponse = await fetch('/auth/google', { redirect: 'manual' });
                const backendOk = backendResponse.status === 302 || backendResponse.type === 'opaqueredirect';
                
                if (frontendOk && backendOk) {
                    updateStatus('system-status', 'success', 'âœ… å‰ç«¯å’Œå¾Œç«¯æœå‹™éƒ½æ­£å¸¸é‹è¡Œ');
                    log('ç³»çµ±ç‹€æ…‹æª¢æŸ¥ï¼šå‰ç«¯å’Œå¾Œç«¯éƒ½æ­£å¸¸', 'success');
                    testResults.systemStatus = true;
                } else {
                    updateStatus('system-status', 'error', `âŒ æœå‹™ç•°å¸¸ - å‰ç«¯:${frontendOk} å¾Œç«¯:${backendOk}`);
                    log(`ç³»çµ±ç‹€æ…‹æª¢æŸ¥å¤±æ•— - å‰ç«¯:${frontendOk} å¾Œç«¯:${backendOk}`, 'error');
                    testResults.systemStatus = false;
                }
            } catch (error) {
                updateStatus('system-status', 'error', `âŒ ç³»çµ±æª¢æŸ¥å¤±æ•—: ${error.message}`);
                log(`ç³»çµ±ç‹€æ…‹æª¢æŸ¥éŒ¯èª¤: ${error.message}`, 'error');
                testResults.systemStatus = false;
            }
        }

        // 2. çµ„ä»¶è¼‰å…¥æª¢æŸ¥
        function checkComponentLoading() {
            log('é–‹å§‹æª¢æŸ¥çµ„ä»¶è¼‰å…¥...', 'info');
            
            const checks = {
                LoginModal: typeof LoginModal !== 'undefined',
                loginModalInstance: typeof window.loginModal !== 'undefined',
                app: typeof window.app !== 'undefined',
                authStateManager: typeof window.authStateManager !== 'undefined'
            };
            
            const allLoaded = Object.values(checks).every(Boolean);
            
            if (allLoaded) {
                updateStatus('component-status', 'success', 'âœ… æ‰€æœ‰æ ¸å¿ƒçµ„ä»¶å·²è¼‰å…¥');
                log('çµ„ä»¶è¼‰å…¥æª¢æŸ¥ï¼šæ‰€æœ‰çµ„ä»¶éƒ½æ­£å¸¸è¼‰å…¥', 'success');
                testResults.componentLoading = true;
            } else {
                const missing = Object.entries(checks)
                    .filter(([, loaded]) => !loaded)
                    .map(([name]) => name);
                updateStatus('component-status', 'warning', `âš ï¸ ç¼ºå°‘çµ„ä»¶: ${missing.join(', ')}`);
                log(`çµ„ä»¶è¼‰å…¥æª¢æŸ¥ï¼šç¼ºå°‘ ${missing.join(', ')}`, 'warning');
                testResults.componentLoading = false;
            }
            
            log(`çµ„ä»¶è©³æƒ…: ${JSON.stringify(checks, null, 2)}`, 'info');
        }

        // 3. èªè­‰ç‹€æ…‹æª¢æŸ¥
        function checkAuthState() {
            log('é–‹å§‹æª¢æŸ¥èªè­‰ç‹€æ…‹...', 'info');
            
            const tokens = {
                nexustrade_token: localStorage.getItem('nexustrade_token'),
                nexustrade_user: localStorage.getItem('nexustrade_user'),
                token: localStorage.getItem('token'),
                userInfo: localStorage.getItem('userInfo')
            };
            
            const hasAuth = Object.values(tokens).some(Boolean);
            
            if (hasAuth) {
                updateStatus('auth-status', 'success', 'âœ… ç™¼ç¾èªè­‰æ•¸æ“š');
                log('èªè­‰ç‹€æ…‹æª¢æŸ¥ï¼šç™¼ç¾å·²ä¿å­˜çš„èªè­‰æ•¸æ“š', 'success');
                testResults.authState = true;
            } else {
                updateStatus('auth-status', 'info', 'â„¹ï¸ æœªç™¼ç¾èªè­‰æ•¸æ“šï¼ˆæ­£å¸¸ï¼Œæœªç™»å…¥ï¼‰');
                log('èªè­‰ç‹€æ…‹æª¢æŸ¥ï¼šæœªç™¼ç¾èªè­‰æ•¸æ“š', 'info');
                testResults.authState = null;
            }
            
            log(`èªè­‰æ•¸æ“šè©³æƒ…: ${JSON.stringify(tokens, null, 2)}`, 'info');
        }

        // æ¸…é™¤èªè­‰ç‹€æ…‹
        function clearAuthState() {
            log('æ¸…é™¤èªè­‰ç‹€æ…‹...', 'info');
            
            if (window.loginModal && typeof window.loginModal.clearTokensFromStorage === 'function') {
                window.loginModal.clearTokensFromStorage();
                updateStatus('auth-status', 'warning', 'âš ï¸ èªè­‰ç‹€æ…‹å·²æ¸…é™¤');
                log('èªè­‰ç‹€æ…‹å·²é€šé LoginModal æ¸…é™¤', 'success');
            } else {
                // æ‰‹å‹•æ¸…é™¤
                const keys = ['nexustrade_token', 'nexustrade_user', 'token', 'userInfo', 'nexustrade_refresh_token'];
                keys.forEach(key => localStorage.removeItem(key));
                updateStatus('auth-status', 'warning', 'âš ï¸ èªè­‰ç‹€æ…‹å·²æ‰‹å‹•æ¸…é™¤');
                log('èªè­‰ç‹€æ…‹å·²æ‰‹å‹•æ¸…é™¤', 'success');
            }
        }

        // 4. äº‹ä»¶ç¶å®šæ¸¬è©¦
        function testEventBinding() {
            log('é–‹å§‹æ¸¬è©¦äº‹ä»¶ç¶å®š...', 'info');
            
            const loginBtn = document.getElementById('login-btn');
            
            if (!loginBtn) {
                updateStatus('event-status', 'error', 'âŒ æ‰¾ä¸åˆ°ç™»å…¥æŒ‰éˆ•');
                log('äº‹ä»¶ç¶å®šæ¸¬è©¦ï¼šæ‰¾ä¸åˆ° login-btn å…ƒç´ ', 'error');
                testResults.eventBinding = false;
                return;
            }
            
            // æª¢æŸ¥äº‹ä»¶ç›£è½å™¨
            const hasClickHandler = loginBtn.onclick || (getEventListeners && getEventListeners(loginBtn).click);
            
            if (hasClickHandler || window.app) {
                updateStatus('event-status', 'success', 'âœ… ç™»å…¥æŒ‰éˆ•äº‹ä»¶å·²ç¶å®š');
                log('äº‹ä»¶ç¶å®šæ¸¬è©¦ï¼šç™»å…¥æŒ‰éˆ•äº‹ä»¶æ­£å¸¸', 'success');
                testResults.eventBinding = true;
                
                // æ¨¡æ“¬é»æ“Šæ¸¬è©¦ï¼ˆä¸å¯¦éš›è§¸ç™¼ï¼‰
                log('å¯ä»¥å˜—è©¦é»æ“Šé é¢é ‚éƒ¨çš„ "ç™»å…¥" æŒ‰éˆ•æ¸¬è©¦', 'info');
            } else {
                updateStatus('event-status', 'warning', 'âš ï¸ ç„¡æ³•ç¢ºèªäº‹ä»¶ç¶å®šç‹€æ…‹');
                log('äº‹ä»¶ç¶å®šæ¸¬è©¦ï¼šç„¡æ³•ç¢ºèªäº‹ä»¶ç›£è½å™¨', 'warning');
                testResults.eventBinding = false;
            }
        }

        // 5. OAuth ç«¯é»æ¸¬è©¦
        async function testOAuthEndpoints() {
            log('é–‹å§‹æ¸¬è©¦ OAuth ç«¯é»...', 'info');
            
            try {
                const endpoints = [
                    { name: 'Google OAuth', url: '/auth/google' },
                    { name: 'LINE OAuth', url: '/auth/line' }
                ];
                
                const results = await Promise.all(endpoints.map(async endpoint => {
                    try {
                        const response = await fetch(endpoint.url, { redirect: 'manual' });
                        const isRedirect = response.status === 302 || response.type === 'opaqueredirect';
                        return { ...endpoint, success: isRedirect, status: response.status };
                    } catch (error) {
                        return { ...endpoint, success: false, error: error.message };
                    }
                }));
                
                const allSuccess = results.every(r => r.success);
                
                if (allSuccess) {
                    updateStatus('oauth-status', 'success', 'âœ… æ‰€æœ‰ OAuth ç«¯é»æ­£å¸¸');
                    log('OAuth ç«¯é»æ¸¬è©¦ï¼šæ‰€æœ‰ç«¯é»éƒ½æ­£å¸¸å›æ‡‰é‡å®šå‘', 'success');
                    testResults.oauthEndpoints = true;
                } else {
                    const failed = results.filter(r => !r.success);
                    updateStatus('oauth-status', 'error', `âŒ ${failed.length} å€‹ç«¯é»ç•°å¸¸`);
                    log(`OAuth ç«¯é»æ¸¬è©¦ï¼š${failed.map(f => f.name).join(', ')} ç•°å¸¸`, 'error');
                    testResults.oauthEndpoints = false;
                }
                
                log(`OAuth ç«¯é»è©³æƒ…: ${JSON.stringify(results, null, 2)}`, 'info');
            } catch (error) {
                updateStatus('oauth-status', 'error', `âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`);
                log(`OAuth ç«¯é»æ¸¬è©¦éŒ¯èª¤: ${error.message}`, 'error');
                testResults.oauthEndpoints = false;
            }
        }

        // 6. æ¨¡æ…‹æ¡†é¡¯ç¤ºæ¸¬è©¦
        function testModalDisplay() {
            log('é–‹å§‹æ¸¬è©¦æ¨¡æ…‹æ¡†é¡¯ç¤º...', 'info');
            
            if (window.loginModal && typeof window.loginModal.show === 'function') {
                try {
                    window.loginModal.show();
                    updateStatus('modal-status', 'success', 'âœ… ç™»å…¥æ¨¡æ…‹æ¡†å·²é¡¯ç¤º');
                    log('æ¨¡æ…‹æ¡†é¡¯ç¤ºæ¸¬è©¦ï¼šæˆåŠŸé¡¯ç¤ºç™»å…¥æ¨¡æ…‹æ¡†', 'success');
                    testResults.modalDisplay = true;
                } catch (error) {
                    updateStatus('modal-status', 'error', `âŒ é¡¯ç¤ºå¤±æ•—: ${error.message}`);
                    log(`æ¨¡æ…‹æ¡†é¡¯ç¤ºæ¸¬è©¦éŒ¯èª¤: ${error.message}`, 'error');
                    testResults.modalDisplay = false;
                }
            } else {
                updateStatus('modal-status', 'error', 'âŒ LoginModal å¯¦ä¾‹ä¸å­˜åœ¨');
                log('æ¨¡æ…‹æ¡†é¡¯ç¤ºæ¸¬è©¦ï¼šLoginModal å¯¦ä¾‹ä¸å­˜åœ¨', 'error');
                testResults.modalDisplay = false;
            }
        }

        function hideModal() {
            if (window.loginModal && typeof window.loginModal.hide === 'function') {
                window.loginModal.hide();
                log('æ¨¡æ…‹æ¡†å·²é—œé–‰', 'info');
            }
        }

        // åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
        async function runAllTests() {
            log('ğŸš€ é–‹å§‹åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦...', 'info');
            
            await checkSystemStatus();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            checkComponentLoading();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            checkAuthState();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testEventBinding();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testOAuthEndpoints();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testModalDisplay();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // å½™ç¸½çµæœ
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(Boolean).length;
            const skippedTests = Object.values(testResults).filter(result => result === null).length;
            
            log(`ğŸ¯ æ¸¬è©¦å®Œæˆï¼é€šé: ${passedTests}/${totalTests} (è·³é: ${skippedTests})`, 'success');
            
            if (passedTests >= totalTests - skippedTests) {
                log('âœ… ç³»çµ±ä¿®å¾©é©—è­‰ï¼šåŸºæœ¬åŠŸèƒ½æ­£å¸¸', 'success');
            } else {
                log('âš ï¸ ç³»çµ±ä¿®å¾©é©—è­‰ï¼šç™¼ç¾å•é¡Œï¼Œéœ€è¦é€²ä¸€æ­¥æª¢æŸ¥', 'warning');
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥åŸºæœ¬ç‹€æ…‹
        document.addEventListener('DOMContentLoaded', function() {
            log('OAuth ä¿®å¾©é©—è­‰é é¢å·²è¼‰å…¥', 'info');
            
            // å»¶é² 1 ç§’å¾Œè‡ªå‹•åŸ·è¡ŒåŸºæœ¬æª¢æŸ¥
            setTimeout(() => {
                log('è‡ªå‹•åŸ·è¡ŒåŸºæœ¬æª¢æŸ¥...', 'info');
                checkSystemStatus();
                checkComponentLoading();
            }, 1000);
        });

        // ç›£è½å…¨åŸŸéŒ¯èª¤
        window.addEventListener('error', function(event) {
            log(`JavaScript éŒ¯èª¤: ${event.error?.message || event.message}`, 'error');
        });
    </script>
</body>
</html>