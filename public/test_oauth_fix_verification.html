<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth 修復驗證 - NexusTrade</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover { background: #3367d6; }
        .test-button.success { background: #28a745; }
        .test-button.warning { background: #ffc107; color: #212529; }
        .test-button.danger { background: #dc3545; }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        
        .log-output {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        h1 { color: #333; margin-bottom: 10px; }
        h2 { color: #555; margin-bottom: 15px; font-size: 18px; }
        h3 { color: #666; margin-bottom: 10px; font-size: 16px; }
    </style>
</head>
<body>
    <h1>🔧 OAuth 認證系統修復驗證</h1>
    <p><strong>修復時間</strong>: 2025-06-30 晚上</p>
    
    <div class="grid">
        <!-- 系統狀態檢查 -->
        <div class="test-section">
            <h3>🚀 系統狀態檢查</h3>
            <button class="test-button" onclick="checkSystemStatus()">檢查系統狀態</button>
            <div id="system-status" class="status info">點擊檢查系統是否正常運行</div>
        </div>

        <!-- 組件載入檢查 -->
        <div class="test-section">
            <h3>📦 組件載入檢查</h3>
            <button class="test-button" onclick="checkComponentLoading()">檢查組件載入</button>
            <div id="component-status" class="status info">點擊檢查 LoginModal 等組件</div>
        </div>

        <!-- 認證狀態管理 -->
        <div class="test-section">
            <h3>🔐 認證狀態管理</h3>
            <button class="test-button" onclick="checkAuthState()">檢查認證狀態</button>
            <button class="test-button warning" onclick="clearAuthState()">清除認證狀態</button>
            <div id="auth-status" class="status info">點擊檢查當前認證狀態</div>
        </div>

        <!-- 事件綁定測試 -->
        <div class="test-section">
            <h3>⚡ 事件綁定測試</h3>
            <button class="test-button" onclick="testEventBinding()">測試事件綁定</button>
            <div id="event-status" class="status info">點擊測試登入按鈕事件</div>
        </div>

        <!-- OAuth 端點測試 -->
        <div class="test-section">
            <h3>🌐 OAuth 端點測試</h3>
            <button class="test-button" onclick="testOAuthEndpoints()">測試 OAuth 端點</button>
            <div id="oauth-status" class="status info">點擊測試後端 OAuth 端點</div>
        </div>

        <!-- 模態框顯示測試 -->
        <div class="test-section">
            <h3>🎭 模態框顯示測試</h3>
            <button class="test-button" onclick="testModalDisplay()">顯示登入模態框</button>
            <button class="test-button danger" onclick="hideModal()">關閉模態框</button>
            <div id="modal-status" class="status info">點擊測試模態框顯示/隱藏</div>
        </div>

        <!-- 測試日誌 -->
        <div class="test-section full-width">
            <h3>📋 測試日誌</h3>
            <button class="test-button warning" onclick="clearLog()">清除日誌</button>
            <button class="test-button" onclick="runAllTests()">執行所有測試</button>
            <div id="log" class="log-output">測試日誌將顯示在這裡...\n</div>
        </div>
    </div>

    <script>
        let testResults = {};

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`OAuth Test - ${logEntry}`);
        }

        function clearLog() {
            document.getElementById('log').textContent = '測試日誌將顯示在這裡...\n';
            testResults = {};
        }

        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = message;
        }

        // 1. 系統狀態檢查
        async function checkSystemStatus() {
            log('開始檢查系統狀態...', 'info');
            
            try {
                // 檢查前端服務
                const frontendResponse = await fetch('/');
                const frontendOk = frontendResponse.ok;
                
                // 檢查後端 API
                const backendResponse = await fetch('/auth/google', { redirect: 'manual' });
                const backendOk = backendResponse.status === 302 || backendResponse.type === 'opaqueredirect';
                
                if (frontendOk && backendOk) {
                    updateStatus('system-status', 'success', '✅ 前端和後端服務都正常運行');
                    log('系統狀態檢查：前端和後端都正常', 'success');
                    testResults.systemStatus = true;
                } else {
                    updateStatus('system-status', 'error', `❌ 服務異常 - 前端:${frontendOk} 後端:${backendOk}`);
                    log(`系統狀態檢查失敗 - 前端:${frontendOk} 後端:${backendOk}`, 'error');
                    testResults.systemStatus = false;
                }
            } catch (error) {
                updateStatus('system-status', 'error', `❌ 系統檢查失敗: ${error.message}`);
                log(`系統狀態檢查錯誤: ${error.message}`, 'error');
                testResults.systemStatus = false;
            }
        }

        // 2. 組件載入檢查
        function checkComponentLoading() {
            log('開始檢查組件載入...', 'info');
            
            const checks = {
                LoginModal: typeof LoginModal !== 'undefined',
                loginModalInstance: typeof window.loginModal !== 'undefined',
                app: typeof window.app !== 'undefined',
                authStateManager: typeof window.authStateManager !== 'undefined'
            };
            
            const allLoaded = Object.values(checks).every(Boolean);
            
            if (allLoaded) {
                updateStatus('component-status', 'success', '✅ 所有核心組件已載入');
                log('組件載入檢查：所有組件都正常載入', 'success');
                testResults.componentLoading = true;
            } else {
                const missing = Object.entries(checks)
                    .filter(([, loaded]) => !loaded)
                    .map(([name]) => name);
                updateStatus('component-status', 'warning', `⚠️ 缺少組件: ${missing.join(', ')}`);
                log(`組件載入檢查：缺少 ${missing.join(', ')}`, 'warning');
                testResults.componentLoading = false;
            }
            
            log(`組件詳情: ${JSON.stringify(checks, null, 2)}`, 'info');
        }

        // 3. 認證狀態檢查
        function checkAuthState() {
            log('開始檢查認證狀態...', 'info');
            
            const tokens = {
                nexustrade_token: localStorage.getItem('nexustrade_token'),
                nexustrade_user: localStorage.getItem('nexustrade_user'),
                token: localStorage.getItem('token'),
                userInfo: localStorage.getItem('userInfo')
            };
            
            const hasAuth = Object.values(tokens).some(Boolean);
            
            if (hasAuth) {
                updateStatus('auth-status', 'success', '✅ 發現認證數據');
                log('認證狀態檢查：發現已保存的認證數據', 'success');
                testResults.authState = true;
            } else {
                updateStatus('auth-status', 'info', 'ℹ️ 未發現認證數據（正常，未登入）');
                log('認證狀態檢查：未發現認證數據', 'info');
                testResults.authState = null;
            }
            
            log(`認證數據詳情: ${JSON.stringify(tokens, null, 2)}`, 'info');
        }

        // 清除認證狀態
        function clearAuthState() {
            log('清除認證狀態...', 'info');
            
            if (window.loginModal && typeof window.loginModal.clearTokensFromStorage === 'function') {
                window.loginModal.clearTokensFromStorage();
                updateStatus('auth-status', 'warning', '⚠️ 認證狀態已清除');
                log('認證狀態已通過 LoginModal 清除', 'success');
            } else {
                // 手動清除
                const keys = ['nexustrade_token', 'nexustrade_user', 'token', 'userInfo', 'nexustrade_refresh_token'];
                keys.forEach(key => localStorage.removeItem(key));
                updateStatus('auth-status', 'warning', '⚠️ 認證狀態已手動清除');
                log('認證狀態已手動清除', 'success');
            }
        }

        // 4. 事件綁定測試
        function testEventBinding() {
            log('開始測試事件綁定...', 'info');
            
            const loginBtn = document.getElementById('login-btn');
            
            if (!loginBtn) {
                updateStatus('event-status', 'error', '❌ 找不到登入按鈕');
                log('事件綁定測試：找不到 login-btn 元素', 'error');
                testResults.eventBinding = false;
                return;
            }
            
            // 檢查事件監聽器
            const hasClickHandler = loginBtn.onclick || (getEventListeners && getEventListeners(loginBtn).click);
            
            if (hasClickHandler || window.app) {
                updateStatus('event-status', 'success', '✅ 登入按鈕事件已綁定');
                log('事件綁定測試：登入按鈕事件正常', 'success');
                testResults.eventBinding = true;
                
                // 模擬點擊測試（不實際觸發）
                log('可以嘗試點擊頁面頂部的 "登入" 按鈕測試', 'info');
            } else {
                updateStatus('event-status', 'warning', '⚠️ 無法確認事件綁定狀態');
                log('事件綁定測試：無法確認事件監聽器', 'warning');
                testResults.eventBinding = false;
            }
        }

        // 5. OAuth 端點測試
        async function testOAuthEndpoints() {
            log('開始測試 OAuth 端點...', 'info');
            
            try {
                const endpoints = [
                    { name: 'Google OAuth', url: '/auth/google' },
                    { name: 'LINE OAuth', url: '/auth/line' }
                ];
                
                const results = await Promise.all(endpoints.map(async endpoint => {
                    try {
                        const response = await fetch(endpoint.url, { redirect: 'manual' });
                        const isRedirect = response.status === 302 || response.type === 'opaqueredirect';
                        return { ...endpoint, success: isRedirect, status: response.status };
                    } catch (error) {
                        return { ...endpoint, success: false, error: error.message };
                    }
                }));
                
                const allSuccess = results.every(r => r.success);
                
                if (allSuccess) {
                    updateStatus('oauth-status', 'success', '✅ 所有 OAuth 端點正常');
                    log('OAuth 端點測試：所有端點都正常回應重定向', 'success');
                    testResults.oauthEndpoints = true;
                } else {
                    const failed = results.filter(r => !r.success);
                    updateStatus('oauth-status', 'error', `❌ ${failed.length} 個端點異常`);
                    log(`OAuth 端點測試：${failed.map(f => f.name).join(', ')} 異常`, 'error');
                    testResults.oauthEndpoints = false;
                }
                
                log(`OAuth 端點詳情: ${JSON.stringify(results, null, 2)}`, 'info');
            } catch (error) {
                updateStatus('oauth-status', 'error', `❌ 測試失敗: ${error.message}`);
                log(`OAuth 端點測試錯誤: ${error.message}`, 'error');
                testResults.oauthEndpoints = false;
            }
        }

        // 6. 模態框顯示測試
        function testModalDisplay() {
            log('開始測試模態框顯示...', 'info');
            
            if (window.loginModal && typeof window.loginModal.show === 'function') {
                try {
                    window.loginModal.show();
                    updateStatus('modal-status', 'success', '✅ 登入模態框已顯示');
                    log('模態框顯示測試：成功顯示登入模態框', 'success');
                    testResults.modalDisplay = true;
                } catch (error) {
                    updateStatus('modal-status', 'error', `❌ 顯示失敗: ${error.message}`);
                    log(`模態框顯示測試錯誤: ${error.message}`, 'error');
                    testResults.modalDisplay = false;
                }
            } else {
                updateStatus('modal-status', 'error', '❌ LoginModal 實例不存在');
                log('模態框顯示測試：LoginModal 實例不存在', 'error');
                testResults.modalDisplay = false;
            }
        }

        function hideModal() {
            if (window.loginModal && typeof window.loginModal.hide === 'function') {
                window.loginModal.hide();
                log('模態框已關閉', 'info');
            }
        }

        // 執行所有測試
        async function runAllTests() {
            log('🚀 開始執行所有測試...', 'info');
            
            await checkSystemStatus();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            checkComponentLoading();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            checkAuthState();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testEventBinding();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testOAuthEndpoints();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testModalDisplay();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 彙總結果
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(Boolean).length;
            const skippedTests = Object.values(testResults).filter(result => result === null).length;
            
            log(`🎯 測試完成！通過: ${passedTests}/${totalTests} (跳過: ${skippedTests})`, 'success');
            
            if (passedTests >= totalTests - skippedTests) {
                log('✅ 系統修復驗證：基本功能正常', 'success');
            } else {
                log('⚠️ 系統修復驗證：發現問題，需要進一步檢查', 'warning');
            }
        }

        // 頁面載入時自動檢查基本狀態
        document.addEventListener('DOMContentLoaded', function() {
            log('OAuth 修復驗證頁面已載入', 'info');
            
            // 延遲 1 秒後自動執行基本檢查
            setTimeout(() => {
                log('自動執行基本檢查...', 'info');
                checkSystemStatus();
                checkComponentLoading();
            }, 1000);
        });

        // 監聽全域錯誤
        window.addEventListener('error', function(event) {
            log(`JavaScript 錯誤: ${event.error?.message || event.message}`, 'error');
        });
    </script>
</body>
</html>