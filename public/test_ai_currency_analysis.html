<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 單一貨幣分析測試</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .test-container {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .analysis-section {
            background: #3d3d3d;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .loading {
            text-align: center;
            color: #ffa502;
        }
        .error {
            color: #ff6b6b;
            background: #4a1f1f;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            color: #00d2d3;
        }
        button {
            background: #0088ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0066cc;
        }
        .json-output {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .indicator-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin: 2px;
        }
        .bullish { background-color: #00d2d3; color: #000; }
        .bearish { background-color: #ff6b6b; color: #fff; }
        .neutral { background-color: #ffa502; color: #000; }
        .hold { background-color: #0088ff; color: #fff; }
    </style>
</head>
<body>
    <h1>🤖 AI 單一貨幣分析測試</h1>
    
    <div class="test-container">
        <h2>測試控制</h2>
        <button onclick="testBTCAnalysis()">測試 BTC 分析</button>
        <button onclick="testETHAnalysis()">測試 ETH 分析</button>
        <button onclick="testDirectAPI()">直接 API 測試</button>
        <button onclick="clearResults()">清除結果</button>
    </div>

    <div id="results"></div>

    <script>
        let testResults = [];

        async function testBTCAnalysis() {
            await testCurrencyAnalysis('BTCUSDT');
        }

        async function testETHAnalysis() {
            await testCurrencyAnalysis('ETHUSDT');
        }

        async function testCurrencyAnalysis(symbol) {
            const resultDiv = document.getElementById('results');
            const testContainer = document.createElement('div');
            testContainer.className = 'test-container';
            testContainer.innerHTML = `
                <h3>📊 ${symbol} AI 分析測試</h3>
                <div class="loading">🔄 載入中...</div>
            `;
            resultDiv.appendChild(testContainer);

            try {
                console.log(`🔍 開始測試 ${symbol} AI 分析...`);
                
                const response = await fetch(`/api/ai/currency-analysis/${symbol}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    testContainer.innerHTML = generateAnalysisHTML(symbol, data.data);
                    testResults.push({
                        symbol,
                        status: 'success',
                        data: data.data,
                        timestamp: new Date().toISOString()
                    });
                } else {
                    throw new Error(data.message || '分析失敗');
                }
                
            } catch (error) {
                console.error(`❌ ${symbol} 分析測試失敗:`, error);
                testContainer.innerHTML = `
                    <h3>❌ ${symbol} 分析失敗</h3>
                    <div class="error">錯誤: ${error.message}</div>
                `;
                testResults.push({
                    symbol,
                    status: 'error',
                    error: error.message,
                    timestamp: new Date().toISOString()
                });
            }
        }

        function generateAnalysisHTML(symbol, analysisData) {
            const analysis = analysisData.analysis;
            
            return `
                <h3>✅ ${symbol} AI 分析結果</h3>
                
                <div class="analysis-section">
                    <h4>📈 趨勢分析</h4>
                    <p><strong>方向:</strong> <span class="indicator-tag ${analysis.trend.direction}">${getTrendText(analysis.trend.direction)}</span></p>
                    <p><strong>信心度:</strong> ${analysis.trend.confidence}%</p>
                    <p><strong>摘要:</strong> ${analysis.trend.summary}</p>
                </div>

                <div class="analysis-section">
                    <h4>📊 技術指標分析</h4>
                    ${generateTechnicalIndicatorsHTML(analysis.technicalAnalysis)}
                </div>

                <div class="analysis-section">
                    <h4>💭 市場情緒</h4>
                    <p><strong>評分:</strong> ${analysis.marketSentiment.score}/100</p>
                    <p><strong>標籤:</strong> <span class="indicator-tag ${analysis.marketSentiment.label}">${getSentimentText(analysis.marketSentiment.label)}</span></p>
                    <p><strong>摘要:</strong> ${analysis.marketSentiment.summary}</p>
                </div>

                <div class="analysis-section">
                    <h4>📋 分析詳情</h4>
                    <p><strong>分析日期:</strong> ${analysisData.analysisDate}</p>
                    <p><strong>數據來源:</strong> ${analysisData.dataSources.analysisModel}</p>
                    <p><strong>處理時間:</strong> ${analysisData.qualityMetrics.processingTime}ms</p>
                    <p><strong>數據完整性:</strong> ${analysisData.qualityMetrics.dataCompleteness}%</p>
                    <p><strong>是否快取:</strong> ${analysisData.isFromCache ? '是' : '否'}</p>
                </div>

                <details>
                    <summary>📝 完整 JSON 回應</summary>
                    <div class="json-output">${JSON.stringify(analysisData, null, 2)}</div>
                </details>
            `;
        }

        function generateTechnicalIndicatorsHTML(technical) {
            let html = '';
            
            for (const [indicator, data] of Object.entries(technical)) {
                if (data && typeof data === 'object' && data.signal) {
                    html += `
                        <p><strong>${getIndicatorName(indicator)}:</strong> 
                        <span class="indicator-tag ${getSignalClass(data.signal)}">${data.signal}</span>
                        ${data.interpretation ? `- ${data.interpretation}` : ''}
                        ${data.value !== undefined ? ` (值: ${data.value})` : ''}
                        </p>
                    `;
                }
            }
            
            return html || '<p>技術指標數據不可用</p>';
        }

        function getSignalClass(signal) {
            if (signal.includes('看漲') || signal.includes('買入')) return 'bullish';
            if (signal.includes('看跌') || signal.includes('賣出')) return 'bearish';
            if (signal.includes('中性')) return 'neutral';
            return 'hold';
        }

        function getTrendText(trend) {
            const trendMap = {
                'bullish': '看漲',
                'bearish': '看跌',
                'neutral': '中性'
            };
            return trendMap[trend] || trend;
        }

        function getSentimentText(sentiment) {
            const sentimentMap = {
                'positive': '積極',
                'negative': '消極',
                'neutral': '中性'
            };
            return sentimentMap[sentiment] || sentiment;
        }

        function getIndicatorName(indicator) {
            const indicatorMap = {
                'rsi': 'RSI',
                'macd': 'MACD',
                'movingAverage': '移動平均線',
                'bollingerBands': '布林帶',
                'volume': '成交量'
            };
            return indicatorMap[indicator] || indicator;
        }

        async function testDirectAPI() {
            const resultDiv = document.getElementById('results');
            const testContainer = document.createElement('div');
            testContainer.className = 'test-container';
            testContainer.innerHTML = `
                <h3>🔧 直接 API 測試</h3>
                <div class="loading">🔄 測試中...</div>
            `;
            resultDiv.appendChild(testContainer);

            try {
                // 測試 AI 服務狀態
                const statusResponse = await fetch('/api/ai/status');
                const statusData = await statusResponse.json();
                
                let html = `
                    <h3>🔧 API 測試結果</h3>
                    <div class="analysis-section">
                        <h4>🏥 AI 服務狀態</h4>
                        <div class="json-output">${JSON.stringify(statusData, null, 2)}</div>
                    </div>
                `;

                // 測試貨幣分析 API
                const btcResponse = await fetch('/api/ai/currency-analysis/BTCUSDT');
                const btcData = await btcResponse.json();
                
                html += `
                    <div class="analysis-section">
                        <h4>📊 BTC 分析 API 回應</h4>
                        <div class="json-output">${JSON.stringify(btcData, null, 2)}</div>
                    </div>
                `;

                testContainer.innerHTML = html;
                
            } catch (error) {
                console.error('❌ 直接 API 測試失敗:', error);
                testContainer.innerHTML = `
                    <h3>❌ API 測試失敗</h3>
                    <div class="error">錯誤: ${error.message}</div>
                `;
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            testResults = [];
            console.log('🧹 測試結果已清除');
        }

        // 頁面載入時顯示歡迎訊息
        window.addEventListener('load', () => {
            console.log('🤖 AI 單一貨幣分析測試頁面已載入');
            console.log('請點擊按鈕開始測試 AI 分析功能');
        });
    </script>
</body>
</html>