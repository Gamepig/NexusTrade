<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>觀察清單認證整合測試 - NexusTrade</title>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: #1a1b1e;
            color: #e1e3e7;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #2d2f35;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            color: #4fc3f7;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #363841;
            border-radius: 8px;
            border-left: 4px solid #4fc3f7;
        }
        
        .section h2 {
            color: #81c784;
            margin-top: 0;
        }
        
        .test-button {
            background: #4fc3f7;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .test-button:hover {
            background: #29b6f6;
        }
        
        .status-good {
            color: #81c784;
        }
        
        .status-warning {
            color: #ffb74d;
        }
        
        .status-error {
            color: #f48fb1;
        }
        
        .code-block {
            background: #1e1e1e;
            color: #e1e3e7;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .log-output {
            background: #1e1e1e;
            color: #e1e3e7;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #b0bec5;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            background: #1e1e1e;
            border: 1px solid #555;
            border-radius: 4px;
            color: #e1e3e7;
            box-sizing: border-box;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔐 觀察清單認證整合測試</h1>
        
        <div class="section">
            <h2>📊 系統狀態檢查</h2>
            <button class="test-button" onclick="checkSystemStatus()">檢查系統狀態</button>
            <button class="test-button" onclick="checkAuthComponents()">檢查認證組件</button>
            <button class="test-button" onclick="checkWatchlistComponent()">檢查觀察清單組件</button>
            <div id="system-status" class="code-block">點擊按鈕開始檢查...</div>
        </div>
        
        <div class="grid">
            <div class="section">
                <h2>🔑 認證狀態測試</h2>
                <button class="test-button" onclick="checkAuthState()">檢查當前認證狀態</button>
                <button class="test-button" onclick="simulateLogin()">模擬登入狀態</button>
                <button class="test-button" onclick="clearAuthState()">清除認證狀態</button>
                <div id="auth-status" class="code-block">未檢查</div>
            </div>
            
            <div class="section">
                <h2>📋 觀察清單API測試</h2>
                <button class="test-button" onclick="testWatchlistAPI()">測試API連接</button>
                <button class="test-button" onclick="testAddItem()">測試新增項目</button>
                <button class="test-button" onclick="testRemoveItem()">測試移除項目</button>
                <div id="api-status" class="code-block">未測試</div>
            </div>
        </div>
        
        <div class="section">
            <h2>🧪 整合測試工具</h2>
            <div class="form-group">
                <label for="test-symbol">測試交易對:</label>
                <input type="text" id="test-symbol" class="form-control" value="BTCUSDT" placeholder="例如: BTCUSDT">
            </div>
            <button class="test-button" onclick="fullIntegrationTest()">完整整合測試</button>
            <button class="test-button" onclick="simulateAuthFlow()">模擬認證流程</button>
            <button class="test-button" onclick="clearLog()">清除日誌</button>
        </div>
        
        <div class="section">
            <h2>📝 測試日誌</h2>
            <div id="test-log" class="log-output">準備開始測試...</div>
        </div>
    </div>

    <!-- 載入必要的組件 -->
    <script src="/js/lib/router.js"></script>
    <script src="/js/components/LoginModal.js"></script>
    <script src="/js/components/WatchlistPage.js"></script>
    <script src="/js/lib/auth-state-manager.js"></script>

    <script>
        // 測試日誌功能
        function log(message, type = 'info') {
            const logElement = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f48fb1' : type === 'warning' ? '#ffb74d' : type === 'success' ? '#81c784' : '#e1e3e7';
            logElement.innerHTML += `<span style="color: ${color};">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = '日誌已清除...\n';
        }

        // 系統狀態檢查
        async function checkSystemStatus() {
            const statusElement = document.getElementById('system-status');
            let status = '';
            
            try {
                // 檢查伺服器連接
                const response = await fetch('/api/watchlist/health');
                if (response.ok) {
                    status += '<span class="status-good">✅ API 伺服器連接正常</span>\n';
                    const data = await response.json();
                    status += `   版本: ${data.version || 'unknown'}\n`;
                    status += `   功能: ${JSON.stringify(data.features, null, 2)}\n`;
                } else {
                    status += '<span class="status-error">❌ API 伺服器連接失敗</span>\n';
                }
            } catch (error) {
                status += `<span class="status-error">❌ 伺服器錯誤: ${error.message}</span>\n`;
            }
            
            statusElement.innerHTML = status;
            log('系統狀態檢查完成', 'info');
        }

        function checkAuthComponents() {
            const statusElement = document.getElementById('system-status');
            let status = statusElement.innerHTML;
            
            // 檢查認證管理器
            if (window.authStateManager) {
                status += '<span class="status-good">✅ AuthStateManager 已載入</span>\n';
            } else {
                status += '<span class="status-warning">⚠️ AuthStateManager 未載入</span>\n';
            }
            
            // 檢查登入模態框
            if (window.LoginModal || typeof LoginModal !== 'undefined') {
                status += '<span class="status-good">✅ LoginModal 組件已載入</span>\n';
            } else {
                status += '<span class="status-warning">⚠️ LoginModal 組件未載入</span>\n';
            }
            
            // 檢查全域登入功能
            if (window.showLoginModal) {
                status += '<span class="status-good">✅ 全域登入功能可用</span>\n';
            } else {
                status += '<span class="status-warning">⚠️ 全域登入功能不可用</span>\n';
            }
            
            statusElement.innerHTML = status;
            log('認證組件檢查完成', 'info');
        }

        function checkWatchlistComponent() {
            const statusElement = document.getElementById('system-status');
            let status = statusElement.innerHTML;
            
            // 檢查觀察清單組件
            if (typeof WatchlistPage !== 'undefined') {
                status += '<span class="status-good">✅ WatchlistPage 組件已載入</span>\n';
                
                // 嘗試創建實例
                try {
                    const testInstance = new WatchlistPage();
                    status += '<span class="status-good">✅ WatchlistPage 可以實例化</span>\n';
                    
                    // 檢查關鍵方法
                    if (typeof testInstance.getAuthToken === 'function') {
                        status += '<span class="status-good">✅ getAuthToken 方法存在</span>\n';
                    }
                    if (typeof testInstance.showSuccess === 'function') {
                        status += '<span class="status-good">✅ showSuccess 方法存在</span>\n';
                    }
                    if (typeof testInstance.showError === 'function') {
                        status += '<span class="status-good">✅ showError 方法存在</span>\n';
                    }
                } catch (error) {
                    status += `<span class="status-error">❌ WatchlistPage 實例化失敗: ${error.message}</span>\n`;
                }
            } else {
                status += '<span class="status-error">❌ WatchlistPage 組件未載入</span>\n';
            }
            
            statusElement.innerHTML = status;
            log('觀察清單組件檢查完成', 'info');
        }

        // 認證狀態測試
        function checkAuthState() {
            const authElement = document.getElementById('auth-status');
            let status = '';
            
            // 檢查 localStorage
            const localToken = localStorage.getItem('nexustrade_token');
            const localUser = localStorage.getItem('nexustrade_user');
            
            if (localToken) {
                status += '<span class="status-good">✅ localStorage 有 token</span>\n';
                status += `   Token 前20字元: ${localToken.substring(0, 20)}...\n`;
                
                // 檢查 token 有效性
                try {
                    const payload = JSON.parse(atob(localToken.split('.')[1]));
                    const expTime = new Date(payload.exp * 1000);
                    if (payload.exp * 1000 > Date.now()) {
                        status += `<span class="status-good">✅ Token 有效，到期時間: ${expTime.toLocaleString()}</span>\n`;
                    } else {
                        status += `<span class="status-warning">⚠️ Token 已過期: ${expTime.toLocaleString()}</span>\n`;
                    }
                } catch (error) {
                    status += `<span class="status-error">❌ Token 格式錯誤: ${error.message}</span>\n`;
                }
            } else {
                status += '<span class="status-warning">⚠️ localStorage 無 token</span>\n';
            }
            
            if (localUser) {
                status += '<span class="status-good">✅ localStorage 有用戶資料</span>\n';
                try {
                    const user = JSON.parse(localUser);
                    status += `   用戶: ${user.name || '未知'} (${user.email || '未知'})\n`;
                } catch (error) {
                    status += `<span class="status-error">❌ 用戶資料格式錯誤</span>\n`;
                }
            } else {
                status += '<span class="status-warning">⚠️ localStorage 無用戶資料</span>\n';
            }
            
            // 檢查 AuthStateManager
            if (window.authStateManager) {
                try {
                    const token = window.authStateManager.getToken();
                    const isExpired = window.authStateManager.isTokenExpired();
                    status += `<span class="status-good">✅ AuthStateManager token: ${token ? '存在' : '不存在'}</span>\n`;
                    status += `<span class="status-good">✅ Token 過期狀態: ${isExpired ? '已過期' : '有效'}</span>\n`;
                } catch (error) {
                    status += `<span class="status-warning">⚠️ AuthStateManager 錯誤: ${error.message}</span>\n`;
                }
            }
            
            authElement.innerHTML = status;
            log('認證狀態檢查完成', 'info');
        }

        function simulateLogin() {
            // 創建測試用的 JWT token
            const testPayload = {
                sub: 'test-user-123',
                email: 'test@nexustrade.com',
                name: '測試用戶',
                iat: Math.floor(Date.now() / 1000),
                exp: Math.floor(Date.now() / 1000) + 3600 // 1小時後過期
            };
            
            const testToken = `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.${btoa(JSON.stringify(testPayload))}.test-signature`;
            const testUser = {
                id: 'test-user-123',
                email: 'test@nexustrade.com',
                name: '測試用戶',
                avatar: 'https://via.placeholder.com/32'
            };
            
            // 保存到 localStorage
            localStorage.setItem('nexustrade_token', testToken);
            localStorage.setItem('nexustrade_user', JSON.stringify(testUser));
            
            // 如果有 AuthStateManager，也更新它
            if (window.authStateManager) {
                try {
                    window.authStateManager.forceAuthStateRefresh();
                } catch (error) {
                    console.warn('AuthStateManager 更新失敗:', error);
                }
            }
            
            log('模擬登入完成 - 測試用戶已登入', 'success');
            checkAuthState(); // 重新檢查狀態
        }

        function clearAuthState() {
            localStorage.removeItem('nexustrade_token');
            localStorage.removeItem('nexustrade_user');
            sessionStorage.removeItem('nexustrade_token');
            sessionStorage.removeItem('nexustrade_user');
            
            log('認證狀態已清除', 'warning');
            checkAuthState(); // 重新檢查狀態
        }

        // API 測試
        async function testWatchlistAPI() {
            const apiElement = document.getElementById('api-status');
            let status = '';
            
            try {
                // 創建測試實例
                const watchlist = new WatchlistPage();
                
                // 測試認證令牌取得
                try {
                    const token = watchlist.getAuthToken();
                    if (token) {
                        status += '<span class="status-good">✅ 認證令牌取得成功</span>\n';
                        
                        // 測試 API 呼叫
                        const response = await fetch('/api/watchlist', {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            status += '<span class="status-good">✅ API 呼叫成功</span>\n';
                            status += `   觀察清單項目數: ${data.data ? data.data.length : 0}\n`;
                        } else {
                            const errorData = await response.json();
                            status += `<span class="status-warning">⚠️ API 呼叫失敗: ${errorData.message}</span>\n`;
                        }
                    } else {
                        status += '<span class="status-warning">⚠️ 無有效認證令牌</span>\n';
                        status += '   提示: 請先進行登入或模擬登入\n';
                    }
                } catch (error) {
                    status += `<span class="status-error">❌ 認證錯誤: ${error.message}</span>\n`;
                }
            } catch (error) {
                status += `<span class="status-error">❌ 組件錯誤: ${error.message}</span>\n`;
            }
            
            apiElement.innerHTML = status;
            log('API 測試完成', 'info');
        }

        async function testAddItem() {
            const symbol = document.getElementById('test-symbol').value || 'BTCUSDT';
            const apiElement = document.getElementById('api-status');
            let status = apiElement.innerHTML;
            
            try {
                const watchlist = new WatchlistPage();
                const token = watchlist.getAuthToken();
                
                if (!token) {
                    status += '<span class="status-warning">⚠️ 需要先登入才能測試新增</span>\n';
                    apiElement.innerHTML = status;
                    return;
                }
                
                const response = await fetch('/api/watchlist', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        priority: 5,
                        category: 'trading',
                        notes: `測試新增 ${symbol}`
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    status += `<span class="status-good">✅ 新增 ${symbol} 成功</span>\n`;
                    log(`成功新增 ${symbol} 到觀察清單`, 'success');
                } else {
                    const errorData = await response.json();
                    status += `<span class="status-warning">⚠️ 新增失敗: ${errorData.message}</span>\n`;
                    log(`新增 ${symbol} 失敗: ${errorData.message}`, 'error');
                }
            } catch (error) {
                status += `<span class="status-error">❌ 新增錯誤: ${error.message}</span>\n`;
                log(`新增項目錯誤: ${error.message}`, 'error');
            }
            
            apiElement.innerHTML = status;
        }

        async function testRemoveItem() {
            const symbol = document.getElementById('test-symbol').value || 'BTCUSDT';
            const apiElement = document.getElementById('api-status');
            let status = apiElement.innerHTML;
            
            try {
                const watchlist = new WatchlistPage();
                const token = watchlist.getAuthToken();
                
                if (!token) {
                    status += '<span class="status-warning">⚠️ 需要先登入才能測試移除</span>\n';
                    apiElement.innerHTML = status;
                    return;
                }
                
                const response = await fetch(`/api/watchlist/${symbol}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    status += `<span class="status-good">✅ 移除 ${symbol} 成功</span>\n`;
                    log(`成功移除 ${symbol} 從觀察清單`, 'success');
                } else {
                    const errorData = await response.json();
                    status += `<span class="status-warning">⚠️ 移除失敗: ${errorData.message}</span>\n`;
                    log(`移除 ${symbol} 失敗: ${errorData.message}`, 'warning');
                }
            } catch (error) {
                status += `<span class="status-error">❌ 移除錯誤: ${error.message}</span>\n`;
                log(`移除項目錯誤: ${error.message}`, 'error');
            }
            
            apiElement.innerHTML = status;
        }

        // 完整整合測試
        async function fullIntegrationTest() {
            log('🚀 開始完整整合測試...', 'info');
            
            // 1. 檢查系統狀態
            await checkSystemStatus();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 2. 檢查組件
            checkAuthComponents();
            checkWatchlistComponent();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 3. 檢查認證狀態
            checkAuthState();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 4. 如果未登入，模擬登入
            const hasToken = localStorage.getItem('nexustrade_token');
            if (!hasToken) {
                log('📝 未檢測到登入狀態，正在模擬登入...', 'info');
                simulateLogin();
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // 5. 測試 API
            await testWatchlistAPI();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 6. 測試 CRUD 操作
            log('📋 測試觀察清單 CRUD 操作...', 'info');
            await testAddItem();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testRemoveItem();
            
            log('🎉 完整整合測試完成！', 'success');
        }

        function simulateAuthFlow() {
            log('🔐 模擬完整認證流程...', 'info');
            
            // 1. 清除現有狀態
            clearAuthState();
            log('1. 清除現有認證狀態', 'info');
            
            setTimeout(() => {
                // 2. 模擬 OAuth 登入
                simulateLogin();
                log('2. 模擬 OAuth 登入成功', 'success');
                
                setTimeout(() => {
                    // 3. 測試認證後的功能
                    log('3. 測試認證後功能...', 'info');
                    testWatchlistAPI();
                }, 1000);
            }, 1000);
        }

        // 頁面載入時自動執行基本檢查
        window.addEventListener('load', () => {
            log('頁面載入完成，開始基本檢查...', 'info');
            setTimeout(() => {
                checkSystemStatus();
                checkAuthComponents();
                checkWatchlistComponent();
            }, 1000);
        });
    </script>
</body>
</html>