<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView 除錯</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: #000; 
            color: white; 
            padding: 20px; 
        }
        .debug-info { 
            background: #222; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border: 1px solid #444; 
        }
        .error { background: #420; border-color: #f44; }
        .success { background: #042; border-color: #4f4; }
        .warning { background: #440; border-color: #ff4; }
        
        .chart-container {
            height: 200px;
            background: #111;
            margin: 20px 0;
            border: 2px solid #333;
            position: relative;
        }
        .tradingview-widget-container {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>
    <h1>🔍 TradingView 除錯診斷</h1>
    
    <div id="console-logs" class="debug-info">
        <h3>📝 控制台日誌</h3>
        <div id="log-output"></div>
    </div>
    
    <div id="script-status" class="debug-info">
        <h3>📜 腳本載入狀態</h3>
        <div id="script-output">檢查中...</div>
    </div>
    
    <div id="widget-status" class="debug-info">
        <h3>📊 小工具狀態</h3>
        <div id="widget-output">等待載入...</div>
    </div>
    
    <h2>🧪 TradingView 小工具測試</h2>
    <div class="chart-container">
        <!-- TradingView Widget BEGIN -->
        <div class="tradingview-widget-container">
            <div class="tradingview-widget-container__widget"></div>
            <div class="tradingview-widget-copyright">
                <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
                    <span class="blue-text">Track all markets on TradingView</span>
                </a>
            </div>
        </div>
        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js" async>
        {
          "symbol": "BINANCE:BTCUSDT",
          "width": "100%",
          "height": "200",
          "locale": "zh_TW",
          "dateRange": "1D",
          "colorTheme": "dark",
          "isTransparent": true,
          "autosize": true,
          "largeChartUrl": ""
        }
        </script>
        <!-- TradingView Widget END -->
    </div>
    
    <script>
        // 攔截控制台輸出
        const logOutput = document.getElementById('log-output');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addLog(type, message) {
            const div = document.createElement('div');
            div.style.color = type === 'error' ? '#f44' : type === 'warn' ? '#fa4' : '#4f4';
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${type.toUpperCase()}: ${message}`;
            logOutput.appendChild(div);
        }
        
        console.log = function(...args) {
            addLog('log', args.join(' '));
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            addLog('error', args.join(' '));
            originalError.apply(console, args);
        };
        
        console.warn = function(...args) {
            addLog('warn', args.join(' '));
            originalWarn.apply(console, args);
        };
        
        // 檢查腳本載入
        const scriptOutput = document.getElementById('script-output');
        const widgetOutput = document.getElementById('widget-output');
        
        // 腳本載入檢測
        const scripts = document.querySelectorAll('script[src*="tradingview"]');
        if (scripts.length > 0) {
            scriptOutput.innerHTML = `✅ 找到 ${scripts.length} 個 TradingView 腳本`;
            
            scripts.forEach((script, index) => {
                script.onload = function() {
                    addLog('log', `TradingView 腳本 ${index + 1} 載入成功`);
                };
                
                script.onerror = function() {
                    addLog('error', `TradingView 腳本 ${index + 1} 載入失敗`);
                };
            });
        } else {
            scriptOutput.innerHTML = `❌ 未找到 TradingView 腳本`;
        }
        
        // 小工具檢測
        let checkCount = 0;
        const maxChecks = 30;
        
        function checkWidget() {
            const widgets = document.querySelectorAll('.tradingview-widget-container__widget');
            let loadedCount = 0;
            
            widgets.forEach(widget => {
                if (widget.hasChildNodes() && widget.children.length > 0) {
                    loadedCount++;
                }
            });
            
            if (loadedCount > 0) {
                widgetOutput.innerHTML = `✅ ${loadedCount}/${widgets.length} 個小工具載入成功`;
                addLog('log', `TradingView 小工具載入成功 (${loadedCount}/${widgets.length})`);
            } else if (checkCount >= maxChecks) {
                widgetOutput.innerHTML = `❌ 小工具載入超時 (檢查了 ${checkCount} 次)`;
                addLog('error', 'TradingView 小工具載入超時');
            } else {
                widgetOutput.innerHTML = `⏳ 檢查中... (${checkCount + 1}/${maxChecks})`;
                checkCount++;
                setTimeout(checkWidget, 1000);
            }
        }
        
        // 開始檢查
        setTimeout(checkWidget, 2000);
        
        // CSP 錯誤檢測
        document.addEventListener('securitypolicyviolation', function(e) {
            addLog('error', `CSP 違規: ${e.blockedURI} - ${e.violatedDirective}`);
        });
        
        // 網路錯誤檢測
        window.addEventListener('error', function(e) {
            if (e.target && e.target.tagName === 'SCRIPT') {
                addLog('error', `腳本載入錯誤: ${e.target.src}`);
            }
        });
        
        // 初始日誌
        addLog('log', '除錯頁面初始化完成');
    </script>
</body>
</html>