<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚨 緊急修復驗證</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #ffffff;
        }
        .test-section {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #444;
        }
        .btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
            font-weight: bold;
        }
        .btn:hover {
            background: #1976D2;
        }
        .btn-success {
            background: #4CAF50;
        }
        .btn-danger {
            background: #f44336;
        }
        .result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .result-success {
            background: rgba(76, 175, 80, 0.2);
            border-left-color: #4CAF50;
        }
        .result-error {
            background: rgba(244, 67, 54, 0.2);
            border-left-color: #F44336;
        }
        .emergency-fix {
            background: linear-gradient(45deg, #f44336, #ff9800);
            color: white;
            text-align: center;
            font-size: 20px;
            padding: 25px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>🚨 緊急修復驗證工具</h1>
    <p><strong>目標</strong>：驗證 PriceAlertModal 緊急修復是否成功</p>

    <div class="emergency-fix">
        🚨 緊急修復：移除 LINE 連接阻擋邏輯
    </div>

    <div class="test-section">
        <h2>🔧 測試環境設定</h2>
        <div id="setup-results"></div>
        <button class="btn btn-success" onclick="setupAuthenticatedUser()">✅ 設定已認證用戶</button>
        <button class="btn btn-danger" onclick="setupUnauthenticatedUser()">❌ 模擬未認證狀態</button>
    </div>

    <div class="test-section">
        <h2>🎯 緊急修復測試</h2>
        <div id="fix-test-results"></div>
        <button class="btn" onclick="testEmergencyFix()">🚀 測試緊急修復</button>
        <button class="btn" onclick="checkLineStatus()">🔍 檢查 LINE 狀態邏輯</button>
    </div>

    <!-- 載入必要的腳本 -->
    <script src="/js/lib/auth-state-manager.js"></script>
    <script src="/js/components/PriceAlertModal.js"></script>

    <script>
        /**
         * 設定已認證用戶（但 LINE 狀態未知）
         */
        function setupAuthenticatedUser() {
            const resultsDiv = document.getElementById('setup-results');
            
            try {
                // 設定 Vic Huang 認證資料
                const vicUser = {
                    "id": "ue5cc188e1d2cdbac5cfda2abb6f6a34b",
                    "email": "line_ue5cc188e1d2cdbac5cfda2abb6f6a34b@example.com",
                    "username": "vic_huang",
                    "profile": {
                        "firstName": "Vic",
                        "lastName": "Huang",
                        "displayName": "Vic Huang"
                    },
                    "provider": "line",
                    "lineId": "ue5cc188e1d2cdbac5cfda2abb6f6a34b",
                    "lineUserId": "ue5cc188e1d2cdbac5cfda2abb6f6a34b"
                };
                
                const testToken = 'test_emergency_fix_token_' + Date.now();
                
                localStorage.setItem('nexustrade_token', testToken);
                localStorage.setItem('nexustrade_user', JSON.stringify(vicUser));
                window.currentUser = vicUser;
                
                resultsDiv.innerHTML = `
                    <div class="result result-success">✅ 已設定已認證用戶：${vicUser.profile.displayName}</div>
                    <div class="result result-success">📱 LINE Provider: ${vicUser.provider}</div>
                    <div class="result result-success">🆔 LINE User ID: ${vicUser.lineUserId}</div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="result result-error">❌ 設定失敗: ${error.message}</div>
                `;
            }
        }

        /**
         * 設定未認證狀態
         */
        function setupUnauthenticatedUser() {
            localStorage.clear();
            window.currentUser = null;
            
            document.getElementById('setup-results').innerHTML = `
                <div class="result result-error">❌ 已清除認證狀態（模擬未認證用戶）</div>
            `;
        }

        /**
         * 測試緊急修復
         */
        function testEmergencyFix() {
            const resultsDiv = document.getElementById('fix-test-results');
            let html = '<h3>🧪 緊急修復測試結果</h3>';
            
            try {
                // 檢查認證狀態
                const token = localStorage.getItem('nexustrade_token');
                const userStr = localStorage.getItem('nexustrade_user');
                const user = userStr ? JSON.parse(userStr) : null;
                
                const isAuthenticated = !!(token && user);
                html += `<div class="result ${isAuthenticated ? 'result-success' : 'result-error'}">
                    認證狀態: ${isAuthenticated ? '✅ 已認證' : '❌ 未認證'}
                </div>`;
                
                if (!isAuthenticated) {
                    html += '<div class="result result-error">❌ 請先設定已認證用戶</div>';
                    resultsDiv.innerHTML = html;
                    return;
                }
                
                // 檢查 PriceAlertModal
                if (typeof window.PriceAlertModal !== 'undefined' && typeof window.priceAlertModal !== 'undefined') {
                    html += '<div class="result result-success">✅ PriceAlertModal 存在</div>';
                    
                    // 測試 LINE 狀態檢查
                    window.priceAlertModal.checkLineConnectionStatus().then(() => {
                        const lineConnected = window.priceAlertModal.isLineConnected;
                        html += `<div class="result ${lineConnected ? 'result-success' : 'result-error'}">
                            LINE 連接狀態: ${lineConnected ? '✅ 已連接' : '⚠️ 未連接'}
                        </div>`;
                        
                        // 關鍵測試：調用 show() 方法
                        window.priceAlertModal.show('BTCUSDT');
                        html += '<div class="result result-success">🚀 已調用 priceAlertModal.show("BTCUSDT")</div>';
                        
                        // 檢查模態框是否顯示完整表單
                        setTimeout(() => {
                            const modal = document.querySelector('.price-alert-modal');
                            if (modal && modal.style.display !== 'none') {
                                const modalContent = modal.innerHTML;
                                
                                const hasLoginPrompt = modalContent.includes('需要登入');
                                const hasLineConnectionPrompt = modalContent.includes('建議連結 LINE');
                                const hasFullForm = modalContent.includes('新增通知') && modalContent.includes('儲存設定');
                                
                                html += '<h4>📋 模態框內容分析</h4>';
                                html += `<div class="result ${!hasLoginPrompt ? 'result-success' : 'result-error'}">
                                    登入提示: ${hasLoginPrompt ? '❌ 仍然顯示' : '✅ 已移除'}
                                </div>`;
                                html += `<div class="result ${!hasLineConnectionPrompt ? 'result-success' : 'result-error'}">
                                    LINE 連接阻擋: ${hasLineConnectionPrompt ? '❌ 仍然存在' : '✅ 已移除'}
                                </div>`;
                                html += `<div class="result ${hasFullForm ? 'result-success' : 'result-error'}">
                                    完整表單: ${hasFullForm ? '✅ 正常顯示' : '❌ 未顯示'}
                                </div>`;
                                
                                if (hasFullForm && !hasLoginPrompt && !hasLineConnectionPrompt) {
                                    html += '<div class="emergency-fix">🎉 緊急修復成功！用戶現在可以正常設定價格警報</div>';
                                } else {
                                    html += '<div class="result result-error">⚠️ 緊急修復仍有問題，需要進一步調查</div>';
                                }
                                
                            } else {
                                html += '<div class="result result-error">❌ 模態框未顯示</div>';
                            }
                            
                            resultsDiv.innerHTML = html;
                        }, 1500);
                        
                        resultsDiv.innerHTML = html + '<div class="result result-success">⏳ 正在分析模態框內容...</div>';
                        
                    }).catch(error => {
                        html += `<div class="result result-error">❌ LINE 狀態檢查失敗: ${error.message}</div>`;
                        resultsDiv.innerHTML = html;
                    });
                    
                } else {
                    html += '<div class="result result-error">❌ PriceAlertModal 不存在</div>';
                    resultsDiv.innerHTML = html;
                }
                
            } catch (error) {
                html += `<div class="result result-error">❌ 測試失敗: ${error.message}</div>`;
                resultsDiv.innerHTML = html;
            }
        }

        /**
         * 檢查 LINE 狀態邏輯
         */
        function checkLineStatus() {
            const resultsDiv = document.getElementById('fix-test-results');
            
            try {
                const currentUser = window.priceAlertModal?.getCurrentUser();
                
                let html = '<h3>🔍 LINE 狀態邏輯檢查</h3>';
                
                if (currentUser) {
                    html += `<div class="result result-success">當前用戶: ${currentUser.profile?.displayName}</div>`;
                    html += `<div class="result result-success">Provider: ${currentUser.provider}</div>`;
                    html += `<div class="result result-success">LINE ID: ${currentUser.lineId || '無'}</div>`;
                    html += `<div class="result result-success">LINE User ID: ${currentUser.lineUserId || '無'}</div>`;
                    
                    // 測試各種 LINE 連接檢查邏輯
                    const check1 = !!currentUser.lineUserId;
                    const check2 = !!currentUser.lineId;
                    const check3 = currentUser.provider === 'line';
                    const finalCheck = check1 || check2 || check3;
                    
                    html += '<h4>🧮 邏輯檢查結果</h4>';
                    html += `<div class="result ${check1 ? 'result-success' : 'result-error'}">lineUserId 存在: ${check1}</div>`;
                    html += `<div class="result ${check2 ? 'result-success' : 'result-error'}">lineId 存在: ${check2}</div>`;
                    html += `<div class="result ${check3 ? 'result-success' : 'result-error'}">provider === 'line': ${check3}</div>`;
                    html += `<div class="result ${finalCheck ? 'result-success' : 'result-error'}">最終判斷 (任一為真): ${finalCheck ? '✅ 應該連接' : '❌ 未連接'}</div>`;
                    
                } else {
                    html += '<div class="result result-error">❌ 無法獲取當前用戶</div>';
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="result result-error">❌ 檢查失敗: ${error.message}</div>`;
            }
        }

        // 頁面載入時的說明
        window.addEventListener('load', function() {
            document.getElementById('setup-results').innerHTML = `
                <div class="result result-success">
                    💡 <strong>使用說明</strong>：<br>
                    1. 先點擊 "設定已認證用戶" 建立測試環境<br>
                    2. 點擊 "測試緊急修復" 驗證修復效果<br>
                    3. 觀察是否能正常顯示價格警報設定表單
                </div>
            `;
        });
    </script>
</body>
</html>