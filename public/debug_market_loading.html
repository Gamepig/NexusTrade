<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸‚å ´é é¢è¼‰å…¥è¨ºæ–·</title>
    <link rel="stylesheet" href="/css/main.css">
    <style>
        body { padding: 20px; background: #1a1a1a; color: #fff; }
        .debug-section { margin: 20px 0; padding: 15px; background: #2a2a2a; border-radius: 8px; }
        .debug-title { color: #4CAF50; font-weight: 600; margin-bottom: 10px; }
        .debug-output { background: #1a1a1a; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.9rem; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .test-btn { background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .test-btn:hover { background: #45a049; }
        .error { color: #f44336; }
        .success { color: #4CAF50; }
        .warning { color: #ff9800; }
    </style>
</head>
<body>
    <h1>ğŸ” å¸‚å ´é é¢è¼‰å…¥è¨ºæ–·å·¥å…·</h1>
    
    <div class="debug-section">
        <div class="debug-title">ğŸ“‹ Step 1: çµ„ä»¶è¼‰å…¥æª¢æŸ¥</div>
        <button class="test-btn" onclick="step1_checkComponents()">æª¢æŸ¥çµ„ä»¶è¼‰å…¥</button>
        <div id="step1-output" class="debug-output"></div>
    </div>
    
    <div class="debug-section">
        <div class="debug-title">ğŸ”Œ Step 2: API ç«¯é»æ¸¬è©¦</div>
        <button class="test-btn" onclick="step2_testAPIs()">æ¸¬è©¦æ‰€æœ‰ API</button>
        <div id="step2-output" class="debug-output"></div>
    </div>
    
    <div class="debug-section">
        <div class="debug-title">ğŸ¯ Step 3: DOM å…ƒç´ æª¢æŸ¥</div>
        <button class="test-btn" onclick="step3_checkDOM()">æª¢æŸ¥ DOM çµæ§‹</button>
        <div id="step3-output" class="debug-output"></div>
    </div>
    
    <div class="debug-section">
        <div class="debug-title">ğŸ§ª Step 4: çµ„ä»¶åˆå§‹åŒ–æ¸¬è©¦</div>
        <div id="test-market-stats" class="market-stats">
            <div class="market-stat">
                <div class="stat-label">è¼‰å…¥ä¸­...</div>
                <div class="stat-value">-</div>
            </div>
        </div>
        <div id="test-market-coins-grid" style="min-height: 200px; border: 1px solid #444; margin: 10px 0; padding: 10px;">
            æ¸¬è©¦å®¹å™¨
        </div>
        <button class="test-btn" onclick="step4_testMarketPage()">æ¸¬è©¦ MarketPage çµ„ä»¶</button>
        <button class="test-btn" onclick="step4_testCryptoList()">æ¸¬è©¦ CryptoCurrencyList çµ„ä»¶</button>
        <div id="step4-output" class="debug-output"></div>
    </div>
    
    <div class="debug-section">
        <div class="debug-title">ğŸ”„ Step 5: å®Œæ•´æµç¨‹æ¸¬è©¦</div>
        <button class="test-btn" onclick="step5_fullTest()">åŸ·è¡Œå®Œæ•´æ¸¬è©¦</button>
        <div id="step5-output" class="debug-output"></div>
    </div>

    <!-- JavaScript æ¨¡çµ„ -->
    <script src="/js/lib/api.js"></script>
    <script src="/js/components/CryptoCurrencyList.js"></script>
    <script src="/js/components/HomeCryptoList.js"></script>
    <script src="/js/components/MarketPage.js"></script>
    
    <script>
        // Step 1: æª¢æŸ¥çµ„ä»¶è¼‰å…¥
        function step1_checkComponents() {
            const output = document.getElementById('step1-output');
            let result = 'çµ„ä»¶è¼‰å…¥æª¢æŸ¥çµæœï¼š\n\n';
            
            const components = [
                'CryptoCurrencyList',
                'HomeCryptoList', 
                'MarketPage'
            ];
            
            let allLoaded = true;
            components.forEach(comp => {
                if (typeof window[comp] !== 'undefined') {
                    result += `âœ… ${comp}: å·²è¼‰å…¥\n`;
                } else {
                    result += `âŒ ${comp}: æœªè¼‰å…¥\n`;
                    allLoaded = false;
                }
            });
            
            result += `\nç‹€æ…‹: ${allLoaded ? 'âœ… æ‰€æœ‰çµ„ä»¶å·²è¼‰å…¥' : 'âŒ éƒ¨åˆ†çµ„ä»¶æœªè¼‰å…¥'}`;
            output.textContent = result;
        }
        
        // Step 2: æ¸¬è©¦ API
        async function step2_testAPIs() {
            const output = document.getElementById('step2-output');
            output.textContent = 'æ¸¬è©¦ API ç«¯é»...\n';
            
            const tests = [
                { name: 'ç†±é–€äº¤æ˜“å°', url: '/api/market/trending?limit=5' },
                { name: 'æ‰¹é‡åƒ¹æ ¼', url: '/api/market/batch-prices?symbols=BTCUSDT,ETHUSDT' },
                { name: '24hçµ±è¨ˆ', url: '/api/market/stats24h' }
            ];
            
            for (const test of tests) {
                try {
                    const response = await fetch(test.url);
                    const data = await response.json();
                    if (data.success) {
                        output.textContent += `âœ… ${test.name}: æˆåŠŸ (${data.data?.length || 'N/A'} é …ç›®)\n`;
                    } else {
                        output.textContent += `âŒ ${test.name}: ${data.message}\n`;
                    }
                } catch (error) {
                    output.textContent += `âŒ ${test.name}: ${error.message}\n`;
                }
            }
        }
        
        // Step 3: æª¢æŸ¥ DOM
        function step3_checkDOM() {
            const output = document.getElementById('step3-output');
            let result = 'DOM å…ƒç´ æª¢æŸ¥çµæœï¼š\n\n';
            
            const elements = [
                'test-market-stats',
                'test-market-coins-grid'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    result += `âœ… #${id}: å­˜åœ¨ (${element.tagName})\n`;
                } else {
                    result += `âŒ #${id}: ä¸å­˜åœ¨\n`;
                }
            });
            
            output.textContent = result;
        }
        
        // Step 4: æ¸¬è©¦ MarketPage çµ„ä»¶
        function step4_testMarketPage() {
            const output = document.getElementById('step4-output');
            output.textContent = 'æ¸¬è©¦ MarketPage çµ„ä»¶...\n';
            
            try {
                if (typeof MarketPage === 'undefined') {
                    output.textContent += 'âŒ MarketPage çµ„ä»¶æœªè¼‰å…¥\n';
                    return;
                }
                
                // æ¸¬è©¦åˆå§‹åŒ–
                output.textContent += 'ğŸ”§ å˜—è©¦åˆå§‹åŒ– MarketPage...\n';
                const marketPage = new MarketPage();
                output.textContent += 'âœ… MarketPage çµ„ä»¶åˆå§‹åŒ–æˆåŠŸ\n';
                
                // æª¢æŸ¥æ–¹æ³•
                const methods = ['loadMarketStats', 'renderMarketStats', 'refresh'];
                methods.forEach(method => {
                    if (typeof marketPage[method] === 'function') {
                        output.textContent += `âœ… æ–¹æ³• ${method}: å­˜åœ¨\n`;
                    } else {
                        output.textContent += `âŒ æ–¹æ³• ${method}: ä¸å­˜åœ¨\n`;
                    }
                });
                
                // å˜—è©¦è¼‰å…¥å¸‚å ´çµ±è¨ˆ
                output.textContent += 'ğŸ”„ å˜—è©¦è¼‰å…¥å¸‚å ´çµ±è¨ˆ...\n';
                marketPage.loadMarketStats().then(() => {
                    output.textContent += 'âœ… å¸‚å ´çµ±è¨ˆè¼‰å…¥æˆåŠŸ\n';
                }).catch(err => {
                    output.textContent += `âŒ å¸‚å ´çµ±è¨ˆè¼‰å…¥å¤±æ•—: ${err.message}\n`;
                });
                
            } catch (error) {
                output.textContent += `âŒ MarketPage çµ„ä»¶æ¸¬è©¦å¤±æ•—ï¼š\n${error.message}\n${error.stack}\n`;
            }
        }
        
        // Step 4: æ¸¬è©¦ CryptoCurrencyList çµ„ä»¶
        function step4_testCryptoList() {
            const output = document.getElementById('step4-output');
            output.textContent = 'æ¸¬è©¦ CryptoCurrencyList çµ„ä»¶...\n';
            
            try {
                if (typeof CryptoCurrencyList === 'undefined') {
                    output.textContent += 'âŒ CryptoCurrencyList çµ„ä»¶æœªè¼‰å…¥\n';
                    return;
                }
                
                const container = document.getElementById('test-market-coins-grid');
                if (!container) {
                    output.textContent += 'âŒ æ¸¬è©¦å®¹å™¨ä¸å­˜åœ¨\n';
                    return;
                }
                
                // æ¸…ç©ºå®¹å™¨
                container.innerHTML = '';
                
                // æ¸¬è©¦åˆå§‹åŒ–
                output.textContent += 'ğŸ”§ å˜—è©¦åˆå§‹åŒ– CryptoCurrencyList...\n';
                const cryptoList = new CryptoCurrencyList({
                    container: container,
                    mode: 'infinite',
                    maxCoins: 10,
                    coinsPerPage: 5,
                    updateInterval: 15000
                });
                
                output.textContent += 'âœ… CryptoCurrencyList çµ„ä»¶åˆå§‹åŒ–æˆåŠŸ\n';
                output.textContent += `âœ… å®¹å™¨: ${container.id}\n`;
                output.textContent += `âœ… æ¨¡å¼: infinite\n`;
                output.textContent += `âœ… æœ€å¤§è²¨å¹£æ•¸: 10\n`;
                
            } catch (error) {
                output.textContent += `âŒ CryptoCurrencyList çµ„ä»¶æ¸¬è©¦å¤±æ•—ï¼š\n${error.message}\n${error.stack}\n`;
            }
        }
        
        // Step 5: å®Œæ•´æµç¨‹æ¸¬è©¦
        async function step5_fullTest() {
            const output = document.getElementById('step5-output');
            output.textContent = 'åŸ·è¡Œå®Œæ•´æµç¨‹æ¸¬è©¦...\n\n';
            
            // 1. æª¢æŸ¥çµ„ä»¶
            output.textContent += 'æ­¥é©Ÿ 1: æª¢æŸ¥çµ„ä»¶è¼‰å…¥\n';
            if (typeof MarketPage === 'undefined' || typeof CryptoCurrencyList === 'undefined') {
                output.textContent += 'âŒ å¿…è¦çµ„ä»¶æœªè¼‰å…¥ï¼Œæ¸¬è©¦çµ‚æ­¢\n';
                return;
            }
            output.textContent += 'âœ… çµ„ä»¶æª¢æŸ¥é€šé\n\n';
            
            // 2. æ¸¬è©¦ API
            output.textContent += 'æ­¥é©Ÿ 2: æ¸¬è©¦ API é€£é€šæ€§\n';
            try {
                const apiTest = await fetch('/api/market/trending?limit=3');
                const apiData = await apiTest.json();
                if (apiData.success) {
                    output.textContent += 'âœ… API é€£é€šæ€§æ­£å¸¸\n\n';
                } else {
                    output.textContent += 'âŒ API å›æ‡‰ç•°å¸¸\n';
                    return;
                }
            } catch (error) {
                output.textContent += `âŒ API é€£æ¥å¤±æ•—: ${error.message}\n`;
                return;
            }
            
            // 3. æ¸¬è©¦å®Œæ•´çµ„ä»¶åˆå§‹åŒ–
            output.textContent += 'æ­¥é©Ÿ 3: åˆå§‹åŒ–å®Œæ•´çµ„ä»¶\n';
            try {
                const container = document.getElementById('test-market-coins-grid');
                container.innerHTML = '';
                
                // å‰µå»ºå¸‚å ´é é¢çµ„ä»¶ (æ¨¡æ“¬çœŸå¯¦ç’°å¢ƒ)
                const marketPage = new MarketPage();
                output.textContent += 'âœ… MarketPage åˆå§‹åŒ–æˆåŠŸ\n';
                
                // æ‰‹å‹•åˆå§‹åŒ–åŠ å¯†è²¨å¹£åˆ—è¡¨
                const cryptoList = new CryptoCurrencyList({
                    container: container,
                    mode: 'infinite',
                    maxCoins: 10,
                    coinsPerPage: 5,
                    updateInterval: 15000
                });
                
                output.textContent += 'âœ… CryptoCurrencyList åˆå§‹åŒ–æˆåŠŸ\n';
                output.textContent += 'âœ… å®Œæ•´æµç¨‹æ¸¬è©¦é€šéï¼\n';
                
            } catch (error) {
                output.textContent += `âŒ çµ„ä»¶åˆå§‹åŒ–å¤±æ•—: ${error.message}\n`;
            }
        }
        
        // è‡ªå‹•é‹è¡ŒåŸºç¤æª¢æŸ¥
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                step1_checkComponents();
                step3_checkDOM();
            }, 500);
        });
        
        // æ•ç² JavaScript éŒ¯èª¤
        window.addEventListener('error', (event) => {
            console.error('JavaScript éŒ¯èª¤:', event.error);
        });
        
        // æ•ç²æœªè™•ç†çš„ Promise éŒ¯èª¤
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Promise éŒ¯èª¤:', event.reason);
        });
    </script>
</body>
</html>