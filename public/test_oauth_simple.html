<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth 簡化測試 - NexusTrade</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
            display: block;
            width: 200px;
        }
        .test-button:hover {
            background: #3367d6;
        }
        .log-output {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>🔧 OAuth 簡化測試頁面</h1>
    
    <div class="test-section">
        <h2>測試 1: 直接重定向測試</h2>
        <p>測試瀏覽器是否能正常重定向到 OAuth 端點</p>
        <button class="test-button" onclick="testDirectRedirect()">測試直接重定向</button>
        <div id="redirect-status" class="status info">點擊按鈕開始測試</div>
    </div>

    <div class="test-section">
        <h2>測試 2: API 端點測試</h2>
        <p>測試後端 OAuth 端點是否正常回應</p>
        <button class="test-button" onclick="testOAuthEndpoint()">測試 API 端點</button>
        <div id="api-status" class="status info">點擊按鈕開始測試</div>
    </div>

    <div class="test-section">
        <h2>測試 3: 認證狀態檢查</h2>
        <p>檢查當前認證狀態和 Token 管理</p>
        <button class="test-button" onclick="checkAuthState()">檢查認證狀態</button>
        <div id="auth-status" class="status info">點擊按鈕開始測試</div>
    </div>

    <div class="test-section">
        <h2>測試日誌</h2>
        <div id="log" class="log-output">測試日誌將顯示在這裡...</div>
        <button class="test-button" onclick="clearLog()">清除日誌</button>
    </div>

    <script>
        // 日誌功能
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`OAuth Test - ${logEntry}`);
        }

        function clearLog() {
            document.getElementById('log').textContent = '測試日誌將顯示在這裡...\n';
        }

        // 測試 1: 直接重定向測試
        function testDirectRedirect() {
            log('開始測試直接重定向...', 'info');
            const statusEl = document.getElementById('redirect-status');
            
            try {
                // 記錄當前 URL
                log(`當前 URL: ${window.location.href}`, 'info');
                
                // 設置狀態元素
                statusEl.className = 'status info';
                statusEl.textContent = '準備重定向到 OAuth...';
                
                // 延遲重定向，讓用戶看到狀態變化
                setTimeout(() => {
                    log('執行重定向: window.location.href = "/auth/google"', 'info');
                    window.location.href = '/auth/google';
                }, 1000);
                
            } catch (error) {
                log(`重定向測試失敗: ${error.message}`, 'error');
                statusEl.className = 'status error';
                statusEl.textContent = `錯誤: ${error.message}`;
            }
        }

        // 測試 2: API 端點測試
        async function testOAuthEndpoint() {
            log('開始測試 OAuth 端點...', 'info');
            const statusEl = document.getElementById('api-status');
            
            try {
                statusEl.className = 'status info';
                statusEl.textContent = '檢查 OAuth 端點...';
                
                // 使用 fetch 測試端點（不跟隨重定向）
                const response = await fetch('/auth/google', {
                    method: 'GET',
                    redirect: 'manual' // 不自動跟隨重定向
                });
                
                log(`API 回應狀態: ${response.status}`, 'info');
                log(`API 回應類型: ${response.type}`, 'info');
                
                if (response.status === 302 || response.type === 'opaqueredirect') {
                    statusEl.className = 'status success';
                    statusEl.textContent = '✅ OAuth 端點正常 (302 重定向)';
                    log('OAuth 端點測試成功 - 正確返回重定向', 'success');
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = `❌ 意外的回應狀態: ${response.status}`;
                    log(`意外的回應狀態: ${response.status}`, 'error');
                }
                
            } catch (error) {
                log(`API 端點測試失敗: ${error.message}`, 'error');
                statusEl.className = 'status error';
                statusEl.textContent = `❌ 錯誤: ${error.message}`;
            }
        }

        // 測試 3: 認證狀態檢查
        function checkAuthState() {
            log('開始檢查認證狀態...', 'info');
            const statusEl = document.getElementById('auth-status');
            
            try {
                // 檢查 localStorage
                const token = localStorage.getItem('token');
                const userInfo = localStorage.getItem('userInfo');
                
                log(`localStorage token: ${token ? '存在' : '不存在'}`, 'info');
                log(`localStorage userInfo: ${userInfo ? '存在' : '不存在'}`, 'info');
                
                // 檢查 sessionStorage
                const sessionToken = sessionStorage.getItem('token');
                log(`sessionStorage token: ${sessionToken ? '存在' : '不存在'}`, 'info');
                
                // 檢查 cookies
                const cookies = document.cookie;
                log(`Cookies: ${cookies || '無 cookies'}`, 'info');
                
                // 檢查全域變數
                const globalAuth = window.authStateManager;
                log(`全域 AuthStateManager: ${globalAuth ? '存在' : '不存在'}`, 'info');
                
                if (globalAuth && typeof globalAuth.getToken === 'function') {
                    const globalToken = globalAuth.getToken();
                    log(`AuthStateManager token: ${globalToken ? '存在' : '不存在'}`, 'info');
                }
                
                // 總結狀態
                if (token || sessionToken || userInfo) {
                    statusEl.className = 'status success';
                    statusEl.textContent = '✅ 發現認證數據';
                } else {
                    statusEl.className = 'status info';
                    statusEl.textContent = 'ℹ️ 未發現認證數據（正常，未登入）';
                }
                
            } catch (error) {
                log(`認證狀態檢查失敗: ${error.message}`, 'error');
                statusEl.className = 'status error';
                statusEl.textContent = `❌ 錯誤: ${error.message}`;
            }
        }

        // 檢查 URL 參數（OAuth 回調）
        function checkURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            const token = urlParams.get('token');
            
            if (error) {
                log(`URL 錯誤參數: ${error}`, 'error');
            }
            
            if (token) {
                log(`URL token 參數: ${token.substring(0, 20)}...`, 'info');
            }
            
            if (!error && !token && window.location.search) {
                log(`其他 URL 參數: ${window.location.search}`, 'info');
            }
        }

        // 頁面載入時執行
        document.addEventListener('DOMContentLoaded', function() {
            log('OAuth 簡化測試頁面已載入', 'info');
            checkURLParams();
        });

        // 監聽錯誤
        window.addEventListener('error', function(event) {
            log(`JavaScript 錯誤: ${event.error?.message || event.message}`, 'error');
        });
    </script>
</body>
</html>