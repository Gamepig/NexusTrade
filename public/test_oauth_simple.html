<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth ç°¡åŒ–æ¸¬è©¦ - NexusTrade</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
            display: block;
            width: 200px;
        }
        .test-button:hover {
            background: #3367d6;
        }
        .log-output {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>ğŸ”§ OAuth ç°¡åŒ–æ¸¬è©¦é é¢</h1>
    
    <div class="test-section">
        <h2>æ¸¬è©¦ 1: ç›´æ¥é‡å®šå‘æ¸¬è©¦</h2>
        <p>æ¸¬è©¦ç€è¦½å™¨æ˜¯å¦èƒ½æ­£å¸¸é‡å®šå‘åˆ° OAuth ç«¯é»</p>
        <button class="test-button" onclick="testDirectRedirect()">æ¸¬è©¦ç›´æ¥é‡å®šå‘</button>
        <div id="redirect-status" class="status info">é»æ“ŠæŒ‰éˆ•é–‹å§‹æ¸¬è©¦</div>
    </div>

    <div class="test-section">
        <h2>æ¸¬è©¦ 2: API ç«¯é»æ¸¬è©¦</h2>
        <p>æ¸¬è©¦å¾Œç«¯ OAuth ç«¯é»æ˜¯å¦æ­£å¸¸å›æ‡‰</p>
        <button class="test-button" onclick="testOAuthEndpoint()">æ¸¬è©¦ API ç«¯é»</button>
        <div id="api-status" class="status info">é»æ“ŠæŒ‰éˆ•é–‹å§‹æ¸¬è©¦</div>
    </div>

    <div class="test-section">
        <h2>æ¸¬è©¦ 3: èªè­‰ç‹€æ…‹æª¢æŸ¥</h2>
        <p>æª¢æŸ¥ç•¶å‰èªè­‰ç‹€æ…‹å’Œ Token ç®¡ç†</p>
        <button class="test-button" onclick="checkAuthState()">æª¢æŸ¥èªè­‰ç‹€æ…‹</button>
        <div id="auth-status" class="status info">é»æ“ŠæŒ‰éˆ•é–‹å§‹æ¸¬è©¦</div>
    </div>

    <div class="test-section">
        <h2>æ¸¬è©¦æ—¥èªŒ</h2>
        <div id="log" class="log-output">æ¸¬è©¦æ—¥èªŒå°‡é¡¯ç¤ºåœ¨é€™è£¡...</div>
        <button class="test-button" onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
    </div>

    <script>
        // æ—¥èªŒåŠŸèƒ½
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`OAuth Test - ${logEntry}`);
        }

        function clearLog() {
            document.getElementById('log').textContent = 'æ¸¬è©¦æ—¥èªŒå°‡é¡¯ç¤ºåœ¨é€™è£¡...\n';
        }

        // æ¸¬è©¦ 1: ç›´æ¥é‡å®šå‘æ¸¬è©¦
        function testDirectRedirect() {
            log('é–‹å§‹æ¸¬è©¦ç›´æ¥é‡å®šå‘...', 'info');
            const statusEl = document.getElementById('redirect-status');
            
            try {
                // è¨˜éŒ„ç•¶å‰ URL
                log(`ç•¶å‰ URL: ${window.location.href}`, 'info');
                
                // è¨­ç½®ç‹€æ…‹å…ƒç´ 
                statusEl.className = 'status info';
                statusEl.textContent = 'æº–å‚™é‡å®šå‘åˆ° OAuth...';
                
                // å»¶é²é‡å®šå‘ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°ç‹€æ…‹è®ŠåŒ–
                setTimeout(() => {
                    log('åŸ·è¡Œé‡å®šå‘: window.location.href = "/auth/google"', 'info');
                    window.location.href = '/auth/google';
                }, 1000);
                
            } catch (error) {
                log(`é‡å®šå‘æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                statusEl.className = 'status error';
                statusEl.textContent = `éŒ¯èª¤: ${error.message}`;
            }
        }

        // æ¸¬è©¦ 2: API ç«¯é»æ¸¬è©¦
        async function testOAuthEndpoint() {
            log('é–‹å§‹æ¸¬è©¦ OAuth ç«¯é»...', 'info');
            const statusEl = document.getElementById('api-status');
            
            try {
                statusEl.className = 'status info';
                statusEl.textContent = 'æª¢æŸ¥ OAuth ç«¯é»...';
                
                // ä½¿ç”¨ fetch æ¸¬è©¦ç«¯é»ï¼ˆä¸è·Ÿéš¨é‡å®šå‘ï¼‰
                const response = await fetch('/auth/google', {
                    method: 'GET',
                    redirect: 'manual' // ä¸è‡ªå‹•è·Ÿéš¨é‡å®šå‘
                });
                
                log(`API å›æ‡‰ç‹€æ…‹: ${response.status}`, 'info');
                log(`API å›æ‡‰é¡å‹: ${response.type}`, 'info');
                
                if (response.status === 302 || response.type === 'opaqueredirect') {
                    statusEl.className = 'status success';
                    statusEl.textContent = 'âœ… OAuth ç«¯é»æ­£å¸¸ (302 é‡å®šå‘)';
                    log('OAuth ç«¯é»æ¸¬è©¦æˆåŠŸ - æ­£ç¢ºè¿”å›é‡å®šå‘', 'success');
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = `âŒ æ„å¤–çš„å›æ‡‰ç‹€æ…‹: ${response.status}`;
                    log(`æ„å¤–çš„å›æ‡‰ç‹€æ…‹: ${response.status}`, 'error');
                }
                
            } catch (error) {
                log(`API ç«¯é»æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                statusEl.className = 'status error';
                statusEl.textContent = `âŒ éŒ¯èª¤: ${error.message}`;
            }
        }

        // æ¸¬è©¦ 3: èªè­‰ç‹€æ…‹æª¢æŸ¥
        function checkAuthState() {
            log('é–‹å§‹æª¢æŸ¥èªè­‰ç‹€æ…‹...', 'info');
            const statusEl = document.getElementById('auth-status');
            
            try {
                // æª¢æŸ¥ localStorage
                const token = localStorage.getItem('token');
                const userInfo = localStorage.getItem('userInfo');
                
                log(`localStorage token: ${token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`, 'info');
                log(`localStorage userInfo: ${userInfo ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`, 'info');
                
                // æª¢æŸ¥ sessionStorage
                const sessionToken = sessionStorage.getItem('token');
                log(`sessionStorage token: ${sessionToken ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`, 'info');
                
                // æª¢æŸ¥ cookies
                const cookies = document.cookie;
                log(`Cookies: ${cookies || 'ç„¡ cookies'}`, 'info');
                
                // æª¢æŸ¥å…¨åŸŸè®Šæ•¸
                const globalAuth = window.authStateManager;
                log(`å…¨åŸŸ AuthStateManager: ${globalAuth ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`, 'info');
                
                if (globalAuth && typeof globalAuth.getToken === 'function') {
                    const globalToken = globalAuth.getToken();
                    log(`AuthStateManager token: ${globalToken ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`, 'info');
                }
                
                // ç¸½çµç‹€æ…‹
                if (token || sessionToken || userInfo) {
                    statusEl.className = 'status success';
                    statusEl.textContent = 'âœ… ç™¼ç¾èªè­‰æ•¸æ“š';
                } else {
                    statusEl.className = 'status info';
                    statusEl.textContent = 'â„¹ï¸ æœªç™¼ç¾èªè­‰æ•¸æ“šï¼ˆæ­£å¸¸ï¼Œæœªç™»å…¥ï¼‰';
                }
                
            } catch (error) {
                log(`èªè­‰ç‹€æ…‹æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
                statusEl.className = 'status error';
                statusEl.textContent = `âŒ éŒ¯èª¤: ${error.message}`;
            }
        }

        // æª¢æŸ¥ URL åƒæ•¸ï¼ˆOAuth å›èª¿ï¼‰
        function checkURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            const token = urlParams.get('token');
            
            if (error) {
                log(`URL éŒ¯èª¤åƒæ•¸: ${error}`, 'error');
            }
            
            if (token) {
                log(`URL token åƒæ•¸: ${token.substring(0, 20)}...`, 'info');
            }
            
            if (!error && !token && window.location.search) {
                log(`å…¶ä»– URL åƒæ•¸: ${window.location.search}`, 'info');
            }
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            log('OAuth ç°¡åŒ–æ¸¬è©¦é é¢å·²è¼‰å…¥', 'info');
            checkURLParams();
        });

        // ç›£è½éŒ¯èª¤
        window.addEventListener('error', function(event) {
            log(`JavaScript éŒ¯èª¤: ${event.error?.message || event.message}`, 'error');
        });
    </script>
</body>
</html>