<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å…¥å•é¡Œè¨ºæ–· - NexusTrade</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover { background: #0056b3; }
        .button.success { background: #28a745; }
        .button.danger { background: #dc3545; }
        .button.warning { background: #ffc107; color: #212529; }
        
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .status.warning { background: #fff3cd; color: #856404; }
        
        h1 { color: #333; }
        h2 { color: #555; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ç™»å…¥å•é¡Œè¨ºæ–·å·¥å…·</h1>
    <p><strong>å•é¡Œæè¿°</strong>: é»æ“Š Google ç™»å…¥ç„¡åæ‡‰ï¼Œé»æ“Š LINE ç™»å…¥ç›´æ¥è·³å›é¦–é </p>
    
    <div class="grid">
        <!-- åŸºæœ¬è¨ºæ–· -->
        <div class="section">
            <h2>ğŸ” åŸºæœ¬è¨ºæ–·</h2>
            <button class="button" onclick="runBasicDiagnosis()">åŸ·è¡ŒåŸºæœ¬è¨ºæ–·</button>
            <div id="basic-result" class="result">é»æ“ŠåŸ·è¡ŒåŸºæœ¬è¨ºæ–·...</div>
        </div>

        <!-- ç™»å…¥æŒ‰éˆ•æ¸¬è©¦ -->
        <div class="section">
            <h2>ğŸ¯ ç™»å…¥æŒ‰éˆ•æ¸¬è©¦</h2>
            <button class="button" onclick="testLoginButton()">æ¸¬è©¦ç™»å…¥æŒ‰éˆ•</button>
            <button class="button warning" onclick="testModalShow()">æ¸¬è©¦æ¨¡æ…‹æ¡†é¡¯ç¤º</button>
            <div id="login-test-result" class="result">é»æ“Šæ¸¬è©¦ç™»å…¥æŒ‰éˆ•...</div>
        </div>

        <!-- OAuth æŒ‰éˆ•æ¸¬è©¦ -->
        <div class="section">
            <h2>ğŸ” OAuth æŒ‰éˆ•æ¸¬è©¦</h2>
            <button class="button" onclick="testGoogleLogin()">æ¸¬è©¦ Google ç™»å…¥</button>
            <button class="button success" onclick="testLineLogin()">æ¸¬è©¦ LINE ç™»å…¥</button>
            <div id="oauth-test-result" class="result">é»æ“Šæ¸¬è©¦ OAuth æŒ‰éˆ•...</div>
        </div>

        <!-- OAuth ç«¯é»æ¸¬è©¦ -->
        <div class="section">
            <h2>ğŸŒ OAuth ç«¯é»æ¸¬è©¦</h2>
            <button class="button" onclick="testOAuthEndpoints()">æ¸¬è©¦ OAuth ç«¯é»</button>
            <div id="endpoint-test-result" class="result">é»æ“Šæ¸¬è©¦ OAuth ç«¯é»...</div>
        </div>

        <!-- å¯¦æ™‚éŒ¯èª¤ç›£æ§ -->
        <div class="section full-width">
            <h2>ğŸš¨ å¯¦æ™‚éŒ¯èª¤ç›£æ§</h2>
            <button class="button danger" onclick="clearErrorLog()">æ¸…é™¤éŒ¯èª¤æ—¥èªŒ</button>
            <div id="error-log" class="result">ç­‰å¾…éŒ¯èª¤...</div>
        </div>

        <!-- æ‰‹å‹•æ¸¬è©¦å€åŸŸ -->
        <div class="section full-width">
            <h2>ğŸ§ª æ‰‹å‹•æ¸¬è©¦å€åŸŸ</h2>
            <p>é€™è£¡è¤‡è£½ä¸»é é¢çš„ç™»å…¥æŒ‰éˆ•ï¼Œç”¨æ–¼éš”é›¢æ¸¬è©¦ï¼š</p>
            <button class="button" id="test-login-btn">ç™»å…¥</button>
            <div id="manual-test-result" class="result">æ‰‹å‹•æ¸¬è©¦çµæœ...</div>
        </div>
    </div>

    <!-- è¼‰å…¥å¿…è¦çš„è…³æœ¬ -->
    <script src="/js/lib/api.js"></script>
    <script src="/js/lib/dom.js"></script>
    <script src="/js/lib/router.js"></script>
    <script src="/js/lib/auth-state-manager.js"></script>
    <script src="/js/state/store.js"></script>
    <script src="/js/components/Notification.js"></script>
    <script src="/js/components/LoginModal.js"></script>

    <script>
        let errorCount = 0;
        let diagnosticResults = {};

        // éŒ¯èª¤ç›£æ§
        const originalError = console.error;
        const originalLog = console.log;
        
        console.error = function(...args) {
            errorCount++;
            const errorLog = document.getElementById('error-log');
            const timestamp = new Date().toLocaleTimeString();
            errorLog.textContent += `[${timestamp}] ERROR: ${args.join(' ')}\n`;
            errorLog.scrollTop = errorLog.scrollHeight;
            originalError.apply(console, args);
        };

        function clearErrorLog() {
            document.getElementById('error-log').textContent = 'ç­‰å¾…éŒ¯èª¤...';
            errorCount = 0;
        }

        // åŸºæœ¬è¨ºæ–·
        function runBasicDiagnosis() {
            const result = document.getElementById('basic-result');
            let output = '';

            // 1. æª¢æŸ¥å…¨åŸŸè®Šæ•¸
            output += '=== å…¨åŸŸè®Šæ•¸æª¢æŸ¥ ===\n';
            output += `window.app: ${typeof window.app !== 'undefined'}\n`;
            output += `window.loginModal: ${typeof window.loginModal !== 'undefined'}\n`;
            output += `LoginModal é¡åˆ¥: ${typeof LoginModal !== 'undefined'}\n`;

            // 2. æª¢æŸ¥ DOM å…ƒç´ 
            output += '\n=== DOM å…ƒç´ æª¢æŸ¥ ===\n';
            const loginBtn = document.getElementById('login-btn');
            const loginModal = document.getElementById('login-modal');
            
            output += `login-btn å…ƒç´ : ${!!loginBtn}\n`;
            output += `login-modal å…ƒç´ : ${!!loginModal}\n`;
            
            if (loginBtn) {
                output += `login-btn å¯è¦‹: ${loginBtn.offsetParent !== null}\n`;
                output += `login-btn å…§å®¹: "${loginBtn.textContent}"\n`;
            }

            // 3. æª¢æŸ¥ LoginModal å¯¦ä¾‹
            output += '\n=== LoginModal å¯¦ä¾‹æª¢æŸ¥ ===\n';
            if (typeof LoginModal !== 'undefined') {
                try {
                    const testModal = new LoginModal();
                    output += `LoginModal å¯¦ä¾‹åŒ–: æˆåŠŸ\n`;
                    output += `testModal.modal å­˜åœ¨: ${!!testModal.modal}\n`;
                } catch (error) {
                    output += `LoginModal å¯¦ä¾‹åŒ–: å¤±æ•— - ${error.message}\n`;
                }
            }

            // 4. æª¢æŸ¥è…³æœ¬è¼‰å…¥
            output += '\n=== è…³æœ¬è¼‰å…¥æª¢æŸ¥ ===\n';
            const scripts = Array.from(document.querySelectorAll('script')).map(s => s.src);
            const relevantScripts = scripts.filter(src => 
                src.includes('LoginModal') || 
                src.includes('nexus-app-fixed') ||
                src.includes('auth-state-manager')
            );
            
            output += `ç›¸é—œè…³æœ¬è¼‰å…¥: ${relevantScripts.length} å€‹\n`;
            relevantScripts.forEach(script => {
                output += `  - ${script.split('/').pop()}\n`;
            });

            result.textContent = output;
            diagnosticResults.basic = { success: true, output };
        }

        // æ¸¬è©¦ç™»å…¥æŒ‰éˆ•
        function testLoginButton() {
            const result = document.getElementById('login-test-result');
            let output = '';

            const loginBtn = document.getElementById('login-btn');
            
            if (!loginBtn) {
                output = 'âŒ æ‰¾ä¸åˆ° login-btn å…ƒç´ ';
                result.textContent = output;
                return;
            }

            output += '=== ç™»å…¥æŒ‰éˆ•æ¸¬è©¦ ===\n';
            output += '1. è§¸ç™¼é»æ“Šäº‹ä»¶...\n';

            // å‰µå»ºé»æ“Šäº‹ä»¶
            const clickEvent = new MouseEvent('click', {
                bubbles: true,
                cancelable: true,
                view: window
            });

            // è¨˜éŒ„é»æ“Šå‰ç‹€æ…‹
            const modalBefore = document.getElementById('login-modal');
            const modalVisibleBefore = modalBefore ? window.getComputedStyle(modalBefore).display !== 'none' : false;
            output += `é»æ“Šå‰æ¨¡æ…‹æ¡†é¡¯ç¤º: ${modalVisibleBefore}\n`;

            // æ´¾ç™¼é»æ“Šäº‹ä»¶
            const dispatched = loginBtn.dispatchEvent(clickEvent);
            output += `é»æ“Šäº‹ä»¶æ´¾ç™¼: ${dispatched}\n`;

            // æª¢æŸ¥é»æ“Šå¾Œç‹€æ…‹
            setTimeout(() => {
                const modalAfter = document.getElementById('login-modal');
                const modalVisibleAfter = modalAfter ? window.getComputedStyle(modalAfter).display !== 'none' : false;
                output += `é»æ“Šå¾Œæ¨¡æ…‹æ¡†é¡¯ç¤º: ${modalVisibleAfter}\n`;
                
                if (modalVisibleAfter && !modalVisibleBefore) {
                    output += 'âœ… ç™»å…¥æŒ‰éˆ•åŠŸèƒ½æ­£å¸¸\n';
                } else {
                    output += 'âŒ ç™»å…¥æŒ‰éˆ•å¯èƒ½ç„¡åæ‡‰\n';
                }
                
                result.textContent = output;
                diagnosticResults.loginButton = { success: modalVisibleAfter && !modalVisibleBefore };
            }, 200);
        }

        // æ¸¬è©¦æ¨¡æ…‹æ¡†é¡¯ç¤º
        function testModalShow() {
            const result = document.getElementById('login-test-result');
            let output = '=== æ¨¡æ…‹æ¡†é¡¯ç¤ºæ¸¬è©¦ ===\n';

            // å˜—è©¦ä¸åŒçš„æ–¹å¼é¡¯ç¤ºæ¨¡æ…‹æ¡†
            if (window.loginModal && typeof window.loginModal.show === 'function') {
                try {
                    window.loginModal.show();
                    output += 'âœ… window.loginModal.show() åŸ·è¡ŒæˆåŠŸ\n';
                } catch (error) {
                    output += `âŒ window.loginModal.show() å¤±æ•—: ${error.message}\n`;
                }
            } else if (window.app && window.app.loginModal) {
                try {
                    window.app.loginModal.show();
                    output += 'âœ… window.app.loginModal.show() åŸ·è¡ŒæˆåŠŸ\n';
                } catch (error) {
                    output += `âŒ window.app.loginModal.show() å¤±æ•—: ${error.message}\n`;
                }
            } else {
                output += 'âŒ æ‰¾ä¸åˆ°ä»»ä½• loginModal å¯¦ä¾‹\n';
                
                // å˜—è©¦å‰µå»ºæ–°å¯¦ä¾‹
                if (typeof LoginModal !== 'undefined') {
                    try {
                        const newModal = new LoginModal();
                        newModal.show();
                        output += 'âœ… æ–°å»º LoginModal å¯¦ä¾‹ä¸¦é¡¯ç¤ºæˆåŠŸ\n';
                    } catch (error) {
                        output += `âŒ æ–°å»º LoginModal å¯¦ä¾‹å¤±æ•—: ${error.message}\n`;
                    }
                }
            }

            result.textContent = output;
        }

        // æ¸¬è©¦ Google ç™»å…¥
        function testGoogleLogin() {
            const result = document.getElementById('oauth-test-result');
            result.textContent = '=== Google ç™»å…¥æ¸¬è©¦ ===\næ­£åœ¨åŸ·è¡Œ...';
            
            // å…ˆé¡¯ç¤ºæ¨¡æ…‹æ¡†
            testModalShow();
            
            setTimeout(() => {
                const googleBtn = document.getElementById('google-login-btn');
                let output = result.textContent;
                
                if (googleBtn) {
                    output += '\næ‰¾åˆ° Google ç™»å…¥æŒ‰éˆ•\n';
                    output += 'è§¸ç™¼é»æ“Šäº‹ä»¶...\n';
                    
                    const clickEvent = new MouseEvent('click', {
                        bubbles: true,
                        cancelable: true,
                        view: window
                    });
                    
                    googleBtn.dispatchEvent(clickEvent);
                    output += 'âœ… Google ç™»å…¥æŒ‰éˆ•é»æ“Šäº‹ä»¶å·²è§¸ç™¼\n';
                } else {
                    output += '\nâŒ æ‰¾ä¸åˆ° Google ç™»å…¥æŒ‰éˆ•\n';
                }
                
                result.textContent = output;
            }, 500);
        }

        // æ¸¬è©¦ LINE ç™»å…¥
        function testLineLogin() {
            const result = document.getElementById('oauth-test-result');
            result.textContent = '=== LINE ç™»å…¥æ¸¬è©¦ ===\næ­£åœ¨åŸ·è¡Œ...';
            
            // å…ˆé¡¯ç¤ºæ¨¡æ…‹æ¡†
            testModalShow();
            
            setTimeout(() => {
                const lineBtn = document.getElementById('line-login-btn');
                let output = result.textContent;
                
                if (lineBtn) {
                    output += '\næ‰¾åˆ° LINE ç™»å…¥æŒ‰éˆ•\n';
                    output += 'è§¸ç™¼é»æ“Šäº‹ä»¶...\n';
                    
                    const clickEvent = new MouseEvent('click', {
                        bubbles: true,
                        cancelable: true,
                        view: window
                    });
                    
                    lineBtn.dispatchEvent(clickEvent);
                    output += 'âœ… LINE ç™»å…¥æŒ‰éˆ•é»æ“Šäº‹ä»¶å·²è§¸ç™¼\n';
                } else {
                    output += '\nâŒ æ‰¾ä¸åˆ° LINE ç™»å…¥æŒ‰éˆ•\n';
                }
                
                result.textContent = output;
            }, 500);
        }

        // æ¸¬è©¦ OAuth ç«¯é»
        async function testOAuthEndpoints() {
            const result = document.getElementById('endpoint-test-result');
            result.textContent = '=== OAuth ç«¯é»æ¸¬è©¦ ===\næ­£åœ¨æ¸¬è©¦...';
            
            let output = '';
            
            try {
                // æ¸¬è©¦ Google OAuth
                output += '\næ¸¬è©¦ Google OAuth ç«¯é»...\n';
                const googleResponse = await fetch('/auth/google', { redirect: 'manual' });
                output += `Google å›æ‡‰: status=${googleResponse.status}, type=${googleResponse.type}\n`;
                
                // æ¸¬è©¦ LINE OAuth
                output += '\næ¸¬è©¦ LINE OAuth ç«¯é»...\n';
                const lineResponse = await fetch('/auth/line', { redirect: 'manual' });
                output += `LINE å›æ‡‰: status=${lineResponse.status}, type=${lineResponse.type}\n`;
                
                // åˆ†æçµæœ
                if (googleResponse.type === 'opaqueredirect') {
                    output += '\nâœ… Google OAuth ç«¯é»æ­£å¸¸ (é‡å®šå‘)\n';
                } else {
                    output += '\nâŒ Google OAuth ç«¯é»å¯èƒ½æœ‰å•é¡Œ\n';
                }
                
                if (lineResponse.type === 'opaqueredirect') {
                    output += 'âœ… LINE OAuth ç«¯é»æ­£å¸¸ (é‡å®šå‘)\n';
                } else {
                    output += 'âŒ LINE OAuth ç«¯é»å¯èƒ½æœ‰å•é¡Œ\n';
                }
                
            } catch (error) {
                output += `\nâŒ OAuth ç«¯é»æ¸¬è©¦å¤±æ•—: ${error.message}\n`;
            }
            
            result.textContent = output;
        }

        // é é¢è¼‰å…¥å¾Œè‡ªå‹•åŸ·è¡ŒåŸºæœ¬è¨ºæ–·
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”§ ç™»å…¥å•é¡Œè¨ºæ–·é é¢å·²è¼‰å…¥');
            
            // å»¶é²åŸ·è¡Œï¼Œç¢ºä¿æ‰€æœ‰è…³æœ¬éƒ½è¼‰å…¥å®Œæˆ
            setTimeout(() => {
                runBasicDiagnosis();
            }, 1000);
        });

        // æ‰‹å‹•æ¸¬è©¦æŒ‰éˆ•
        document.addEventListener('DOMContentLoaded', function() {
            const testBtn = document.getElementById('test-login-btn');
            const result = document.getElementById('manual-test-result');
            
            if (testBtn) {
                testBtn.addEventListener('click', function() {
                    result.textContent = 'æ‰‹å‹•ç™»å…¥æŒ‰éˆ•è¢«é»æ“Šï¼\næ™‚é–“: ' + new Date().toLocaleTimeString();
                });
            }
        });
    </script>
</body>
</html>