<!DOCTYPE html>
<html>
<head>
    <title>OAuth Token ä¿®å¾©é©—è­‰</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-container { background: white; padding: 20px; border-radius: 8px; margin: 10px 0; }
        .status { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { background: #f8f9fa; padding: 15px; margin: 10px 0; border-left: 4px solid #007bff; }
        pre { background: #f1f1f1; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ”§ OAuth Token ä¿®å¾©é©—è­‰æ¸¬è©¦</h1>
    
    <div class="test-container">
        <h2>ğŸ“Š ç•¶å‰ç‹€æ³æª¢æŸ¥</h2>
        <button onclick="checkCurrentState()">æª¢æŸ¥ç•¶å‰ç‹€æ…‹</button>
        <button onclick="checkLoginModal()">æª¢æŸ¥ LoginModal å¯¦ä¾‹</button>
        <div id="current-state-result"></div>
    </div>
    
    <div class="test-container">
        <h2>ğŸ§ª æ¨¡æ“¬ä¿®å¾©å‰å•é¡Œ</h2>
        <p>è¨­ç½®æœ‰ token ä½†æ²’æœ‰ user çš„æƒ…æ³ï¼ˆä¿®å¾©å‰æœƒè¢«æ¸…é™¤ï¼‰</p>
        <button onclick="simulateOldProblem()">æ¨¡æ“¬ä¿®å¾©å‰çš„å•é¡Œ</button>
        <div id="old-problem-result"></div>
    </div>
    
    <div class="test-container">
        <h2>âœ… æ¸¬è©¦ä¿®å¾©æ•ˆæœ</h2>
        <p>é©—è­‰ä¿®å¾©å¾Œçš„å®¹éŒ¯æ©Ÿåˆ¶å’Œè³‡æ–™ä¿è­·</p>
        <button onclick="testTokenFix()">æ¸¬è©¦ Token ä¿®å¾©æ©Ÿåˆ¶</button>
        <button onclick="testManualLogin()">æ‰‹å‹•è¨­ç½®ç™»å…¥ç‹€æ…‹</button>
        <div id="fix-test-result"></div>
    </div>
    
    <div class="test-container">
        <h2>ğŸ”„ é‡è¼‰æ¸¬è©¦</h2>
        <p>æ¸¬è©¦é é¢é‡è¼‰å¾Œç‹€æ…‹æŒä¹…æ€§</p>
        <button onclick="testReloadPersistence()">æ¸¬è©¦é é¢é‡è¼‰æŒä¹…æ€§</button>
        <button onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ¸¬è©¦è³‡æ–™</button>
        <div id="reload-test-result"></div>
    </div>

    <script>
        function showResult(containerId, type, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function showDetailedResult(containerId, title, data) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="result">
                    <h4>${title}</h4>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
        }
        
        function checkCurrentState() {
            const tokens = {
                token: localStorage.getItem('nexustrade_token'),
                refreshToken: localStorage.getItem('nexustrade_refresh_token'),
                user: localStorage.getItem('nexustrade_user')
            };
            
            const hasLoginModal = !!window.loginModal;
            const authTokens = hasLoginModal ? window.loginModal.authTokens : null;
            
            showDetailedResult('current-state-result', 'ğŸ“Š ç•¶å‰ç‹€æ…‹', {
                localStorage: tokens,
                loginModalExists: hasLoginModal,
                authTokens: authTokens,
                parsedUser: tokens.user ? JSON.parse(tokens.user) : null
            });
        }
        
        function checkLoginModal() {
            if (!window.loginModal) {
                showResult('current-state-result', 'error', 'âŒ LoginModal å¯¦ä¾‹ä¸å­˜åœ¨');
                return;
            }
            
            const modalInfo = {
                exists: true,
                authTokens: window.loginModal.authTokens,
                hasToken: !!window.loginModal.authTokens.token,
                hasUser: !!window.loginModal.authTokens.user,
                tokenType: window.loginModal.authTokens.token ? 
                    (window.loginModal.authTokens.token.includes('test') ? 'test' : 'real') : 'none'
            };
            
            showDetailedResult('current-state-result', 'ğŸ” LoginModal ç‹€æ…‹', modalInfo);
        }
        
        function simulateOldProblem() {
            // è¨­ç½®æœ‰ token ä½†æ²’æœ‰ user çš„æƒ…æ³
            localStorage.setItem('nexustrade_token', 'test_token_without_user_12345');
            localStorage.setItem('nexustrade_refresh_token', 'test_refresh_token_12345');
            localStorage.removeItem('nexustrade_user');
            
            showResult('old-problem-result', 'warning', 
                'âš ï¸ å·²è¨­ç½®æœ‰ token ä½†æ²’æœ‰ user çš„æƒ…æ³ã€‚ä¿®å¾©å‰é€™æœƒå°è‡´ token è¢«æ¸…é™¤ã€‚<br>' +
                'è«‹é‡æ–°è¼‰å…¥é é¢ä¸¦è§€å¯Ÿ Console æ—¥èªŒä¾†æŸ¥çœ‹ä¿®å¾©æ•ˆæœã€‚'
            );
        }
        
        function testTokenFix() {
            // è¨­ç½®æ¸¬è©¦å ´æ™¯
            localStorage.setItem('nexustrade_token', 'test_token_fix_validation_12345');
            localStorage.setItem('nexustrade_refresh_token', 'test_refresh_token_12345');
            localStorage.removeItem('nexustrade_user');
            
            if (window.loginModal) {
                // é‡æ–°è¼‰å…¥ authTokens
                window.loginModal.authTokens = window.loginModal.loadTokensFromStorage();
                
                // è§¸ç™¼ handleAutoLogin
                window.loginModal.handleAutoLogin().then(() => {
                    setTimeout(() => {
                        const result = {
                            tokenPreserved: !!localStorage.getItem('nexustrade_token'),
                            userCreated: !!localStorage.getItem('nexustrade_user'),
                            authTokensState: window.loginModal.authTokens,
                            testResult: 'ä¿®å¾©æ©Ÿåˆ¶æ­£å¸¸é‹ä½œ'
                        };
                        
                        showDetailedResult('fix-test-result', 'âœ… Token ä¿®å¾©æ¸¬è©¦çµæœ', result);
                    }, 1000);
                });
            } else {
                showResult('fix-test-result', 'error', 'âŒ éœ€è¦å…ˆè¼‰å…¥ LoginModal å¯¦ä¾‹');
            }
        }
        
        function testManualLogin() {
            const testUser = {
                name: 'ä¿®å¾©æ¸¬è©¦ä½¿ç”¨è€…',
                email: 'fix-test@nexustrade.com',
                avatar: 'https://via.placeholder.com/40',
                provider: 'manual-test'
            };
            
            localStorage.setItem('nexustrade_token', 'manual_test_token_' + Date.now());
            localStorage.setItem('nexustrade_refresh_token', 'manual_test_refresh_' + Date.now());
            localStorage.setItem('nexustrade_user', JSON.stringify(testUser));
            
            if (window.loginModal) {
                window.loginModal.authTokens = window.loginModal.loadTokensFromStorage();
                window.loginModal.updateUIForLoggedInUser(testUser);
                
                showResult('fix-test-result', 'success', 
                    'âœ… æ‰‹å‹•ç™»å…¥ç‹€æ…‹å·²è¨­ç½®ã€‚è«‹æª¢æŸ¥é é¢é ‚éƒ¨æ˜¯å¦é¡¯ç¤ºä½¿ç”¨è€…é ­åƒå’Œåç¨±ã€‚'
                );
            } else {
                showResult('fix-test-result', 'error', 'âŒ éœ€è¦å…ˆè¼‰å…¥ LoginModal å¯¦ä¾‹');
            }
        }
        
        function testReloadPersistence() {
            const testData = {
                token: 'persistence_test_token_' + Date.now(),
                user: {
                    name: 'æŒä¹…æ€§æ¸¬è©¦',
                    email: 'persistence@test.com',
                    avatar: 'https://via.placeholder.com/40'
                }
            };
            
            localStorage.setItem('nexustrade_token', testData.token);
            localStorage.setItem('nexustrade_user', JSON.stringify(testData.user));
            
            showResult('reload-test-result', 'info', 
                'ğŸ“ æ¸¬è©¦è³‡æ–™å·²è¨­ç½®ã€‚é»æ“Šé‡æ–°è¼‰å…¥æŒ‰éˆ•æ¸¬è©¦æŒä¹…æ€§...<br>' +
                '<button onclick="location.reload()">ğŸ”„ é‡æ–°è¼‰å…¥é é¢</button>'
            );
        }
        
        function clearAllData() {
            const keys = [
                'nexustrade_token', 'nexustrade_refresh_token', 'nexustrade_user',
                'nexustrade_line_bound', 'nexustrade_return_state',
                'token', 'userInfo', 'refreshToken', 'user'
            ];
            
            keys.forEach(key => localStorage.removeItem(key));
            
            if (window.loginModal) {
                window.loginModal.authTokens = { token: null, refreshToken: null, user: null };
                window.loginModal.updateUIForLoggedOutUser();
            }
            
            showResult('reload-test-result', 'success', 'ğŸ§¹ æ‰€æœ‰æ¸¬è©¦è³‡æ–™å·²æ¸…é™¤');
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥ç‹€æ…‹
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkCurrentState();
                
                // é¡¯ç¤ºä¿®å¾©æ•ˆæœæç¤º
                const hasToken = localStorage.getItem('nexustrade_token');
                const hasUser = localStorage.getItem('nexustrade_user');
                
                if (hasToken && !hasUser) {
                    showResult('current-state-result', 'warning', 
                        'âš ï¸ æª¢æ¸¬åˆ°æœ‰ token ä½†æ²’æœ‰ user çš„æƒ…æ³ã€‚ä¿®å¾©æ©Ÿåˆ¶æ‡‰è©²æœƒè‡ªå‹•è™•ç†ã€‚<br>' +
                        'è«‹è§€å¯Ÿ Console æ—¥èªŒæŸ¥çœ‹ä¿®å¾©éç¨‹ã€‚'
                    );
                }
            }, 1000);
        });
    </script>
</body>
</html>