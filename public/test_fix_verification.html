<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修復驗證測試</title>
    <link rel="stylesheet" href="/css/main.css">
    <style>
        .test-section {
            background: #1a1a1a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .test-section h3 {
            color: #f7931a;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        .success { color: #00d4aa; }
        .error { color: #ff4757; }
        .warning { color: #ffa502; }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <span class="logo-icon">₿</span>
                        <span class="logo-text">NexusTrade 修復驗證</span>
                    </div>
                </div>
            </div>
        </header>

        <div class="container" style="margin-top: 20px;">
            <h1>🔧 修復驗證測試</h1>
            
            <!-- 1. 新聞跑馬燈測試 -->
            <div class="test-section">
                <h3>1. 新聞跑馬燈測試</h3>
                <div class="news-ticker-section">
                    <div id="news-ticker"></div>
                </div>
                <p id="ticker-status" class="warning">初始化中...</p>
            </div>

            <!-- 2. 圖標顯示測試 -->
            <div class="test-section">
                <h3>2. 純文字圖標測試</h3>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin: 15px 0;">
                    <div id="icon-btc"></div>
                    <div id="icon-eth"></div>
                    <div id="icon-bnb"></div>
                    <div id="icon-sol"></div>
                    <div id="icon-usdc"></div>
                    <div id="icon-doge"></div>
                </div>
                <p id="icon-status" class="warning">載入中...</p>
            </div>

            <!-- 3. 熱門貨幣列表測試 -->
            <div class="test-section">
                <h3>3. 熱門貨幣列表測試</h3>
                <div class="coins-table">
                    <div class="table-header">
                        <div class="col-coin">貨幣</div>
                        <div class="col-price">價格</div>
                        <div class="col-change">24h 變化</div>
                        <div class="col-change-amount">漲跌點數</div>
                        <div class="col-volume">24h 交易量</div>
                        <div class="col-market-cap">市值</div>
                    </div>
                    <div class="table-body" id="test-coins-list">
                        <div class="loading-row">
                            <div class="loading-spinner"></div>
                            <span>載入中...</span>
                        </div>
                    </div>
                </div>
                <p id="list-status" class="warning">載入中...</p>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="/js/crypto-icons-map.js"></script>
    <script src="/js/lib/api.js"></script>
    <script src="/js/components/NewsTicker.js"></script>

    <script>
        // 測試狀態
        let testResults = {
            ticker: false,
            icons: false,
            list: false
        };

        // 1. 測試新聞跑馬燈
        function testNewsTicker() {
            console.log('🧪 測試新聞跑馬燈...');
            const tickerContainer = document.getElementById('news-ticker');
            
            if (typeof NewsTicker !== 'undefined' && tickerContainer) {
                const ticker = new NewsTicker(tickerContainer);
                
                // 檢查初始化結果
                setTimeout(() => {
                    const content = tickerContainer.innerHTML;
                    if (content && content.includes('news-ticker-wrapper')) {
                        document.getElementById('ticker-status').innerHTML = '<span class="success">✅ 新聞跑馬燈初始化成功</span>';
                        testResults.ticker = true;
                    } else {
                        document.getElementById('ticker-status').innerHTML = '<span class="error">❌ 新聞跑馬燈初始化失敗</span>';
                    }
                    updateOverallStatus();
                }, 2000);
            } else {
                document.getElementById('ticker-status').innerHTML = '<span class="error">❌ NewsTicker 組件未載入</span>';
                updateOverallStatus();
            }
        }

        // 2. 測試圖標顯示
        function testIcons() {
            console.log('🧪 測試圖標顯示...');
            
            if (typeof window.getCryptoIcon === 'function') {
                const testSymbols = ['BTCUSDT', 'ETHUSDT', 'BNBUSDT', 'SOLUSDT', 'USDCUSDT', 'DOGEUSDT'];
                testSymbols.forEach(symbol => {
                    const baseCoin = symbol.replace('USDT', '').toLowerCase();
                    const container = document.getElementById(`icon-${baseCoin}`);
                    if (container) {
                        container.innerHTML = window.getCryptoIcon(symbol, 40);
                    }
                });
                
                document.getElementById('icon-status').innerHTML = '<span class="success">✅ 純文字圖標顯示正常</span>';
                testResults.icons = true;
            } else {
                document.getElementById('icon-status').innerHTML = '<span class="error">❌ getCryptoIcon 函數未載入</span>';
            }
            
            updateOverallStatus();
        }

        // 3. 測試熱門貨幣列表
        async function testCoinsList() {
            console.log('🧪 測試熱門貨幣列表...');
            
            try {
                const response = await fetch('/api/market/trending?limit=5');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const container = document.getElementById('test-coins-list');
                    let html = '';
                    
                    result.data.forEach((coin, index) => {
                        const changePercent = parseFloat(coin.priceChangePercent || 0);
                        const changeAmount = parseFloat(coin.priceChange || 0);
                        const isPositive = changePercent >= 0;
                        const baseCoin = coin.symbol.replace('USDT', '');
                        
                        // 模擬市值計算
                        const simulatedSupply = {
                            'BTC': 19700000, 'ETH': 120000000, 'USDC': 35000000000,
                            'SOL': 470000000, 'FDUSD': 10000000000
                        };
                        const supply = simulatedSupply[baseCoin] || 1000000000;
                        const marketCap = coin.price * supply;
                        
                        function formatNumber(value) {
                            if (value >= 1e12) return `$${(value/1e12).toFixed(2)}T`;
                            if (value >= 1e9) return `$${(value/1e9).toFixed(2)}B`;
                            if (value >= 1e6) return `$${(value/1e6).toFixed(2)}M`;
                            return `$${value.toFixed(2)}`;
                        }
                        
                        html += `
                            <div class="coin-row">
                                <div class="col-coin">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        ${window.getCryptoIcon(coin.symbol, 32)}
                                        <div>
                                            <div style="font-weight: bold;">${baseCoin}</div>
                                            <div style="font-size: 0.8em; color: #aaa;">${coin.name}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-price">$${parseFloat(coin.price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 6})}</div>
                                <div class="col-change" style="color: ${isPositive ? '#00d4aa' : '#ff4757'};">${changePercent.toFixed(2)}%</div>
                                <div class="col-change-amount" style="color: ${isPositive ? '#00d4aa' : '#ff4757'};">${isPositive ? '+' : ''}$${Math.abs(changeAmount).toFixed(4)}</div>
                                <div class="col-volume">${formatNumber(coin.quoteVolume)}</div>
                                <div class="col-market-cap">${formatNumber(marketCap)}</div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                    document.getElementById('list-status').innerHTML = '<span class="success">✅ 熱門貨幣列表載入成功</span>';
                    testResults.list = true;
                } else {
                    throw new Error(result.message || '獲取數據失敗');
                }
            } catch (error) {
                document.getElementById('list-status').innerHTML = `<span class="error">❌ 列表載入失敗: ${error.message}</span>`;
            }
            
            updateOverallStatus();
        }

        // 更新整體狀態
        function updateOverallStatus() {
            const passed = Object.values(testResults).filter(Boolean).length;
            const total = Object.keys(testResults).length;
            
            console.log(`測試進度: ${passed}/${total}`);
            
            if (passed === total) {
                console.log('🎉 所有測試通過！');
            }
        }

        // 開始測試
        window.addEventListener('load', () => {
            console.log('🧪 開始驗證修復結果...');
            
            setTimeout(() => {
                testIcons();
                testNewsTicker();
                testCoinsList();
            }, 1000);
        });
    </script>
</body>
</html>