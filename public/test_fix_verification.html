<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®å¾©é©—è­‰æ¸¬è©¦</title>
    <link rel="stylesheet" href="/css/main.css">
    <style>
        .test-section {
            background: #1a1a1a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .test-section h3 {
            color: #f7931a;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        .success { color: #00d4aa; }
        .error { color: #ff4757; }
        .warning { color: #ffa502; }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <span class="logo-icon">â‚¿</span>
                        <span class="logo-text">NexusTrade ä¿®å¾©é©—è­‰</span>
                    </div>
                </div>
            </div>
        </header>

        <div class="container" style="margin-top: 20px;">
            <h1>ğŸ”§ ä¿®å¾©é©—è­‰æ¸¬è©¦</h1>
            
            <!-- 1. æ–°èè·‘é¦¬ç‡ˆæ¸¬è©¦ -->
            <div class="test-section">
                <h3>1. æ–°èè·‘é¦¬ç‡ˆæ¸¬è©¦</h3>
                <div class="news-ticker-section">
                    <div id="news-ticker"></div>
                </div>
                <p id="ticker-status" class="warning">åˆå§‹åŒ–ä¸­...</p>
            </div>

            <!-- 2. åœ–æ¨™é¡¯ç¤ºæ¸¬è©¦ -->
            <div class="test-section">
                <h3>2. ç´”æ–‡å­—åœ–æ¨™æ¸¬è©¦</h3>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin: 15px 0;">
                    <div id="icon-btc"></div>
                    <div id="icon-eth"></div>
                    <div id="icon-bnb"></div>
                    <div id="icon-sol"></div>
                    <div id="icon-usdc"></div>
                    <div id="icon-doge"></div>
                </div>
                <p id="icon-status" class="warning">è¼‰å…¥ä¸­...</p>
            </div>

            <!-- 3. ç†±é–€è²¨å¹£åˆ—è¡¨æ¸¬è©¦ -->
            <div class="test-section">
                <h3>3. ç†±é–€è²¨å¹£åˆ—è¡¨æ¸¬è©¦</h3>
                <div class="coins-table">
                    <div class="table-header">
                        <div class="col-coin">è²¨å¹£</div>
                        <div class="col-price">åƒ¹æ ¼</div>
                        <div class="col-change">24h è®ŠåŒ–</div>
                        <div class="col-change-amount">æ¼²è·Œé»æ•¸</div>
                        <div class="col-volume">24h äº¤æ˜“é‡</div>
                        <div class="col-market-cap">å¸‚å€¼</div>
                    </div>
                    <div class="table-body" id="test-coins-list">
                        <div class="loading-row">
                            <div class="loading-spinner"></div>
                            <span>è¼‰å…¥ä¸­...</span>
                        </div>
                    </div>
                </div>
                <p id="list-status" class="warning">è¼‰å…¥ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="/js/crypto-icons-map.js"></script>
    <script src="/js/lib/api.js"></script>
    <script src="/js/components/NewsTicker.js"></script>

    <script>
        // æ¸¬è©¦ç‹€æ…‹
        let testResults = {
            ticker: false,
            icons: false,
            list: false
        };

        // 1. æ¸¬è©¦æ–°èè·‘é¦¬ç‡ˆ
        function testNewsTicker() {
            console.log('ğŸ§ª æ¸¬è©¦æ–°èè·‘é¦¬ç‡ˆ...');
            const tickerContainer = document.getElementById('news-ticker');
            
            if (typeof NewsTicker !== 'undefined' && tickerContainer) {
                const ticker = new NewsTicker(tickerContainer);
                
                // æª¢æŸ¥åˆå§‹åŒ–çµæœ
                setTimeout(() => {
                    const content = tickerContainer.innerHTML;
                    if (content && content.includes('news-ticker-wrapper')) {
                        document.getElementById('ticker-status').innerHTML = '<span class="success">âœ… æ–°èè·‘é¦¬ç‡ˆåˆå§‹åŒ–æˆåŠŸ</span>';
                        testResults.ticker = true;
                    } else {
                        document.getElementById('ticker-status').innerHTML = '<span class="error">âŒ æ–°èè·‘é¦¬ç‡ˆåˆå§‹åŒ–å¤±æ•—</span>';
                    }
                    updateOverallStatus();
                }, 2000);
            } else {
                document.getElementById('ticker-status').innerHTML = '<span class="error">âŒ NewsTicker çµ„ä»¶æœªè¼‰å…¥</span>';
                updateOverallStatus();
            }
        }

        // 2. æ¸¬è©¦åœ–æ¨™é¡¯ç¤º
        function testIcons() {
            console.log('ğŸ§ª æ¸¬è©¦åœ–æ¨™é¡¯ç¤º...');
            
            if (typeof window.getCryptoIcon === 'function') {
                const testSymbols = ['BTCUSDT', 'ETHUSDT', 'BNBUSDT', 'SOLUSDT', 'USDCUSDT', 'DOGEUSDT'];
                testSymbols.forEach(symbol => {
                    const baseCoin = symbol.replace('USDT', '').toLowerCase();
                    const container = document.getElementById(`icon-${baseCoin}`);
                    if (container) {
                        container.innerHTML = window.getCryptoIcon(symbol, 40);
                    }
                });
                
                document.getElementById('icon-status').innerHTML = '<span class="success">âœ… ç´”æ–‡å­—åœ–æ¨™é¡¯ç¤ºæ­£å¸¸</span>';
                testResults.icons = true;
            } else {
                document.getElementById('icon-status').innerHTML = '<span class="error">âŒ getCryptoIcon å‡½æ•¸æœªè¼‰å…¥</span>';
            }
            
            updateOverallStatus();
        }

        // 3. æ¸¬è©¦ç†±é–€è²¨å¹£åˆ—è¡¨
        async function testCoinsList() {
            console.log('ğŸ§ª æ¸¬è©¦ç†±é–€è²¨å¹£åˆ—è¡¨...');
            
            try {
                const response = await fetch('/api/market/trending?limit=5');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const container = document.getElementById('test-coins-list');
                    let html = '';
                    
                    result.data.forEach((coin, index) => {
                        const changePercent = parseFloat(coin.priceChangePercent || 0);
                        const changeAmount = parseFloat(coin.priceChange || 0);
                        const isPositive = changePercent >= 0;
                        const baseCoin = coin.symbol.replace('USDT', '');
                        
                        // æ¨¡æ“¬å¸‚å€¼è¨ˆç®—
                        const simulatedSupply = {
                            'BTC': 19700000, 'ETH': 120000000, 'USDC': 35000000000,
                            'SOL': 470000000, 'FDUSD': 10000000000
                        };
                        const supply = simulatedSupply[baseCoin] || 1000000000;
                        const marketCap = coin.price * supply;
                        
                        function formatNumber(value) {
                            if (value >= 1e12) return `$${(value/1e12).toFixed(2)}T`;
                            if (value >= 1e9) return `$${(value/1e9).toFixed(2)}B`;
                            if (value >= 1e6) return `$${(value/1e6).toFixed(2)}M`;
                            return `$${value.toFixed(2)}`;
                        }
                        
                        html += `
                            <div class="coin-row">
                                <div class="col-coin">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        ${window.getCryptoIcon(coin.symbol, 32)}
                                        <div>
                                            <div style="font-weight: bold;">${baseCoin}</div>
                                            <div style="font-size: 0.8em; color: #aaa;">${coin.name}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-price">$${parseFloat(coin.price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 6})}</div>
                                <div class="col-change" style="color: ${isPositive ? '#00d4aa' : '#ff4757'};">${changePercent.toFixed(2)}%</div>
                                <div class="col-change-amount" style="color: ${isPositive ? '#00d4aa' : '#ff4757'};">${isPositive ? '+' : ''}$${Math.abs(changeAmount).toFixed(4)}</div>
                                <div class="col-volume">${formatNumber(coin.quoteVolume)}</div>
                                <div class="col-market-cap">${formatNumber(marketCap)}</div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                    document.getElementById('list-status').innerHTML = '<span class="success">âœ… ç†±é–€è²¨å¹£åˆ—è¡¨è¼‰å…¥æˆåŠŸ</span>';
                    testResults.list = true;
                } else {
                    throw new Error(result.message || 'ç²å–æ•¸æ“šå¤±æ•—');
                }
            } catch (error) {
                document.getElementById('list-status').innerHTML = `<span class="error">âŒ åˆ—è¡¨è¼‰å…¥å¤±æ•—: ${error.message}</span>`;
            }
            
            updateOverallStatus();
        }

        // æ›´æ–°æ•´é«”ç‹€æ…‹
        function updateOverallStatus() {
            const passed = Object.values(testResults).filter(Boolean).length;
            const total = Object.keys(testResults).length;
            
            console.log(`æ¸¬è©¦é€²åº¦: ${passed}/${total}`);
            
            if (passed === total) {
                console.log('ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼');
            }
        }

        // é–‹å§‹æ¸¬è©¦
        window.addEventListener('load', () => {
            console.log('ğŸ§ª é–‹å§‹é©—è­‰ä¿®å¾©çµæœ...');
            
            setTimeout(() => {
                testIcons();
                testNewsTicker();
                testCoinsList();
            }, 1000);
        });
    </script>
</body>
</html>