<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth ä¿®å¾©æ¸¬è©¦ - NexusTrade</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px;
            display: inline-block;
        }
        .button:hover { background: #0056b3; }
        .button.google { background: #db4437; }
        .button.line { background: #00c300; }
        
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        
        h1 { color: #333; text-align: center; }
        h2 { color: #555; }
    </style>
</head>
<body>
    <h1>ğŸ”§ OAuth ä¿®å¾©æ•ˆæœæ¸¬è©¦</h1>
    <p style="text-align: center;"><strong>æ³¨æ„ï¼šå¦‚æœçœ‹åˆ°èˆŠçš„éŒ¯èª¤è¨Šæ¯ï¼Œè«‹æŒ‰ Ctrl+F5 å¼·åˆ¶é‡æ–°æ•´ç†é é¢</strong></p>
    
    <div class="section">
        <h2>ğŸ“Š ä¿®å¾©ç‹€æ…‹æª¢æŸ¥</h2>
        <div id="fix-status" class="status info">æ­£åœ¨æª¢æŸ¥ä¿®å¾©ç‹€æ…‹...</div>
        <div id="version-info" class="result">è¼‰å…¥ä¸­...</div>
    </div>
    
    <div class="section">
        <h2>ğŸ§ª ç™»å…¥åŠŸèƒ½æ¸¬è©¦</h2>
        <p>é€™äº›æŒ‰éˆ•æœƒç›´æ¥è§¸ç™¼ OAuth é‡å®šå‘ï¼š</p>
        
        <button class="button google" onclick="testGoogleLogin()">ğŸ”´ Google ç™»å…¥æ¸¬è©¦</button>
        <button class="button line" onclick="testLineLogin()">ğŸ’š LINE ç™»å…¥æ¸¬è©¦</button>
        
        <div id="test-result" class="result">é»æ“ŠæŒ‰éˆ•æ¸¬è©¦ OAuth ç™»å…¥åŠŸèƒ½...</div>
    </div>
    
    <div class="section">
        <h2>ğŸ” è©³ç´°è¨ºæ–·</h2>
        <button class="button" onclick="runDetailedDiagnostic()">åŸ·è¡Œè©³ç´°è¨ºæ–·</button>
        <div id="diagnostic-result" class="result">é»æ“ŠåŸ·è¡Œè©³ç´°è¨ºæ–·...</div>
    </div>

    <!-- è¼‰å…¥æ‰€æœ‰å¿…è¦çš„è…³æœ¬ï¼Œä¸ä½¿ç”¨å¿«å– -->
    <script src="/js/lib/api.js?nocache=true"></script>
    <script src="/js/lib/dom.js?nocache=true"></script>
    <script src="/js/lib/router.js?nocache=true"></script>
    <script src="/js/lib/auth-state-manager.js?nocache=true"></script>
    <script src="/js/state/store.js?nocache=true"></script>
    <script src="/js/components/Notification.js?nocache=true"></script>
    <script src="/js/components/LoginModal.js?nocache=true"></script>

    <script>
        // æª¢æŸ¥ä¿®å¾©ç‹€æ…‹
        function checkFixStatus() {
            const statusEl = document.getElementById('fix-status');
            const versionEl = document.getElementById('version-info');
            
            let output = '';
            
            // æª¢æŸ¥ LoginModal æ˜¯å¦è¼‰å…¥
            if (typeof LoginModal !== 'undefined') {
                output += 'âœ… LoginModal é¡åˆ¥å·²è¼‰å…¥\n';
                
                try {
                    // æª¢æŸ¥æ–¹æ³•ç°½å
                    const modal = new LoginModal();
                    const googleLoginMethod = modal.handleGoogleLogin.toString();
                    
                    if (googleLoginMethod.includes('OAuth ç«¯é»å›æ‡‰ç•°å¸¸')) {
                        output += 'âŒ ä»åœ¨ä½¿ç”¨èˆŠç‰ˆæœ¬ç¨‹å¼ç¢¼ (åŒ…å«ç«¯é»æª¢æŸ¥)\n';
                        statusEl.className = 'status error';
                        statusEl.textContent = 'âŒ éœ€è¦å¼·åˆ¶é‡æ–°æ•´ç†é é¢ (Ctrl+F5)';
                    } else if (googleLoginMethod.includes('ç›´æ¥é‡å®šå‘åˆ° Google OAuth')) {
                        output += 'âœ… å·²ä½¿ç”¨æ–°ç‰ˆæœ¬ç¨‹å¼ç¢¼ (ç§»é™¤ç«¯é»æª¢æŸ¥)\n';
                        statusEl.className = 'status success';
                        statusEl.textContent = 'âœ… ä¿®å¾©ç‰ˆæœ¬å·²è¼‰å…¥';
                    } else {
                        output += 'âš ï¸ ç¨‹å¼ç¢¼ç‰ˆæœ¬ä¸æ˜ç¢º\n';
                        statusEl.className = 'status info';
                        statusEl.textContent = 'âš ï¸ ç¨‹å¼ç¢¼ç‰ˆæœ¬ä¸æ˜ç¢º';
                    }
                    
                    // é¡¯ç¤ºæ–¹æ³•çš„ä¸€éƒ¨åˆ†
                    output += '\næ–¹æ³•å…§å®¹æª¢æŸ¥:\n';
                    const lines = googleLoginMethod.split('\n').slice(0, 10);
                    lines.forEach((line, index) => {
                        output += `${index + 1}: ${line}\n`;
                    });
                    
                } catch (error) {
                    output += `âŒ LoginModal å¯¦ä¾‹åŒ–å¤±æ•—: ${error.message}\n`;
                    statusEl.className = 'status error';
                    statusEl.textContent = 'âŒ LoginModal å¯¦ä¾‹åŒ–å¤±æ•—';
                }
            } else {
                output += 'âŒ LoginModal é¡åˆ¥æœªè¼‰å…¥\n';
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ LoginModal é¡åˆ¥æœªè¼‰å…¥';
            }
            
            // æª¢æŸ¥è¼‰å…¥æ™‚é–“
            output += `\né é¢è¼‰å…¥æ™‚é–“: ${new Date().toLocaleTimeString()}\n`;
            output += `User Agent: ${navigator.userAgent.split(' ').slice(-2).join(' ')}\n`;
            
            versionEl.textContent = output;
        }

        // æ¸¬è©¦ Google ç™»å…¥
        function testGoogleLogin() {
            const resultEl = document.getElementById('test-result');
            resultEl.textContent = 'ğŸ”´ æ¸¬è©¦ Google ç™»å…¥...\n';
            
            try {
                if (typeof LoginModal !== 'undefined') {
                    const modal = new LoginModal();
                    
                    // æ¨¡æ“¬é»æ“Šäº‹ä»¶
                    const mockEvent = {
                        preventDefault: () => console.log('preventDefault called'),
                        stopPropagation: () => console.log('stopPropagation called')
                    };
                    
                    resultEl.textContent += 'æ­£åœ¨åŸ·è¡Œ handleGoogleLogin...\n';
                    modal.handleGoogleLogin(mockEvent);
                    
                    resultEl.textContent += 'âœ… Google ç™»å…¥æ–¹æ³•åŸ·è¡Œå®Œæˆ\n';
                    resultEl.textContent += 'â³ å¦‚æœä¿®å¾©æˆåŠŸï¼Œæ‡‰è©²æœƒé‡å®šå‘åˆ° Google OAuth\n';
                } else {
                    resultEl.textContent += 'âŒ LoginModal é¡åˆ¥ä¸å­˜åœ¨\n';
                }
            } catch (error) {
                resultEl.textContent += `âŒ Google ç™»å…¥æ¸¬è©¦å¤±æ•—: ${error.message}\n`;
            }
        }

        // æ¸¬è©¦ LINE ç™»å…¥
        function testLineLogin() {
            const resultEl = document.getElementById('test-result');
            resultEl.textContent = 'ğŸ’š æ¸¬è©¦ LINE ç™»å…¥...\n';
            
            try {
                if (typeof LoginModal !== 'undefined') {
                    const modal = new LoginModal();
                    
                    // æ¨¡æ“¬é»æ“Šäº‹ä»¶
                    const mockEvent = {
                        preventDefault: () => console.log('preventDefault called'),
                        stopPropagation: () => console.log('stopPropagation called')
                    };
                    
                    resultEl.textContent += 'æ­£åœ¨åŸ·è¡Œ handleLineLogin...\n';
                    modal.handleLineLogin(mockEvent);
                    
                    resultEl.textContent += 'âœ… LINE ç™»å…¥æ–¹æ³•åŸ·è¡Œå®Œæˆ\n';
                    resultEl.textContent += 'â³ å¦‚æœä¿®å¾©æˆåŠŸï¼Œæ‡‰è©²æœƒé‡å®šå‘åˆ° LINE OAuth\n';
                } else {
                    resultEl.textContent += 'âŒ LoginModal é¡åˆ¥ä¸å­˜åœ¨\n';
                }
            } catch (error) {
                resultEl.textContent += `âŒ LINE ç™»å…¥æ¸¬è©¦å¤±æ•—: ${error.message}\n`;
            }
        }

        // åŸ·è¡Œè©³ç´°è¨ºæ–·
        function runDetailedDiagnostic() {
            const resultEl = document.getElementById('diagnostic-result');
            let output = '=== è©³ç´°è¨ºæ–·å ±å‘Š ===\n';
            
            // 1. æª¢æŸ¥ DOM å…ƒç´ 
            output += '\n1. DOM å…ƒç´ æª¢æŸ¥:\n';
            const loginBtn = document.getElementById('login-btn');
            output += `ä¸»é é¢ç™»å…¥æŒ‰éˆ•: ${loginBtn ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}\n`;
            
            // 2. æª¢æŸ¥äº‹ä»¶ç›£è½å™¨
            output += '\n2. äº‹ä»¶ç›£è½å™¨æª¢æŸ¥:\n';
            if (window.app) {
                output += 'âœ… window.app å­˜åœ¨\n';
                output += `app.loginModal: ${window.app.loginModal ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}\n`;
            } else {
                output += 'âŒ window.app ä¸å­˜åœ¨\n';
            }
            
            // 3. æª¢æŸ¥ OAuth ç«¯é»
            output += '\n3. OAuth ç«¯é»æª¢æŸ¥:\n';
            
            // ä½¿ç”¨ fetch æª¢æŸ¥ç«¯é»
            Promise.all([
                fetch('/auth/google', { redirect: 'error' }).catch(e => ({ error: e.message })),
                fetch('/auth/line', { redirect: 'error' }).catch(e => ({ error: e.message }))
            ]).then(results => {
                results.forEach((result, index) => {
                    const endpoint = index === 0 ? 'Google' : 'LINE';
                    if (result.error) {
                        if (result.error.includes('redirect')) {
                            output += `âœ… ${endpoint} OAuth ç«¯é»æ­£å¸¸ (é æœŸé‡å®šå‘éŒ¯èª¤)\n`;
                        } else {
                            output += `âŒ ${endpoint} OAuth ç«¯é»éŒ¯èª¤: ${result.error}\n`;
                        }
                    } else {
                        output += `âš ï¸ ${endpoint} OAuth ç«¯é»æœªé‡å®šå‘ (ç‹€æ…‹: ${result.status})\n`;
                    }
                });
                
                output += '\nè¨ºæ–·å®Œæˆã€‚\n';
                resultEl.textContent = output;
            });
            
            resultEl.textContent = output + '\næ­£åœ¨æª¢æŸ¥ OAuth ç«¯é»...';
        }

        // é é¢è¼‰å…¥å¾Œè‡ªå‹•æª¢æŸ¥
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”§ OAuth ä¿®å¾©æ¸¬è©¦é é¢å·²è¼‰å…¥');
            
            // å»¶é²æª¢æŸ¥ï¼Œç¢ºä¿æ‰€æœ‰è…³æœ¬è¼‰å…¥å®Œæˆ
            setTimeout(() => {
                checkFixStatus();
            }, 1000);
        });

        // ç›£è½éŒ¯èª¤
        window.addEventListener('error', function(event) {
            console.error('é é¢éŒ¯èª¤:', event.error);
        });
    </script>
</body>
</html>