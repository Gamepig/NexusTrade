<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>價格警報功能測試</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #ffffff;
        }
        .test-section {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #444;
        }
        .test-section h2 {
            color: #4CAF50;
            margin-top: 0;
        }
        .btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        .btn:hover {
            background: #1976D2;
        }
        .btn-success {
            background: #4CAF50;
        }
        .btn-warning {
            background: #FF9800;
        }
        .btn-danger {
            background: #F44336;
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .result-success {
            background: rgba(76, 175, 80, 0.1);
            border-left-color: #4CAF50;
        }
        .result-error {
            background: rgba(244, 67, 54, 0.1);
            border-left-color: #F44336;
        }
        .result-warning {
            background: rgba(255, 152, 0, 0.1);
            border-left-color: #FF9800;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-pass { background: #4CAF50; }
        .status-fail { background: #F44336; }
        .status-pending { background: #FF9800; }
        .json-display {
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>🔔 價格警報功能測試驗證</h1>
    <p><strong>目的</strong>：全面測試新實現的價格警報管理功能</p>

    <div class="test-grid">
        <!-- 測試 1: 認證狀態檢查 -->
        <div class="test-section">
            <h2>🔐 測試 1: 認證狀態檢查</h2>
            <div id="auth-test-results">載入中...</div>
            <button class="btn" onclick="testAuthenticationStatus()">🔄 重新檢查認證</button>
            <button class="btn btn-warning" onclick="simulateUser('free')">🆓 模擬免費會員</button>
            <button class="btn btn-success" onclick="simulateUser('premium')">🚀 模擬付費會員</button>
            <button class="btn btn-warning" onclick="simulateUser('enterprise')">👑 模擬企業會員</button>
        </div>

        <!-- 測試 2: 按鈕狀態顯示 -->
        <div class="test-section">
            <h2>🔘 測試 2: 按鈕狀態顯示</h2>
            <div id="button-status-results">載入中...</div>
            <button class="btn" onclick="testButtonStates()">🧪 測試按鈕狀態</button>
            <button class="btn btn-success" onclick="openPriceAlertModal('BTCUSDT')">🔔 開啟警報設定</button>
        </div>

        <!-- 測試 3: 會員配額檢查 -->
        <div class="test-section">
            <h2>💎 測試 3: 會員配額檢查</h2>
            <div id="quota-test-results">載入中...</div>
            <button class="btn" onclick="testQuotaLimits()">📊 測試配額限制</button>
            <button class="btn btn-warning" onclick="simulateAlertsCount(0)">設定 0 個警報</button>
            <button class="btn btn-warning" onclick="simulateAlertsCount(1)">設定 1 個警報</button>
            <button class="btn btn-danger" onclick="simulateAlertsCount(2)">設定 2 個警報</button>
        </div>

        <!-- 測試 4: 警報管理頁面 -->
        <div class="test-section">
            <h2>📋 測試 4: 警報管理頁面</h2>
            <div id="page-test-results">載入中...</div>
            <button class="btn" onclick="testPriceAlertsPage()">🔗 測試價格警報頁面</button>
            <button class="btn btn-success" onclick="navigateToPriceAlerts()">📄 訪問警報頁面</button>
        </div>

        <!-- 測試 5: 事件同步 -->
        <div class="test-section">
            <h2>🔄 測試 5: 狀態同步</h2>
            <div id="sync-test-results">載入中...</div>
            <button class="btn" onclick="testEventSynchronization()">⚡ 測試事件同步</button>
            <button class="btn btn-success" onclick="simulateAlertStatusChange()">📢 模擬狀態變更</button>
        </div>

        <!-- 測試 6: 升級模態框 -->
        <div class="test-section">
            <h2>🚀 測試 6: 升級功能</h2>
            <div id="upgrade-test-results">載入中...</div>
            <button class="btn" onclick="testUpgradeModal()">💰 測試升級模態框</button>
            <button class="btn btn-success" onclick="showUpgradeDemo('free')">🆓 免費會員升級</button>
            <button class="btn btn-success" onclick="showUpgradeDemo('premium')">🚀 付費會員升級</button>
        </div>
    </div>

    <!-- 全局測試結果 -->
    <div class="test-section">
        <h2>📊 全局測試結果</h2>
        <div id="overall-results">
            <div class="result result-warning">⏳ 等待測試執行...</div>
        </div>
        <button class="btn btn-success" onclick="runAllTests()">🧪 執行全部測試</button>
        <button class="btn btn-warning" onclick="generateTestReport()">📄 生成測試報告</button>
    </div>

    <script>
        let testResults = {
            auth: null,
            buttonStates: null,
            quotaLimits: null,
            pageAccess: null,
            eventSync: null,
            upgradeModal: null
        };

        /**
         * 測試認證狀態
         */
        function testAuthenticationStatus() {
            const resultsDiv = document.getElementById('auth-test-results');
            resultsDiv.innerHTML = '<div class="result result-warning">🔄 檢查認證狀態...</div>';
            
            try {
                const token = localStorage.getItem('nexustrade_token');
                const userStr = localStorage.getItem('nexustrade_user');
                const user = userStr ? JSON.parse(userStr) : null;
                
                let html = '<h3>🔍 認證狀態檢查</h3>';
                
                // 檢查 Token
                if (!token) {
                    html += '<div class="result result-error">❌ 沒有認證 Token</div>';
                    testResults.auth = 'fail';
                } else {
                    html += '<div class="result result-success">✅ 認證 Token 存在</div>';
                }
                
                // 檢查用戶資料
                if (!user) {
                    html += '<div class="result result-error">❌ 沒有用戶資料</div>';
                    testResults.auth = 'fail';
                } else {
                    html += `<div class="result result-success">✅ 用戶: ${user.name}</div>`;
                    html += `<div class="result result-success">✅ 會員類型: ${user.membershipType || 'free'}</div>`;
                    html += `<div class="result result-success">✅ LINE 連接: ${user.lineUserId ? '已連接' : '未連接'}</div>`;
                    testResults.auth = 'pass';
                }
                
                // 檢查組件是否載入
                const components = ['PriceAlertModal', 'CurrencyDetailPage', 'priceAlertModal'];
                components.forEach(comp => {
                    if (window[comp]) {
                        html += `<div class="result result-success">✅ ${comp} 已載入</div>`;
                    } else {
                        html += `<div class="result result-warning">⚠️ ${comp} 未載入</div>`;
                    }
                });
                
                resultsDiv.innerHTML = html;
                updateOverallResults();
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="result result-error">❌ 檢查失敗: ${error.message}</div>`;
                testResults.auth = 'fail';
            }
        }

        /**
         * 模擬不同會員類型
         */
        function simulateUser(membershipType) {
            const user = {
                id: 'test-user-123',
                name: 'Test User',
                email: 'test@example.com',
                membershipType: membershipType,
                lineUserId: 'test-line-id',
                provider: 'line'
            };
            
            localStorage.setItem('nexustrade_user', JSON.stringify(user));
            localStorage.setItem('nexustrade_token', 'test-token-123');
            
            testAuthenticationStatus();
            
            const membershipNames = {
                free: '免費會員',
                premium: '付費會員',
                enterprise: '企業會員'
            };
            
            alert(`✅ 已模擬 ${membershipNames[membershipType]} 狀態`);
        }

        /**
         * 測試按鈕狀態
         */
        function testButtonStates() {
            const resultsDiv = document.getElementById('button-status-results');
            resultsDiv.innerHTML = '<div class="result result-warning">🔄 測試按鈕狀態...</div>';
            
            let html = '<h3>🔘 按鈕狀態測試</h3>';
            
            // 檢查 CurrencyDetailPage 方法
            if (typeof window.CurrencyDetailPage !== 'undefined') {
                html += '<div class="result result-success">✅ CurrencyDetailPage 類別存在</div>';
                
                // 檢查關鍵方法
                const methods = ['checkAlertStatus', 'updateAlertButton', 'setupAlertStatusListener'];
                const prototype = window.CurrencyDetailPage.prototype;
                
                methods.forEach(method => {
                    if (typeof prototype[method] === 'function') {
                        html += `<div class="result result-success">✅ ${method} 方法存在</div>`;
                    } else {
                        html += `<div class="result result-error">❌ ${method} 方法缺失</div>`;
                    }
                });
                
                testResults.buttonStates = 'pass';
            } else {
                html += '<div class="result result-error">❌ CurrencyDetailPage 類別不存在</div>';
                testResults.buttonStates = 'fail';
            }
            
            // 檢查 CSS 樣式
            const requiredClasses = ['.action-btn.alert-active', '.quota-status', '.upgrade-modal'];
            requiredClasses.forEach(className => {
                const styleSheets = Array.from(document.styleSheets);
                let found = false;
                
                try {
                    styleSheets.forEach(sheet => {
                        try {
                            const rules = Array.from(sheet.cssRules || sheet.rules || []);
                            if (rules.some(rule => rule.selectorText && rule.selectorText.includes(className.substring(1)))) {
                                found = true;
                            }
                        } catch (e) {
                            // 跨域樣式表，無法檢查
                        }
                    });
                } catch (e) {
                    console.warn('無法檢查樣式表:', e);
                }
                
                if (found) {
                    html += `<div class="result result-success">✅ CSS 樣式 ${className} 存在</div>`;
                } else {
                    html += `<div class="result result-warning">⚠️ CSS 樣式 ${className} 未找到或無法檢查</div>`;
                }
            });
            
            resultsDiv.innerHTML = html;
            updateOverallResults();
        }

        /**
         * 測試配額限制
         */
        function testQuotaLimits() {
            const resultsDiv = document.getElementById('quota-test-results');
            resultsDiv.innerHTML = '<div class="result result-warning">🔄 測試配額限制...</div>';
            
            let html = '<h3>💎 配額限制測試</h3>';
            
            if (window.priceAlertModal && typeof window.priceAlertModal.checkQuotaLimit === 'function') {
                html += '<div class="result result-success">✅ checkQuotaLimit 方法存在</div>';
                
                // 測試不同會員類型的配額
                const membershipTypes = ['free', 'premium', 'enterprise'];
                membershipTypes.forEach(type => {
                    // 模擬用戶類型
                    const user = JSON.parse(localStorage.getItem('nexustrade_user') || '{}');
                    user.membershipType = type;
                    localStorage.setItem('nexustrade_user', JSON.stringify(user));
                    
                    // 測試配額檢查
                    try {
                        window.priceAlertModal.existingAlerts = [];
                        const quota1 = window.priceAlertModal.checkQuotaLimit();
                        
                        window.priceAlertModal.existingAlerts = [{ id: 1 }];
                        const quota2 = window.priceAlertModal.checkQuotaLimit();
                        
                        html += `<div class="result result-success">✅ ${type}: 0個警報 - 可新增: ${quota1.canAddMore}</div>`;
                        html += `<div class="result result-success">✅ ${type}: 1個警報 - 可新增: ${quota2.canAddMore}</div>`;
                        
                    } catch (error) {
                        html += `<div class="result result-error">❌ ${type} 配額檢查失敗: ${error.message}</div>`;
                    }
                });
                
                testResults.quotaLimits = 'pass';
            } else {
                html += '<div class="result result-error">❌ checkQuotaLimit 方法不存在</div>';
                testResults.quotaLimits = 'fail';
            }
            
            resultsDiv.innerHTML = html;
            updateOverallResults();
        }

        /**
         * 模擬警報數量
         */
        function simulateAlertsCount(count) {
            if (window.priceAlertModal) {
                window.priceAlertModal.existingAlerts = Array.from({length: count}, (_, i) => ({
                    id: `alert-${i + 1}`,
                    symbol: 'BTCUSDT',
                    type: 'price_above',
                    targetPrice: 50000 + i * 1000
                }));
                
                alert(`✅ 已模擬 ${count} 個警報`);
                testQuotaLimits();
            }
        }

        /**
         * 測試價格警報頁面
         */
        function testPriceAlertsPage() {
            const resultsDiv = document.getElementById('page-test-results');
            resultsDiv.innerHTML = '<div class="result result-warning">🔄 測試價格警報頁面...</div>';
            
            let html = '<h3>📋 價格警報頁面測試</h3>';
            
            // 檢查頁面容器
            const pageContainer = document.getElementById('price-alerts-page');
            if (pageContainer) {
                html += '<div class="result result-success">✅ price-alerts-page 容器存在</div>';
            } else {
                html += '<div class="result result-error">❌ price-alerts-page 容器不存在</div>';
            }
            
            // 檢查導航連結
            const navLink = document.querySelector('a[href="#price-alerts"]');
            if (navLink) {
                html += '<div class="result result-success">✅ 導航連結存在</div>';
            } else {
                html += '<div class="result result-error">❌ 導航連結不存在</div>';
            }
            
            // 檢查 PriceAlertsPage 類別
            if (typeof window.PriceAlertsPage !== 'undefined') {
                html += '<div class="result result-success">✅ PriceAlertsPage 類別存在</div>';
                testResults.pageAccess = 'pass';
            } else {
                html += '<div class="result result-error">❌ PriceAlertsPage 類別不存在</div>';
                testResults.pageAccess = 'fail';
            }
            
            // 檢查主應用的路由配置
            if (window.app && typeof window.app.loadPriceAlertsData === 'function') {
                html += '<div class="result result-success">✅ loadPriceAlertsData 方法存在</div>';
            } else {
                html += '<div class="result result-warning">⚠️ loadPriceAlertsData 方法可能不存在</div>';
            }
            
            resultsDiv.innerHTML = html;
            updateOverallResults();
        }

        /**
         * 導航到價格警報頁面
         */
        function navigateToPriceAlerts() {
            if (window.app && typeof window.app.navigateToPage === 'function') {
                window.app.navigateToPage('price-alerts');
                alert('✅ 已導航到價格警報頁面');
            } else {
                window.location.hash = '#price-alerts';
                alert('✅ 已嘗試導航到價格警報頁面 (使用 hash)');
            }
        }

        /**
         * 測試事件同步
         */
        function testEventSynchronization() {
            const resultsDiv = document.getElementById('sync-test-results');
            resultsDiv.innerHTML = '<div class="result result-warning">🔄 測試事件同步...</div>';
            
            let html = '<h3>🔄 事件同步測試</h3>';
            let eventReceived = false;
            
            // 設定事件監聽器
            const testListener = (event) => {
                eventReceived = true;
                html += `<div class="result result-success">✅ 接收到事件: ${event.type}</div>`;
                html += `<div class="result result-success">✅ 事件數據: ${JSON.stringify(event.detail)}</div>`;
                
                resultsDiv.innerHTML = html;
                testResults.eventSync = 'pass';
                updateOverallResults();
                
                // 移除監聽器
                window.removeEventListener('alertStatusChanged', testListener);
            };
            
            window.addEventListener('alertStatusChanged', testListener);
            
            // 分發測試事件
            const testEvent = new CustomEvent('alertStatusChanged', {
                detail: {
                    symbol: 'BTCUSDT',
                    alertCount: 2,
                    hasAlerts: true,
                    alerts: [
                        { id: 1, type: 'price_above', targetPrice: 50000 },
                        { id: 2, type: 'price_below', targetPrice: 45000 }
                    ]
                }
            });
            
            window.dispatchEvent(testEvent);
            
            // 檢查是否收到事件
            setTimeout(() => {
                if (!eventReceived) {
                    html += '<div class="result result-error">❌ 未接收到測試事件</div>';
                    resultsDiv.innerHTML = html;
                    testResults.eventSync = 'fail';
                    updateOverallResults();
                }
            }, 1000);
            
            html += '<div class="result result-warning">⏳ 等待事件響應...</div>';
            resultsDiv.innerHTML = html;
        }

        /**
         * 模擬警報狀態變更
         */
        function simulateAlertStatusChange() {
            if (window.priceAlertModal && typeof window.priceAlertModal.dispatchAlertStatusUpdateEvent === 'function') {
                window.priceAlertModal.currentSymbol = 'BTCUSDT';
                window.priceAlertModal.existingAlerts = [
                    { id: 1, type: 'price_above', targetPrice: 52000 }
                ];
                window.priceAlertModal.dispatchAlertStatusUpdateEvent();
                alert('✅ 已分發警報狀態變更事件');
            } else {
                alert('❌ dispatchAlertStatusUpdateEvent 方法不存在');
            }
        }

        /**
         * 測試升級模態框
         */
        function testUpgradeModal() {
            const resultsDiv = document.getElementById('upgrade-test-results');
            resultsDiv.innerHTML = '<div class="result result-warning">🔄 測試升級模態框...</div>';
            
            let html = '<h3>🚀 升級模態框測試</h3>';
            
            if (window.priceAlertModal && typeof window.priceAlertModal.showUpgradeModal === 'function') {
                html += '<div class="result result-success">✅ showUpgradeModal 方法存在</div>';
                
                if (typeof window.priceAlertModal.renderUpgradePlans === 'function') {
                    html += '<div class="result result-success">✅ renderUpgradePlans 方法存在</div>';
                } else {
                    html += '<div class="result result-error">❌ renderUpgradePlans 方法不存在</div>';
                }
                
                if (typeof window.priceAlertModal.renderMembershipStatus === 'function') {
                    html += '<div class="result result-success">✅ renderMembershipStatus 方法存在</div>';
                } else {
                    html += '<div class="result result-error">❌ renderMembershipStatus 方法不存在</div>';
                }
                
                testResults.upgradeModal = 'pass';
            } else {
                html += '<div class="result result-error">❌ showUpgradeModal 方法不存在</div>';
                testResults.upgradeModal = 'fail';
            }
            
            resultsDiv.innerHTML = html;
            updateOverallResults();
        }

        /**
         * 顯示升級模態框示例
         */
        function showUpgradeDemo(currentPlan) {
            if (window.priceAlertModal && typeof window.priceAlertModal.showUpgradeModal === 'function') {
                window.priceAlertModal.showUpgradeModal(currentPlan);
            } else {
                alert('❌ showUpgradeModal 方法不存在');
            }
        }

        /**
         * 開啟價格警報模態框
         */
        function openPriceAlertModal(symbol) {
            if (window.priceAlertModal && typeof window.priceAlertModal.show === 'function') {
                window.priceAlertModal.show(symbol);
            } else {
                alert('❌ PriceAlertModal 不可用');
            }
        }

        /**
         * 執行全部測試
         */
        async function runAllTests() {
            const overallDiv = document.getElementById('overall-results');
            overallDiv.innerHTML = '<div class="result result-warning">🔄 執行全部測試...</div>';
            
            // 重置測試結果
            Object.keys(testResults).forEach(key => testResults[key] = null);
            
            // 按順序執行測試
            testAuthenticationStatus();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testButtonStates();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testQuotaLimits();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testPriceAlertsPage();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testEventSynchronization();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testUpgradeModal();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 等待所有測試完成
            setTimeout(() => {
                updateOverallResults();
                generateTestReport();
            }, 2000);
        }

        /**
         * 更新全局測試結果
         */
        function updateOverallResults() {
            const overallDiv = document.getElementById('overall-results');
            
            const results = Object.values(testResults);
            const passCount = results.filter(r => r === 'pass').length;
            const failCount = results.filter(r => r === 'fail').length;
            const pendingCount = results.filter(r => r === null).length;
            
            let html = '<h3>📊 測試結果統計</h3>';
            html += `<div class="result result-success">
                <span class="status-indicator status-pass"></span>通過: ${passCount}
            </div>`;
            html += `<div class="result result-error">
                <span class="status-indicator status-fail"></span>失敗: ${failCount}
            </div>`;
            html += `<div class="result result-warning">
                <span class="status-indicator status-pending"></span>待測試: ${pendingCount}
            </div>`;
            
            // 詳細結果
            Object.entries(testResults).forEach(([test, result]) => {
                const status = result === 'pass' ? 'success' : result === 'fail' ? 'error' : 'warning';
                const icon = result === 'pass' ? '✅' : result === 'fail' ? '❌' : '⏳';
                const statusClass = result === 'pass' ? 'status-pass' : result === 'fail' ? 'status-fail' : 'status-pending';
                
                html += `<div class="result result-${status}">
                    <span class="status-indicator ${statusClass}"></span>${icon} ${test}: ${result || '待測試'}
                </div>`;
            });
            
            overallDiv.innerHTML = html;
        }

        /**
         * 生成測試報告
         */
        function generateTestReport() {
            const report = {
                timestamp: new Date().toLocaleString('zh-TW'),
                testResults: testResults,
                summary: {
                    total: Object.keys(testResults).length,
                    passed: Object.values(testResults).filter(r => r === 'pass').length,
                    failed: Object.values(testResults).filter(r => r === 'fail').length,
                    pending: Object.values(testResults).filter(r => r === null).length
                },
                environment: {
                    userAgent: navigator.userAgent,
                    url: window.location.href,
                    hasToken: !!localStorage.getItem('nexustrade_token'),
                    hasUser: !!localStorage.getItem('nexustrade_user')
                }
            };
            
            console.log('📄 測試報告:', report);
            
            // 顯示報告
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(`
                <html>
                <head><title>價格警報功能測試報告</title></head>
                <body style="font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff;">
                    <h1>🔔 價格警報功能測試報告</h1>
                    <pre style="background: #2d2d2d; padding: 20px; border-radius: 8px; overflow: auto;">
${JSON.stringify(report, null, 2)}
                    </pre>
                </body>
                </html>
            `);
            
            alert('✅ 測試報告已生成，請檢查新開啟的視窗');
        }

        // 頁面載入時自動執行初始檢查
        window.addEventListener('load', function() {
            setTimeout(() => {
                testAuthenticationStatus();
            }, 1000);
        });
    </script>
</body>
</html>