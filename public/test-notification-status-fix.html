<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>測試通知狀態顯示修復</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans TC', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .step {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }
        .step h3 {
            margin-top: 0;
            color: #007bff;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.secondary {
            background: #6c757d;
        }
        .btn.success {
            background: #28a745;
        }
        .btn.danger {
            background: #dc3545;
        }
        .log {
            background: #333;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .currency-detail-mock {
            border: 2px solid #007bff;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .action-buttons-container {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .action-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .action-btn.primary {
            background: #007bff;
            color: white;
        }
        .action-btn.secondary {
            background: #6c757d;
            color: white;
        }
        .action-btn.alert-active {
            background: #28a745;
            color: white;
        }
        .action-btn.added {
            background: #28a745;
            color: white;
        }
        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🔔 通知狀態顯示修復測試</h1>
        <p>測試使用者設定通知後，離開頁面再回來時按鈕狀態是否正確顯示</p>
        
        <div class="step">
            <h3>第一步：模擬認證狀態</h3>
            <p>設定測試用戶和認證 token</p>
            <button class="btn" onclick="setupAuth()">🔐 設定認證狀態</button>
            <button class="btn secondary" onclick="clearAuth()">🧹 清除認證</button>
            <div id="auth-status" class="status"></div>
        </div>

        <div class="step">
            <h3>第二步：模擬已設定的通知</h3>
            <p>在伺服器端創建一些測試通知資料</p>
            <button class="btn" onclick="createMockAlerts()">📝 創建測試通知</button>
            <button class="btn secondary" onclick="clearMockAlerts()">🗑️ 清除測試通知</button>
            <div id="alert-creation-status" class="status"></div>
        </div>

        <div class="step">
            <h3>第三步：模擬貨幣詳情頁面</h3>
            <p>測試 CurrencyDetailPage 的按鈕狀態更新</p>
            <div class="currency-detail-mock">
                <h4>BTCUSDT 詳情頁面 (模擬)</h4>
                <div class="action-buttons-container">
                    <button class="action-btn primary" id="add-watchlist-btn">
                        ⭐ 加入關注
                    </button>
                    <button class="action-btn secondary" id="set-alert-btn">
                        🔔 設定通知
                    </button>
                </div>
            </div>
            <button class="btn" onclick="testButtonStateUpdate()">🔄 測試按鈕狀態更新</button>
            <button class="btn secondary" onclick="simulatePageReturn()">↩️ 模擬返回頁面</button>
        </div>

        <div class="step">
            <h3>第四步：驗證修復效果</h3>
            <p>檢查按鈕是否正確顯示通知狀態</p>
            <button class="btn success" onclick="verifyFix()">✅ 驗證修復</button>
            <div id="verification-result" class="status"></div>
        </div>

        <div class="step">
            <h3>系統日誌</h3>
            <div id="log" class="log">等待測試操作...</div>
            <button class="btn secondary" onclick="clearLog()">清除日誌</button>
        </div>
    </div>

    <!-- 載入必要的腳本 -->
    <script src="/js/lib/api.js"></script>
    <script src="/js/auth/AuthManager.js"></script>
    <script src="/js/components/CurrencyDetailPage.js"></script>

    <script>
        let currencyDetailPage;
        let testSymbol = 'BTCUSDT';

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
            logElement.innerHTML += `[${timestamp}] ${typeIcon} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '日誌已清除...\n';
        }

        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        async function setupAuth() {
            try {
                log('設定測試認證狀態...');
                
                // 創建測試 token
                const testToken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfMDAxIiwibmFtZSI6IlRlc3QgVXNlciIsImV4cCI6OTk5OTk5OTk5OX0.test';
                const testUser = {
                    id: 'test_user_001',
                    name: 'Test User',
                    email: 'test@example.com',
                    provider: 'google',
                    lineUserId: 'test_line_user_001'
                };

                // 儲存到 localStorage
                localStorage.setItem('nexustrade_token', testToken);
                localStorage.setItem('nexustrade_user', JSON.stringify(testUser));

                // 如果有 AuthManager，同步狀態
                if (window.authManager) {
                    window.authManager.setAuthState(testToken, testUser);
                }

                log('✅ 測試認證狀態設定完成', 'success');
                updateStatus('auth-status', '✅ 認證狀態: 已登入 (Test User)', 'success');
                
            } catch (error) {
                log(`❌ 設定認證狀態失敗: ${error.message}`, 'error');
                updateStatus('auth-status', `❌ 認證設定失敗: ${error.message}`, 'error');
            }
        }

        async function clearAuth() {
            try {
                log('清除認證狀態...');
                
                localStorage.removeItem('nexustrade_token');
                localStorage.removeItem('nexustrade_user');
                
                if (window.authManager) {
                    window.authManager.clearAuthState();
                }

                log('✅ 認證狀態已清除', 'success');
                updateStatus('auth-status', '⚪ 認證狀態: 未登入', 'warning');
                
            } catch (error) {
                log(`❌ 清除認證狀態失敗: ${error.message}`, 'error');
            }
        }

        async function createMockAlerts() {
            try {
                log('創建測試通知資料...');
                
                // 模擬已設定的通知資料
                const mockAlerts = [
                    {
                        id: 'test_alert_1',
                        symbol: testSymbol,
                        alertType: 'price_above',
                        targetPrice: 50000,
                        status: 'active',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'test_alert_2', 
                        symbol: testSymbol,
                        alertType: 'price_below',
                        targetPrice: 45000,
                        status: 'active',
                        createdAt: new Date().toISOString()
                    }
                ];

                // 模擬 API 回應
                window.mockAlertsData = mockAlerts;
                
                log('✅ 測試通知資料創建完成', 'success');
                log(`📝 已創建 ${mockAlerts.length} 個測試通知:`, 'info');
                mockAlerts.forEach(alert => {
                    log(`   - ${alert.alertType}: $${alert.targetPrice}`, 'info');
                });
                
                updateStatus('alert-creation-status', `✅ 已創建 ${mockAlerts.length} 個測試通知`, 'success');
                
            } catch (error) {
                log(`❌ 創建測試通知失敗: ${error.message}`, 'error');
                updateStatus('alert-creation-status', `❌ 測試通知創建失敗: ${error.message}`, 'error');
            }
        }

        async function clearMockAlerts() {
            try {
                log('清除測試通知資料...');
                window.mockAlertsData = [];
                log('✅ 測試通知資料已清除', 'success');
                updateStatus('alert-creation-status', '⚪ 無測試通知', 'warning');
            } catch (error) {
                log(`❌ 清除測試通知失敗: ${error.message}`, 'error');
            }
        }

        async function testButtonStateUpdate() {
            try {
                log('測試按鈕狀態更新...');
                
                // 創建 CurrencyDetailPage 實例
                if (!currencyDetailPage) {
                    currencyDetailPage = new CurrencyDetailPage();
                    log('✅ CurrencyDetailPage 實例已創建', 'success');
                }

                // 設定當前貨幣
                currencyDetailPage.currentSymbol = testSymbol;
                log(`🪙 設定當前貨幣: ${testSymbol}`, 'info');

                // 模擬 API 回應
                mockApiResponses();

                // 執行按鈕狀態更新
                await currencyDetailPage.updateButtonStates();
                
                log('✅ 按鈕狀態更新完成', 'success');
                
            } catch (error) {
                log(`❌ 按鈕狀態更新失敗: ${error.message}`, 'error');
            }
        }

        function mockApiResponses() {
            log('🔧 設定 API 模擬回應...');
            
            // 保存原始 fetch
            if (!window.originalFetch) {
                window.originalFetch = window.fetch;
            }
            
            // 模擬 fetch
            window.fetch = async function(url, options) {
                log(`📡 API 調用: ${url}`, 'info');
                
                // 模擬警報狀態檢查
                if (url.includes('/api/notifications/alerts/')) {
                    const mockAlerts = window.mockAlertsData || [];
                    return Promise.resolve({
                        ok: true,
                        json: () => Promise.resolve({
                            status: 'success',
                            data: {
                                symbol: testSymbol,
                                alerts: mockAlerts
                            }
                        })
                    });
                }
                
                // 模擬觀察清單狀態檢查
                if (url.includes('/api/watchlist/status/')) {
                    return Promise.resolve({
                        ok: true,
                        json: () => Promise.resolve({
                            success: true,
                            data: {
                                isWatched: false // 假設未加入觀察清單
                            }
                        })
                    });
                }
                
                // 其他請求使用原始 fetch
                return window.originalFetch(url, options);
            };
            
            log('✅ API 模擬回應設定完成', 'success');
        }

        async function simulatePageReturn() {
            try {
                log('🔄 模擬離開頁面後重新返回...');
                
                // 清理當前實例
                if (currencyDetailPage) {
                    currencyDetailPage.cleanup();
                    log('🧹 清理舊的頁面實例', 'info');
                }
                
                // 模擬重新載入頁面
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 重新創建實例並載入
                currencyDetailPage = new CurrencyDetailPage();
                currencyDetailPage.currentSymbol = testSymbol;
                
                log('🔄 重新創建頁面實例', 'info');
                
                // 重新設定 API 模擬
                mockApiResponses();
                
                // 重新檢查按鈕狀態
                await currencyDetailPage.updateButtonStates();
                
                log('✅ 頁面返回模擬完成', 'success');
                
            } catch (error) {
                log(`❌ 模擬頁面返回失敗: ${error.message}`, 'error');
            }
        }

        async function verifyFix() {
            try {
                log('🔍 驗證修復效果...');
                
                const alertBtn = document.getElementById('set-alert-btn');
                const watchlistBtn = document.getElementById('add-watchlist-btn');
                
                let results = [];
                
                // 檢查警報按鈕狀態
                if (alertBtn) {
                    const btnText = alertBtn.textContent.trim();
                    if (window.mockAlertsData && window.mockAlertsData.length > 0) {
                        if (btnText.includes('已設定')) {
                            results.push('✅ 警報按鈕狀態正確：顯示已設定');
                            log(`✅ 警報按鈕顯示: ${btnText}`, 'success');
                        } else {
                            results.push('❌ 警報按鈕狀態錯誤：應顯示已設定');
                            log(`❌ 警報按鈕顯示: ${btnText} (應顯示已設定)`, 'error');
                        }
                    } else {
                        if (btnText.includes('設定通知')) {
                            results.push('✅ 警報按鈕狀態正確：顯示設定通知');
                            log(`✅ 警報按鈕顯示: ${btnText}`, 'success');
                        } else {
                            results.push('❌ 警報按鈕狀態錯誤：應顯示設定通知');
                            log(`❌ 警報按鈕顯示: ${btnText} (應顯示設定通知)`, 'error');
                        }
                    }
                }
                
                // 檢查觀察清單按鈕狀態
                if (watchlistBtn) {
                    const btnText = watchlistBtn.textContent.trim();
                    log(`ℹ️ 觀察清單按鈕顯示: ${btnText}`, 'info');
                    results.push('ℹ️ 觀察清單按鈕狀態正常檢查');
                }
                
                // 顯示驗證結果
                const allPassed = results.every(r => r.startsWith('✅'));
                const resultMessage = results.join('\n');
                
                if (allPassed) {
                    updateStatus('verification-result', '🎉 修復驗證成功！所有按鈕狀態正確', 'success');
                    log('🎉 修復驗證成功！', 'success');
                } else {
                    updateStatus('verification-result', '⚠️ 部分測試未通過，請檢查日誌', 'warning');
                    log('⚠️ 部分測試未通過', 'warning');
                }
                
                results.forEach(result => log(result));
                
            } catch (error) {
                log(`❌ 驗證失敗: ${error.message}`, 'error');
                updateStatus('verification-result', `❌ 驗證失敗: ${error.message}`, 'error');
            }
        }

        // 頁面載入完成後的初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('📱 通知狀態顯示測試頁面已載入', 'success');
            log('👆 請按照步驟進行測試', 'info');
        });

        // 監聽警報狀態變更事件
        window.addEventListener('alertStatusChanged', function(event) {
            log(`🔔 接收到警報狀態變更事件: ${JSON.stringify(event.detail)}`, 'info');
        });
    </script>
</body>
</html>