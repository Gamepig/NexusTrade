<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦é€šçŸ¥ç‹€æ…‹é¡¯ç¤ºä¿®å¾©</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans TC', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .step {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }
        .step h3 {
            margin-top: 0;
            color: #007bff;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.secondary {
            background: #6c757d;
        }
        .btn.success {
            background: #28a745;
        }
        .btn.danger {
            background: #dc3545;
        }
        .log {
            background: #333;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .currency-detail-mock {
            border: 2px solid #007bff;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .action-buttons-container {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .action-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .action-btn.primary {
            background: #007bff;
            color: white;
        }
        .action-btn.secondary {
            background: #6c757d;
            color: white;
        }
        .action-btn.alert-active {
            background: #28a745;
            color: white;
        }
        .action-btn.added {
            background: #28a745;
            color: white;
        }
        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”” é€šçŸ¥ç‹€æ…‹é¡¯ç¤ºä¿®å¾©æ¸¬è©¦</h1>
        <p>æ¸¬è©¦ä½¿ç”¨è€…è¨­å®šé€šçŸ¥å¾Œï¼Œé›¢é–‹é é¢å†å›ä¾†æ™‚æŒ‰éˆ•ç‹€æ…‹æ˜¯å¦æ­£ç¢ºé¡¯ç¤º</p>
        
        <div class="step">
            <h3>ç¬¬ä¸€æ­¥ï¼šæ¨¡æ“¬èªè­‰ç‹€æ…‹</h3>
            <p>è¨­å®šæ¸¬è©¦ç”¨æˆ¶å’Œèªè­‰ token</p>
            <button class="btn" onclick="setupAuth()">ğŸ” è¨­å®šèªè­‰ç‹€æ…‹</button>
            <button class="btn secondary" onclick="clearAuth()">ğŸ§¹ æ¸…é™¤èªè­‰</button>
            <div id="auth-status" class="status"></div>
        </div>

        <div class="step">
            <h3>ç¬¬äºŒæ­¥ï¼šæ¨¡æ“¬å·²è¨­å®šçš„é€šçŸ¥</h3>
            <p>åœ¨ä¼ºæœå™¨ç«¯å‰µå»ºä¸€äº›æ¸¬è©¦é€šçŸ¥è³‡æ–™</p>
            <button class="btn" onclick="createMockAlerts()">ğŸ“ å‰µå»ºæ¸¬è©¦é€šçŸ¥</button>
            <button class="btn secondary" onclick="clearMockAlerts()">ğŸ—‘ï¸ æ¸…é™¤æ¸¬è©¦é€šçŸ¥</button>
            <div id="alert-creation-status" class="status"></div>
        </div>

        <div class="step">
            <h3>ç¬¬ä¸‰æ­¥ï¼šæ¨¡æ“¬è²¨å¹£è©³æƒ…é é¢</h3>
            <p>æ¸¬è©¦ CurrencyDetailPage çš„æŒ‰éˆ•ç‹€æ…‹æ›´æ–°</p>
            <div class="currency-detail-mock">
                <h4>BTCUSDT è©³æƒ…é é¢ (æ¨¡æ“¬)</h4>
                <div class="action-buttons-container">
                    <button class="action-btn primary" id="add-watchlist-btn">
                        â­ åŠ å…¥é—œæ³¨
                    </button>
                    <button class="action-btn secondary" id="set-alert-btn">
                        ğŸ”” è¨­å®šé€šçŸ¥
                    </button>
                </div>
            </div>
            <button class="btn" onclick="testButtonStateUpdate()">ğŸ”„ æ¸¬è©¦æŒ‰éˆ•ç‹€æ…‹æ›´æ–°</button>
            <button class="btn secondary" onclick="simulatePageReturn()">â†©ï¸ æ¨¡æ“¬è¿”å›é é¢</button>
        </div>

        <div class="step">
            <h3>ç¬¬å››æ­¥ï¼šé©—è­‰ä¿®å¾©æ•ˆæœ</h3>
            <p>æª¢æŸ¥æŒ‰éˆ•æ˜¯å¦æ­£ç¢ºé¡¯ç¤ºé€šçŸ¥ç‹€æ…‹</p>
            <button class="btn success" onclick="verifyFix()">âœ… é©—è­‰ä¿®å¾©</button>
            <div id="verification-result" class="status"></div>
        </div>

        <div class="step">
            <h3>ç³»çµ±æ—¥èªŒ</h3>
            <div id="log" class="log">ç­‰å¾…æ¸¬è©¦æ“ä½œ...</div>
            <button class="btn secondary" onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
        </div>
    </div>

    <!-- è¼‰å…¥å¿…è¦çš„è…³æœ¬ -->
    <script src="/js/lib/api.js"></script>
    <script src="/js/auth/AuthManager.js"></script>
    <script src="/js/components/CurrencyDetailPage.js"></script>

    <script>
        let currencyDetailPage;
        let testSymbol = 'BTCUSDT';

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            logElement.innerHTML += `[${timestamp}] ${typeIcon} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = 'æ—¥èªŒå·²æ¸…é™¤...\n';
        }

        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        async function setupAuth() {
            try {
                log('è¨­å®šæ¸¬è©¦èªè­‰ç‹€æ…‹...');
                
                // å‰µå»ºæ¸¬è©¦ token
                const testToken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0ZXN0X3VzZXJfMDAxIiwibmFtZSI6IlRlc3QgVXNlciIsImV4cCI6OTk5OTk5OTk5OX0.test';
                const testUser = {
                    id: 'test_user_001',
                    name: 'Test User',
                    email: 'test@example.com',
                    provider: 'google',
                    lineUserId: 'test_line_user_001'
                };

                // å„²å­˜åˆ° localStorage
                localStorage.setItem('nexustrade_token', testToken);
                localStorage.setItem('nexustrade_user', JSON.stringify(testUser));

                // å¦‚æœæœ‰ AuthManagerï¼ŒåŒæ­¥ç‹€æ…‹
                if (window.authManager) {
                    window.authManager.setAuthState(testToken, testUser);
                }

                log('âœ… æ¸¬è©¦èªè­‰ç‹€æ…‹è¨­å®šå®Œæˆ', 'success');
                updateStatus('auth-status', 'âœ… èªè­‰ç‹€æ…‹: å·²ç™»å…¥ (Test User)', 'success');
                
            } catch (error) {
                log(`âŒ è¨­å®šèªè­‰ç‹€æ…‹å¤±æ•—: ${error.message}`, 'error');
                updateStatus('auth-status', `âŒ èªè­‰è¨­å®šå¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function clearAuth() {
            try {
                log('æ¸…é™¤èªè­‰ç‹€æ…‹...');
                
                localStorage.removeItem('nexustrade_token');
                localStorage.removeItem('nexustrade_user');
                
                if (window.authManager) {
                    window.authManager.clearAuthState();
                }

                log('âœ… èªè­‰ç‹€æ…‹å·²æ¸…é™¤', 'success');
                updateStatus('auth-status', 'âšª èªè­‰ç‹€æ…‹: æœªç™»å…¥', 'warning');
                
            } catch (error) {
                log(`âŒ æ¸…é™¤èªè­‰ç‹€æ…‹å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function createMockAlerts() {
            try {
                log('å‰µå»ºæ¸¬è©¦é€šçŸ¥è³‡æ–™...');
                
                // æ¨¡æ“¬å·²è¨­å®šçš„é€šçŸ¥è³‡æ–™
                const mockAlerts = [
                    {
                        id: 'test_alert_1',
                        symbol: testSymbol,
                        alertType: 'price_above',
                        targetPrice: 50000,
                        status: 'active',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'test_alert_2', 
                        symbol: testSymbol,
                        alertType: 'price_below',
                        targetPrice: 45000,
                        status: 'active',
                        createdAt: new Date().toISOString()
                    }
                ];

                // æ¨¡æ“¬ API å›æ‡‰
                window.mockAlertsData = mockAlerts;
                
                log('âœ… æ¸¬è©¦é€šçŸ¥è³‡æ–™å‰µå»ºå®Œæˆ', 'success');
                log(`ğŸ“ å·²å‰µå»º ${mockAlerts.length} å€‹æ¸¬è©¦é€šçŸ¥:`, 'info');
                mockAlerts.forEach(alert => {
                    log(`   - ${alert.alertType}: $${alert.targetPrice}`, 'info');
                });
                
                updateStatus('alert-creation-status', `âœ… å·²å‰µå»º ${mockAlerts.length} å€‹æ¸¬è©¦é€šçŸ¥`, 'success');
                
            } catch (error) {
                log(`âŒ å‰µå»ºæ¸¬è©¦é€šçŸ¥å¤±æ•—: ${error.message}`, 'error');
                updateStatus('alert-creation-status', `âŒ æ¸¬è©¦é€šçŸ¥å‰µå»ºå¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function clearMockAlerts() {
            try {
                log('æ¸…é™¤æ¸¬è©¦é€šçŸ¥è³‡æ–™...');
                window.mockAlertsData = [];
                log('âœ… æ¸¬è©¦é€šçŸ¥è³‡æ–™å·²æ¸…é™¤', 'success');
                updateStatus('alert-creation-status', 'âšª ç„¡æ¸¬è©¦é€šçŸ¥', 'warning');
            } catch (error) {
                log(`âŒ æ¸…é™¤æ¸¬è©¦é€šçŸ¥å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function testButtonStateUpdate() {
            try {
                log('æ¸¬è©¦æŒ‰éˆ•ç‹€æ…‹æ›´æ–°...');
                
                // å‰µå»º CurrencyDetailPage å¯¦ä¾‹
                if (!currencyDetailPage) {
                    currencyDetailPage = new CurrencyDetailPage();
                    log('âœ… CurrencyDetailPage å¯¦ä¾‹å·²å‰µå»º', 'success');
                }

                // è¨­å®šç•¶å‰è²¨å¹£
                currencyDetailPage.currentSymbol = testSymbol;
                log(`ğŸª™ è¨­å®šç•¶å‰è²¨å¹£: ${testSymbol}`, 'info');

                // æ¨¡æ“¬ API å›æ‡‰
                mockApiResponses();

                // åŸ·è¡ŒæŒ‰éˆ•ç‹€æ…‹æ›´æ–°
                await currencyDetailPage.updateButtonStates();
                
                log('âœ… æŒ‰éˆ•ç‹€æ…‹æ›´æ–°å®Œæˆ', 'success');
                
            } catch (error) {
                log(`âŒ æŒ‰éˆ•ç‹€æ…‹æ›´æ–°å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function mockApiResponses() {
            log('ğŸ”§ è¨­å®š API æ¨¡æ“¬å›æ‡‰...');
            
            // ä¿å­˜åŸå§‹ fetch
            if (!window.originalFetch) {
                window.originalFetch = window.fetch;
            }
            
            // æ¨¡æ“¬ fetch
            window.fetch = async function(url, options) {
                log(`ğŸ“¡ API èª¿ç”¨: ${url}`, 'info');
                
                // æ¨¡æ“¬è­¦å ±ç‹€æ…‹æª¢æŸ¥
                if (url.includes('/api/notifications/alerts/')) {
                    const mockAlerts = window.mockAlertsData || [];
                    return Promise.resolve({
                        ok: true,
                        json: () => Promise.resolve({
                            status: 'success',
                            data: {
                                symbol: testSymbol,
                                alerts: mockAlerts
                            }
                        })
                    });
                }
                
                // æ¨¡æ“¬è§€å¯Ÿæ¸…å–®ç‹€æ…‹æª¢æŸ¥
                if (url.includes('/api/watchlist/status/')) {
                    return Promise.resolve({
                        ok: true,
                        json: () => Promise.resolve({
                            success: true,
                            data: {
                                isWatched: false // å‡è¨­æœªåŠ å…¥è§€å¯Ÿæ¸…å–®
                            }
                        })
                    });
                }
                
                // å…¶ä»–è«‹æ±‚ä½¿ç”¨åŸå§‹ fetch
                return window.originalFetch(url, options);
            };
            
            log('âœ… API æ¨¡æ“¬å›æ‡‰è¨­å®šå®Œæˆ', 'success');
        }

        async function simulatePageReturn() {
            try {
                log('ğŸ”„ æ¨¡æ“¬é›¢é–‹é é¢å¾Œé‡æ–°è¿”å›...');
                
                // æ¸…ç†ç•¶å‰å¯¦ä¾‹
                if (currencyDetailPage) {
                    currencyDetailPage.cleanup();
                    log('ğŸ§¹ æ¸…ç†èˆŠçš„é é¢å¯¦ä¾‹', 'info');
                }
                
                // æ¨¡æ“¬é‡æ–°è¼‰å…¥é é¢
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // é‡æ–°å‰µå»ºå¯¦ä¾‹ä¸¦è¼‰å…¥
                currencyDetailPage = new CurrencyDetailPage();
                currencyDetailPage.currentSymbol = testSymbol;
                
                log('ğŸ”„ é‡æ–°å‰µå»ºé é¢å¯¦ä¾‹', 'info');
                
                // é‡æ–°è¨­å®š API æ¨¡æ“¬
                mockApiResponses();
                
                // é‡æ–°æª¢æŸ¥æŒ‰éˆ•ç‹€æ…‹
                await currencyDetailPage.updateButtonStates();
                
                log('âœ… é é¢è¿”å›æ¨¡æ“¬å®Œæˆ', 'success');
                
            } catch (error) {
                log(`âŒ æ¨¡æ“¬é é¢è¿”å›å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function verifyFix() {
            try {
                log('ğŸ” é©—è­‰ä¿®å¾©æ•ˆæœ...');
                
                const alertBtn = document.getElementById('set-alert-btn');
                const watchlistBtn = document.getElementById('add-watchlist-btn');
                
                let results = [];
                
                // æª¢æŸ¥è­¦å ±æŒ‰éˆ•ç‹€æ…‹
                if (alertBtn) {
                    const btnText = alertBtn.textContent.trim();
                    if (window.mockAlertsData && window.mockAlertsData.length > 0) {
                        if (btnText.includes('å·²è¨­å®š')) {
                            results.push('âœ… è­¦å ±æŒ‰éˆ•ç‹€æ…‹æ­£ç¢ºï¼šé¡¯ç¤ºå·²è¨­å®š');
                            log(`âœ… è­¦å ±æŒ‰éˆ•é¡¯ç¤º: ${btnText}`, 'success');
                        } else {
                            results.push('âŒ è­¦å ±æŒ‰éˆ•ç‹€æ…‹éŒ¯èª¤ï¼šæ‡‰é¡¯ç¤ºå·²è¨­å®š');
                            log(`âŒ è­¦å ±æŒ‰éˆ•é¡¯ç¤º: ${btnText} (æ‡‰é¡¯ç¤ºå·²è¨­å®š)`, 'error');
                        }
                    } else {
                        if (btnText.includes('è¨­å®šé€šçŸ¥')) {
                            results.push('âœ… è­¦å ±æŒ‰éˆ•ç‹€æ…‹æ­£ç¢ºï¼šé¡¯ç¤ºè¨­å®šé€šçŸ¥');
                            log(`âœ… è­¦å ±æŒ‰éˆ•é¡¯ç¤º: ${btnText}`, 'success');
                        } else {
                            results.push('âŒ è­¦å ±æŒ‰éˆ•ç‹€æ…‹éŒ¯èª¤ï¼šæ‡‰é¡¯ç¤ºè¨­å®šé€šçŸ¥');
                            log(`âŒ è­¦å ±æŒ‰éˆ•é¡¯ç¤º: ${btnText} (æ‡‰é¡¯ç¤ºè¨­å®šé€šçŸ¥)`, 'error');
                        }
                    }
                }
                
                // æª¢æŸ¥è§€å¯Ÿæ¸…å–®æŒ‰éˆ•ç‹€æ…‹
                if (watchlistBtn) {
                    const btnText = watchlistBtn.textContent.trim();
                    log(`â„¹ï¸ è§€å¯Ÿæ¸…å–®æŒ‰éˆ•é¡¯ç¤º: ${btnText}`, 'info');
                    results.push('â„¹ï¸ è§€å¯Ÿæ¸…å–®æŒ‰éˆ•ç‹€æ…‹æ­£å¸¸æª¢æŸ¥');
                }
                
                // é¡¯ç¤ºé©—è­‰çµæœ
                const allPassed = results.every(r => r.startsWith('âœ…'));
                const resultMessage = results.join('\n');
                
                if (allPassed) {
                    updateStatus('verification-result', 'ğŸ‰ ä¿®å¾©é©—è­‰æˆåŠŸï¼æ‰€æœ‰æŒ‰éˆ•ç‹€æ…‹æ­£ç¢º', 'success');
                    log('ğŸ‰ ä¿®å¾©é©—è­‰æˆåŠŸï¼', 'success');
                } else {
                    updateStatus('verification-result', 'âš ï¸ éƒ¨åˆ†æ¸¬è©¦æœªé€šéï¼Œè«‹æª¢æŸ¥æ—¥èªŒ', 'warning');
                    log('âš ï¸ éƒ¨åˆ†æ¸¬è©¦æœªé€šé', 'warning');
                }
                
                results.forEach(result => log(result));
                
            } catch (error) {
                log(`âŒ é©—è­‰å¤±æ•—: ${error.message}`, 'error');
                updateStatus('verification-result', `âŒ é©—è­‰å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ“± é€šçŸ¥ç‹€æ…‹é¡¯ç¤ºæ¸¬è©¦é é¢å·²è¼‰å…¥', 'success');
            log('ğŸ‘† è«‹æŒ‰ç…§æ­¥é©Ÿé€²è¡Œæ¸¬è©¦', 'info');
        });

        // ç›£è½è­¦å ±ç‹€æ…‹è®Šæ›´äº‹ä»¶
        window.addEventListener('alertStatusChanged', function(event) {
            log(`ğŸ”” æ¥æ”¶åˆ°è­¦å ±ç‹€æ…‹è®Šæ›´äº‹ä»¶: ${JSON.stringify(event.detail)}`, 'info');
        });
    </script>
</body>
</html>