<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token 診斷頁面</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; background: #007bff; color: white; }
        button:hover { background: #0056b3; }
        pre { background: #f4f4f4; padding: 15px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Token 診斷工具</h1>
        
        <div id="url-info" class="status warning">
            <h3>當前 URL 參數：</h3>
            <div id="url-params"></div>
        </div>
        
        <div id="storage-info" class="status">
            <h3>本地儲存狀態：</h3>
            <div id="storage-content"></div>
        </div>
        
        <div>
            <button onclick="extractTokenFromUrl()">🔍 從 URL 提取 Token</button>
            <button onclick="checkStorage()">📊 檢查儲存狀態</button>
            <button onclick="testGoogleLogin()">🔐 測試 Google 登入</button>
            <button onclick="clearAll()">🗑️ 清除所有 Token</button>
        </div>
        
        <div id="result"></div>
        
        <div class="status warning">
            <h3>📋 使用說明：</h3>
            <ol>
                <li>進行 Google 登入：<a href="/auth/google" target="_blank">點此登入</a></li>
                <li>登入成功後會回到首頁，立即點擊「從 URL 提取 Token」</li>
                <li>檢查 Token 是否正確保存到 localStorage</li>
                <li>重新整理頁面，檢查 Token 是否持續存在</li>
            </ol>
        </div>
    </div>

    <script>
        function displayResult(message, type = 'info') {
            const result = document.getElementById('result');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'warning';
            result.innerHTML = '<div class="status ' + className + '">' + message + '</div>';
        }
        
        function extractTokenFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const provider = urlParams.get('provider');
            
            let urlInfo = '<pre>URL 參數:\n';
            urlParams.forEach((value, key) => {
                urlInfo += key + ': ' + value + '\n';
            });
            urlInfo += '</pre>';
            document.getElementById('url-params').innerHTML = urlInfo;
            
            if (token) {
                // 保存 Token 到 localStorage
                localStorage.setItem('nexustrade_token', token);
                
                // 嘗試解析 Token 獲取使用者資訊
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const user = {
                        _id: payload.userId,
                        email: payload.email,
                        name: payload.name || payload.email,
                        provider: provider || 'google'
                    };
                    localStorage.setItem('nexustrade_user', JSON.stringify(user));
                    localStorage.setItem('nexustrade_line_bound', 'false');
                    
                    displayResult('✅ Token 成功提取並保存！\n用戶: ' + user.email + '\nProvider: ' + user.provider, 'success');
                    
                    // 清除 URL 參數
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // 更新頁面顯示
                    setTimeout(checkStorage, 100);
                } catch (error) {
                    displayResult('❌ Token 解析失敗: ' + error.message, 'error');
                }
            } else {
                displayResult('⚠️ URL 中沒有找到 Token 參數', 'warning');
            }
        }
        
        function checkStorage() {
            const token = localStorage.getItem('nexustrade_token');
            const user = localStorage.getItem('nexustrade_user');
            const lineBound = localStorage.getItem('nexustrade_line_bound');
            
            let storageInfo = '<pre>localStorage 內容:\n';
            storageInfo += 'nexustrade_token: ' + (token ? token.substring(0, 50) + '...' : '無') + '\n';
            storageInfo += 'nexustrade_user: ' + (user || '無') + '\n';
            storageInfo += 'nexustrade_line_bound: ' + (lineBound || '無') + '\n';
            
            if (token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const isExpired = payload.exp * 1000 <= Date.now();
                    const timeLeft = Math.max(0, payload.exp * 1000 - Date.now());
                    
                    storageInfo += '\nToken 資訊:\n';
                    storageInfo += '使用者 ID: ' + payload.userId + '\n';
                    storageInfo += 'Email: ' + payload.email + '\n';
                    storageInfo += '過期狀態: ' + (isExpired ? '已過期' : '有效') + '\n';
                    storageInfo += '剩餘時間: ' + Math.round(timeLeft / 60000) + ' 分鐘\n';
                } catch (error) {
                    storageInfo += '\nToken 解析錯誤: ' + error.message + '\n';
                }
            }
            storageInfo += '</pre>';
            
            document.getElementById('storage-content').innerHTML = storageInfo;
            document.getElementById('storage-info').className = 'status ' + (token ? 'success' : 'error');
        }
        
        function testGoogleLogin() {
            window.open('/auth/google', '_blank');
        }
        
        function clearAll() {
            localStorage.removeItem('nexustrade_token');
            localStorage.removeItem('nexustrade_user');
            localStorage.removeItem('nexustrade_line_bound');
            displayResult('🗑️ 所有 Token 已清除', 'success');
            setTimeout(checkStorage, 100);
        }
        
        // 頁面載入時自動檢查
        window.onload = function() {
            extractTokenFromUrl();
            checkStorage();
        };
    </script>
</body>
</html>