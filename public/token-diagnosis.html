<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token è¨ºæ–·é é¢</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; background: #007bff; color: white; }
        button:hover { background: #0056b3; }
        pre { background: #f4f4f4; padding: 15px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Token è¨ºæ–·å·¥å…·</h1>
        
        <div id="url-info" class="status warning">
            <h3>ç•¶å‰ URL åƒæ•¸ï¼š</h3>
            <div id="url-params"></div>
        </div>
        
        <div id="storage-info" class="status">
            <h3>æœ¬åœ°å„²å­˜ç‹€æ…‹ï¼š</h3>
            <div id="storage-content"></div>
        </div>
        
        <div>
            <button onclick="extractTokenFromUrl()">ğŸ” å¾ URL æå– Token</button>
            <button onclick="checkStorage()">ğŸ“Š æª¢æŸ¥å„²å­˜ç‹€æ…‹</button>
            <button onclick="testGoogleLogin()">ğŸ” æ¸¬è©¦ Google ç™»å…¥</button>
            <button onclick="clearAll()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ Token</button>
        </div>
        
        <div id="result"></div>
        
        <div class="status warning">
            <h3>ğŸ“‹ ä½¿ç”¨èªªæ˜ï¼š</h3>
            <ol>
                <li>é€²è¡Œ Google ç™»å…¥ï¼š<a href="/auth/google" target="_blank">é»æ­¤ç™»å…¥</a></li>
                <li>ç™»å…¥æˆåŠŸå¾Œæœƒå›åˆ°é¦–é ï¼Œç«‹å³é»æ“Šã€Œå¾ URL æå– Tokenã€</li>
                <li>æª¢æŸ¥ Token æ˜¯å¦æ­£ç¢ºä¿å­˜åˆ° localStorage</li>
                <li>é‡æ–°æ•´ç†é é¢ï¼Œæª¢æŸ¥ Token æ˜¯å¦æŒçºŒå­˜åœ¨</li>
            </ol>
        </div>
    </div>

    <script>
        function displayResult(message, type = 'info') {
            const result = document.getElementById('result');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'warning';
            result.innerHTML = '<div class="status ' + className + '">' + message + '</div>';
        }
        
        function extractTokenFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const provider = urlParams.get('provider');
            
            let urlInfo = '<pre>URL åƒæ•¸:\n';
            urlParams.forEach((value, key) => {
                urlInfo += key + ': ' + value + '\n';
            });
            urlInfo += '</pre>';
            document.getElementById('url-params').innerHTML = urlInfo;
            
            if (token) {
                // ä¿å­˜ Token åˆ° localStorage
                localStorage.setItem('nexustrade_token', token);
                
                // å˜—è©¦è§£æ Token ç²å–ä½¿ç”¨è€…è³‡è¨Š
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const user = {
                        _id: payload.userId,
                        email: payload.email,
                        name: payload.name || payload.email,
                        provider: provider || 'google'
                    };
                    localStorage.setItem('nexustrade_user', JSON.stringify(user));
                    localStorage.setItem('nexustrade_line_bound', 'false');
                    
                    displayResult('âœ… Token æˆåŠŸæå–ä¸¦ä¿å­˜ï¼\nç”¨æˆ¶: ' + user.email + '\nProvider: ' + user.provider, 'success');
                    
                    // æ¸…é™¤ URL åƒæ•¸
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // æ›´æ–°é é¢é¡¯ç¤º
                    setTimeout(checkStorage, 100);
                } catch (error) {
                    displayResult('âŒ Token è§£æå¤±æ•—: ' + error.message, 'error');
                }
            } else {
                displayResult('âš ï¸ URL ä¸­æ²’æœ‰æ‰¾åˆ° Token åƒæ•¸', 'warning');
            }
        }
        
        function checkStorage() {
            const token = localStorage.getItem('nexustrade_token');
            const user = localStorage.getItem('nexustrade_user');
            const lineBound = localStorage.getItem('nexustrade_line_bound');
            
            let storageInfo = '<pre>localStorage å…§å®¹:\n';
            storageInfo += 'nexustrade_token: ' + (token ? token.substring(0, 50) + '...' : 'ç„¡') + '\n';
            storageInfo += 'nexustrade_user: ' + (user || 'ç„¡') + '\n';
            storageInfo += 'nexustrade_line_bound: ' + (lineBound || 'ç„¡') + '\n';
            
            if (token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const isExpired = payload.exp * 1000 <= Date.now();
                    const timeLeft = Math.max(0, payload.exp * 1000 - Date.now());
                    
                    storageInfo += '\nToken è³‡è¨Š:\n';
                    storageInfo += 'ä½¿ç”¨è€… ID: ' + payload.userId + '\n';
                    storageInfo += 'Email: ' + payload.email + '\n';
                    storageInfo += 'éæœŸç‹€æ…‹: ' + (isExpired ? 'å·²éæœŸ' : 'æœ‰æ•ˆ') + '\n';
                    storageInfo += 'å‰©é¤˜æ™‚é–“: ' + Math.round(timeLeft / 60000) + ' åˆ†é˜\n';
                } catch (error) {
                    storageInfo += '\nToken è§£æéŒ¯èª¤: ' + error.message + '\n';
                }
            }
            storageInfo += '</pre>';
            
            document.getElementById('storage-content').innerHTML = storageInfo;
            document.getElementById('storage-info').className = 'status ' + (token ? 'success' : 'error');
        }
        
        function testGoogleLogin() {
            window.open('/auth/google', '_blank');
        }
        
        function clearAll() {
            localStorage.removeItem('nexustrade_token');
            localStorage.removeItem('nexustrade_user');
            localStorage.removeItem('nexustrade_line_bound');
            displayResult('ğŸ—‘ï¸ æ‰€æœ‰ Token å·²æ¸…é™¤', 'success');
            setTimeout(checkStorage, 100);
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
        window.onload = function() {
            extractTokenFromUrl();
            checkStorage();
        };
    </script>
</body>
</html>