<!DOCTYPE html>
<html>
<head>
    <title>認證狀態除錯</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .debug-container { background: white; padding: 20px; border-radius: 8px; margin: 10px 0; }
        .status { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { background: #f8f9fa; padding: 15px; margin: 10px 0; border-left: 4px solid #007bff; }
        pre { background: #f1f1f1; padding: 10px; overflow-x: auto; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>🔧 認證狀態除錯工具</h1>
    
    <div class="debug-container">
        <h2>📊 localStorage 狀態</h2>
        <button onclick="checkLocalStorage()">檢查 localStorage</button>
        <button onclick="clearLocalStorage()">清除 localStorage</button>
        <div id="localStorage-result"></div>
    </div>
    
    <div class="debug-container">
        <h2>🔐 AuthManager 狀態</h2>
        <button onclick="checkAuthManager()">檢查 AuthManager</button>
        <button onclick="forceShowLoginBtn()">強制顯示登入按鈕</button>
        <div id="authManager-result"></div>
    </div>
    
    <div class="debug-container">
        <h2>🎯 DOM 元素檢查</h2>
        <button onclick="checkDOMElements()">檢查 DOM 元素</button>
        <button onclick="restoreLoginButton()">恢復登入按鈕</button>
        <div id="dom-result"></div>
    </div>
    
    <div class="debug-container">
        <h2>🔄 重新初始化</h2>
        <button onclick="reinitializeAuth()">重新初始化認證系統</button>
        <button onclick="simulateLogout()">模擬登出</button>
        <div id="reinit-result"></div>
    </div>

    <!-- 載入 AuthManager -->
    <script src="/js/auth/AuthManager.js"></script>
    
    <script>
        function showResult(containerId, type, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function showDetailedResult(containerId, title, data) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="result">
                    <h4>${title}</h4>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
        }
        
        function checkLocalStorage() {
            const keys = [
                'nexustrade_token', 'nexustrade_refresh_token', 'nexustrade_user',
                'nexustrade_line_bound', 'nexustrade_return_state'
            ];
            
            const storageData = {};
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    try {
                        storageData[key] = key.includes('user') ? JSON.parse(value) : value;
                    } catch (e) {
                        storageData[key] = value;
                    }
                } else {
                    storageData[key] = null;
                }
            });
            
            showDetailedResult('localStorage-result', '💾 localStorage 內容', storageData);
        }
        
        function clearLocalStorage() {
            const keys = [
                'nexustrade_token', 'nexustrade_refresh_token', 'nexustrade_user',
                'nexustrade_line_bound', 'nexustrade_return_state'
            ];
            
            keys.forEach(key => localStorage.removeItem(key));
            
            showResult('localStorage-result', 'success', '🧹 localStorage 已清除');
            
            // 重新載入頁面以重新初始化
            setTimeout(() => location.reload(), 1000);
        }
        
        function checkAuthManager() {
            const result = {
                exists: !!window.authManager,
                initialized: window.authManager ? window.authManager.isInitialized : false,
                authState: window.authManager ? window.authManager.getAuthState() : null
            };
            
            showDetailedResult('authManager-result', '🔐 AuthManager 狀態', result);
        }
        
        function forceShowLoginBtn() {
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.style.display = 'inline-block';
                showResult('authManager-result', 'success', '✅ 登入按鈕已強制顯示');
            } else {
                showResult('authManager-result', 'error', '❌ 找不到登入按鈕元素');
            }
        }
        
        function checkDOMElements() {
            const elements = {
                loginBtn: !!document.getElementById('login-btn'),
                loginBtnDisplay: document.getElementById('login-btn')?.style.display || 'default',
                userMenu: !!document.querySelector('.user-menu'),
                headerRight: !!document.querySelector('.header-right'),
                headerActions: !!document.querySelector('.header-actions')
            };
            
            showDetailedResult('dom-result', '🎯 DOM 元素狀態', elements);
        }
        
        function restoreLoginButton() {
            // 確保登入按鈕存在且可見
            let loginBtn = document.getElementById('login-btn');
            
            if (!loginBtn) {
                // 如果按鈕不存在，創建一個
                const headerActions = document.querySelector('.header-actions') || 
                                    document.querySelector('.header-right');
                
                if (headerActions) {
                    loginBtn = document.createElement('button');
                    loginBtn.id = 'login-btn';
                    loginBtn.className = 'btn btn-secondary';
                    loginBtn.textContent = '登入';
                    headerActions.appendChild(loginBtn);
                    
                    // 添加點擊事件
                    loginBtn.addEventListener('click', () => {
                        if (window.authManager) {
                            window.authManager.showLoginModal();
                        } else {
                            alert('認證系統尚未載入');
                        }
                    });
                }
            }
            
            if (loginBtn) {
                loginBtn.style.display = 'inline-block';
                
                // 移除使用者選單
                const userMenu = document.querySelector('.user-menu');
                if (userMenu) {
                    userMenu.remove();
                }
                
                showResult('dom-result', 'success', '✅ 登入按鈕已恢復');
            } else {
                showResult('dom-result', 'error', '❌ 無法恢復登入按鈕');
            }
        }
        
        function reinitializeAuth() {
            if (window.authManager) {
                // 清除認證狀態
                window.authManager.clearAuthState();
                
                // 重新初始化
                window.authManager.init();
                
                showResult('reinit-result', 'success', '✅ 認證系統已重新初始化');
            } else {
                showResult('reinit-result', 'error', '❌ AuthManager 不存在');
            }
        }
        
        function simulateLogout() {
            if (window.authManager) {
                window.authManager.logout();
                showResult('reinit-result', 'success', '✅ 已執行登出');
            } else {
                // 手動清除狀態
                const keys = [
                    'nexustrade_token', 'nexustrade_refresh_token', 'nexustrade_user',
                    'nexustrade_line_bound', 'nexustrade_return_state'
                ];
                keys.forEach(key => localStorage.removeItem(key));
                
                restoreLoginButton();
                showResult('reinit-result', 'success', '✅ 已手動清除認證狀態');
            }
        }
        
        // 頁面載入後自動檢查
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkLocalStorage();
                checkAuthManager();
                checkDOMElements();
            }, 1000);
        });
    </script>
</body>
</html>