<!DOCTYPE html>
<html>
<head>
    <title>èªè­‰ç‹€æ…‹é™¤éŒ¯</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .debug-container { background: white; padding: 20px; border-radius: 8px; margin: 10px 0; }
        .status { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { background: #f8f9fa; padding: 15px; margin: 10px 0; border-left: 4px solid #007bff; }
        pre { background: #f1f1f1; padding: 10px; overflow-x: auto; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ğŸ”§ èªè­‰ç‹€æ…‹é™¤éŒ¯å·¥å…·</h1>
    
    <div class="debug-container">
        <h2>ğŸ“Š localStorage ç‹€æ…‹</h2>
        <button onclick="checkLocalStorage()">æª¢æŸ¥ localStorage</button>
        <button onclick="clearLocalStorage()">æ¸…é™¤ localStorage</button>
        <div id="localStorage-result"></div>
    </div>
    
    <div class="debug-container">
        <h2>ğŸ” AuthManager ç‹€æ…‹</h2>
        <button onclick="checkAuthManager()">æª¢æŸ¥ AuthManager</button>
        <button onclick="forceShowLoginBtn()">å¼·åˆ¶é¡¯ç¤ºç™»å…¥æŒ‰éˆ•</button>
        <div id="authManager-result"></div>
    </div>
    
    <div class="debug-container">
        <h2>ğŸ¯ DOM å…ƒç´ æª¢æŸ¥</h2>
        <button onclick="checkDOMElements()">æª¢æŸ¥ DOM å…ƒç´ </button>
        <button onclick="restoreLoginButton()">æ¢å¾©ç™»å…¥æŒ‰éˆ•</button>
        <div id="dom-result"></div>
    </div>
    
    <div class="debug-container">
        <h2>ğŸ”„ é‡æ–°åˆå§‹åŒ–</h2>
        <button onclick="reinitializeAuth()">é‡æ–°åˆå§‹åŒ–èªè­‰ç³»çµ±</button>
        <button onclick="simulateLogout()">æ¨¡æ“¬ç™»å‡º</button>
        <div id="reinit-result"></div>
    </div>

    <!-- è¼‰å…¥ AuthManager -->
    <script src="/js/auth/AuthManager.js"></script>
    
    <script>
        function showResult(containerId, type, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function showDetailedResult(containerId, title, data) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="result">
                    <h4>${title}</h4>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
        }
        
        function checkLocalStorage() {
            const keys = [
                'nexustrade_token', 'nexustrade_refresh_token', 'nexustrade_user',
                'nexustrade_line_bound', 'nexustrade_return_state'
            ];
            
            const storageData = {};
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    try {
                        storageData[key] = key.includes('user') ? JSON.parse(value) : value;
                    } catch (e) {
                        storageData[key] = value;
                    }
                } else {
                    storageData[key] = null;
                }
            });
            
            showDetailedResult('localStorage-result', 'ğŸ’¾ localStorage å…§å®¹', storageData);
        }
        
        function clearLocalStorage() {
            const keys = [
                'nexustrade_token', 'nexustrade_refresh_token', 'nexustrade_user',
                'nexustrade_line_bound', 'nexustrade_return_state'
            ];
            
            keys.forEach(key => localStorage.removeItem(key));
            
            showResult('localStorage-result', 'success', 'ğŸ§¹ localStorage å·²æ¸…é™¤');
            
            // é‡æ–°è¼‰å…¥é é¢ä»¥é‡æ–°åˆå§‹åŒ–
            setTimeout(() => location.reload(), 1000);
        }
        
        function checkAuthManager() {
            const result = {
                exists: !!window.authManager,
                initialized: window.authManager ? window.authManager.isInitialized : false,
                authState: window.authManager ? window.authManager.getAuthState() : null
            };
            
            showDetailedResult('authManager-result', 'ğŸ” AuthManager ç‹€æ…‹', result);
        }
        
        function forceShowLoginBtn() {
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.style.display = 'inline-block';
                showResult('authManager-result', 'success', 'âœ… ç™»å…¥æŒ‰éˆ•å·²å¼·åˆ¶é¡¯ç¤º');
            } else {
                showResult('authManager-result', 'error', 'âŒ æ‰¾ä¸åˆ°ç™»å…¥æŒ‰éˆ•å…ƒç´ ');
            }
        }
        
        function checkDOMElements() {
            const elements = {
                loginBtn: !!document.getElementById('login-btn'),
                loginBtnDisplay: document.getElementById('login-btn')?.style.display || 'default',
                userMenu: !!document.querySelector('.user-menu'),
                headerRight: !!document.querySelector('.header-right'),
                headerActions: !!document.querySelector('.header-actions')
            };
            
            showDetailedResult('dom-result', 'ğŸ¯ DOM å…ƒç´ ç‹€æ…‹', elements);
        }
        
        function restoreLoginButton() {
            // ç¢ºä¿ç™»å…¥æŒ‰éˆ•å­˜åœ¨ä¸”å¯è¦‹
            let loginBtn = document.getElementById('login-btn');
            
            if (!loginBtn) {
                // å¦‚æœæŒ‰éˆ•ä¸å­˜åœ¨ï¼Œå‰µå»ºä¸€å€‹
                const headerActions = document.querySelector('.header-actions') || 
                                    document.querySelector('.header-right');
                
                if (headerActions) {
                    loginBtn = document.createElement('button');
                    loginBtn.id = 'login-btn';
                    loginBtn.className = 'btn btn-secondary';
                    loginBtn.textContent = 'ç™»å…¥';
                    headerActions.appendChild(loginBtn);
                    
                    // æ·»åŠ é»æ“Šäº‹ä»¶
                    loginBtn.addEventListener('click', () => {
                        if (window.authManager) {
                            window.authManager.showLoginModal();
                        } else {
                            alert('èªè­‰ç³»çµ±å°šæœªè¼‰å…¥');
                        }
                    });
                }
            }
            
            if (loginBtn) {
                loginBtn.style.display = 'inline-block';
                
                // ç§»é™¤ä½¿ç”¨è€…é¸å–®
                const userMenu = document.querySelector('.user-menu');
                if (userMenu) {
                    userMenu.remove();
                }
                
                showResult('dom-result', 'success', 'âœ… ç™»å…¥æŒ‰éˆ•å·²æ¢å¾©');
            } else {
                showResult('dom-result', 'error', 'âŒ ç„¡æ³•æ¢å¾©ç™»å…¥æŒ‰éˆ•');
            }
        }
        
        function reinitializeAuth() {
            if (window.authManager) {
                // æ¸…é™¤èªè­‰ç‹€æ…‹
                window.authManager.clearAuthState();
                
                // é‡æ–°åˆå§‹åŒ–
                window.authManager.init();
                
                showResult('reinit-result', 'success', 'âœ… èªè­‰ç³»çµ±å·²é‡æ–°åˆå§‹åŒ–');
            } else {
                showResult('reinit-result', 'error', 'âŒ AuthManager ä¸å­˜åœ¨');
            }
        }
        
        function simulateLogout() {
            if (window.authManager) {
                window.authManager.logout();
                showResult('reinit-result', 'success', 'âœ… å·²åŸ·è¡Œç™»å‡º');
            } else {
                // æ‰‹å‹•æ¸…é™¤ç‹€æ…‹
                const keys = [
                    'nexustrade_token', 'nexustrade_refresh_token', 'nexustrade_user',
                    'nexustrade_line_bound', 'nexustrade_return_state'
                ];
                keys.forEach(key => localStorage.removeItem(key));
                
                restoreLoginButton();
                showResult('reinit-result', 'success', 'âœ… å·²æ‰‹å‹•æ¸…é™¤èªè­‰ç‹€æ…‹');
            }
        }
        
        // é é¢è¼‰å…¥å¾Œè‡ªå‹•æª¢æŸ¥
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkLocalStorage();
                checkAuthManager();
                checkDOMElements();
            }, 1000);
        });
    </script>
</body>
</html>