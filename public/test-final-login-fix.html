<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎯 最終登入修復驗證</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #ffffff;
        }
        .test-section {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #444;
        }
        .btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
            font-weight: bold;
        }
        .btn:hover {
            background: #1976D2;
        }
        .btn-success {
            background: #4CAF50;
        }
        .btn-warning {
            background: #FF9800;
        }
        .result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .result-success {
            background: rgba(76, 175, 80, 0.2);
            border-left-color: #4CAF50;
        }
        .result-error {
            background: rgba(244, 67, 54, 0.2);
            border-left-color: #F44336;
        }
        .big-success {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
            text-align: center;
            font-size: 20px;
            padding: 25px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .step-box {
            background: #333;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>🎯 最終登入修復驗證</h1>
    <p><strong>測試目標</strong>：驗證 PriceAlertModal 現在提供 LINE 登入選項</p>

    <div class="test-section">
        <h2>📋 測試步驟</h2>
        <div class="step-box">
            <strong>步驟 1</strong>：設定測試用戶 (已認證但模擬未登入狀態)
        </div>
        <div class="step-box">
            <strong>步驟 2</strong>：清除認證狀態來觸發登入提示
        </div>
        <div class="step-box">
            <strong>步驟 3</strong>：測試價格警報模態框的登入選項
        </div>
        <div class="step-box">
            <strong>步驟 4</strong>：驗證是否有 LINE 登入選項
        </div>
    </div>

    <div class="test-section">
        <h2>🧪 執行測試</h2>
        <div id="test-results"></div>
        <button class="btn btn-success" onclick="runFullTest()">🚀 執行完整測試</button>
        <button class="btn" onclick="clearAuthAndTest()">🔄 清除認證並測試</button>
        <button class="btn btn-warning" onclick="restoreAuth()">⚡ 還原認證狀態</button>
    </div>

    <!-- 載入必要的腳本 -->
    <script src="/js/lib/auth-state-manager.js"></script>
    <script src="/js/components/PriceAlertModal.js"></script>

    <script>
        // 保存原始認證狀態
        let originalAuthState = null;

        /**
         * 執行完整測試
         */
        function runFullTest() {
            const resultsDiv = document.getElementById('test-results');
            let html = '<h3>🧪 測試進行中...</h3>';
            resultsDiv.innerHTML = html;

            try {
                // 1. 保存當前認證狀態
                originalAuthState = {
                    token: localStorage.getItem('nexustrade_token'),
                    user: localStorage.getItem('nexustrade_user')
                };

                // 2. 清除認證狀態
                localStorage.removeItem('nexustrade_token');
                localStorage.removeItem('nexustrade_user');
                window.currentUser = null;

                html += '<div class="result result-success">✅ 步驟 1: 已清除認證狀態</div>';

                // 3. 檢查 PriceAlertModal 是否存在
                if (typeof window.PriceAlertModal !== 'undefined' && typeof window.priceAlertModal !== 'undefined') {
                    html += '<div class="result result-success">✅ 步驟 2: PriceAlertModal 存在</div>';

                    // 4. 觸發價格警報模態框
                    window.priceAlertModal.show('BTCUSDT');
                    html += '<div class="result result-success">✅ 步驟 3: 已觸發 PriceAlertModal</div>';

                    // 5. 檢查模態框內容
                    setTimeout(() => {
                        const modal = document.querySelector('.price-alert-modal');
                        if (modal && modal.style.display !== 'none') {
                            const modalContent = modal.innerHTML;

                            // 檢查是否有 LINE 登入按鈕
                            const hasLineLogin = modalContent.includes('LINE 登入') || modalContent.includes('📱');
                            const hasGoogleLogin = modalContent.includes('Google 登入') || modalContent.includes('🔐');
                            const hasLoginPrompt = modalContent.includes('需要先登入') || modalContent.includes('設定通知功能需要');

                            html += '<h3>🔍 模態框內容檢查</h3>';

                            if (hasLoginPrompt) {
                                html += '<div class="result result-success">✅ 正確顯示登入提示</div>';
                            } else {
                                html += '<div class="result result-error">❌ 沒有顯示登入提示</div>';
                            }

                            if (hasLineLogin) {
                                html += '<div class="result result-success">✅ 有 LINE 登入選項</div>';
                            } else {
                                html += '<div class="result result-error">❌ 缺少 LINE 登入選項</div>';
                            }

                            if (hasGoogleLogin) {
                                html += '<div class="result result-success">✅ 有 Google 登入選項</div>';
                            } else {
                                html += '<div class="result result-error">❌ 缺少 Google 登入選項</div>';
                            }

                            if (hasLineLogin && hasGoogleLogin && hasLoginPrompt) {
                                html += '<div class="big-success">🎉 測試成功！現在用戶可以選擇 LINE 或 Google 登入</div>';
                                html += '<div class="result result-success">✅ 修復完成：用戶現在可以選擇適合的登入方式</div>';
                                html += '<div class="result result-success">📱 LINE 登入：適合需要通知功能的用戶</div>';
                                html += '<div class="result result-success">🔐 Google 登入：適合一般使用者</div>';
                            } else {
                                html += '<div class="result result-error">❌ 測試未完全通過，需要進一步檢查</div>';
                            }

                        } else {
                            html += '<div class="result result-error">❌ 模態框未正確顯示</div>';
                        }

                        resultsDiv.innerHTML = html;
                    }, 1000);

                } else {
                    html += '<div class="result result-error">❌ PriceAlertModal 不存在</div>';
                    resultsDiv.innerHTML = html;
                }

            } catch (error) {
                html += `<div class="result result-error">❌ 測試失敗: ${error.message}</div>`;
                resultsDiv.innerHTML = html;
            }
        }

        /**
         * 清除認證並測試
         */
        function clearAuthAndTest() {
            localStorage.clear();
            window.currentUser = null;
            document.getElementById('test-results').innerHTML = 
                '<div class="result result-success">🗑️ 已清除所有認證資料，可以重新測試登入流程</div>';
        }

        /**
         * 還原認證狀態
         */
        function restoreAuth() {
            if (originalAuthState) {
                if (originalAuthState.token) {
                    localStorage.setItem('nexustrade_token', originalAuthState.token);
                }
                if (originalAuthState.user) {
                    localStorage.setItem('nexustrade_user', originalAuthState.user);
                    window.currentUser = JSON.parse(originalAuthState.user);
                }
                document.getElementById('test-results').innerHTML = 
                    '<div class="result result-success">⚡ 已還原原始認證狀態</div>';
            } else {
                // 設定 Vic Huang 測試認證
                const vicHuangUser = {
                    "id": "ue5cc188e1d2cdbac5cfda2abb6f6a34b",
                    "email": "line_ue5cc188e1d2cdbac5cfda2abb6f6a34b@example.com",
                    "username": "vic_huang",
                    "profile": {
                        "firstName": "Vic",
                        "lastName": "Huang",
                        "displayName": "Vic Huang",
                        "avatar": "https://profile.line-scdn.net/0he27Lgff1Oh0aNRC2EBlEYmplOXc5RGMPN1FwKS8yZH0vAypDZQF2K3o9NChzA3VKY1NyfSZiZSsWJk17BGPGKR0FZywmA31OMVV9-A"
                    },
                    "emailVerified": true,
                    "status": "active",
                    "lastLoginAt": "2025-07-02T17:38:16.385Z",
                    "googleId": null,
                    "lineId": "ue5cc188e1d2cdbac5cfda2abb6f6a34b",
                    "lineUserId": "ue5cc188e1d2cdbac5cfda2abb6f6a34b",
                    "provider": "line"
                };

                const testToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJ1ZTVjYzE4OGUxZDJjZGJhYzVjZmRhMmFiYjZmNmEzNGIiLCJlbWFpbCI6ImxpbmVfdWU1Y2MxODhlMWQyY2RiYWM1Y2ZkYTJhYmI2ZjZhMzRiQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ2aWNfaHVhbmciLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzUxNDg3ODExLCJleHAiOjE3NTIwOTI2MTF9.tgdnC-lPoPgEsFNE79DkKey8toMpRFjSeH9doF1NhzE';

                localStorage.setItem('nexustrade_token', testToken);
                localStorage.setItem('nexustrade_user', JSON.stringify(vicHuangUser));
                window.currentUser = vicHuangUser;

                document.getElementById('test-results').innerHTML = 
                    '<div class="result result-success">⚡ 已設定 Vic Huang 測試認證狀態</div>';
            }
        }

        // 頁面載入時的說明
        window.addEventListener('load', function() {
            document.getElementById('test-results').innerHTML = `
                <div class="result result-success">
                    💡 <strong>測試說明</strong>：<br>
                    1. 點擊 "執行完整測試" 來測試登入選項<br>
                    2. 觀察模態框是否提供 LINE 和 Google 登入選項<br>
                    3. 測試完成後可以點擊 "還原認證狀態" 恢復登入狀態
                </div>
            `;
        });
    </script>
</body>
</html>