<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ æœ€çµ‚ç™»å…¥ä¿®å¾©é©—è­‰</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #ffffff;
        }
        .test-section {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #444;
        }
        .btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
            font-weight: bold;
        }
        .btn:hover {
            background: #1976D2;
        }
        .btn-success {
            background: #4CAF50;
        }
        .btn-warning {
            background: #FF9800;
        }
        .result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .result-success {
            background: rgba(76, 175, 80, 0.2);
            border-left-color: #4CAF50;
        }
        .result-error {
            background: rgba(244, 67, 54, 0.2);
            border-left-color: #F44336;
        }
        .big-success {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
            text-align: center;
            font-size: 20px;
            padding: 25px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .step-box {
            background: #333;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ¯ æœ€çµ‚ç™»å…¥ä¿®å¾©é©—è­‰</h1>
    <p><strong>æ¸¬è©¦ç›®æ¨™</strong>ï¼šé©—è­‰ PriceAlertModal ç¾åœ¨æä¾› LINE ç™»å…¥é¸é …</p>

    <div class="test-section">
        <h2>ğŸ“‹ æ¸¬è©¦æ­¥é©Ÿ</h2>
        <div class="step-box">
            <strong>æ­¥é©Ÿ 1</strong>ï¼šè¨­å®šæ¸¬è©¦ç”¨æˆ¶ (å·²èªè­‰ä½†æ¨¡æ“¬æœªç™»å…¥ç‹€æ…‹)
        </div>
        <div class="step-box">
            <strong>æ­¥é©Ÿ 2</strong>ï¼šæ¸…é™¤èªè­‰ç‹€æ…‹ä¾†è§¸ç™¼ç™»å…¥æç¤º
        </div>
        <div class="step-box">
            <strong>æ­¥é©Ÿ 3</strong>ï¼šæ¸¬è©¦åƒ¹æ ¼è­¦å ±æ¨¡æ…‹æ¡†çš„ç™»å…¥é¸é …
        </div>
        <div class="step-box">
            <strong>æ­¥é©Ÿ 4</strong>ï¼šé©—è­‰æ˜¯å¦æœ‰ LINE ç™»å…¥é¸é …
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ§ª åŸ·è¡Œæ¸¬è©¦</h2>
        <div id="test-results"></div>
        <button class="btn btn-success" onclick="runFullTest()">ğŸš€ åŸ·è¡Œå®Œæ•´æ¸¬è©¦</button>
        <button class="btn" onclick="clearAuthAndTest()">ğŸ”„ æ¸…é™¤èªè­‰ä¸¦æ¸¬è©¦</button>
        <button class="btn btn-warning" onclick="restoreAuth()">âš¡ é‚„åŸèªè­‰ç‹€æ…‹</button>
    </div>

    <!-- è¼‰å…¥å¿…è¦çš„è…³æœ¬ -->
    <script src="/js/lib/auth-state-manager.js"></script>
    <script src="/js/components/PriceAlertModal.js"></script>

    <script>
        // ä¿å­˜åŸå§‹èªè­‰ç‹€æ…‹
        let originalAuthState = null;

        /**
         * åŸ·è¡Œå®Œæ•´æ¸¬è©¦
         */
        function runFullTest() {
            const resultsDiv = document.getElementById('test-results');
            let html = '<h3>ğŸ§ª æ¸¬è©¦é€²è¡Œä¸­...</h3>';
            resultsDiv.innerHTML = html;

            try {
                // 1. ä¿å­˜ç•¶å‰èªè­‰ç‹€æ…‹
                originalAuthState = {
                    token: localStorage.getItem('nexustrade_token'),
                    user: localStorage.getItem('nexustrade_user')
                };

                // 2. æ¸…é™¤èªè­‰ç‹€æ…‹
                localStorage.removeItem('nexustrade_token');
                localStorage.removeItem('nexustrade_user');
                window.currentUser = null;

                html += '<div class="result result-success">âœ… æ­¥é©Ÿ 1: å·²æ¸…é™¤èªè­‰ç‹€æ…‹</div>';

                // 3. æª¢æŸ¥ PriceAlertModal æ˜¯å¦å­˜åœ¨
                if (typeof window.PriceAlertModal !== 'undefined' && typeof window.priceAlertModal !== 'undefined') {
                    html += '<div class="result result-success">âœ… æ­¥é©Ÿ 2: PriceAlertModal å­˜åœ¨</div>';

                    // 4. è§¸ç™¼åƒ¹æ ¼è­¦å ±æ¨¡æ…‹æ¡†
                    window.priceAlertModal.show('BTCUSDT');
                    html += '<div class="result result-success">âœ… æ­¥é©Ÿ 3: å·²è§¸ç™¼ PriceAlertModal</div>';

                    // 5. æª¢æŸ¥æ¨¡æ…‹æ¡†å…§å®¹
                    setTimeout(() => {
                        const modal = document.querySelector('.price-alert-modal');
                        if (modal && modal.style.display !== 'none') {
                            const modalContent = modal.innerHTML;

                            // æª¢æŸ¥æ˜¯å¦æœ‰ LINE ç™»å…¥æŒ‰éˆ•
                            const hasLineLogin = modalContent.includes('LINE ç™»å…¥') || modalContent.includes('ğŸ“±');
                            const hasGoogleLogin = modalContent.includes('Google ç™»å…¥') || modalContent.includes('ğŸ”');
                            const hasLoginPrompt = modalContent.includes('éœ€è¦å…ˆç™»å…¥') || modalContent.includes('è¨­å®šé€šçŸ¥åŠŸèƒ½éœ€è¦');

                            html += '<h3>ğŸ” æ¨¡æ…‹æ¡†å…§å®¹æª¢æŸ¥</h3>';

                            if (hasLoginPrompt) {
                                html += '<div class="result result-success">âœ… æ­£ç¢ºé¡¯ç¤ºç™»å…¥æç¤º</div>';
                            } else {
                                html += '<div class="result result-error">âŒ æ²’æœ‰é¡¯ç¤ºç™»å…¥æç¤º</div>';
                            }

                            if (hasLineLogin) {
                                html += '<div class="result result-success">âœ… æœ‰ LINE ç™»å…¥é¸é …</div>';
                            } else {
                                html += '<div class="result result-error">âŒ ç¼ºå°‘ LINE ç™»å…¥é¸é …</div>';
                            }

                            if (hasGoogleLogin) {
                                html += '<div class="result result-success">âœ… æœ‰ Google ç™»å…¥é¸é …</div>';
                            } else {
                                html += '<div class="result result-error">âŒ ç¼ºå°‘ Google ç™»å…¥é¸é …</div>';
                            }

                            if (hasLineLogin && hasGoogleLogin && hasLoginPrompt) {
                                html += '<div class="big-success">ğŸ‰ æ¸¬è©¦æˆåŠŸï¼ç¾åœ¨ç”¨æˆ¶å¯ä»¥é¸æ“‡ LINE æˆ– Google ç™»å…¥</div>';
                                html += '<div class="result result-success">âœ… ä¿®å¾©å®Œæˆï¼šç”¨æˆ¶ç¾åœ¨å¯ä»¥é¸æ“‡é©åˆçš„ç™»å…¥æ–¹å¼</div>';
                                html += '<div class="result result-success">ğŸ“± LINE ç™»å…¥ï¼šé©åˆéœ€è¦é€šçŸ¥åŠŸèƒ½çš„ç”¨æˆ¶</div>';
                                html += '<div class="result result-success">ğŸ” Google ç™»å…¥ï¼šé©åˆä¸€èˆ¬ä½¿ç”¨è€…</div>';
                            } else {
                                html += '<div class="result result-error">âŒ æ¸¬è©¦æœªå®Œå…¨é€šéï¼Œéœ€è¦é€²ä¸€æ­¥æª¢æŸ¥</div>';
                            }

                        } else {
                            html += '<div class="result result-error">âŒ æ¨¡æ…‹æ¡†æœªæ­£ç¢ºé¡¯ç¤º</div>';
                        }

                        resultsDiv.innerHTML = html;
                    }, 1000);

                } else {
                    html += '<div class="result result-error">âŒ PriceAlertModal ä¸å­˜åœ¨</div>';
                    resultsDiv.innerHTML = html;
                }

            } catch (error) {
                html += `<div class="result result-error">âŒ æ¸¬è©¦å¤±æ•—: ${error.message}</div>`;
                resultsDiv.innerHTML = html;
            }
        }

        /**
         * æ¸…é™¤èªè­‰ä¸¦æ¸¬è©¦
         */
        function clearAuthAndTest() {
            localStorage.clear();
            window.currentUser = null;
            document.getElementById('test-results').innerHTML = 
                '<div class="result result-success">ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰èªè­‰è³‡æ–™ï¼Œå¯ä»¥é‡æ–°æ¸¬è©¦ç™»å…¥æµç¨‹</div>';
        }

        /**
         * é‚„åŸèªè­‰ç‹€æ…‹
         */
        function restoreAuth() {
            if (originalAuthState) {
                if (originalAuthState.token) {
                    localStorage.setItem('nexustrade_token', originalAuthState.token);
                }
                if (originalAuthState.user) {
                    localStorage.setItem('nexustrade_user', originalAuthState.user);
                    window.currentUser = JSON.parse(originalAuthState.user);
                }
                document.getElementById('test-results').innerHTML = 
                    '<div class="result result-success">âš¡ å·²é‚„åŸåŸå§‹èªè­‰ç‹€æ…‹</div>';
            } else {
                // è¨­å®š Vic Huang æ¸¬è©¦èªè­‰
                const vicHuangUser = {
                    "id": "ue5cc188e1d2cdbac5cfda2abb6f6a34b",
                    "email": "line_ue5cc188e1d2cdbac5cfda2abb6f6a34b@example.com",
                    "username": "vic_huang",
                    "profile": {
                        "firstName": "Vic",
                        "lastName": "Huang",
                        "displayName": "Vic Huang",
                        "avatar": "https://profile.line-scdn.net/0he27Lgff1Oh0aNRC2EBlEYmplOXc5RGMPN1FwKS8yZH0vAypDZQF2K3o9NChzA3VKY1NyfSZiZSsWJk17BGPGKR0FZywmA31OMVV9-A"
                    },
                    "emailVerified": true,
                    "status": "active",
                    "lastLoginAt": "2025-07-02T17:38:16.385Z",
                    "googleId": null,
                    "lineId": "ue5cc188e1d2cdbac5cfda2abb6f6a34b",
                    "lineUserId": "ue5cc188e1d2cdbac5cfda2abb6f6a34b",
                    "provider": "line"
                };

                const testToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJ1ZTVjYzE4OGUxZDJjZGJhYzVjZmRhMmFiYjZmNmEzNGIiLCJlbWFpbCI6ImxpbmVfdWU1Y2MxODhlMWQyY2RiYWM1Y2ZkYTJhYmI2ZjZhMzRiQGV4YW1wbGUuY29tIiwidXNlcm5hbWUiOiJ2aWNfaHVhbmciLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzUxNDg3ODExLCJleHAiOjE3NTIwOTI2MTF9.tgdnC-lPoPgEsFNE79DkKey8toMpRFjSeH9doF1NhzE';

                localStorage.setItem('nexustrade_token', testToken);
                localStorage.setItem('nexustrade_user', JSON.stringify(vicHuangUser));
                window.currentUser = vicHuangUser;

                document.getElementById('test-results').innerHTML = 
                    '<div class="result result-success">âš¡ å·²è¨­å®š Vic Huang æ¸¬è©¦èªè­‰ç‹€æ…‹</div>';
            }
        }

        // é é¢è¼‰å…¥æ™‚çš„èªªæ˜
        window.addEventListener('load', function() {
            document.getElementById('test-results').innerHTML = `
                <div class="result result-success">
                    ğŸ’¡ <strong>æ¸¬è©¦èªªæ˜</strong>ï¼š<br>
                    1. é»æ“Š "åŸ·è¡Œå®Œæ•´æ¸¬è©¦" ä¾†æ¸¬è©¦ç™»å…¥é¸é …<br>
                    2. è§€å¯Ÿæ¨¡æ…‹æ¡†æ˜¯å¦æä¾› LINE å’Œ Google ç™»å…¥é¸é …<br>
                    3. æ¸¬è©¦å®Œæˆå¾Œå¯ä»¥é»æ“Š "é‚„åŸèªè­‰ç‹€æ…‹" æ¢å¾©ç™»å…¥ç‹€æ…‹
                </div>
            `;
        });
    </script>
</body>
</html>