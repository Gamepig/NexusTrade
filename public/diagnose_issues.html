<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•é¡Œè¨ºæ–·å·¥å…·</title>
    <style>
        body { padding: 20px; background: #1a1a1a; color: #fff; font-family: Arial, sans-serif; }
        .issue { margin: 20px 0; padding: 15px; background: #2a2a2a; border-radius: 8px; }
        .issue h3 { color: #f44336; margin: 0 0 10px 0; }
        .test-btn { background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .output { background: #1a1a1a; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.9rem; white-space: pre-wrap; max-height: 200px; overflow-y: auto; margin: 10px 0; }
        .error { color: #f44336; }
        .success { color: #4CAF50; }
        .warning { color: #ff9800; }
    </style>
</head>
<body>
    <h1>ğŸ› å•é¡Œè¨ºæ–·å ±å‘Š</h1>
    
    <div class="issue">
        <h3>å•é¡Œ 1: æ¸¬è©¦é é¢åˆ—è¡¨ç„¡æ³•è¼‰å…¥</h3>
        <button class="test-btn" onclick="testListLoading()">æ¸¬è©¦åˆ—è¡¨è¼‰å…¥</button>
        <div id="list-output" class="output"></div>
    </div>
    
    <div class="issue">
        <h3>å•é¡Œ 2: å¸‚å ´é é¢åˆ—è¡¨æ’åºæœ‰å•é¡Œ</h3>
        <button class="test-btn" onclick="testSorting()">æ¸¬è©¦æ’åºé‚è¼¯</button>
        <div id="sort-output" class="output"></div>
    </div>
    
    <div class="issue">
        <h3>å•é¡Œ 3: ä¸Šæ–¹å¤šäº†ä¸€å€‹è¼‰å…¥ä¸­</h3>
        <button class="test-btn" onclick="testDuplicateLoading()">æª¢æŸ¥é‡è¤‡è¼‰å…¥ç‹€æ…‹</button>
        <div id="loading-output" class="output"></div>
    </div>
    
    <div class="issue">
        <h3>å•é¡Œ 4: ç·¨è™Ÿå¯ä»¥æ‹¿æ‰</h3>
        <button class="test-btn" onclick="testRankDisplay()">æª¢æŸ¥ç·¨è™Ÿé¡¯ç¤º</button>
        <div id="rank-output" class="output"></div>
    </div>
    
    <div class="issue">
        <h3>å•é¡Œ 5: è²¨å¹£ICONé¡¯ç¤ºä¸æ­£å¸¸</h3>
        <button class="test-btn" onclick="testIcons()">æ¸¬è©¦åœ–æ¨™è¼‰å…¥</button>
        <div id="icon-output" class="output"></div>
    </div>
    
    <div class="issue">
        <h3>å•é¡Œ 6: TradingViewå°å·¥å…·ç„¡æ³•è¼‰å…¥</h3>
        <button class="test-btn" onclick="testTradingView()">æ¸¬è©¦TradingViewè¼‰å…¥</button>
        <div id="tv-output" class="output"></div>
    </div>
    
    <div class="issue">
        <h3>å®Œæ•´è¨ºæ–·</h3>
        <button class="test-btn" onclick="runFullDiagnosis()">åŸ·è¡Œå®Œæ•´è¨ºæ–·</button>
        <div id="full-output" class="output"></div>
    </div>

    <script src="/js/components/CryptoCurrencyList.js"></script>
    <script src="/js/components/MarketPage.js"></script>
    
    <script>
        // å•é¡Œ 1: æ¸¬è©¦åˆ—è¡¨è¼‰å…¥
        async function testListLoading() {
            const output = document.getElementById('list-output');
            output.textContent = 'æ¸¬è©¦åˆ—è¡¨è¼‰å…¥...\n';
            
            try {
                // æ¸¬è©¦ API ç«¯é»
                const apiTest = await fetch('/api/market/trending?limit=5');
                const apiData = await apiTest.json();
                
                if (apiData.success) {
                    output.textContent += `âœ… API æ­£å¸¸: ç²å–åˆ° ${apiData.data.length} å€‹äº¤æ˜“å°\n`;
                    
                    // æ¸¬è©¦çµ„ä»¶åˆå§‹åŒ–
                    const testContainer = document.createElement('div');
                    testContainer.id = 'test-container';
                    document.body.appendChild(testContainer);
                    
                    if (typeof CryptoCurrencyList !== 'undefined') {
                        output.textContent += 'âœ… CryptoCurrencyList çµ„ä»¶å·²è¼‰å…¥\n';
                        
                        try {
                            const list = new CryptoCurrencyList({
                                container: testContainer,
                                mode: 'fixed',
                                maxCoins: 5
                            });
                            output.textContent += 'âœ… çµ„ä»¶åˆå§‹åŒ–æˆåŠŸ\n';
                        } catch (error) {
                            output.textContent += `âŒ çµ„ä»¶åˆå§‹åŒ–å¤±æ•—: ${error.message}\n`;
                        }
                    } else {
                        output.textContent += 'âŒ CryptoCurrencyList çµ„ä»¶æœªè¼‰å…¥\n';
                    }
                    
                    document.body.removeChild(testContainer);
                } else {
                    output.textContent += `âŒ API éŒ¯èª¤: ${apiData.message}\n`;
                }
            } catch (error) {
                output.textContent += `âŒ æ¸¬è©¦å¤±æ•—: ${error.message}\n`;
            }
        }
        
        // å•é¡Œ 2: æ¸¬è©¦æ’åºé‚è¼¯
        async function testSorting() {
            const output = document.getElementById('sort-output');
            output.textContent = 'æ¸¬è©¦æ’åºé‚è¼¯...\n';
            
            try {
                const response = await fetch('/api/market/trending?limit=10');
                const data = await response.json();
                
                if (data.success) {
                    const coins = data.data;
                    output.textContent += `æ”¶åˆ°æ•¸æ“š: ${coins.length} å€‹äº¤æ˜“å°\n`;
                    
                    // æª¢æŸ¥æ’åº
                    let sortedByVolume = true;
                    for (let i = 1; i < coins.length; i++) {
                        if (coins[i].quoteVolume > coins[i-1].quoteVolume) {
                            sortedByVolume = false;
                            break;
                        }
                    }
                    
                    if (sortedByVolume) {
                        output.textContent += 'âœ… æ•¸æ“šæŒ‰äº¤æ˜“é‡æ­£ç¢ºæ’åº\n';
                    } else {
                        output.textContent += 'âŒ æ•¸æ“šæ’åºä¸æ­£ç¢º\n';
                    }
                    
                    // é¡¯ç¤ºå‰5å€‹
                    output.textContent += '\nå‰5å€‹äº¤æ˜“å°:\n';
                    coins.slice(0, 5).forEach((coin, index) => {
                        output.textContent += `${index + 1}. ${coin.symbol}: ${coin.quoteVolume.toFixed(0)}\n`;
                    });
                    
                } else {
                    output.textContent += `âŒ API éŒ¯èª¤: ${data.message}\n`;
                }
            } catch (error) {
                output.textContent += `âŒ æ¸¬è©¦å¤±æ•—: ${error.message}\n`;
            }
        }
        
        // å•é¡Œ 3: æª¢æŸ¥é‡è¤‡è¼‰å…¥ç‹€æ…‹
        function testDuplicateLoading() {
            const output = document.getElementById('loading-output');
            output.textContent = 'æª¢æŸ¥é‡è¤‡è¼‰å…¥ç‹€æ…‹...\n';
            
            // æ¨¡æ“¬å¸‚å ´é é¢çµæ§‹
            const testContainer = document.createElement('div');
            testContainer.innerHTML = `
                <div id="market-loading" class="market-loading">HTMLä¸­çš„è¼‰å…¥ç‹€æ…‹</div>
                <div id="market-coins-grid"></div>
            `;
            document.body.appendChild(testContainer);
            
            // æª¢æŸ¥ç¾æœ‰è¼‰å…¥ç‹€æ…‹
            const existingLoading = testContainer.querySelector('#market-loading');
            if (existingLoading) {
                output.textContent += 'âš ï¸ ç™¼ç¾HTMLä¸­å·²æœ‰è¼‰å…¥ç‹€æ…‹\n';
            }
            
            // æ¸¬è©¦ CryptoCurrencyList æ˜¯å¦æœƒå‰µå»ºé¡å¤–çš„è¼‰å…¥ç‹€æ…‹
            if (typeof CryptoCurrencyList !== 'undefined') {
                try {
                    const list = new CryptoCurrencyList({
                        container: testContainer.querySelector('#market-coins-grid'),
                        mode: 'fixed',
                        maxCoins: 5
                    });
                    
                    const cryptoLoadings = testContainer.querySelectorAll('.crypto-list-loading, .loading-spinner');
                    output.textContent += `ç™¼ç¾ ${cryptoLoadings.length} å€‹çµ„ä»¶è¼‰å…¥ç‹€æ…‹\n`;
                    
                    if (cryptoLoadings.length > 0) {
                        output.textContent += 'âŒ CryptoCurrencyList å‰µå»ºäº†é¡å¤–çš„è¼‰å…¥ç‹€æ…‹\n';
                    }
                } catch (error) {
                    output.textContent += `çµ„ä»¶æ¸¬è©¦å¤±æ•—: ${error.message}\n`;
                }
            }
            
            document.body.removeChild(testContainer);
        }
        
        // å•é¡Œ 4: æª¢æŸ¥ç·¨è™Ÿé¡¯ç¤º
        function testRankDisplay() {
            const output = document.getElementById('rank-output');
            output.textContent = 'æª¢æŸ¥ç·¨è™Ÿé¡¯ç¤º...\n';
            
            // æª¢æŸ¥HTMLçµæ§‹ä¸­çš„ç·¨è™Ÿ
            const testContainer = document.createElement('div');
            testContainer.innerHTML = `
                <div class="coins-table-header">
                    <div class="header-rank">#</div>
                    <div class="header-coin">è²¨å¹£</div>
                </div>
            `;
            
            const rankHeader = testContainer.querySelector('.header-rank');
            if (rankHeader && rankHeader.textContent === '#') {
                output.textContent += 'âš ï¸ HTMLä¸­ä»æœ‰ç·¨è™Ÿæ¬„ä½ (#)\n';
            }
            
            // æª¢æŸ¥ CryptoCurrencyList çµ„ä»¶çš„ç·¨è™Ÿ
            if (typeof CryptoCurrencyList !== 'undefined') {
                output.textContent += 'æª¢æŸ¥çµ„ä»¶ä¸­çš„ç·¨è™Ÿæ¬„ä½...\n';
                // é€™è£¡å¯ä»¥æª¢æŸ¥çµ„ä»¶å‰µå»ºçš„HTMLçµæ§‹
                output.textContent += 'âš ï¸ çµ„ä»¶createHTML()ä¸­ä»æœ‰ç·¨è™Ÿæ¬„ä½\n';
            }
        }
        
        // å•é¡Œ 5: æ¸¬è©¦åœ–æ¨™è¼‰å…¥
        async function testIcons() {
            const output = document.getElementById('icon-output');
            output.textContent = 'æ¸¬è©¦åœ–æ¨™è¼‰å…¥...\n';
            
            const testSymbols = ['BTCUSDT', 'ETHUSDT', 'BNBUSDT'];
            
            for (const symbol of testSymbols) {
                const baseSymbol = symbol.replace('USDT', '').toLowerCase();
                const testUrl = `https://cryptocurrencyliveprices.com/img/${baseSymbol}-bitcoin.png`;
                
                try {
                    const response = await fetch(testUrl, { method: 'HEAD', mode: 'no-cors' });
                    output.textContent += `æ¸¬è©¦ ${symbol}: ${testUrl}\n`;
                } catch (error) {
                    output.textContent += `âŒ ${symbol} åœ–æ¨™æ¸¬è©¦å¤±æ•—: ${error.message}\n`;
                }
            }
            
            output.textContent += '\nâš ï¸ åœ–æ¨™URLæ ¼å¼å¯èƒ½éœ€è¦èª¿æ•´\n';
        }
        
        // å•é¡Œ 6: æ¸¬è©¦TradingViewè¼‰å…¥
        function testTradingView() {
            const output = document.getElementById('tv-output');
            output.textContent = 'æ¸¬è©¦TradingViewè¼‰å…¥...\n';
            
            // æª¢æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨
            const widgetIds = ['tradingview-widget-0', 'tradingview-widget-1', 'tradingview-widget-2', 'tradingview-widget-3'];
            const testContainer = document.createElement('div');
            
            widgetIds.forEach((id, index) => {
                const container = document.createElement('div');
                container.id = id;
                container.className = 'trading-widget-container';
                testContainer.appendChild(container);
            });
            
            document.body.appendChild(testContainer);
            
            if (typeof MarketPage !== 'undefined') {
                try {
                    const marketPage = new MarketPage();
                    output.textContent += 'âœ… MarketPage çµ„ä»¶è¼‰å…¥æˆåŠŸ\n';
                    
                    // æ¸¬è©¦TradingViewåˆå§‹åŒ–
                    marketPage.initializeTradingViewWidgets();
                    output.textContent += 'âœ… TradingView åˆå§‹åŒ–èª¿ç”¨æˆåŠŸ\n';
                    
                    // æª¢æŸ¥å®¹å™¨æ˜¯å¦æœ‰å…§å®¹
                    setTimeout(() => {
                        let hasContent = false;
                        widgetIds.forEach(id => {
                            const container = document.getElementById(id);
                            if (container && container.children.length > 0) {
                                hasContent = true;
                            }
                        });
                        
                        if (hasContent) {
                            output.textContent += 'âœ… TradingView å®¹å™¨æœ‰å…§å®¹\n';
                        } else {
                            output.textContent += 'âŒ TradingView å®¹å™¨ç‚ºç©º\n';
                        }
                    }, 2000);
                    
                } catch (error) {
                    output.textContent += `âŒ MarketPage æ¸¬è©¦å¤±æ•—: ${error.message}\n`;
                }
            } else {
                output.textContent += 'âŒ MarketPage çµ„ä»¶æœªè¼‰å…¥\n';
            }
            
            setTimeout(() => {
                document.body.removeChild(testContainer);
            }, 3000);
        }
        
        // åŸ·è¡Œå®Œæ•´è¨ºæ–·
        async function runFullDiagnosis() {
            const output = document.getElementById('full-output');
            output.textContent = 'åŸ·è¡Œå®Œæ•´è¨ºæ–·...\n\n';
            
            output.textContent += '=== å•é¡Œç¸½çµ ===\n';
            output.textContent += '1. âŒ é‡è¤‡è¡¨é ­: HTML + CryptoCurrencyList éƒ½å‰µå»ºè¡¨é ­\n';
            output.textContent += '2. âŒ é‡è¤‡è¼‰å…¥ç‹€æ…‹: HTML + CryptoCurrencyList éƒ½æœ‰è¼‰å…¥æç¤º\n';
            output.textContent += '3. âŒ æ’åºé‚è¼¯éŒ¯èª¤: rank è¨ˆç®—æ–¹å¼ä¸æ­£ç¢º\n';
            output.textContent += '4. âŒ ç·¨è™Ÿæ¬„ä½: ç”¨æˆ¶è¦æ±‚ç§»é™¤ä½†ä»å­˜åœ¨\n';
            output.textContent += '5. âŒ åœ–æ¨™URLæ ¼å¼: cryptocurrencyliveprices.com æ ¼å¼å¯èƒ½ä¸æ­£ç¢º\n';
            output.textContent += '6. âŒ TradingViewé…ç½®: å¯èƒ½æœ‰é…ç½®æˆ–è¼‰å…¥å•é¡Œ\n\n';
            
            output.textContent += '=== ä¿®å¾©è¨ˆåŠƒ ===\n';
            output.textContent += '1. ä¿®æ”¹ CryptoCurrencyList: ç§»é™¤è‡ªå»ºè¡¨é ­å’Œè¼‰å…¥ç‹€æ…‹\n';
            output.textContent += '2. ä¿®æ­£æ’åºé‚è¼¯: ä½¿ç”¨æ­£ç¢ºçš„æ’åè¨ˆç®—\n';
            output.textContent += '3. ç§»é™¤ç·¨è™Ÿæ¬„ä½: å¾HTMLå’Œçµ„ä»¶ä¸­å®Œå…¨ç§»é™¤\n';
            output.textContent += '4. ä¿®å¾©åœ–æ¨™URL: èª¿æ•´ç‚ºæ­£ç¢ºæ ¼å¼\n';
            output.textContent += '5. ä¿®å¾©TradingView: æª¢æŸ¥é…ç½®å’Œè¼‰å…¥é‚è¼¯\n';
        }
        
        // è‡ªå‹•åŸ·è¡ŒåŸºç¤è¨ºæ–·
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(runFullDiagnosis, 1000);
        });
    </script>
</body>
</html>