<!DOCTYPE html>
<html>
<head>
    <title>登入狀態除錯</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .info { background: #d1ecf1; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>🔍 登入狀態除錯</h1>
    
    <div class="section">
        <button onclick="debugLoginState()">檢查登入狀態</button>
        <button onclick="clearState()">清除狀態</button>
        <button onclick="forceUpdateUI()">強制更新 UI</button>
    </div>
    
    <div id="results"></div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `section ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
            console.log(`[${type}] ${message}`);
        }

        function debugLoginState() {
            log('<h3>📋 localStorage 內容檢查</h3>', 'info');
            
            // 檢查所有 localStorage 項目
            const token = localStorage.getItem('nexustrade_token');
            const refreshToken = localStorage.getItem('nexustrade_refresh_token');
            const user = localStorage.getItem('nexustrade_user');
            
            log(`<strong>Token:</strong> ${token ? 'exists (length: ' + token.length + ')' : 'not found'}`, token ? 'success' : 'error');
            log(`<strong>Refresh Token:</strong> ${refreshToken ? 'exists' : 'not found'}`, refreshToken ? 'success' : 'error');
            log(`<strong>User Data:</strong> ${user ? 'exists' : 'not found'}`, user ? 'success' : 'error');
            
            if (token) {
                log(`<strong>Token preview:</strong> ${token.substring(0, 50)}...`, 'info');
            }
            
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    log(`<strong>User object:</strong><pre>${JSON.stringify(userData, null, 2)}</pre>`, 'info');
                } catch (e) {
                    log(`<strong>User parse error:</strong> ${e.message}`, 'error');
                    log(`<strong>Raw user data:</strong> ${user}`, 'error');
                }
            }
            
            log('<h3>🔍 LoginModal 狀態檢查</h3>', 'info');
            
            // 檢查 LoginModal 實例
            if (window.loginModal) {
                log('✅ LoginModal 實例存在', 'success');
                
                // 檢查 authTokens
                const authTokens = window.loginModal.authTokens;
                log(`<strong>authTokens:</strong><pre>${JSON.stringify(authTokens, null, 2)}</pre>`, 'info');
                
                // 檢查 loadTokensFromStorage 方法
                const loadedTokens = window.loginModal.loadTokensFromStorage();
                log(`<strong>loadTokensFromStorage result:</strong><pre>${JSON.stringify(loadedTokens, null, 2)}</pre>`, 'info');
                
            } else {
                log('❌ LoginModal 實例不存在', 'error');
            }
            
            log('<h3>🖥️ DOM 元素檢查</h3>', 'info');
            
            const loginBtn = document.getElementById('login-btn');
            const userMenu = document.querySelector('.user-menu');
            
            log(`<strong>Login Button:</strong> ${loginBtn ? 'exists (display: ' + getComputedStyle(loginBtn).display + ')' : 'not found'}`, loginBtn ? 'success' : 'error');
            log(`<strong>User Menu:</strong> ${userMenu ? 'exists (display: ' + getComputedStyle(userMenu).display + ')' : 'not found'}`, userMenu ? 'success' : 'error');
        }

        function clearState() {
            localStorage.clear();
            log('🧹 所有 localStorage 已清除', 'success');
            window.location.reload();
        }

        function forceUpdateUI() {
            if (window.loginModal) {
                const user = localStorage.getItem('nexustrade_user');
                if (user) {
                    try {
                        const userData = JSON.parse(user);
                        log('🔄 強制更新 UI...', 'info');
                        window.loginModal.updateUIForLoggedInUser(userData);
                        log('✅ UI 更新完成', 'success');
                    } catch (e) {
                        log(`❌ 強制更新失敗: ${e.message}`, 'error');
                    }
                } else {
                    log('❌ 沒有使用者資料可更新', 'error');
                }
            } else {
                log('❌ LoginModal 實例不存在', 'error');
            }
        }

        // 頁面載入時自動檢查
        window.addEventListener('load', function() {
            log('📄 頁面載入完成，自動檢查狀態...', 'info');
            setTimeout(debugLoginState, 1000);
        });
    </script>
</body>
</html>