<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PriceAlertModal èª¿è©¦</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #1a1d29; color: white; }
    .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #2d3748; border-radius: 5px; }
    button { padding: 10px 15px; margin: 5px; cursor: pointer; background: #3182ce; color: white; border: none; border-radius: 4px; }
    .status { margin: 10px 0; padding: 10px; background: #2d3748; border-radius: 3px; }
    pre { background: #2d3748; padding: 10px; border-radius: 3px; overflow-x: auto; }
    .success { background: #38a169; }
    .error { background: #e53e3e; }
    .warning { background: #ffa500; }
  </style>
</head>
<body>
  <h1>ğŸ”§ PriceAlertModal èª¿è©¦å·¥å…·</h1>
  
  <div class="debug-section">
    <h2>æ­¥é©Ÿ 1: æª¢æŸ¥ç€è¦½å™¨ç‹€æ…‹</h2>
    <button onclick="checkBrowserState()">æª¢æŸ¥ç€è¦½å™¨ç‹€æ…‹</button>
    <div id="browser-status" class="status"></div>
    <pre id="browser-details"></pre>
  </div>
  
  <div class="debug-section">
    <h2>æ­¥é©Ÿ 2: æ¸¬è©¦ LINE ç‹€æ…‹ API</h2>
    <button onclick="testLineStatusAPI()">æ¸¬è©¦ LINE ç‹€æ…‹ API</button>
    <div id="api-status" class="status"></div>
    <pre id="api-details"></pre>
  </div>
  
  <div class="debug-section">
    <h2>æ­¥é©Ÿ 3: æ¨¡æ“¬ç™»å…¥ç‹€æ…‹</h2>
    <button onclick="simulateLogin()">æ¨¡æ“¬ç™»å…¥</button>
    <button onclick="clearLoginState()">æ¸…é™¤ç™»å…¥ç‹€æ…‹</button>
    <div id="login-status" class="status"></div>
  </div>
  
  <div class="debug-section">
    <h2>æ­¥é©Ÿ 4: æ¸¬è©¦ PriceAlertModal</h2>
    <button onclick="testPriceAlertModal()">æ¸¬è©¦ PriceAlertModal LINE æª¢æŸ¥</button>
    <div id="modal-status" class="status"></div>
    <pre id="modal-details"></pre>
  </div>

  <script>
    function checkBrowserState() {
      const status = document.getElementById('browser-status');
      const details = document.getElementById('browser-details');
      
      const browserState = {
        hasWindowCurrentUser: !!window.currentUser,
        currentUser: window.currentUser,
        localStorageToken: localStorage.getItem('nexustrade_token'),
        localStorageUser: localStorage.getItem('nexustrade_user'),
        sessionStorageToken: sessionStorage.getItem('nexustrade_token'),
        sessionStorageUser: sessionStorage.getItem('nexustrade_user'),
        hostname: window.location.hostname,
        pathname: window.location.pathname
      };
      
      const hasAuth = browserState.localStorageToken || browserState.sessionStorageToken;
      const hasUser = browserState.localStorageUser || browserState.sessionStorageUser || browserState.currentUser;
      
      status.innerHTML = `èªè­‰ç‹€æ…‹: ${hasAuth ? 'âœ… æœ‰ Token' : 'âŒ ç„¡ Token'} | ä½¿ç”¨è€…ç‹€æ…‹: ${hasUser ? 'âœ… æœ‰ä½¿ç”¨è€…è³‡æ–™' : 'âŒ ç„¡ä½¿ç”¨è€…è³‡æ–™'}`;
      status.className = `status ${hasAuth && hasUser ? 'success' : 'error'}`;
      
      details.textContent = JSON.stringify(browserState, null, 2);
    }

    async function testLineStatusAPI() {
      const status = document.getElementById('api-status');
      const details = document.getElementById('api-details');
      
      status.innerHTML = 'æ­£åœ¨æ¸¬è©¦ API...';
      
      try {
        const token = localStorage.getItem('nexustrade_token') || sessionStorage.getItem('nexustrade_token');
        
        if (!token) {
          throw new Error('æ²’æœ‰æ‰¾åˆ°èªè­‰ token');
        }
        
        const response = await fetch('/api/line/bind/status', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (response.ok) {
          const isConnected = data.data?.isBound;
          status.innerHTML = `API å›æ‡‰: ${response.status} | LINE ç‹€æ…‹: ${isConnected ? 'âœ… å·²é€£çµ' : 'âŒ æœªé€£çµ'}`;
          status.className = `status ${isConnected ? 'success' : 'warning'}`;
        } else {
          status.innerHTML = `API éŒ¯èª¤: ${response.status} - ${data.message}`;
          status.className = 'status error';
        }
        
        details.textContent = JSON.stringify(data, null, 2);
        
      } catch (error) {
        status.innerHTML = `æ¸¬è©¦å¤±æ•—: ${error.message}`;
        status.className = 'status error';
        details.textContent = error.stack;
      }
    }

    function simulateLogin() {
      const status = document.getElementById('login-status');
      
      // ä½¿ç”¨æˆ‘å€‘çŸ¥é“æœ‰æ•ˆçš„æ¸¬è©¦è³‡æ–™
      const testToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2NzZlZDZhNzE5MWFjMTBlMzEwOWQzMTMiLCJpYXQiOjE3NTExNDMzNDEsImV4cCI6MTc1MTc0ODE0MX0.cgRgbJ8DMqUK9I8KU6Qf-TZMhwJk5KSgAFLHE9cNzPY';
      const testUser = {
        _id: '676ed6a7191ac10e3109d313',
        id: '676ed6a7191ac10e3109d313',
        email: 'test@nexustrade.com',
        profile: {
          displayName: 'Test User'
        },
        lineId: 'U1234567890abcdef1234567890abcdef'
      };
      
      // è¨­å®šå„ç¨®å¯èƒ½çš„ç‹€æ…‹
      localStorage.setItem('nexustrade_token', testToken);
      localStorage.setItem('nexustrade_user', JSON.stringify(testUser));
      window.currentUser = testUser;
      
      status.innerHTML = 'âœ… å·²æ¨¡æ“¬ç™»å…¥ç‹€æ…‹';
      status.className = 'status success';
    }

    function clearLoginState() {
      const status = document.getElementById('login-status');
      
      localStorage.removeItem('nexustrade_token');
      localStorage.removeItem('nexustrade_user');
      sessionStorage.removeItem('nexustrade_token');
      sessionStorage.removeItem('nexustrade_user');
      delete window.currentUser;
      
      status.innerHTML = 'ğŸ—‘ï¸ å·²æ¸…é™¤ç™»å…¥ç‹€æ…‹';
      status.className = 'status';
    }

    async function testPriceAlertModal() {
      const status = document.getElementById('modal-status');
      const details = document.getElementById('modal-details');
      
      status.innerHTML = 'æ­£åœ¨æ¸¬è©¦ PriceAlertModal é‚è¼¯...';
      
      try {
        // æ¨¡æ“¬ PriceAlertModal çš„æª¢æŸ¥é‚è¼¯
        const checkLineConnectionStatus = async () => {
          const results = {
            step1_token: null,
            step2_user: null,
            step3_api_call: null,
            step4_final_result: false
          };
          
          // æ­¥é©Ÿ 1: æª¢æŸ¥ token
          const token = localStorage.getItem('nexustrade_token') || sessionStorage.getItem('nexustrade_token');
          results.step1_token = {
            found: !!token,
            token: token ? token.substring(0, 20) + '...' : null
          };
          
          if (!token) {
            results.step4_final_result = false;
            return results;
          }
          
          // æ­¥é©Ÿ 2: æª¢æŸ¥ä½¿ç”¨è€…
          const getCurrentUser = () => {
            if (window.currentUser) {
              return window.currentUser;
            }
            const userStr = localStorage.getItem('nexustrade_user') || sessionStorage.getItem('nexustrade_user');
            return userStr ? JSON.parse(userStr) : null;
          };
          
          const currentUser = getCurrentUser();
          const userId = currentUser?.id || currentUser?._id;
          results.step2_user = {
            found: !!currentUser,
            hasUserId: !!userId,
            user: currentUser ? {
              id: userId,
              email: currentUser.email,
              hasLineId: !!currentUser.lineId
            } : null
          };
          
          if (!currentUser || !userId) {
            results.step4_final_result = false;
            return results;
          }
          
          // æ­¥é©Ÿ 3: API èª¿ç”¨
          const response = await fetch('/api/line/bind/status', {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            results.step3_api_call = {
              status: response.status,
              success: true,
              data: data
            };
            results.step4_final_result = data.data?.isBound || false;
          } else {
            const data = await response.json().catch(() => ({}));
            results.step3_api_call = {
              status: response.status,
              success: false,
              error: data.message || 'æœªçŸ¥éŒ¯èª¤'
            };
            results.step4_final_result = false;
          }
          
          return results;
        };
        
        const results = await checkLineConnectionStatus();
        
        const finalResult = results.step4_final_result;
        status.innerHTML = `PriceAlertModal æª¢æŸ¥çµæœ: ${finalResult ? 'âœ… æœƒé¡¯ç¤ºå·²é€£çµ' : 'âŒ æœƒé¡¯ç¤ºéœ€è¦é€£çµ'}`;
        status.className = `status ${finalResult ? 'success' : 'error'}`;
        
        details.textContent = JSON.stringify(results, null, 2);
        
      } catch (error) {
        status.innerHTML = `æ¸¬è©¦å¤±æ•—: ${error.message}`;
        status.className = 'status error';
        details.textContent = error.stack;
      }
    }

    // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
    window.addEventListener('load', () => {
      checkBrowserState();
    });
  </script>
</body>
</html>