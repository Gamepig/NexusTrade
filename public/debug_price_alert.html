<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PriceAlertModal 調試</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #1a1d29; color: white; }
    .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #2d3748; border-radius: 5px; }
    button { padding: 10px 15px; margin: 5px; cursor: pointer; background: #3182ce; color: white; border: none; border-radius: 4px; }
    .status { margin: 10px 0; padding: 10px; background: #2d3748; border-radius: 3px; }
    pre { background: #2d3748; padding: 10px; border-radius: 3px; overflow-x: auto; }
    .success { background: #38a169; }
    .error { background: #e53e3e; }
    .warning { background: #ffa500; }
  </style>
</head>
<body>
  <h1>🔧 PriceAlertModal 調試工具</h1>
  
  <div class="debug-section">
    <h2>步驟 1: 檢查瀏覽器狀態</h2>
    <button onclick="checkBrowserState()">檢查瀏覽器狀態</button>
    <div id="browser-status" class="status"></div>
    <pre id="browser-details"></pre>
  </div>
  
  <div class="debug-section">
    <h2>步驟 2: 測試 LINE 狀態 API</h2>
    <button onclick="testLineStatusAPI()">測試 LINE 狀態 API</button>
    <div id="api-status" class="status"></div>
    <pre id="api-details"></pre>
  </div>
  
  <div class="debug-section">
    <h2>步驟 3: 模擬登入狀態</h2>
    <button onclick="simulateLogin()">模擬登入</button>
    <button onclick="clearLoginState()">清除登入狀態</button>
    <div id="login-status" class="status"></div>
  </div>
  
  <div class="debug-section">
    <h2>步驟 4: 測試 PriceAlertModal</h2>
    <button onclick="testPriceAlertModal()">測試 PriceAlertModal LINE 檢查</button>
    <div id="modal-status" class="status"></div>
    <pre id="modal-details"></pre>
  </div>

  <script>
    function checkBrowserState() {
      const status = document.getElementById('browser-status');
      const details = document.getElementById('browser-details');
      
      const browserState = {
        hasWindowCurrentUser: !!window.currentUser,
        currentUser: window.currentUser,
        localStorageToken: localStorage.getItem('nexustrade_token'),
        localStorageUser: localStorage.getItem('nexustrade_user'),
        sessionStorageToken: sessionStorage.getItem('nexustrade_token'),
        sessionStorageUser: sessionStorage.getItem('nexustrade_user'),
        hostname: window.location.hostname,
        pathname: window.location.pathname
      };
      
      const hasAuth = browserState.localStorageToken || browserState.sessionStorageToken;
      const hasUser = browserState.localStorageUser || browserState.sessionStorageUser || browserState.currentUser;
      
      status.innerHTML = `認證狀態: ${hasAuth ? '✅ 有 Token' : '❌ 無 Token'} | 使用者狀態: ${hasUser ? '✅ 有使用者資料' : '❌ 無使用者資料'}`;
      status.className = `status ${hasAuth && hasUser ? 'success' : 'error'}`;
      
      details.textContent = JSON.stringify(browserState, null, 2);
    }

    async function testLineStatusAPI() {
      const status = document.getElementById('api-status');
      const details = document.getElementById('api-details');
      
      status.innerHTML = '正在測試 API...';
      
      try {
        const token = localStorage.getItem('nexustrade_token') || sessionStorage.getItem('nexustrade_token');
        
        if (!token) {
          throw new Error('沒有找到認證 token');
        }
        
        const response = await fetch('/api/line/bind/status', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (response.ok) {
          const isConnected = data.data?.isBound;
          status.innerHTML = `API 回應: ${response.status} | LINE 狀態: ${isConnected ? '✅ 已連結' : '❌ 未連結'}`;
          status.className = `status ${isConnected ? 'success' : 'warning'}`;
        } else {
          status.innerHTML = `API 錯誤: ${response.status} - ${data.message}`;
          status.className = 'status error';
        }
        
        details.textContent = JSON.stringify(data, null, 2);
        
      } catch (error) {
        status.innerHTML = `測試失敗: ${error.message}`;
        status.className = 'status error';
        details.textContent = error.stack;
      }
    }

    function simulateLogin() {
      const status = document.getElementById('login-status');
      
      // 使用我們知道有效的測試資料
      const testToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2NzZlZDZhNzE5MWFjMTBlMzEwOWQzMTMiLCJpYXQiOjE3NTExNDMzNDEsImV4cCI6MTc1MTc0ODE0MX0.cgRgbJ8DMqUK9I8KU6Qf-TZMhwJk5KSgAFLHE9cNzPY';
      const testUser = {
        _id: '676ed6a7191ac10e3109d313',
        id: '676ed6a7191ac10e3109d313',
        email: 'test@nexustrade.com',
        profile: {
          displayName: 'Test User'
        },
        lineId: 'U1234567890abcdef1234567890abcdef'
      };
      
      // 設定各種可能的狀態
      localStorage.setItem('nexustrade_token', testToken);
      localStorage.setItem('nexustrade_user', JSON.stringify(testUser));
      window.currentUser = testUser;
      
      status.innerHTML = '✅ 已模擬登入狀態';
      status.className = 'status success';
    }

    function clearLoginState() {
      const status = document.getElementById('login-status');
      
      localStorage.removeItem('nexustrade_token');
      localStorage.removeItem('nexustrade_user');
      sessionStorage.removeItem('nexustrade_token');
      sessionStorage.removeItem('nexustrade_user');
      delete window.currentUser;
      
      status.innerHTML = '🗑️ 已清除登入狀態';
      status.className = 'status';
    }

    async function testPriceAlertModal() {
      const status = document.getElementById('modal-status');
      const details = document.getElementById('modal-details');
      
      status.innerHTML = '正在測試 PriceAlertModal 邏輯...';
      
      try {
        // 模擬 PriceAlertModal 的檢查邏輯
        const checkLineConnectionStatus = async () => {
          const results = {
            step1_token: null,
            step2_user: null,
            step3_api_call: null,
            step4_final_result: false
          };
          
          // 步驟 1: 檢查 token
          const token = localStorage.getItem('nexustrade_token') || sessionStorage.getItem('nexustrade_token');
          results.step1_token = {
            found: !!token,
            token: token ? token.substring(0, 20) + '...' : null
          };
          
          if (!token) {
            results.step4_final_result = false;
            return results;
          }
          
          // 步驟 2: 檢查使用者
          const getCurrentUser = () => {
            if (window.currentUser) {
              return window.currentUser;
            }
            const userStr = localStorage.getItem('nexustrade_user') || sessionStorage.getItem('nexustrade_user');
            return userStr ? JSON.parse(userStr) : null;
          };
          
          const currentUser = getCurrentUser();
          const userId = currentUser?.id || currentUser?._id;
          results.step2_user = {
            found: !!currentUser,
            hasUserId: !!userId,
            user: currentUser ? {
              id: userId,
              email: currentUser.email,
              hasLineId: !!currentUser.lineId
            } : null
          };
          
          if (!currentUser || !userId) {
            results.step4_final_result = false;
            return results;
          }
          
          // 步驟 3: API 調用
          const response = await fetch('/api/line/bind/status', {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            results.step3_api_call = {
              status: response.status,
              success: true,
              data: data
            };
            results.step4_final_result = data.data?.isBound || false;
          } else {
            const data = await response.json().catch(() => ({}));
            results.step3_api_call = {
              status: response.status,
              success: false,
              error: data.message || '未知錯誤'
            };
            results.step4_final_result = false;
          }
          
          return results;
        };
        
        const results = await checkLineConnectionStatus();
        
        const finalResult = results.step4_final_result;
        status.innerHTML = `PriceAlertModal 檢查結果: ${finalResult ? '✅ 會顯示已連結' : '❌ 會顯示需要連結'}`;
        status.className = `status ${finalResult ? 'success' : 'error'}`;
        
        details.textContent = JSON.stringify(results, null, 2);
        
      } catch (error) {
        status.innerHTML = `測試失敗: ${error.message}`;
        status.className = 'status error';
        details.textContent = error.stack;
      }
    }

    // 頁面載入時自動檢查
    window.addEventListener('load', () => {
      checkBrowserState();
    });
  </script>
</body>
</html>