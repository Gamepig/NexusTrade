<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusTrade é€šçŸ¥ç³»çµ±æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: #ffffff;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #2a2a2a;
        }
        .test-button {
            margin: 5px;
            padding: 10px 20px;
            background: #f7931a;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #e8830f;
        }
        .test-button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .auth-button {
            background: #00b900;
        }
        .auth-button:hover {
            background: #009900;
        }
        .delete-button {
            background: #ef4444;
        }
        .delete-button:hover {
            background: #dc2626;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #0f0f0f;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            border-left: 4px solid #10b981;
        }
        .error {
            border-left: 4px solid #ef4444;
        }
        .info {
            border-left: 4px solid #3b82f6;
        }
        .warning {
            border-left: 4px solid #f59e0b;
        }
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            background: #333;
            border: 1px solid #555;
            border-radius: 4px;
            color: white;
            box-sizing: border-box;
        }
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .alert-card {
            background: #333;
            padding: 15px;
            border-radius: 6px;
            border-left: 3px solid #f7931a;
            margin: 10px 0;
        }
        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .alert-symbol {
            font-weight: bold;
            font-size: 16px;
        }
        .alert-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-active {
            background: #10b981;
            color: white;
        }
        .status-triggered {
            background: #ef4444;
            color: white;
        }
        .status-paused {
            background: #f59e0b;
            color: white;
        }
        .token-input {
            margin: 10px 0;
            padding: 10px;
            background: #333;
            border: 1px solid #555;
            border-radius: 4px;
        }
        .token-display {
            background: #111;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            word-break: break-all;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”” NexusTrade é€šçŸ¥ç³»çµ±æ¸¬è©¦</h1>
    
    <!-- èªè­‰æ¸¬è©¦ -->
    <div class="test-section">
        <h2>1. ä½¿ç”¨è€…èªè­‰</h2>
        <p>å…ˆç™»å…¥ä»¥å–å¾— JWT Tokenï¼Œæ‰èƒ½æ¸¬è©¦éœ€è¦èªè­‰çš„åŠŸèƒ½ï¼š</p>
        <div>
            <button class="test-button auth-button" onclick="loginTestUser()">ç™»å…¥æ¸¬è©¦å¸³æˆ¶</button>
            <button class="test-button" onclick="clearAuth()">æ¸…é™¤èªè­‰</button>
        </div>
        <div class="token-input">
            <label for="manual-token">æˆ–æ‰‹å‹•è¼¸å…¥ JWT Token:</label>
            <input type="text" id="manual-token" placeholder="è²¼ä¸Šæ‚¨çš„ JWT Token">
            <button class="test-button" onclick="setManualToken()">è¨­å®š Token</button>
        </div>
        <div class="token-display" id="current-token-display">å°šæœªèªè­‰</div>
        <div id="auth-test-result" class="result info">æº–å‚™é€²è¡Œèªè­‰æ¸¬è©¦</div>
    </div>

    <!-- é€šçŸ¥ç³»çµ±ç‹€æ…‹ -->
    <div class="test-section">
        <h2>2. é€šçŸ¥ç³»çµ±ç‹€æ…‹</h2>
        <div>
            <button class="test-button" onclick="getNotificationStatus()">æª¢æŸ¥ç³»çµ±ç‹€æ…‹</button>
            <button class="test-button" onclick="sendTestNotification()">ç™¼é€æ¸¬è©¦é€šçŸ¥</button>
        </div>
        <div id="status-test-result" class="result info">æº–å‚™æª¢æŸ¥é€šçŸ¥ç³»çµ±ç‹€æ…‹</div>
    </div>

    <!-- LINE Notify æ•´åˆ -->
    <div class="test-section">
        <h2>3. LINE Notify æ•´åˆ</h2>
        <div>
            <button class="test-button auth-button" onclick="getLineNotifyAuthUrl()">å–å¾— LINE Notify æˆæ¬Šé€£çµ</button>
            <button class="test-button" onclick="testLineNotifyToken()">æ¸¬è©¦ LINE Notify Token</button>
        </div>
        <div class="form-group">
            <label for="line-token">LINE Notify Token:</label>
            <input type="text" id="line-token" placeholder="è¼¸å…¥æ‚¨çš„ LINE Notify Token">
        </div>
        <div id="line-notify-result" class="result info">æº–å‚™æ¸¬è©¦ LINE Notify æ•´åˆ</div>
    </div>

    <!-- åƒ¹æ ¼è­¦å ±ç®¡ç† -->
    <div class="test-section">
        <h2>4. åƒ¹æ ¼è­¦å ±ç®¡ç†</h2>
        
        <!-- å»ºç«‹è­¦å ±è¡¨å–® -->
        <h3>å»ºç«‹æ–°è­¦å ±</h3>
        <div class="form-row">
            <div class="form-group">
                <label for="alert-symbol">äº¤æ˜“å°:</label>
                <input type="text" id="alert-symbol" placeholder="ä¾‹å¦‚: BTCUSDT" value="BTCUSDT">
            </div>
            <div class="form-group">
                <label for="alert-type">è­¦å ±é¡å‹:</label>
                <select id="alert-type" onchange="toggleAlertFields()">
                    <option value="price_above">åƒ¹æ ¼çªç ´</option>
                    <option value="price_below">åƒ¹æ ¼è·Œç ´</option>
                    <option value="percent_change">ç™¾åˆ†æ¯”è®ŠåŒ–</option>
                    <option value="volume_spike">æˆäº¤é‡æ¿€å¢</option>
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group" id="target-price-group">
                <label for="target-price">ç›®æ¨™åƒ¹æ ¼:</label>
                <input type="number" id="target-price" placeholder="ä¾‹å¦‚: 50000" step="0.01">
            </div>
            <div class="form-group" id="percent-change-group" style="display: none;">
                <label for="percent-change">ç™¾åˆ†æ¯”è®ŠåŒ–:</label>
                <input type="number" id="percent-change" placeholder="ä¾‹å¦‚: 5" step="0.1">
            </div>
            <div class="form-group" id="volume-multiplier-group" style="display: none;">
                <label for="volume-multiplier">æˆäº¤é‡å€æ•¸:</label>
                <input type="number" id="volume-multiplier" placeholder="ä¾‹å¦‚: 2" step="0.1" min="1">
            </div>
            <div class="form-group">
                <label for="alert-priority">å„ªå…ˆç´š:</label>
                <select id="alert-priority">
                    <option value="low">ä½</option>
                    <option value="medium" selected>ä¸­</option>
                    <option value="high">é«˜</option>
                    <option value="critical">ç·Šæ€¥</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" id="enable-line-notify"> å•Ÿç”¨ LINE Notify é€šçŸ¥
            </label>
        </div>

        <div class="form-group">
            <label for="alert-note">å‚™è¨»:</label>
            <textarea id="alert-note" placeholder="é¸å¡«ï¼šè­¦å ±å‚™è¨»"></textarea>
        </div>

        <div>
            <button class="test-button" onclick="createPriceAlert()">å»ºç«‹åƒ¹æ ¼è­¦å ±</button>
            <button class="test-button" onclick="getUserAlerts()">å–å¾—æˆ‘çš„è­¦å ±</button>
            <button class="test-button" onclick="getAlertStats()">å–å¾—è­¦å ±çµ±è¨ˆ</button>
        </div>
        
        <div id="alert-management-result" class="result info">æº–å‚™ç®¡ç†åƒ¹æ ¼è­¦å ±</div>
    </div>

    <!-- è­¦å ±åˆ—è¡¨ -->
    <div class="test-section">
        <h2>5. æˆ‘çš„è­¦å ±åˆ—è¡¨</h2>
        <div>
            <button class="test-button" onclick="refreshAlerts()">åˆ·æ–°è­¦å ±åˆ—è¡¨</button>
            <button class="test-button delete-button" onclick="clearAllAlerts()">æ¸…é™¤æ‰€æœ‰è­¦å ±</button>
        </div>
        <div id="alert-list-container"></div>
        <div id="alert-list-result" class="result info">è­¦å ±åˆ—è¡¨å°‡é¡¯ç¤ºåœ¨ä¸Šæ–¹</div>
    </div>

    <!-- å¸‚å ´æ›´æ–°é€šçŸ¥ -->
    <div class="test-section">
        <h2>6. å¸‚å ´æ›´æ–°é€šçŸ¥</h2>
        <div>
            <button class="test-button" onclick="sendMarketUpdate()">ç™¼é€å¸‚å ´æ—¥å ±</button>
        </div>
        <div id="market-update-result" class="result info">æº–å‚™ç™¼é€å¸‚å ´æ›´æ–°é€šçŸ¥</div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentToken = null;
        let currentAlerts = [];

        // API åŸºç¤ URL
        const API_BASE = window.location.origin;

        // æ›´æ–°çµæœé¡¯ç¤º
        function updateResult(elementId, text, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = new Date().toLocaleTimeString() + ' - ' + text;
            element.className = `result ${type}`;
        }

        // æ›´æ–° Token é¡¯ç¤º
        function updateTokenDisplay() {
            const display = document.getElementById('current-token-display');
            if (currentToken) {
                display.textContent = `JWT Token: ${currentToken.substring(0, 50)}...`;
            } else {
                display.textContent = 'å°šæœªèªè­‰';
            }
        }

        // é€šç”¨ API è«‹æ±‚å‡½æ•¸
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            };

            if (currentToken && !options.skipAuth) {
                config.headers['Authorization'] = `Bearer ${currentToken}`;
            }

            try {
                const response = await fetch(url, config);
                const data = await response.json();
                
                return {
                    ok: response.ok,
                    status: response.status,
                    data
                };
            } catch (error) {
                return {
                    ok: false,
                    status: 0,
                    data: { message: error.message }
                };
            }
        }

        // ç™»å…¥æ¸¬è©¦å¸³æˆ¶
        async function loginTestUser() {
            updateResult('auth-test-result', 'æ­£åœ¨ç™»å…¥æ¸¬è©¦å¸³æˆ¶...', 'info');
            
            const result = await apiRequest('/auth/login', {
                method: 'POST',
                skipAuth: true,
                body: JSON.stringify({
                    email: 'test@example.com',
                    password: 'testpassword123'
                })
            });

            if (result.ok) {
                currentToken = result.data.data.token;
                updateTokenDisplay();
                updateResult('auth-test-result', `ç™»å…¥æˆåŠŸï¼ä½¿ç”¨è€…: ${result.data.data.user.email}`, 'success');
            } else {
                // å˜—è©¦è¨»å†Š
                const registerResult = await apiRequest('/auth/register', {
                    method: 'POST',
                    skipAuth: true,
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'testpassword123',
                        username: 'testuser',
                        firstName: 'Test',
                        lastName: 'User'
                    })
                });

                if (registerResult.ok) {
                    currentToken = registerResult.data.data.token;
                    updateTokenDisplay();
                    updateResult('auth-test-result', 'è¨»å†Šä¸¦ç™»å…¥æˆåŠŸï¼', 'success');
                } else {
                    updateResult('auth-test-result', `ç™»å…¥å¤±æ•—: ${result.data.message}`, 'error');
                }
            }
        }

        // è¨­å®šæ‰‹å‹•è¼¸å…¥çš„ Token
        function setManualToken() {
            const token = document.getElementById('manual-token').value.trim();
            if (token) {
                currentToken = token;
                updateTokenDisplay();
                updateResult('auth-test-result', 'JWT Token å·²è¨­å®š', 'success');
            } else {
                updateResult('auth-test-result', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„ JWT Token', 'error');
            }
        }

        // æ¸…é™¤èªè­‰
        function clearAuth() {
            currentToken = null;
            updateTokenDisplay();
            document.getElementById('manual-token').value = '';
            updateResult('auth-test-result', 'èªè­‰å·²æ¸…é™¤', 'info');
        }

        // æª¢æŸ¥é€šçŸ¥ç³»çµ±ç‹€æ…‹
        async function getNotificationStatus() {
            updateResult('status-test-result', 'æ­£åœ¨æª¢æŸ¥é€šçŸ¥ç³»çµ±ç‹€æ…‹...', 'info');
            
            const result = await apiRequest('/api/notifications/status', {
                method: 'GET',
                skipAuth: true
            });

            if (result.ok) {
                updateResult('status-test-result', 
                    `é€šçŸ¥ç³»çµ±ç‹€æ…‹ï¼š\n` +
                    `LINE Notify é…ç½®: ${result.data.data.lineNotify.configured ? 'âœ…' : 'âŒ'}\n` +
                    `OAuth é…ç½®: ${result.data.data.lineNotify.oAuthConfigured ? 'âœ…' : 'âŒ'}\n` +
                    `æ”¯æ´æœå‹™: ${Object.keys(result.data.data.services).join(', ')}\n` +
                    `æ”¯æ´æ–¹å¼: ${result.data.data.supportedMethods.join(', ')}`, 'success');
            } else {
                updateResult('status-test-result', `æª¢æŸ¥å¤±æ•—: ${result.data.message}`, 'error');
            }
        }

        // ç™¼é€æ¸¬è©¦é€šçŸ¥
        async function sendTestNotification() {
            const lineToken = document.getElementById('line-token').value.trim();
            
            updateResult('status-test-result', 'æ­£åœ¨ç™¼é€æ¸¬è©¦é€šçŸ¥...', 'info');
            
            const result = await apiRequest('/api/notifications/test', {
                method: 'POST',
                skipAuth: true,
                body: JSON.stringify({
                    method: 'line_notify',
                    token: lineToken || undefined
                })
            });

            if (result.ok) {
                updateResult('status-test-result', 'æ¸¬è©¦é€šçŸ¥ç™¼é€æˆåŠŸï¼', 'success');
            } else {
                updateResult('status-test-result', `æ¸¬è©¦é€šçŸ¥ç™¼é€å¤±æ•—: ${result.data.message}`, 'error');
            }
        }

        // å–å¾— LINE Notify æˆæ¬Šé€£çµ
        async function getLineNotifyAuthUrl() {
            updateResult('line-notify-result', 'æ­£åœ¨å–å¾— LINE Notify æˆæ¬Šé€£çµ...', 'info');
            
            const result = await apiRequest('/api/notifications/line-notify/auth-url', {
                method: 'GET',
                skipAuth: true
            });

            if (result.ok) {
                const authUrl = result.data.data.authUrl;
                updateResult('line-notify-result', 
                    `LINE Notify æˆæ¬Šé€£çµå·²å–å¾—ï¼\né»æ“Šé€£çµå®Œæˆæˆæ¬Šï¼š\n${authUrl}`, 'success');
                
                // è‡ªå‹•é–‹å•Ÿæˆæ¬Šé€£çµ
                window.open(authUrl, '_blank');
            } else {
                updateResult('line-notify-result', `å–å¾—æˆæ¬Šé€£çµå¤±æ•—: ${result.data.message}`, 'error');
            }
        }

        // æ¸¬è©¦ LINE Notify Token
        async function testLineNotifyToken() {
            const lineToken = document.getElementById('line-token').value.trim();
            
            if (!lineToken) {
                updateResult('line-notify-result', 'è«‹å…ˆè¼¸å…¥ LINE Notify Token', 'error');
                return;
            }
            
            updateResult('line-notify-result', 'æ­£åœ¨æ¸¬è©¦ LINE Notify Token...', 'info');
            
            const result = await apiRequest('/api/notifications/test', {
                method: 'POST',
                skipAuth: true,
                body: JSON.stringify({
                    method: 'line_notify',
                    token: lineToken
                })
            });

            if (result.ok) {
                updateResult('line-notify-result', 'LINE Notify Token æ¸¬è©¦æˆåŠŸï¼', 'success');
            } else {
                updateResult('line-notify-result', `Token æ¸¬è©¦å¤±æ•—: ${result.data.message}`, 'error');
            }
        }

        // åˆ‡æ›è­¦å ±é¡å‹æ¬„ä½
        function toggleAlertFields() {
            const alertType = document.getElementById('alert-type').value;
            
            document.getElementById('target-price-group').style.display = 
                ['price_above', 'price_below'].includes(alertType) ? 'block' : 'none';
            
            document.getElementById('percent-change-group').style.display = 
                alertType === 'percent_change' ? 'block' : 'none';
            
            document.getElementById('volume-multiplier-group').style.display = 
                alertType === 'volume_spike' ? 'block' : 'none';
        }

        // å»ºç«‹åƒ¹æ ¼è­¦å ±
        async function createPriceAlert() {
            if (!currentToken) {
                updateResult('alert-management-result', 'è«‹å…ˆç™»å…¥', 'error');
                return;
            }

            const symbol = document.getElementById('alert-symbol').value.trim().toUpperCase();
            const alertType = document.getElementById('alert-type').value;
            const targetPrice = parseFloat(document.getElementById('target-price').value);
            const percentChange = parseFloat(document.getElementById('percent-change').value);
            const volumeMultiplier = parseFloat(document.getElementById('volume-multiplier').value);
            const priority = document.getElementById('alert-priority').value;
            const enableLineNotify = document.getElementById('enable-line-notify').checked;
            const note = document.getElementById('alert-note').value.trim();
            const lineToken = document.getElementById('line-token').value.trim();

            if (!symbol) {
                updateResult('alert-management-result', 'è«‹è¼¸å…¥äº¤æ˜“å°', 'error');
                return;
            }

            const alertData = {
                symbol,
                alertType,
                priority,
                notificationMethods: {
                    lineNotify: {
                        enabled: enableLineNotify,
                        token: enableLineNotify ? lineToken : undefined
                    }
                },
                note: note || undefined
            };

            // æ ¹æ“šè­¦å ±é¡å‹æ·»åŠ ç›¸æ‡‰åƒæ•¸
            if (['price_above', 'price_below'].includes(alertType)) {
                if (isNaN(targetPrice)) {
                    updateResult('alert-management-result', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„ç›®æ¨™åƒ¹æ ¼', 'error');
                    return;
                }
                alertData.targetPrice = targetPrice;
            } else if (alertType === 'percent_change') {
                if (isNaN(percentChange)) {
                    updateResult('alert-management-result', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„ç™¾åˆ†æ¯”è®ŠåŒ–', 'error');
                    return;
                }
                alertData.percentChange = percentChange;
            } else if (alertType === 'volume_spike') {
                if (isNaN(volumeMultiplier) || volumeMultiplier < 1) {
                    updateResult('alert-management-result', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„æˆäº¤é‡å€æ•¸ (â‰¥1)', 'error');
                    return;
                }
                alertData.volumeMultiplier = volumeMultiplier;
            }

            updateResult('alert-management-result', 'æ­£åœ¨å»ºç«‹åƒ¹æ ¼è­¦å ±...', 'info');
            
            const result = await apiRequest('/api/notifications/alerts', {
                method: 'POST',
                body: JSON.stringify(alertData)
            });

            if (result.ok) {
                updateResult('alert-management-result', 
                    `åƒ¹æ ¼è­¦å ±å»ºç«‹æˆåŠŸï¼\n` +
                    `äº¤æ˜“å°: ${result.data.data.alert.symbol}\n` +
                    `é¡å‹: ${result.data.data.alert.alertType}\n` +
                    `ç•¶å‰åƒ¹æ ¼: $${result.data.data.currentPrice}`, 'success');
                
                // åˆ·æ–°è­¦å ±åˆ—è¡¨
                refreshAlerts();
            } else {
                updateResult('alert-management-result', `å»ºç«‹è­¦å ±å¤±æ•—: ${result.data.message}`, 'error');
            }
        }

        // å–å¾—ä½¿ç”¨è€…è­¦å ±
        async function getUserAlerts() {
            if (!currentToken) {
                updateResult('alert-management-result', 'è«‹å…ˆç™»å…¥', 'error');
                return;
            }

            updateResult('alert-management-result', 'æ­£åœ¨å–å¾—è­¦å ±åˆ—è¡¨...', 'info');
            
            const result = await apiRequest('/api/notifications/alerts', {
                method: 'GET'
            });

            if (result.ok) {
                currentAlerts = result.data.data.alerts;
                updateResult('alert-management-result', 
                    `å–å¾— ${currentAlerts.length} å€‹è­¦å ±`, 'success');
                
                displayAlerts(currentAlerts);
            } else {
                updateResult('alert-management-result', `å–å¾—è­¦å ±å¤±æ•—: ${result.data.message}`, 'error');
            }
        }

        // é¡¯ç¤ºè­¦å ±åˆ—è¡¨
        function displayAlerts(alerts) {
            const container = document.getElementById('alert-list-container');
            container.innerHTML = '';

            if (alerts.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888;">æš«ç„¡è­¦å ±</p>';
                return;
            }

            alerts.forEach(alert => {
                const alertCard = document.createElement('div');
                alertCard.className = 'alert-card';
                alertCard.innerHTML = `
                    <div class="alert-header">
                        <span class="alert-symbol">${alert.symbol}</span>
                        <span class="alert-status status-${alert.status}">${getStatusText(alert.status)}</span>
                    </div>
                    <div>
                        <strong>é¡å‹:</strong> ${getAlertTypeText(alert.alertType)}<br>
                        ${getAlertTarget(alert)}<br>
                        <strong>å„ªå…ˆç´š:</strong> ${alert.priority}<br>
                        <strong>å»ºç«‹æ™‚é–“:</strong> ${new Date(alert.createdAt).toLocaleString()}<br>
                        ${alert.note ? `<strong>å‚™è¨»:</strong> ${alert.note}<br>` : ''}
                        <strong>é€šçŸ¥:</strong> LINE ${alert.notificationMethods.lineNotify?.enabled ? 'âœ…' : 'âŒ'}
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="test-button" onclick="toggleAlert('${alert._id}')">
                            ${alert.status === 'active' ? 'æš«åœ' : 'æ¢å¾©'}
                        </button>
                        <button class="test-button delete-button" onclick="deleteAlert('${alert._id}')">åˆªé™¤</button>
                    </div>
                `;
                container.appendChild(alertCard);
            });
        }

        // å–å¾—ç‹€æ…‹æ–‡å­—
        function getStatusText(status) {
            const statusMap = {
                'active': 'æ´»èº',
                'triggered': 'å·²è§¸ç™¼',
                'paused': 'å·²æš«åœ',
                'expired': 'å·²éæœŸ'
            };
            return statusMap[status] || status;
        }

        // å–å¾—è­¦å ±é¡å‹æ–‡å­—
        function getAlertTypeText(type) {
            const typeMap = {
                'price_above': 'åƒ¹æ ¼çªç ´',
                'price_below': 'åƒ¹æ ¼è·Œç ´',
                'percent_change': 'ç™¾åˆ†æ¯”è®ŠåŒ–',
                'volume_spike': 'æˆäº¤é‡æ¿€å¢'
            };
            return typeMap[type] || type;
        }

        // å–å¾—è­¦å ±ç›®æ¨™
        function getAlertTarget(alert) {
            switch (alert.alertType) {
                case 'price_above':
                case 'price_below':
                    return `<strong>ç›®æ¨™åƒ¹æ ¼:</strong> $${alert.targetPrice?.toLocaleString()}`;
                case 'percent_change':
                    return `<strong>ç™¾åˆ†æ¯”è®ŠåŒ–:</strong> ${alert.percentChange}%`;
                case 'volume_spike':
                    return `<strong>æˆäº¤é‡å€æ•¸:</strong> ${alert.volumeMultiplier}x`;
                default:
                    return '';
            }
        }

        // åˆ‡æ›è­¦å ±ç‹€æ…‹
        async function toggleAlert(alertId) {
            const result = await apiRequest(`/api/notifications/alerts/${alertId}/toggle`, {
                method: 'PATCH'
            });

            if (result.ok) {
                updateResult('alert-list-result', `è­¦å ±ç‹€æ…‹å·²æ›´æ–°`, 'success');
                refreshAlerts();
            } else {
                updateResult('alert-list-result', `æ›´æ–°å¤±æ•—: ${result.data.message}`, 'error');
            }
        }

        // åˆªé™¤è­¦å ±
        async function deleteAlert(alertId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è­¦å ±å—ï¼Ÿ')) {
                return;
            }

            const result = await apiRequest(`/api/notifications/alerts/${alertId}`, {
                method: 'DELETE'
            });

            if (result.ok) {
                updateResult('alert-list-result', `è­¦å ±å·²åˆªé™¤`, 'success');
                refreshAlerts();
            } else {
                updateResult('alert-list-result', `åˆªé™¤å¤±æ•—: ${result.data.message}`, 'error');
            }
        }

        // åˆ·æ–°è­¦å ±åˆ—è¡¨
        function refreshAlerts() {
            getUserAlerts();
        }

        // æ¸…é™¤æ‰€æœ‰è­¦å ±
        async function clearAllAlerts() {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰è­¦å ±å—ï¼Ÿé€™å€‹æ“ä½œç„¡æ³•æ’¤éŠ·ï¼')) {
                return;
            }

            updateResult('alert-list-result', 'æ­£åœ¨åˆªé™¤æ‰€æœ‰è­¦å ±...', 'info');

            let deletedCount = 0;
            for (const alert of currentAlerts) {
                try {
                    await apiRequest(`/api/notifications/alerts/${alert._id}`, {
                        method: 'DELETE'
                    });
                    deletedCount++;
                } catch (error) {
                    console.error(`åˆªé™¤è­¦å ± ${alert._id} å¤±æ•—:`, error);
                }
            }

            updateResult('alert-list-result', `å·²åˆªé™¤ ${deletedCount} å€‹è­¦å ±`, 'success');
            refreshAlerts();
        }

        // å–å¾—è­¦å ±çµ±è¨ˆ
        async function getAlertStats() {
            if (!currentToken) {
                updateResult('alert-management-result', 'è«‹å…ˆç™»å…¥', 'error');
                return;
            }

            const result = await apiRequest('/api/notifications/stats', {
                method: 'GET'
            });

            if (result.ok) {
                const stats = result.data.data.stats;
                const total = result.data.data.total;
                
                let statsText = `è­¦å ±çµ±è¨ˆ (ç¸½è¨ˆ: ${total}):\n`;
                stats.forEach(stat => {
                    statsText += `${getStatusText(stat._id)}: ${stat.count}\n`;
                });

                updateResult('alert-management-result', statsText, 'success');
            } else {
                updateResult('alert-management-result', `å–å¾—çµ±è¨ˆå¤±æ•—: ${result.data.message}`, 'error');
            }
        }

        // ç™¼é€å¸‚å ´æ›´æ–°
        async function sendMarketUpdate() {
            const lineToken = document.getElementById('line-token').value.trim();
            
            if (!lineToken) {
                updateResult('market-update-result', 'è«‹å…ˆè¨­å®š LINE Notify Token', 'error');
                return;
            }

            updateResult('market-update-result', 'æ­£åœ¨ç™¼é€å¸‚å ´æ›´æ–°...', 'info');
            
            const result = await apiRequest('/api/notifications/market-update', {
                method: 'POST',
                body: JSON.stringify({
                    recipients: [{
                        id: 'test_user',
                        token: lineToken
                    }],
                    type: 'daily'
                })
            });

            if (result.ok) {
                updateResult('market-update-result', 
                    `å¸‚å ´æ›´æ–°ç™¼é€å®Œæˆï¼\n` +
                    `æˆåŠŸ: ${result.data.data.successCount}\n` +
                    `å¤±æ•—: ${result.data.data.errorCount}`, 'success');
            } else {
                updateResult('market-update-result', `ç™¼é€å¤±æ•—: ${result.data.message}`, 'error');
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            updateTokenDisplay();
            toggleAlertFields();
            
            updateResult('auth-test-result', 'æº–å‚™é€²è¡Œèªè­‰æ¸¬è©¦');
            updateResult('status-test-result', 'æº–å‚™æª¢æŸ¥é€šçŸ¥ç³»çµ±ç‹€æ…‹');
            updateResult('line-notify-result', 'æº–å‚™æ¸¬è©¦ LINE Notify æ•´åˆ');
            updateResult('alert-management-result', 'æº–å‚™ç®¡ç†åƒ¹æ ¼è­¦å ±');
            updateResult('alert-list-result', 'è­¦å ±åˆ—è¡¨å°‡é¡¯ç¤ºåœ¨ä¸Šæ–¹');
            updateResult('market-update-result', 'æº–å‚™ç™¼é€å¸‚å ´æ›´æ–°é€šçŸ¥');
        });
    </script>
</body>
</html>