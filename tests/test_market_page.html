<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸‚å ´é é¢æ¸¬è©¦ - NexusTrade</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #0f0f0f;
            color: #ffffff;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .test-section {
            background: #1a1a1a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .test-title {
            color: #f7931a;
            font-size: 1.5em;
            margin-bottom: 15px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success { background: rgba(0, 212, 170, 0.2); border: 1px solid #00d4aa; }
        .status.error { background: rgba(255, 71, 87, 0.2); border: 1px solid #ff4757; }
        .status.info { background: rgba(247, 147, 26, 0.2); border: 1px solid #f7931a; }
        .btn {
            background: #f7931a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #e8830f; }
        .results-box {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #333;
            padding: 10px;
            margin: 10px 0;
            background: #0f0f0f;
        }
        .api-result {
            background: #2a2a2a;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 3px solid #f7931a;
        }
        .loading-indicator {
            display: none;
            text-align: center;
            padding: 20px;
            color: #f7931a;
        }
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #333;
            border-top: 2px solid #f7931a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .coin-preview {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            margin: 4px 0;
            background: #1a1a1a;
            border-radius: 4px;
            border: 1px solid #333;
        }
        .coin-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f7931a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
            color: black;
        }
        .coin-info {
            flex: 1;
        }
        .coin-symbol {
            font-weight: bold;
            color: #00d4aa;
        }
        .coin-price {
            color: #ffffff;
            font-family: monospace;
        }
        .coin-change {
            font-size: 0.9em;
        }
        .positive { color: #00d4aa; }
        .negative { color: #ff4757; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¢ å¸‚å ´é é¢åŠŸèƒ½æ¸¬è©¦</h1>
        <div id="status" class="status info">
            <strong>æ¸¬è©¦ç‹€æ…‹:</strong> æº–å‚™ä¸­...
        </div>

        <div class="test-section">
            <div class="test-title">ğŸ“¡ å¸‚å ´ API ç«¯é»æ¸¬è©¦</div>
            <button class="btn" onclick="testMarketAPIs()">æ¸¬è©¦å¸‚å ´ API</button>
            <div class="loading-indicator" id="api-loading">
                <div class="loading-spinner"></div>
                æ­£åœ¨æ¸¬è©¦ API...
            </div>
            <div id="api-results" class="results-box"></div>
        </div>

        <div class="test-section">
            <div class="test-title">ğŸ“Š æ‰¹é‡åƒ¹æ ¼æŸ¥è©¢æ¸¬è©¦</div>
            <button class="btn" onclick="testBatchPrices()">æ¸¬è©¦æ‰¹é‡åƒ¹æ ¼</button>
            <div class="loading-indicator" id="batch-loading">
                <div class="loading-spinner"></div>
                æ­£åœ¨æŸ¥è©¢åƒ¹æ ¼...
            </div>
            <div id="batch-results" class="results-box"></div>
        </div>

        <div class="test-section">
            <div class="test-title">ğŸ¨ TradingView Widget æ¸¬è©¦</div>
            <button class="btn" onclick="testTradingViewWidgets()">æ¸¬è©¦ TradingView Widget</button>
            <div id="tradingview-container" style="display: none;">
                <h4>Bitcoin (BTC/USDT) Widget æ¸¬è©¦:</h4>
                <div id="test-tradingview-widget" style="height: 300px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin: 10px 0;"></div>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">ğŸš€ å¸‚å ´é é¢å°èˆªæ¸¬è©¦</div>
            <button class="btn" onclick="navigateToMarketPage()">å‰å¾€å¸‚å ´é é¢</button>
            <div id="navigation-results"></div>
        </div>

        <div class="test-section">
            <div class="test-title">ğŸ“Š æ¸¬è©¦çµæœç¸½çµ</div>
            <div id="test-summary"></div>
        </div>
    </div>

    <script>
        let testResults = {
            marketAPI: false,
            batchPrices: false,
            tradingViewWidget: false,
            navigation: false
        };

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.innerHTML = `<strong>æ¸¬è©¦ç‹€æ…‹:</strong> ${message}`;
        }

        function updateTestSummary() {
            const passedTests = Object.values(testResults).filter(result => result === true).length;
            const totalTests = Object.keys(testResults).length;
            const summaryEl = document.getElementById('test-summary');
            
            let summaryHtml = `
                <h3>æ¸¬è©¦çµæœ: ${passedTests}/${totalTests} é€šé</h3>
                <ul>
                    <li>å¸‚å ´ API æ¸¬è©¦: ${testResults.marketAPI ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}</li>
                    <li>æ‰¹é‡åƒ¹æ ¼æ¸¬è©¦: ${testResults.batchPrices ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}</li>
                    <li>TradingView Widget: ${testResults.tradingViewWidget ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}</li>
                    <li>é é¢å°èˆªæ¸¬è©¦: ${testResults.navigation ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}</li>
                </ul>
            `;
            
            if (passedTests === totalTests) {
                summaryHtml += '<div class="status success"><strong>ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼å¸‚å ´é é¢æº–å‚™å°±ç·’ï¼</strong></div>';
            } else {
                summaryHtml += '<div class="status error"><strong>âš ï¸ éƒ¨åˆ†æ¸¬è©¦å¤±æ•—ï¼Œéœ€è¦é€²ä¸€æ­¥æª¢æŸ¥</strong></div>';
            }
            
            summaryEl.innerHTML = summaryHtml;
        }

        async function testMarketAPIs() {
            updateStatus('æ¸¬è©¦å¸‚å ´ API ç«¯é»...', 'info');
            const loadingEl = document.getElementById('api-loading');
            const resultsEl = document.getElementById('api-results');
            
            loadingEl.style.display = 'block';
            resultsEl.innerHTML = '';
            
            const apiTests = [
                { name: 'å¸‚å ´æ¦‚è¦½', url: '/api/market/overview' },
                { name: 'ç†±é–€äº¤æ˜“å°', url: '/api/market/trending?limit=5' },
                { name: 'å–®ä¸€åƒ¹æ ¼æŸ¥è©¢', url: '/api/market/price/BTCUSDT' },
                { name: '24h çµ±è¨ˆ', url: '/api/market/ticker/BTCUSDT' },
                { name: 'API å¥åº·æª¢æŸ¥', url: '/api/market/test' }
            ];

            let successCount = 0;
            
            for (const test of apiTests) {
                try {
                    const response = await fetch(test.url);
                    const data = await response.json();
                    
                    const isSuccess = response.ok && (data.status === 'success' || data.success);
                    if (isSuccess) successCount++;
                    
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'api-result';
                    resultDiv.innerHTML = `
                        <strong>${test.name}</strong> - ${isSuccess ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}
                        <br><small>URL: ${test.url}</small>
                        <br><small>å›æ‡‰: ${JSON.stringify(data).substring(0, 100)}...</small>
                    `;
                    resultsEl.appendChild(resultDiv);
                    
                } catch (error) {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'api-result';
                    resultDiv.innerHTML = `
                        <strong>${test.name}</strong> - âŒ éŒ¯èª¤
                        <br><small>éŒ¯èª¤: ${error.message}</small>
                    `;
                    resultsEl.appendChild(resultDiv);
                }
            }
            
            loadingEl.style.display = 'none';
            testResults.marketAPI = successCount >= 3; // è‡³å°‘3å€‹APIæˆåŠŸ
            updateStatus(`å¸‚å ´ API æ¸¬è©¦å®Œæˆï¼Œ${successCount}/${apiTests.length} æˆåŠŸ`, 
                        testResults.marketAPI ? 'success' : 'error');
            updateTestSummary();
        }

        async function testBatchPrices() {
            updateStatus('æ¸¬è©¦æ‰¹é‡åƒ¹æ ¼æŸ¥è©¢...', 'info');
            const loadingEl = document.getElementById('batch-loading');
            const resultsEl = document.getElementById('batch-results');
            
            loadingEl.style.display = 'block';
            resultsEl.innerHTML = '';
            
            try {
                const testSymbols = ['BTC', 'ETH', 'BNB', 'ADA', 'SOL'];
                const symbolsQuery = testSymbols.map(s => `${s}USDT`).join(',');
                const response = await fetch(`/api/market/prices?symbols=${symbolsQuery}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    resultsEl.innerHTML = '<h4>æ‰¹é‡åƒ¹æ ¼æŸ¥è©¢çµæœ:</h4>';
                    
                    data.data.forEach(coin => {
                        const coinDiv = document.createElement('div');
                        coinDiv.className = 'coin-preview';
                        
                        const changePercent = parseFloat(coin.priceChangePercent || 0);
                        const changeClass = changePercent >= 0 ? 'positive' : 'negative';
                        const changeIcon = changePercent >= 0 ? 'â–²' : 'â–¼';
                        
                        coinDiv.innerHTML = `
                            <div class="coin-icon">${coin.symbol.replace('USDT', '').substring(0, 2)}</div>
                            <div class="coin-info">
                                <div class="coin-symbol">${coin.symbol}</div>
                                <div class="coin-price">$${parseFloat(coin.price).toFixed(2)}</div>
                            </div>
                            <div class="coin-change ${changeClass}">
                                ${changeIcon} ${Math.abs(changePercent).toFixed(2)}%
                            </div>
                        `;
                        resultsEl.appendChild(coinDiv);
                    });
                    
                    testResults.batchPrices = true;
                    updateStatus('æ‰¹é‡åƒ¹æ ¼æŸ¥è©¢æ¸¬è©¦æˆåŠŸ', 'success');
                } else {
                    throw new Error(data.message || 'æ‰¹é‡åƒ¹æ ¼æŸ¥è©¢å¤±æ•—');
                }
                
            } catch (error) {
                resultsEl.innerHTML = `<div class="status error">æ‰¹é‡åƒ¹æ ¼æŸ¥è©¢å¤±æ•—: ${error.message}</div>`;
                testResults.batchPrices = false;
                updateStatus('æ‰¹é‡åƒ¹æ ¼æŸ¥è©¢æ¸¬è©¦å¤±æ•—', 'error');
            }
            
            loadingEl.style.display = 'none';
            updateTestSummary();
        }

        function testTradingViewWidgets() {
            updateStatus('æ¸¬è©¦ TradingView Widget...', 'info');
            const containerEl = document.getElementById('tradingview-container');
            const widgetEl = document.getElementById('test-tradingview-widget');
            
            containerEl.style.display = 'block';
            
            try {
                // æ¸…ç©ºå®¹å™¨
                widgetEl.innerHTML = '';
                
                // å‰µå»º TradingView Script
                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js';
                script.async = true;
                script.innerHTML = JSON.stringify({
                    "symbols": [
                        ["BINANCE:BTCUSDT|1D"]
                    ],
                    "chartOnly": false,
                    "width": "100%",
                    "height": "300",
                    "locale": "en",
                    "colorTheme": "dark",
                    "autosize": true,
                    "showVolume": true,
                    "showMA": true,
                    "hideDateRanges": false,
                    "hideMarketStatus": false,
                    "hideSymbolLogo": false,
                    "scalePosition": "right",
                    "scaleMode": "Normal",
                    "fontFamily": "-apple-system, BlinkMacSystemFont, Trebuchet MS, Roboto, Ubuntu, sans-serif",
                    "fontSize": "10",
                    "noTimeScale": false,
                    "valuesTracking": "1",
                    "changeMode": "price-and-percent",
                    "chartType": "area"
                });
                
                widgetEl.appendChild(script);
                
                // æª¢æŸ¥è¼‰å…¥ç‹€æ…‹
                setTimeout(() => {
                    const hasContent = widgetEl.querySelector('iframe') || widgetEl.children.length > 1;
                    testResults.tradingViewWidget = hasContent;
                    updateStatus('TradingView Widget ' + (hasContent ? 'è¼‰å…¥æˆåŠŸ' : 'è¼‰å…¥å¤±æ•—'), 
                                hasContent ? 'success' : 'error');
                    updateTestSummary();
                }, 3000);
                
            } catch (error) {
                testResults.tradingViewWidget = false;
                updateStatus('TradingView Widget æ¸¬è©¦å¤±æ•—', 'error');
                updateTestSummary();
            }
        }

        function navigateToMarketPage() {
            updateStatus('æ¸¬è©¦å¸‚å ´é é¢å°èˆª...', 'info');
            const resultsEl = document.getElementById('navigation-results');
            
            try {
                // é–‹å•Ÿå¸‚å ´é é¢
                window.open('http://localhost:3001/#/market', '_blank');
                
                resultsEl.innerHTML = `
                    <div class="status success">
                        <strong>âœ… å¸‚å ´é é¢å°èˆªæ¸¬è©¦</strong><br>
                        å·²åœ¨æ–°è¦–çª—é–‹å•Ÿå¸‚å ´é é¢ã€‚è«‹æª¢æŸ¥ä»¥ä¸‹åŠŸèƒ½ï¼š<br>
                        <ul>
                            <li>ğŸ“Š å¸‚å ´çµ±è¨ˆè³‡è¨Šé¡¯ç¤º</li>
                            <li>ğŸ“ˆ TradingView Widget è¼‰å…¥</li>
                            <li>ğŸ’° 200ç¨®è²¨å¹£åˆ—è¡¨é¡¯ç¤º</li>
                            <li>ğŸ”„ æ¯4ç§’è‡ªå‹•æ›´æ–°</li>
                            <li>ğŸ“œ æ»¾å‹•è¼‰å…¥æ›´å¤šè²¨å¹£</li>
                            <li>ğŸ–±ï¸ é»æ“Šè²¨å¹£é€²å…¥åˆ†æé é¢</li>
                        </ul>
                    </div>
                `;
                
                testResults.navigation = true;
                updateStatus('å¸‚å ´é é¢å°èˆªæ¸¬è©¦å®Œæˆ', 'success');
                
            } catch (error) {
                resultsEl.innerHTML = `<div class="status error">å°èˆªæ¸¬è©¦å¤±æ•—: ${error.message}</div>`;
                testResults.navigation = false;
                updateStatus('å¸‚å ´é é¢å°èˆªæ¸¬è©¦å¤±æ•—', 'error');
            }
            
            updateTestSummary();
        }

        // è‡ªå‹•é–‹å§‹åŸºæœ¬æ¸¬è©¦
        window.addEventListener('load', () => {
            updateStatus('å¸‚å ´é é¢æ¸¬è©¦æº–å‚™å°±ç·’', 'info');
            updateTestSummary();
        });
    </script>
</body>
</html>