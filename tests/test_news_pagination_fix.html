<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°èåˆ†é åŠŸèƒ½æ¸¬è©¦ - NexusTrade</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #0f0f0f;
            color: #ffffff;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .test-section {
            background: #1a1a1a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .test-title {
            color: #f7931a;
            font-size: 1.5em;
            margin-bottom: 15px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success { background: rgba(0, 212, 170, 0.2); border: 1px solid #00d4aa; }
        .status.error { background: rgba(255, 71, 87, 0.2); border: 1px solid #ff4757; }
        .status.info { background: rgba(247, 147, 26, 0.2); border: 1px solid #f7931a; }
        .btn {
            background: #f7931a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #e8830f; }
        .news-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #333;
            padding: 10px;
            margin: 10px 0;
        }
        .news-item {
            padding: 10px;
            border-bottom: 1px solid #333;
            margin-bottom: 10px;
        }
        .news-title {
            font-weight: bold;
            color: #00d4aa;
        }
        .news-source {
            color: #b3b3b3;
            font-size: 0.9em;
        }
        .pagination-info {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        code {
            background: #2a2a2a;
            padding: 2px 6px;
            border-radius: 3px;
            color: #00d4aa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æ–°èåˆ†é åŠŸèƒ½ä¿®å¾©é©—è­‰</h1>
        <div id="status" class="status info">
            <strong>æ¸¬è©¦ç‹€æ…‹:</strong> æº–å‚™ä¸­...
        </div>

        <div class="test-section">
            <div class="test-title">ğŸ“¡ API ç«¯é»æ¸¬è©¦</div>
            <button class="btn" onclick="testAPIEndpoints()">æ¸¬è©¦ API ç«¯é»</button>
            <div id="api-results"></div>
        </div>

        <div class="test-section">
            <div class="test-title">ğŸ“„ æ–°èåˆ†é æ¸¬è©¦</div>
            <button class="btn" onclick="testPagination()">æ¸¬è©¦åˆ†é åŠŸèƒ½</button>
            <div>
                ç•¶å‰é é¢: <span id="current-page">1</span> | 
                ç¸½é æ•¸: <span id="total-pages">-</span> | 
                ç¸½æ–°èæ•¸: <span id="total-news">-</span>
            </div>
            <div>
                <button class="btn" onclick="loadPage(1)">ç¬¬1é </button>
                <button class="btn" onclick="loadPage(2)">ç¬¬2é </button>
                <button class="btn" onclick="loadPage(3)">ç¬¬3é </button>
                <button class="btn" onclick="loadMoreNews()">è¼‰å…¥æ›´å¤š</button>
            </div>
            <div id="pagination-info" class="pagination-info"></div>
            <div id="news-list" class="news-list"></div>
        </div>

        <div class="test-section">
            <div class="test-title">ğŸ”„ é‡è¤‡æª¢æ¸¬æ¸¬è©¦</div>
            <button class="btn" onclick="checkDuplicates()">æª¢æ¸¬é‡è¤‡æ–°è</button>
            <div id="duplicate-results"></div>
        </div>

        <div class="test-section">
            <div class="test-title">ğŸ“Š æ¸¬è©¦çµæœç¸½çµ</div>
            <div id="test-summary"></div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 0;
        let allLoadedNews = [];
        let testResults = {
            apiEndpoints: false,
            pagination: false,
            duplicateCheck: false,
            loadMore: false
        };

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.innerHTML = `<strong>æ¸¬è©¦ç‹€æ…‹:</strong> ${message}`;
        }

        function updateTestSummary() {
            const passedTests = Object.values(testResults).filter(result => result === true).length;
            const totalTests = Object.keys(testResults).length;
            const summaryEl = document.getElementById('test-summary');
            
            let summaryHtml = `
                <h3>æ¸¬è©¦çµæœ: ${passedTests}/${totalTests} é€šé</h3>
                <ul>
                    <li>API ç«¯é»æ¸¬è©¦: ${testResults.apiEndpoints ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}</li>
                    <li>åˆ†é åŠŸèƒ½æ¸¬è©¦: ${testResults.pagination ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}</li>
                    <li>é‡è¤‡æª¢æ¸¬æ¸¬è©¦: ${testResults.duplicateCheck ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}</li>
                    <li>è¼‰å…¥æ›´å¤šæ¸¬è©¦: ${testResults.loadMore ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}</li>
                </ul>
            `;
            
            if (passedTests === totalTests) {
                summaryHtml += '<div class="status success"><strong>ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼æ–°èåˆ†é åŠŸèƒ½ä¿®å¾©æˆåŠŸï¼</strong></div>';
            } else {
                summaryHtml += '<div class="status error"><strong>âš ï¸ éƒ¨åˆ†æ¸¬è©¦å¤±æ•—ï¼Œéœ€è¦é€²ä¸€æ­¥æª¢æŸ¥</strong></div>';
            }
            
            summaryEl.innerHTML = summaryHtml;
        }

        async function testAPIEndpoints() {
            updateStatus('æ¸¬è©¦ API ç«¯é»...', 'info');
            const resultsEl = document.getElementById('api-results');
            
            try {
                // æ¸¬è©¦èˆŠç«¯é» (æ‡‰è©²æ²’æœ‰åˆ†é )
                const oldResponse = await fetch('/api/news/latest?limit=5');
                const oldData = await oldResponse.json();
                
                // æ¸¬è©¦æ–°ç«¯é» (æ‡‰è©²æœ‰åˆ†é )
                const newResponse = await fetch('/api/news?limit=5&page=1');
                const newData = await newResponse.json();
                
                let results = '<h4>API ç«¯é»æ¸¬è©¦çµæœ:</h4>';
                results += `<div><strong>èˆŠç«¯é»</strong> <code>/api/news/latest</code>:</div>`;
                results += `<div>- ç‹€æ…‹: ${oldResponse.ok ? 'âœ… æ­£å¸¸' : 'âŒ éŒ¯èª¤'}</div>`;
                results += `<div>- æœ‰åˆ†é è³‡è¨Š: ${oldData.pagination ? 'æ˜¯' : 'å¦'}</div>`;
                results += `<div>- æ–°èæ•¸é‡: ${oldData.data?.length || 0}</div><br>`;
                
                results += `<div><strong>æ–°ç«¯é»</strong> <code>/api/news</code>:</div>`;
                results += `<div>- ç‹€æ…‹: ${newResponse.ok ? 'âœ… æ­£å¸¸' : 'âŒ éŒ¯èª¤'}</div>`;
                results += `<div>- æœ‰åˆ†é è³‡è¨Š: ${newData.pagination ? 'âœ… æ˜¯' : 'âŒ å¦'}</div>`;
                results += `<div>- æ–°èæ•¸é‡: ${newData.data?.length || 0}</div>`;
                
                if (newData.pagination) {
                    results += `<div>- ç•¶å‰é : ${newData.pagination.currentPage}</div>`;
                    results += `<div>- ç¸½é æ•¸: ${newData.pagination.totalPages}</div>`;
                    results += `<div>- ç¸½æ–°èæ•¸: ${newData.pagination.totalNews}</div>`;
                }
                
                resultsEl.innerHTML = results;
                testResults.apiEndpoints = newResponse.ok && newData.pagination;
                updateStatus('API ç«¯é»æ¸¬è©¦å®Œæˆ', testResults.apiEndpoints ? 'success' : 'error');
                
            } catch (error) {
                resultsEl.innerHTML = `<div class="status error">API æ¸¬è©¦å¤±æ•—: ${error.message}</div>`;
                testResults.apiEndpoints = false;
                updateStatus('API ç«¯é»æ¸¬è©¦å¤±æ•—', 'error');
            }
            
            updateTestSummary();
        }

        async function testPagination() {
            updateStatus('æ¸¬è©¦åˆ†é åŠŸèƒ½...', 'info');
            
            try {
                await loadPage(1);
                testResults.pagination = true;
                updateStatus('åˆ†é åŠŸèƒ½æ¸¬è©¦å®Œæˆ', 'success');
            } catch (error) {
                testResults.pagination = false;
                updateStatus('åˆ†é åŠŸèƒ½æ¸¬è©¦å¤±æ•—', 'error');
            }
            
            updateTestSummary();
        }

        async function loadPage(page) {
            try {
                updateStatus(`è¼‰å…¥ç¬¬ ${page} é ...`, 'info');
                
                const response = await fetch(`/api/news?limit=5&page=${page}`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'è¼‰å…¥å¤±æ•—');
                }
                
                currentPage = page;
                totalPages = data.pagination.totalPages;
                
                // æ›´æ–°é é¢è³‡è¨Š
                document.getElementById('current-page').textContent = currentPage;
                document.getElementById('total-pages').textContent = totalPages;
                document.getElementById('total-news').textContent = data.pagination.totalNews;
                
                // æ›´æ–°åˆ†é è³‡è¨Š
                const paginationInfoEl = document.getElementById('pagination-info');
                paginationInfoEl.innerHTML = `
                    <strong>åˆ†é è³‡è¨Š:</strong><br>
                    ç•¶å‰é : ${data.pagination.currentPage}<br>
                    ç¸½é æ•¸: ${data.pagination.totalPages}<br>
                    ç¸½æ–°èæ•¸: ${data.pagination.totalNews}<br>
                    æœ‰ä¸‹ä¸€é : ${data.pagination.hasNextPage ? 'æ˜¯' : 'å¦'}<br>
                    æœ‰ä¸Šä¸€é : ${data.pagination.hasPrevPage ? 'æ˜¯' : 'å¦'}
                `;
                
                // é¡¯ç¤ºæ–°èåˆ—è¡¨
                const newsListEl = document.getElementById('news-list');
                newsListEl.innerHTML = '<h4>æ–°èåˆ—è¡¨:</h4>';
                
                data.data.forEach((news, index) => {
                    const newsItem = document.createElement('div');
                    newsItem.className = 'news-item';
                    newsItem.innerHTML = `
                        <div class="news-title">${index + 1}. ${news.title}</div>
                        <div class="news-source">ä¾†æº: ${news.source} | ID: ${news.id}</div>
                    `;
                    newsListEl.appendChild(newsItem);
                });
                
                updateStatus(`æˆåŠŸè¼‰å…¥ç¬¬ ${page} é  (${data.data.length} å‰‡æ–°è)`, 'success');
                
            } catch (error) {
                updateStatus(`è¼‰å…¥ç¬¬ ${page} é å¤±æ•—: ${error.message}`, 'error');
                throw error;
            }
        }

        async function loadMoreNews() {
            if (currentPage >= totalPages) {
                updateStatus('å·²ç¶“æ˜¯æœ€å¾Œä¸€é ', 'info');
                return;
            }
            
            try {
                const nextPage = currentPage + 1;
                const response = await fetch(`/api/news?limit=5&page=${nextPage}`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'è¼‰å…¥æ›´å¤šå¤±æ•—');
                }
                
                // è¿½åŠ æ–°èåˆ°ç¾æœ‰åˆ—è¡¨
                const newsListEl = document.getElementById('news-list');
                const startIndex = allLoadedNews.length;
                
                data.data.forEach((news, index) => {
                    allLoadedNews.push(news);
                    const newsItem = document.createElement('div');
                    newsItem.className = 'news-item';
                    newsItem.innerHTML = `
                        <div class="news-title">${startIndex + index + 1}. ${news.title}</div>
                        <div class="news-source">ä¾†æº: ${news.source} | ID: ${news.id} | é é¢: ${nextPage}</div>
                    `;
                    newsListEl.appendChild(newsItem);
                });
                
                currentPage = nextPage;
                document.getElementById('current-page').textContent = currentPage;
                
                testResults.loadMore = true;
                updateStatus(`æˆåŠŸè¼‰å…¥æ›´å¤šæ–°è (ç¬¬ ${nextPage} é )`, 'success');
                updateTestSummary();
                
            } catch (error) {
                testResults.loadMore = false;
                updateStatus(`è¼‰å…¥æ›´å¤šæ–°èå¤±æ•—: ${error.message}`, 'error');
                updateTestSummary();
            }
        }

        async function checkDuplicates() {
            updateStatus('æª¢æ¸¬é‡è¤‡æ–°è...', 'info');
            const resultsEl = document.getElementById('duplicate-results');
            
            try {
                // è¼‰å…¥å‰å…©é æ–°èé€²è¡Œé‡è¤‡æª¢æ¸¬
                const page1Response = await fetch('/api/news?limit=10&page=1');
                const page2Response = await fetch('/api/news?limit=10&page=2');
                
                const page1Data = await page1Response.json();
                const page2Data = await page2Response.json();
                
                if (!page1Data.success || !page2Data.success) {
                    throw new Error('è¼‰å…¥æ–°èå¤±æ•—');
                }
                
                const page1News = page1Data.data;
                const page2News = page2Data.data;
                const allNews = [...page1News, ...page2News];
                
                // æª¢æ¸¬é‡è¤‡
                const newsIds = allNews.map(news => news.id);
                const newsTitles = allNews.map(news => news.title);
                
                const duplicateIds = newsIds.filter((id, index) => newsIds.indexOf(id) !== index);
                const duplicateTitles = newsTitles.filter((title, index) => newsTitles.indexOf(title) !== index);
                
                let results = '<h4>é‡è¤‡æª¢æ¸¬çµæœ:</h4>';
                results += `<div>ç¬¬1é æ–°èæ•¸é‡: ${page1News.length}</div>`;
                results += `<div>ç¬¬2é æ–°èæ•¸é‡: ${page2News.length}</div>`;
                results += `<div>ç¸½è¨ˆæ–°èæ•¸é‡: ${allNews.length}</div>`;
                results += `<div>é‡è¤‡ ID æ•¸é‡: ${duplicateIds.length}</div>`;
                results += `<div>é‡è¤‡æ¨™é¡Œæ•¸é‡: ${duplicateTitles.length}</div>`;
                
                if (duplicateIds.length === 0 && duplicateTitles.length === 0) {
                    results += '<div class="status success">âœ… æ²’æœ‰ç™¼ç¾é‡è¤‡æ–°è</div>';
                    testResults.duplicateCheck = true;
                } else {
                    results += '<div class="status error">âŒ ç™¼ç¾é‡è¤‡æ–°è</div>';
                    if (duplicateIds.length > 0) {
                        results += `<div>é‡è¤‡ ID: ${duplicateIds.join(', ')}</div>`;
                    }
                    if (duplicateTitles.length > 0) {
                        results += `<div>é‡è¤‡æ¨™é¡Œ: ${duplicateTitles.slice(0, 3).join(', ')}...</div>`;
                    }
                    testResults.duplicateCheck = false;
                }
                
                resultsEl.innerHTML = results;
                updateStatus('é‡è¤‡æª¢æ¸¬å®Œæˆ', testResults.duplicateCheck ? 'success' : 'error');
                
            } catch (error) {
                resultsEl.innerHTML = `<div class="status error">é‡è¤‡æª¢æ¸¬å¤±æ•—: ${error.message}</div>`;
                testResults.duplicateCheck = false;
                updateStatus('é‡è¤‡æª¢æ¸¬å¤±æ•—', 'error');
            }
            
            updateTestSummary();
        }

        // è‡ªå‹•é–‹å§‹æ¸¬è©¦
        window.addEventListener('load', () => {
            updateStatus('æº–å‚™å°±ç·’ï¼Œå¯ä»¥é–‹å§‹æ¸¬è©¦', 'info');
            updateTestSummary();
        });
    </script>
</body>
</html>