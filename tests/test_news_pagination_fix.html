<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新聞分頁功能測試 - NexusTrade</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #0f0f0f;
            color: #ffffff;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .test-section {
            background: #1a1a1a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .test-title {
            color: #f7931a;
            font-size: 1.5em;
            margin-bottom: 15px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success { background: rgba(0, 212, 170, 0.2); border: 1px solid #00d4aa; }
        .status.error { background: rgba(255, 71, 87, 0.2); border: 1px solid #ff4757; }
        .status.info { background: rgba(247, 147, 26, 0.2); border: 1px solid #f7931a; }
        .btn {
            background: #f7931a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #e8830f; }
        .news-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #333;
            padding: 10px;
            margin: 10px 0;
        }
        .news-item {
            padding: 10px;
            border-bottom: 1px solid #333;
            margin-bottom: 10px;
        }
        .news-title {
            font-weight: bold;
            color: #00d4aa;
        }
        .news-source {
            color: #b3b3b3;
            font-size: 0.9em;
        }
        .pagination-info {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        code {
            background: #2a2a2a;
            padding: 2px 6px;
            border-radius: 3px;
            color: #00d4aa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 新聞分頁功能修復驗證</h1>
        <div id="status" class="status info">
            <strong>測試狀態:</strong> 準備中...
        </div>

        <div class="test-section">
            <div class="test-title">📡 API 端點測試</div>
            <button class="btn" onclick="testAPIEndpoints()">測試 API 端點</button>
            <div id="api-results"></div>
        </div>

        <div class="test-section">
            <div class="test-title">📄 新聞分頁測試</div>
            <button class="btn" onclick="testPagination()">測試分頁功能</button>
            <div>
                當前頁面: <span id="current-page">1</span> | 
                總頁數: <span id="total-pages">-</span> | 
                總新聞數: <span id="total-news">-</span>
            </div>
            <div>
                <button class="btn" onclick="loadPage(1)">第1頁</button>
                <button class="btn" onclick="loadPage(2)">第2頁</button>
                <button class="btn" onclick="loadPage(3)">第3頁</button>
                <button class="btn" onclick="loadMoreNews()">載入更多</button>
            </div>
            <div id="pagination-info" class="pagination-info"></div>
            <div id="news-list" class="news-list"></div>
        </div>

        <div class="test-section">
            <div class="test-title">🔄 重複檢測測試</div>
            <button class="btn" onclick="checkDuplicates()">檢測重複新聞</button>
            <div id="duplicate-results"></div>
        </div>

        <div class="test-section">
            <div class="test-title">📊 測試結果總結</div>
            <div id="test-summary"></div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 0;
        let allLoadedNews = [];
        let testResults = {
            apiEndpoints: false,
            pagination: false,
            duplicateCheck: false,
            loadMore: false
        };

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.innerHTML = `<strong>測試狀態:</strong> ${message}`;
        }

        function updateTestSummary() {
            const passedTests = Object.values(testResults).filter(result => result === true).length;
            const totalTests = Object.keys(testResults).length;
            const summaryEl = document.getElementById('test-summary');
            
            let summaryHtml = `
                <h3>測試結果: ${passedTests}/${totalTests} 通過</h3>
                <ul>
                    <li>API 端點測試: ${testResults.apiEndpoints ? '✅ 通過' : '❌ 失敗'}</li>
                    <li>分頁功能測試: ${testResults.pagination ? '✅ 通過' : '❌ 失敗'}</li>
                    <li>重複檢測測試: ${testResults.duplicateCheck ? '✅ 通過' : '❌ 失敗'}</li>
                    <li>載入更多測試: ${testResults.loadMore ? '✅ 通過' : '❌ 失敗'}</li>
                </ul>
            `;
            
            if (passedTests === totalTests) {
                summaryHtml += '<div class="status success"><strong>🎉 所有測試通過！新聞分頁功能修復成功！</strong></div>';
            } else {
                summaryHtml += '<div class="status error"><strong>⚠️ 部分測試失敗，需要進一步檢查</strong></div>';
            }
            
            summaryEl.innerHTML = summaryHtml;
        }

        async function testAPIEndpoints() {
            updateStatus('測試 API 端點...', 'info');
            const resultsEl = document.getElementById('api-results');
            
            try {
                // 測試舊端點 (應該沒有分頁)
                const oldResponse = await fetch('/api/news/latest?limit=5');
                const oldData = await oldResponse.json();
                
                // 測試新端點 (應該有分頁)
                const newResponse = await fetch('/api/news?limit=5&page=1');
                const newData = await newResponse.json();
                
                let results = '<h4>API 端點測試結果:</h4>';
                results += `<div><strong>舊端點</strong> <code>/api/news/latest</code>:</div>`;
                results += `<div>- 狀態: ${oldResponse.ok ? '✅ 正常' : '❌ 錯誤'}</div>`;
                results += `<div>- 有分頁資訊: ${oldData.pagination ? '是' : '否'}</div>`;
                results += `<div>- 新聞數量: ${oldData.data?.length || 0}</div><br>`;
                
                results += `<div><strong>新端點</strong> <code>/api/news</code>:</div>`;
                results += `<div>- 狀態: ${newResponse.ok ? '✅ 正常' : '❌ 錯誤'}</div>`;
                results += `<div>- 有分頁資訊: ${newData.pagination ? '✅ 是' : '❌ 否'}</div>`;
                results += `<div>- 新聞數量: ${newData.data?.length || 0}</div>`;
                
                if (newData.pagination) {
                    results += `<div>- 當前頁: ${newData.pagination.currentPage}</div>`;
                    results += `<div>- 總頁數: ${newData.pagination.totalPages}</div>`;
                    results += `<div>- 總新聞數: ${newData.pagination.totalNews}</div>`;
                }
                
                resultsEl.innerHTML = results;
                testResults.apiEndpoints = newResponse.ok && newData.pagination;
                updateStatus('API 端點測試完成', testResults.apiEndpoints ? 'success' : 'error');
                
            } catch (error) {
                resultsEl.innerHTML = `<div class="status error">API 測試失敗: ${error.message}</div>`;
                testResults.apiEndpoints = false;
                updateStatus('API 端點測試失敗', 'error');
            }
            
            updateTestSummary();
        }

        async function testPagination() {
            updateStatus('測試分頁功能...', 'info');
            
            try {
                await loadPage(1);
                testResults.pagination = true;
                updateStatus('分頁功能測試完成', 'success');
            } catch (error) {
                testResults.pagination = false;
                updateStatus('分頁功能測試失敗', 'error');
            }
            
            updateTestSummary();
        }

        async function loadPage(page) {
            try {
                updateStatus(`載入第 ${page} 頁...`, 'info');
                
                const response = await fetch(`/api/news?limit=5&page=${page}`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || '載入失敗');
                }
                
                currentPage = page;
                totalPages = data.pagination.totalPages;
                
                // 更新頁面資訊
                document.getElementById('current-page').textContent = currentPage;
                document.getElementById('total-pages').textContent = totalPages;
                document.getElementById('total-news').textContent = data.pagination.totalNews;
                
                // 更新分頁資訊
                const paginationInfoEl = document.getElementById('pagination-info');
                paginationInfoEl.innerHTML = `
                    <strong>分頁資訊:</strong><br>
                    當前頁: ${data.pagination.currentPage}<br>
                    總頁數: ${data.pagination.totalPages}<br>
                    總新聞數: ${data.pagination.totalNews}<br>
                    有下一頁: ${data.pagination.hasNextPage ? '是' : '否'}<br>
                    有上一頁: ${data.pagination.hasPrevPage ? '是' : '否'}
                `;
                
                // 顯示新聞列表
                const newsListEl = document.getElementById('news-list');
                newsListEl.innerHTML = '<h4>新聞列表:</h4>';
                
                data.data.forEach((news, index) => {
                    const newsItem = document.createElement('div');
                    newsItem.className = 'news-item';
                    newsItem.innerHTML = `
                        <div class="news-title">${index + 1}. ${news.title}</div>
                        <div class="news-source">來源: ${news.source} | ID: ${news.id}</div>
                    `;
                    newsListEl.appendChild(newsItem);
                });
                
                updateStatus(`成功載入第 ${page} 頁 (${data.data.length} 則新聞)`, 'success');
                
            } catch (error) {
                updateStatus(`載入第 ${page} 頁失敗: ${error.message}`, 'error');
                throw error;
            }
        }

        async function loadMoreNews() {
            if (currentPage >= totalPages) {
                updateStatus('已經是最後一頁', 'info');
                return;
            }
            
            try {
                const nextPage = currentPage + 1;
                const response = await fetch(`/api/news?limit=5&page=${nextPage}`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || '載入更多失敗');
                }
                
                // 追加新聞到現有列表
                const newsListEl = document.getElementById('news-list');
                const startIndex = allLoadedNews.length;
                
                data.data.forEach((news, index) => {
                    allLoadedNews.push(news);
                    const newsItem = document.createElement('div');
                    newsItem.className = 'news-item';
                    newsItem.innerHTML = `
                        <div class="news-title">${startIndex + index + 1}. ${news.title}</div>
                        <div class="news-source">來源: ${news.source} | ID: ${news.id} | 頁面: ${nextPage}</div>
                    `;
                    newsListEl.appendChild(newsItem);
                });
                
                currentPage = nextPage;
                document.getElementById('current-page').textContent = currentPage;
                
                testResults.loadMore = true;
                updateStatus(`成功載入更多新聞 (第 ${nextPage} 頁)`, 'success');
                updateTestSummary();
                
            } catch (error) {
                testResults.loadMore = false;
                updateStatus(`載入更多新聞失敗: ${error.message}`, 'error');
                updateTestSummary();
            }
        }

        async function checkDuplicates() {
            updateStatus('檢測重複新聞...', 'info');
            const resultsEl = document.getElementById('duplicate-results');
            
            try {
                // 載入前兩頁新聞進行重複檢測
                const page1Response = await fetch('/api/news?limit=10&page=1');
                const page2Response = await fetch('/api/news?limit=10&page=2');
                
                const page1Data = await page1Response.json();
                const page2Data = await page2Response.json();
                
                if (!page1Data.success || !page2Data.success) {
                    throw new Error('載入新聞失敗');
                }
                
                const page1News = page1Data.data;
                const page2News = page2Data.data;
                const allNews = [...page1News, ...page2News];
                
                // 檢測重複
                const newsIds = allNews.map(news => news.id);
                const newsTitles = allNews.map(news => news.title);
                
                const duplicateIds = newsIds.filter((id, index) => newsIds.indexOf(id) !== index);
                const duplicateTitles = newsTitles.filter((title, index) => newsTitles.indexOf(title) !== index);
                
                let results = '<h4>重複檢測結果:</h4>';
                results += `<div>第1頁新聞數量: ${page1News.length}</div>`;
                results += `<div>第2頁新聞數量: ${page2News.length}</div>`;
                results += `<div>總計新聞數量: ${allNews.length}</div>`;
                results += `<div>重複 ID 數量: ${duplicateIds.length}</div>`;
                results += `<div>重複標題數量: ${duplicateTitles.length}</div>`;
                
                if (duplicateIds.length === 0 && duplicateTitles.length === 0) {
                    results += '<div class="status success">✅ 沒有發現重複新聞</div>';
                    testResults.duplicateCheck = true;
                } else {
                    results += '<div class="status error">❌ 發現重複新聞</div>';
                    if (duplicateIds.length > 0) {
                        results += `<div>重複 ID: ${duplicateIds.join(', ')}</div>`;
                    }
                    if (duplicateTitles.length > 0) {
                        results += `<div>重複標題: ${duplicateTitles.slice(0, 3).join(', ')}...</div>`;
                    }
                    testResults.duplicateCheck = false;
                }
                
                resultsEl.innerHTML = results;
                updateStatus('重複檢測完成', testResults.duplicateCheck ? 'success' : 'error');
                
            } catch (error) {
                resultsEl.innerHTML = `<div class="status error">重複檢測失敗: ${error.message}</div>`;
                testResults.duplicateCheck = false;
                updateStatus('重複檢測失敗', 'error');
            }
            
            updateTestSummary();
        }

        // 自動開始測試
        window.addEventListener('load', () => {
            updateStatus('準備就緒，可以開始測試', 'info');
            updateTestSummary();
        });
    </script>
</body>
</html>